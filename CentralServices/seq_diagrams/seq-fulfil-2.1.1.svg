<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1768px" preserveAspectRatio="none" style="width:1544px;height:1768px;" version="1.1" viewBox="0 0 1544 1768" width="1544px" zoomAndPan="magnify"><defs><filter height="300%" id="f1xqjvdjwf6yn8" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="282" x="632.25" y="23.5352">2.1.1. Fulfil Handler Consume (Success)</text><rect fill="#FFFFE0" height="1722.5879" style="stroke: #A80036; stroke-width: 1.0;" width="1468.5" x="29" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="712.75" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f1xqjvdjwf6yn8)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="79" y="196.2188"/><rect fill="#FFFFFF" filter="url(#f1xqjvdjwf6yn8)" height="1555.3008" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="386" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1xqjvdjwf6yn8)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="854" y="1462.7461"/><rect fill="#FFFFFF" filter="url(#f1xqjvdjwf6yn8)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137.5" y="1561.3223"/><rect fill="#FFFFFF" filter="url(#f1xqjvdjwf6yn8)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1270.5" y="491.0137"/><rect fill="#FFFFFF" filter="url(#f1xqjvdjwf6yn8)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1270.5" y="913.0508"/><rect fill="#FFFFFF" filter="url(#f1xqjvdjwf6yn8)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1440.5" y="520.3242"/><rect fill="#FFFFFF" filter="url(#f1xqjvdjwf6yn8)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1440.5" y="942.3613"/><rect fill="#FFFFFF" filter="url(#f1xqjvdjwf6yn8)" height="1541.3008" style="stroke: #000000; stroke-width: 2.0;" width="1520.5" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f1xqjvdjwf6yn8)" height="1509.9902" style="stroke: #000000; stroke-width: 2.0;" width="1500.5" x="23" y="157.5977"/><rect fill="#FFFFFF" filter="url(#f1xqjvdjwf6yn8)" height="90.9316" style="stroke: #000000; stroke-width: 2.0;" width="513.5" x="301.5" y="241.2188"/><rect fill="#FFFFFF" filter="url(#f1xqjvdjwf6yn8)" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="493.5" x="311.5" y="265.5293"/><rect fill="#FFFFFF" filter="url(#f1xqjvdjwf6yn8)" height="92.2422" style="stroke: #000000; stroke-width: 2.0;" width="757.5" x="311.5" y="346.1504"/><rect fill="#FFFFFF" filter="url(#f1xqjvdjwf6yn8)" height="183.1738" style="stroke: #000000; stroke-width: 2.0;" width="1192" x="311.5" y="452.3926"/><rect fill="#FFFFFF" filter="url(#f1xqjvdjwf6yn8)" height="186.5527" style="stroke: #000000; stroke-width: 2.0;" width="547.5" x="311.5" y="649.5664"/><rect fill="#FFFFFF" filter="url(#f1xqjvdjwf6yn8)" height="756.2031" style="stroke: #000000; stroke-width: 2.0;" width="1212" x="301.5" y="850.1191"/><rect fill="#FFFFFF" filter="url(#f1xqjvdjwf6yn8)" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1192" x="311.5" y="874.4297"/><rect fill="#FFFFFF" height="105.5762" style="stroke: none; stroke-width: 1.0;" width="1212" x="301.5" y="1500.7461"/><rect fill="#FFFFFF" filter="url(#f1xqjvdjwf6yn8)" height="76.6211" style="stroke: #000000; stroke-width: 2.0;" width="914.5" x="311.5" y="1522.7012"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="1500.5" x="23" y="1613.3223"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="84" x2="84" y1="116.2871" y2="1691.5879"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="390.5" x2="390.5" y1="116.2871" y2="1691.5879"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="859" x2="859" y1="116.2871" y2="1691.5879"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1006" x2="1006" y1="116.2871" y2="1691.5879"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1142" x2="1142" y1="116.2871" y2="1691.5879"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1275" x2="1275" y1="116.2871" y2="1691.5879"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1445.5" x2="1445.5" y1="116.2871" y2="1691.5879"/><rect fill="#FEFECE" filter="url(#f1xqjvdjwf6yn8)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="37" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1xqjvdjwf6yn8)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="33" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="40" y="101.334">Fulfil-Topic</text><rect fill="#FEFECE" filter="url(#f1xqjvdjwf6yn8)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="37" y="1690.5879"/><rect fill="#FEFECE" filter="url(#f1xqjvdjwf6yn8)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="33" y="1694.5879"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="40" y="1715.123">Fulfil-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="133" x="321.5" y="113.334">Fulfil Event Handler</text><ellipse cx="391" cy="83.7988" fill="#FEFECE" filter="url(#f1xqjvdjwf6yn8)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="387,71.7988,393,66.7988,391,71.7988,393,76.7988,387,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="133" x="321.5" y="1704.123">Fulfil Event Handler</text><ellipse cx="391" cy="1723.0762" fill="#FEFECE" filter="url(#f1xqjvdjwf6yn8)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="387,1711.0762,393,1706.0762,391,1711.0762,393,1716.0762,387,1711.0762" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f1xqjvdjwf6yn8)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="778" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1xqjvdjwf6yn8)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="774" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="781" y="101.334">Position-Topic-dfsp2</text><rect fill="#FEFECE" filter="url(#f1xqjvdjwf6yn8)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="778" y="1690.5879"/><rect fill="#FEFECE" filter="url(#f1xqjvdjwf6yn8)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="774" y="1694.5879"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="781" y="1715.123">Position-Topic-dfsp2</text><rect fill="#FEFECE" filter="url(#f1xqjvdjwf6yn8)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="958" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1xqjvdjwf6yn8)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="954" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="961" y="101.334">Event-Topic</text><rect fill="#FEFECE" filter="url(#f1xqjvdjwf6yn8)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="958" y="1690.5879"/><rect fill="#FEFECE" filter="url(#f1xqjvdjwf6yn8)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="954" y="1694.5879"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="961" y="1715.123">Event-Topic</text><rect fill="#FEFECE" filter="url(#f1xqjvdjwf6yn8)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1073" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1xqjvdjwf6yn8)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1069" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1076" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f1xqjvdjwf6yn8)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1073" y="1690.5879"/><rect fill="#FEFECE" filter="url(#f1xqjvdjwf6yn8)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1069" y="1694.5879"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1076" y="1715.123">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1226" y="113.334">Transfer DAO</text><ellipse cx="1275.5" cy="83.7988" fill="#FEFECE" filter="url(#f1xqjvdjwf6yn8)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1263.5" x2="1287.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1226" y="1704.123">Transfer DAO</text><ellipse cx="1275.5" cy="1723.0762" fill="#FEFECE" filter="url(#f1xqjvdjwf6yn8)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1263.5" x2="1287.5" y1="1737.0762" y2="1737.0762"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1397.5" y="113.334">Central Store</text><path d="M1427.5,63.7988 C1427.5,53.7988 1445.5,53.7988 1445.5,53.7988 C1445.5,53.7988 1463.5,53.7988 1463.5,63.7988 L1463.5,89.7988 C1463.5,99.7988 1445.5,99.7988 1445.5,99.7988 C1445.5,99.7988 1427.5,99.7988 1427.5,89.7988 L1427.5,63.7988 " fill="#FEFECE" filter="url(#f1xqjvdjwf6yn8)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1427.5,63.7988 C1427.5,73.7988 1445.5,73.7988 1445.5,73.7988 C1445.5,73.7988 1463.5,73.7988 1463.5,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1397.5" y="1704.123">Central Store</text><path d="M1427.5,1717.0762 C1427.5,1707.0762 1445.5,1707.0762 1445.5,1707.0762 C1445.5,1707.0762 1463.5,1707.0762 1463.5,1717.0762 L1463.5,1743.0762 C1463.5,1753.0762 1445.5,1753.0762 1445.5,1753.0762 C1445.5,1753.0762 1427.5,1753.0762 1427.5,1743.0762 L1427.5,1717.0762 " fill="#FEFECE" filter="url(#f1xqjvdjwf6yn8)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1427.5,1717.0762 C1427.5,1727.0762 1445.5,1727.0762 1445.5,1727.0762 C1445.5,1727.0762 1463.5,1727.0762 1463.5,1717.0762 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1xqjvdjwf6yn8)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="79" y="196.2188"/><rect fill="#FFFFFF" filter="url(#f1xqjvdjwf6yn8)" height="1555.3008" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="386" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1xqjvdjwf6yn8)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="854" y="1462.7461"/><rect fill="#FFFFFF" filter="url(#f1xqjvdjwf6yn8)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137.5" y="1561.3223"/><rect fill="#FFFFFF" filter="url(#f1xqjvdjwf6yn8)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1270.5" y="491.0137"/><rect fill="#FFFFFF" filter="url(#f1xqjvdjwf6yn8)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1270.5" y="913.0508"/><rect fill="#FFFFFF" filter="url(#f1xqjvdjwf6yn8)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1440.5" y="520.3242"/><rect fill="#FFFFFF" filter="url(#f1xqjvdjwf6yn8)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1440.5" y="942.3613"/><path d="M13,133.2871 L282,133.2871 L282,140.2871 L272,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1541.3008" style="stroke: #000000; stroke-width: 2.0;" width="1520.5" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224" x="28" y="146.8555">Fulfil Handler Consume (Success)</text><path d="M23,157.5977 L85,157.5977 L85,164.5977 L75,174.5977 L23,174.5977 L23,157.5977 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1509.9902" style="stroke: #000000; stroke-width: 2.0;" width="1500.5" x="23" y="157.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="171.166">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="149" x="100" y="170.2324">[Consume Single Message]</text><polygon fill="#A80036" points="100,192.2188,90,196.2188,100,200.2188,96,196.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="94" x2="385" y1="196.2188" y2="196.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="106" y="191.4766">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="119" y="191.4766">Consume Prepare event message for Payer</text><path d="M301.5,241.2188 L385.5,241.2188 L385.5,248.2188 L375.5,258.2188 L301.5,258.2188 L301.5,241.2188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="90.9316" style="stroke: #000000; stroke-width: 2.0;" width="513.5" x="301.5" y="241.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="316.5" y="254.7871">break</text><path d="M311.5,265.5293 L453.5,265.5293 L453.5,272.5293 L443.5,282.5293 L311.5,282.5293 L311.5,265.5293 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="493.5" x="311.5" y="265.5293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="326.5" y="279.0977">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="438" y1="304.1504" y2="304.1504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="438" x2="438" y1="304.1504" y2="317.1504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="397" x2="438" y1="317.1504" y2="317.1504"/><polygon fill="#A80036" points="407,313.1504,397,317.1504,407,321.1504,403,317.1504" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="403" y="299.4082">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="377" x="416" y="299.4082">Validate event - Rule: type == 'fulfil' &amp;&amp; action == 'commit'</text><path d="M311.5,346.1504 L526.5,346.1504 L526.5,353.1504 L516.5,363.1504 L311.5,363.1504 L311.5,346.1504 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="92.2422" style="stroke: #000000; stroke-width: 2.0;" width="757.5" x="311.5" y="346.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="326.5" y="359.7188">Persist Event Information</text><polygon fill="#A80036" points="994.5,380.7715,1004.5,384.7715,994.5,388.7715,998.5,384.7715" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="1000.5" y1="384.7715" y2="384.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="403" y="380.0293">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="416" y="380.0293">Publish event information</text><rect fill="#FFFFFF" filter="url(#f1xqjvdjwf6yn8)" height="40.6211" style="stroke: #000000; stroke-width: 2.0;" width="739.5" x="318.5" y="392.7715"/><polygon fill="#EEEEEE" points="318.5,392.7715,382.5,392.7715,382.5,399.7715,372.5,409.7715,318.5,409.7715,318.5,392.7715" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="331.5" y="407.3398">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="591.25" y="426.3398">Event Handler Consume {9.1.0.}</text><path d="M311.5,452.3926 L524.5,452.3926 L524.5,459.3926 L514.5,469.3926 L311.5,469.3926 L311.5,452.3926 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="183.1738" style="stroke: #000000; stroke-width: 2.0;" width="1192" x="311.5" y="452.3926"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="168" x="326.5" y="465.9609">Retrieve Transfer Details</text><polygon fill="#A80036" points="1258.5,487.0137,1268.5,491.0137,1258.5,495.0137,1262.5,491.0137" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="1264.5" y1="491.0137" y2="491.0137"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="403" y="486.2715">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="416" y="486.2715">Request information for the validate checks</text><polygon fill="#A80036" points="1428.5,516.3242,1438.5,520.3242,1428.5,524.3242,1432.5,520.3242" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1280.5" x2="1434.5" y1="520.3242" y2="520.3242"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1287.5" y="515.582">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="1300.5" y="515.582">Fetch from database</text><polygon fill="#A80036" points="1291.5,545.6348,1281.5,549.6348,1291.5,553.6348,1287.5,549.6348" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1285.5" x2="1444.5" y1="549.6348" y2="549.6348"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1297.5" y="544.8926">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1314.5" y="544.8926"/><polygon fill="#FFFFE0" filter="url(#f1xqjvdjwf6yn8)" points="1419,562.6348,1472,562.6348,1482,581.6348,1472,600.6348,1419,600.6348,1409,581.6348,1419,562.6348" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1421" y="579.2031">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="1421" y="594.5137">ilp</text><polygon fill="#A80036" points="407,623.5664,397,627.5664,407,631.5664,403,627.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="401" x2="1274.5" y1="627.5664" y2="627.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="413" y="622.8242">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="426" y="622.8242">Return transfer &amp; ilp</text><path d="M311.5,649.5664 L510.5,649.5664 L510.5,656.5664 L500.5,666.5664 L311.5,666.5664 L311.5,649.5664 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="186.5527" style="stroke: #000000; stroke-width: 2.0;" width="547.5" x="311.5" y="649.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="326.5" y="663.1348">Validate Fulfil Transfer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="438" y1="688.1875" y2="688.1875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="438" x2="438" y1="688.1875" y2="701.1875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="397" x2="438" y1="701.1875" y2="701.1875"/><polygon fill="#A80036" points="407,697.1875,397,701.1875,407,705.1875,403,701.1875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="403" y="683.4453">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="416" y="683.4453">Check existing transfer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="438" y1="730.498" y2="730.498"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="438" x2="438" y1="730.498" y2="743.498"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="397" x2="438" y1="743.498" y2="743.498"/><polygon fill="#A80036" points="407,739.498,397,743.498,407,747.498,403,743.498" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="403" y="725.7559">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="416" y="725.7559">Validate fulfilment against condition</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="438" y1="772.8086" y2="772.8086"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="438" x2="438" y1="772.8086" y2="785.8086"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="397" x2="438" y1="785.8086" y2="785.8086"/><polygon fill="#A80036" points="407,781.8086,397,785.8086,407,789.8086,403,785.8086" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="768.0664">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="425" y="768.0664">Validate duplicate check</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="438" y1="815.1191" y2="815.1191"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="438" x2="438" y1="815.1191" y2="828.1191"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="397" x2="438" y1="828.1191" y2="828.1191"/><polygon fill="#A80036" points="407,824.1191,397,828.1191,407,832.1191,403,828.1191" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="810.377">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="422" x="425" y="810.377">Validate message signature (to be confirmed in future requirement)</text><path d="M301.5,850.1191 L363.5,850.1191 L363.5,857.1191 L353.5,867.1191 L301.5,867.1191 L301.5,850.1191 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="756.2031" style="stroke: #000000; stroke-width: 2.0;" width="1212" x="301.5" y="850.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="316.5" y="863.6875">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="116" x="378.5" y="862.7539">[Validate successful]</text><path d="M311.5,874.4297 L471.5,874.4297 L471.5,881.4297 L461.5,891.4297 L311.5,891.4297 L311.5,874.4297 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1192" x="311.5" y="874.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="115" x="326.5" y="887.998">Persist fulfilment</text><polygon fill="#A80036" points="1258.5,909.0508,1268.5,913.0508,1258.5,917.0508,1262.5,913.0508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="1264.5" y1="913.0508" y2="913.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="908.3086">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="425" y="908.3086">Persist fulfilment</text><polygon fill="#A80036" points="1428.5,938.3613,1438.5,942.3613,1428.5,946.3613,1432.5,942.3613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1280.5" x2="1434.5" y1="942.3613" y2="942.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1287.5" y="937.6191">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1309.5" y="937.6191">Persist to database</text><polygon fill="#FFFFE0" filter="url(#f1xqjvdjwf6yn8)" points="1435,985.3613,1455,985.3613,1465,996.3613,1455,1008.3613,1435,1008.3613,1425,996.3613,1435,985.3613" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="1437" y="1001.9297">ilp</text><polygon fill="#A80036" points="407,1030.9824,397,1034.9824,407,1038.9824,403,1034.9824" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="401" x2="1274.5" y1="1034.9824" y2="1034.9824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413" y="1030.2402">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="435" y="1030.2402">Return success</text><path d="M401,1054.9824 L401,1431.9824 L710,1431.9824 L710,1064.9824 L700,1054.9824 L401,1054.9824 " fill="#FFFF00" filter="url(#f1xqjvdjwf6yn8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M700,1054.9824 L700,1064.9824 L710,1064.9824 L700,1054.9824 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="407" y="1072.5508">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="407" y="1087.8613">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="423" y="1103.1719">id: &lt;ID&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="423" y="1118.4824">from: &lt;transferHeaders.FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="423" y="1133.793">to: &lt;transferHeaders.FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="423" y="1149.1035">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="423" y="1164.4141">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="439" y="1179.7246">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="439" y="1195.0352">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="423" y="1210.3457">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="423" y="1225.6563">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="439" y="1240.9668">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="455" y="1256.2773">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="455" y="1271.5879">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="455" y="1286.8984">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="455" y="1302.209">action: commit,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="455" y="1317.5195">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="455" y="1332.8301">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="471" y="1348.1406">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="471" y="1363.4512">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="455" y="1378.7617">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="439" y="1394.0723">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="423" y="1409.3828">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="407" y="1424.6934">}</text><polygon fill="#A80036" points="842,1458.7461,852,1462.7461,842,1466.7461,846,1462.7461" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="848" y1="1462.7461" y2="1462.7461"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="1458.0039">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="425" y="1458.0039">Route &amp; Publish Position event for Payee</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="301.5" x2="1513.5" y1="1501.7461" y2="1501.7461"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224" x="306.5" y="1512.3809">[Validate Fulfil Transfer not successful]</text><path d="M311.5,1522.7012 L395.5,1522.7012 L395.5,1529.7012 L385.5,1539.7012 L311.5,1539.7012 L311.5,1522.7012 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="76.6211" style="stroke: #000000; stroke-width: 2.0;" width="914.5" x="311.5" y="1522.7012"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="326.5" y="1536.2695">break</text><polygon fill="#A80036" points="1125.5,1557.3223,1135.5,1561.3223,1125.5,1565.3223,1129.5,1561.3223" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="1131.5" y1="1561.3223" y2="1561.3223"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="1556.5801">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="425" y="1556.5801">Route &amp; Publish Notification event for Payee</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1523.5" y1="1614.3223" y2="1614.3223"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="151" x="28" y="1624.957">[Consume Batch Messages]</text><path d="M163,1633.2773 L163,1658.2773 L377,1658.2773 L377,1643.2773 L367,1633.2773 L163,1633.2773 " fill="#ADD8E6" filter="url(#f1xqjvdjwf6yn8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M367,1633.2773 L367,1643.2773 L377,1643.2773 L367,1633.2773 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="169" y="1650.8457">To be delivered by future story</text><!--
@startuml
title 2.1.1. Fulfil Handler Consume (Success)

autonumber


collections "Fulfil-Topic" as TOPIC_FULFIL
control "Fulfil Event Handler" as FULF_HANDLER
collections "Event-Topic" as TOPIC_EVENT
collections "Position-Topic-dfsp2" as TOPIC_POSITION_DFSP2
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Transfer DAO" as TRANS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_FULFIL
    participant FULF_HANDLER
    participant TOPIC_POSITION_DFSP2
    participant TOPIC_EVENT
    participant TOPIC_NOTIFICATIONS
    participant TRANS_DAO
    participant DB
end box

activate FULF_HANDLER
group Fulfil Handler Consume (Success)
    alt Consume Single Message
        TOPIC_FULFIL <- FULF_HANDLER: Consume Prepare event message for Payer
        activate TOPIC_FULFIL
        deactivate TOPIC_FULFIL

        break
            group Validate Event
                FULF_HANDLER <-> FULF_HANDLER: Validate event - Rule: type == 'fulfil' && action == 'commit'
            end
        end

        group Persist Event Information
            FULF_HANDLER -> TOPIC_EVENT: Publish event information
	        ref over FULF_HANDLER, TOPIC_EVENT :  Event Handler Consume {9.1.0.} 
        end

        group Retrieve Transfer Details
            FULF_HANDLER -> TRANS_DAO: Request information for the validate checks
            activate TRANS_DAO
            TRANS_DAO -> DB: Fetch from database
            activate DB
            DB - -> TRANS_DAO
            deactivate DB
            hnote over DB #lightyellow
                transfer
                ilp
            end note
            FULF_HANDLER <- - TRANS_DAO: Return transfer & ilp
            deactivate TRANS_DAO
        end

        group Validate Fulfil Transfer
            FULF_HANDLER <-> FULF_HANDLER: Check existing transfer
            FULF_HANDLER <-> FULF_HANDLER: Validate fulfilment against condition
            FULF_HANDLER <-> FULF_HANDLER: Validate duplicate check
            FULF_HANDLER <-> FULF_HANDLER: Validate message signature (to be confirmed in future requirement)
        end

        alt Validate successful
            group Persist fulfilment
                FULF_HANDLER -> TRANS_DAO: Persist fulfilment
                activate TRANS_DAO
                TRANS_DAO -> DB: Persist to database
                activate DB
                deactivate DB
                hnote over DB #lightyellow
                    ilp
                end note
                FULF_HANDLER <- - TRANS_DAO: Return success
                deactivate TRANS_DAO
            end

            note right of FULF_HANDLER #yellow
                Message:
                {
                    id: <ID>,
                    from: <transferHeaders.FSPIOP-Source>,
                    to: <transferHeaders.FSPIOP-Destination>,
                    type: application/json,
                    content: {
                        headers: <transferHeaders>,
                        payload: <transferMessage>
                    },
                    metadata: {
                        event: {
                            id: <uuid>,
                            responseTo: <previous.uuid>,
                            type: position,
                            action: commit,
                            createdAt: <timestamp>,
                            state: {
                                status: "success",
                                code: 0
                            }
                        }
                    }
                }
            end note
            FULF_HANDLER -> TOPIC_POSITION_DFSP2: Route & Publish Position event for Payee
            activate TOPIC_POSITION_DFSP2
            deactivate TOPIC_POSITION_DFSP2
        else Validate Fulfil Transfer not successful
            break
                FULF_HANDLER -> TOPIC_NOTIFICATIONS: Route & Publish Notification event for Payee
                activate TOPIC_NOTIFICATIONS
                deactivate TOPIC_NOTIFICATIONS
            end
        end

    else Consume Batch Messages
        note left of FULF_HANDLER #lightblue
            To be delivered by future story
        end note
    end
end
deactivate FULF_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.4
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>