<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2337px" preserveAspectRatio="none" style="width:1542px;height:2337px;" version="1.1" viewBox="0 0 1542 2337" width="1542px" zoomAndPan="magnify"><defs><filter height="300%" id="fozt7k3w1nreb" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="304" x="620" y="23.5352">2.1.2. Position Handler Consume (Success)</text><rect fill="#FFFFE0" height="2291.5332" style="stroke: #A80036; stroke-width: 1.0;" width="1419.5" x="29" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="688.25" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="113" y="196.2188"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="2124.2461" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="464.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="960.5" y="2144.2676"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="191.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="491.0137"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="1181.8457"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="1419.0195"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="1569.5723"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1190.5" y="999.293"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="520.3242"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="1028.6035"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="1211.1563"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="1448.3301"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="1598.8828"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="2110.2461" style="stroke: #000000; stroke-width: 2.0;" width="1518" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="2078.9355" style="stroke: #000000; stroke-width: 2.0;" width="1498" x="23" y="157.5977"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="90.9316" style="stroke: #000000; stroke-width: 2.0;" width="546" x="369.5" y="241.2188"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="526" x="379.5" y="265.5293"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="92.2422" style="stroke: #000000; stroke-width: 2.0;" width="356.5" x="203" y="346.1504"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="237.7949" style="stroke: #000000; stroke-width: 2.0;" width="1078.5" x="379.5" y="452.3926"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="242.4844" style="stroke: #000000; stroke-width: 2.0;" width="606.5" x="369.5" y="704.1875"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="156.5527" style="stroke: #000000; stroke-width: 2.0;" width="586.5" x="379.5" y="728.498"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1088.5" x="379.5" y="960.6719"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1102.5" x="379.5" y="1143.2246"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="398.7266" style="stroke: #000000; stroke-width: 2.0;" width="1131.5" x="379.5" y="1325.7773"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="1498" x="23" y="2182.2676"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="118" x2="118" y1="116.2871" y2="2260.5332"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="265" x2="265" y1="116.2871" y2="2260.5332"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="469.5" x2="469.5" y1="116.2871" y2="2260.5332"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="965.5" x2="965.5" y1="116.2871" y2="2260.5332"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1087.5" x2="1087.5" y1="116.2871" y2="2260.5332"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1195.5" x2="1195.5" y1="116.2871" y2="2260.5332"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1396.5" x2="1396.5" y1="116.2871" y2="2260.5332"/><rect fill="#FEFECE" filter="url(#fozt7k3w1nreb)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="37" y="76.7988"/><rect fill="#FEFECE" filter="url(#fozt7k3w1nreb)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="33" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="40" y="101.334">Position-Topic-dfsp2</text><rect fill="#FEFECE" filter="url(#fozt7k3w1nreb)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="37" y="2259.5332"/><rect fill="#FEFECE" filter="url(#fozt7k3w1nreb)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="33" y="2263.5332"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="40" y="2284.0684">Position-Topic-dfsp2</text><rect fill="#FEFECE" filter="url(#fozt7k3w1nreb)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="217" y="76.7988"/><rect fill="#FEFECE" filter="url(#fozt7k3w1nreb)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="213" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="220" y="101.334">Event-Topic</text><rect fill="#FEFECE" filter="url(#fozt7k3w1nreb)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="217" y="2259.5332"/><rect fill="#FEFECE" filter="url(#fozt7k3w1nreb)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="213" y="2263.5332"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="220" y="2284.0684">Event-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="389.5" y="113.334">Position Event Handler</text><ellipse cx="469.5" cy="83.7988" fill="#FEFECE" filter="url(#fozt7k3w1nreb)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="465.5,71.7988,471.5,66.7988,469.5,71.7988,471.5,76.7988,465.5,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="389.5" y="2273.0684">Position Event Handler</text><ellipse cx="469.5" cy="2292.0215" fill="#FEFECE" filter="url(#fozt7k3w1nreb)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="465.5,2280.0215,471.5,2275.0215,469.5,2280.0215,471.5,2285.0215,465.5,2280.0215" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fozt7k3w1nreb)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="906.5" y="76.7988"/><rect fill="#FEFECE" filter="url(#fozt7k3w1nreb)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="902.5" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="909.5" y="101.334">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#fozt7k3w1nreb)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="906.5" y="2259.5332"/><rect fill="#FEFECE" filter="url(#fozt7k3w1nreb)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="902.5" y="2263.5332"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="909.5" y="2284.0684">Transfer-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1038.5" y="113.334">Transfer DAO</text><ellipse cx="1088" cy="83.7988" fill="#FEFECE" filter="url(#fozt7k3w1nreb)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1076" x2="1100" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1038.5" y="2273.0684">Transfer DAO</text><ellipse cx="1088" cy="2292.0215" fill="#FEFECE" filter="url(#fozt7k3w1nreb)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1076" x2="1100" y1="2306.0215" y2="2306.0215"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1147.5" y="113.334">Position DAO</text><ellipse cx="1195.5" cy="83.7988" fill="#FEFECE" filter="url(#fozt7k3w1nreb)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1183.5" x2="1207.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1147.5" y="2273.0684">Position DAO</text><ellipse cx="1195.5" cy="2292.0215" fill="#FEFECE" filter="url(#fozt7k3w1nreb)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1183.5" x2="1207.5" y1="2306.0215" y2="2306.0215"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1348.5" y="113.334">Central Store</text><path d="M1378.5,63.7988 C1378.5,53.7988 1396.5,53.7988 1396.5,53.7988 C1396.5,53.7988 1414.5,53.7988 1414.5,63.7988 L1414.5,89.7988 C1414.5,99.7988 1396.5,99.7988 1396.5,99.7988 C1396.5,99.7988 1378.5,99.7988 1378.5,89.7988 L1378.5,63.7988 " fill="#FEFECE" filter="url(#fozt7k3w1nreb)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1378.5,63.7988 C1378.5,73.7988 1396.5,73.7988 1396.5,73.7988 C1396.5,73.7988 1414.5,73.7988 1414.5,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1348.5" y="2273.0684">Central Store</text><path d="M1378.5,2286.0215 C1378.5,2276.0215 1396.5,2276.0215 1396.5,2276.0215 C1396.5,2276.0215 1414.5,2276.0215 1414.5,2286.0215 L1414.5,2312.0215 C1414.5,2322.0215 1396.5,2322.0215 1396.5,2322.0215 C1396.5,2322.0215 1378.5,2322.0215 1378.5,2312.0215 L1378.5,2286.0215 " fill="#FEFECE" filter="url(#fozt7k3w1nreb)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1378.5,2286.0215 C1378.5,2296.0215 1396.5,2296.0215 1396.5,2296.0215 C1396.5,2296.0215 1414.5,2296.0215 1414.5,2286.0215 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="113" y="196.2188"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="2124.2461" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="464.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="960.5" y="2144.2676"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="191.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="491.0137"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="1181.8457"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="1419.0195"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="1569.5723"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1190.5" y="999.293"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="520.3242"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="1028.6035"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="1211.1563"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="1448.3301"/><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="1598.8828"/><path d="M13,133.2871 L291,133.2871 L291,140.2871 L281,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2110.2461" style="stroke: #000000; stroke-width: 2.0;" width="1518" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="233" x="28" y="146.8555">Position Handler Consume (Reject)</text><path d="M23,157.5977 L85,157.5977 L85,164.5977 L75,174.5977 L23,174.5977 L23,157.5977 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2078.9355" style="stroke: #000000; stroke-width: 2.0;" width="1498" x="23" y="157.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="171.166">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="149" x="100" y="170.2324">[Consume Single Message]</text><polygon fill="#A80036" points="134,192.2188,124,196.2188,134,200.2188,130,196.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="128" x2="463.5" y1="196.2188" y2="196.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="140" y="191.4766">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="153" y="191.4766">Consume Position event message for Payer</text><path d="M369.5,241.2188 L453.5,241.2188 L453.5,248.2188 L443.5,258.2188 L369.5,258.2188 L369.5,241.2188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="90.9316" style="stroke: #000000; stroke-width: 2.0;" width="546" x="369.5" y="241.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="384.5" y="254.7871">break</text><path d="M379.5,265.5293 L521.5,265.5293 L521.5,272.5293 L511.5,282.5293 L379.5,282.5293 L379.5,265.5293 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="526" x="379.5" y="265.5293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="394.5" y="279.0977">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="474.5" x2="516.5" y1="304.1504" y2="304.1504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="516.5" x2="516.5" y1="304.1504" y2="317.1504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="475.5" x2="516.5" y1="317.1504" y2="317.1504"/><polygon fill="#A80036" points="485.5,313.1504,475.5,317.1504,485.5,321.1504,481.5,317.1504" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="481.5" y="299.4082">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="399" x="494.5" y="299.4082">Validate event - Rule: type == 'position' &amp;&amp; action == 'commit'</text><path d="M203,346.1504 L418,346.1504 L418,353.1504 L408,363.1504 L203,363.1504 L203,346.1504 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="92.2422" style="stroke: #000000; stroke-width: 2.0;" width="356.5" x="203" y="346.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="218" y="359.7188">Persist Event Information</text><polygon fill="#A80036" points="276.5,380.7715,266.5,384.7715,276.5,388.7715,272.5,384.7715" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="270.5" x2="463.5" y1="384.7715" y2="384.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="282.5" y="380.0293">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="295.5" y="380.0293">Publish event information</text><rect fill="#FFFFFF" filter="url(#fozt7k3w1nreb)" height="40.6211" style="stroke: #000000; stroke-width: 2.0;" width="338.5" x="210" y="392.7715"/><polygon fill="#EEEEEE" points="210,392.7715,274,392.7715,274,399.7715,264,409.7715,210,409.7715,210,392.7715" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="223" y="407.3398">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="282.25" y="426.3398">Event Handler Consume {9.1.0.}</text><path d="M379.5,452.3926 L648.5,452.3926 L648.5,459.3926 L638.5,469.3926 L379.5,469.3926 L379.5,452.3926 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="237.7949" style="stroke: #000000; stroke-width: 2.0;" width="1078.5" x="379.5" y="452.3926"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224" x="394.5" y="465.9609">Retrieve Current Transfer Details</text><polygon fill="#A80036" points="1071,487.0137,1081,491.0137,1071,495.0137,1075,491.0137" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="474.5" x2="1077" y1="491.0137" y2="491.0137"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="481.5" y="486.2715">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="324" x="494.5" y="486.2715">Request to retrieve expirationDate &amp; transferStateId</text><polygon fill="#A80036" points="1379.5,516.3242,1389.5,520.3242,1379.5,524.3242,1383.5,520.3242" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1093" x2="1385.5" y1="520.3242" y2="520.3242"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1100" y="515.582">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="1113" y="515.582">Fetch from database</text><polygon fill="#A80036" points="1104,545.6348,1094,549.6348,1104,553.6348,1100,549.6348" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1098" x2="1395.5" y1="549.6348" y2="549.6348"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1110" y="544.8926">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1127" y="544.8926"/><polygon fill="#FFFFE0" filter="url(#fozt7k3w1nreb)" points="1354,562.6348,1438,562.6348,1448,581.6348,1438,600.6348,1354,600.6348,1344,581.6348,1354,562.6348" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1356" y="579.2031">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1356" y="594.5137">transferState</text><path d="M1110,611.2559 L1110,651.2559 L1387,651.2559 L1387,621.2559 L1377,611.2559 L1110,611.2559 " fill="#D3D3D3" filter="url(#fozt7k3w1nreb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1377,611.2559 L1377,621.2559 L1387,621.2559 L1377,611.2559 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="117" x="1116" y="628.8242">To be considered</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1233" y="628.8242">: Lock the DB record</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="1116" y="644.1348">to avoid processing by Timeout Handler.</text><polygon fill="#A80036" points="485.5,678.1875,475.5,682.1875,485.5,686.1875,481.5,682.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="479.5" x2="1087" y1="682.1875" y2="682.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="491.5" y="677.4453">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="384" x="504.5" y="677.4453">Return transfer.expirationDate &amp; transferState.transferStateId</text><path d="M369.5,704.1875 L453.5,704.1875 L453.5,711.1875 L443.5,721.1875 L369.5,721.1875 L369.5,704.1875 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="242.4844" style="stroke: #000000; stroke-width: 2.0;" width="606.5" x="369.5" y="704.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="384.5" y="717.7559">break</text><path d="M379.5,728.498 L541.5,728.498 L541.5,735.498 L531.5,745.498 L379.5,745.498 L379.5,728.498 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="156.5527" style="stroke: #000000; stroke-width: 2.0;" width="586.5" x="379.5" y="728.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="117" x="394.5" y="742.0664">Validate Transfer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="474.5" x2="516.5" y1="767.1191" y2="767.1191"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="516.5" x2="516.5" y1="767.1191" y2="780.1191"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="475.5" x2="516.5" y1="780.1191" y2="780.1191"/><polygon fill="#A80036" points="485.5,776.1191,475.5,780.1191,485.5,784.1191,481.5,780.1191" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="481.5" y="762.377">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="400" x="494.5" y="762.377">Validate transfer expiration - Rule: Date.now() &lt; expirationDate</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="474.5" x2="516.5" y1="809.4297" y2="809.4297"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="516.5" x2="516.5" y1="809.4297" y2="822.4297"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="475.5" x2="516.5" y1="822.4297" y2="822.4297"/><polygon fill="#A80036" points="485.5,818.4297,475.5,822.4297,485.5,826.4297,481.5,822.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="481.5" y="804.6875">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="494.5" y="804.6875">Validate transfer state - Rule:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="87" x="683.5" y="804.6875">transferState</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="770.5" y="804.6875">Id corresponds to 'RESERVED'</text><path d="M479,835.4297 L479,875.4297 L952,875.4297 L952,845.4297 L942,835.4297 L479,835.4297 " fill="#D3D3D3" filter="url(#fozt7k3w1nreb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M942,835.4297 L942,845.4297 L952,845.4297 L942,835.4297 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="65" x="485" y="852.998">Condition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="550" y="852.998">: Continue only if both equal to true, break otherwise</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="31" x="485" y="868.3086">Note</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="421" x="516" y="868.3086">: All timestamps should be transformed and stored as UTC (GMT 0)</text><path d="M479,897.0508 L479,937.0508 L900,937.0508 L900,907.0508 L890,897.0508 L479,897.0508 " fill="#D3D3D3" filter="url(#fozt7k3w1nreb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M890,897.0508 L890,907.0508 L900,907.0508 L890,897.0508 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="31" x="485" y="914.6191">Note</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="369" x="516" y="914.6191">: Notifications in break case scenario are being handled by</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="485" y="929.9297">Transfer Timeout Handler.</text><path d="M379.5,960.6719 L654.5,960.6719 L654.5,967.6719 L644.5,977.6719 L379.5,977.6719 L379.5,960.6719 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1088.5" x="379.5" y="960.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="230" x="394.5" y="974.2402">Decrement Payee Position (DFSP2)</text><polygon fill="#A80036" points="1178.5,995.293,1188.5,999.293,1178.5,1003.293,1182.5,999.293" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="474.5" x2="1184.5" y1="999.293" y2="999.293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="481.5" y="994.5508">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="293" x="503.5" y="994.5508">Request to decrement latest position for Payee</text><polygon fill="#A80036" points="1379.5,1024.6035,1389.5,1028.6035,1379.5,1032.6035,1383.5,1028.6035" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1200.5" x2="1385.5" y1="1028.6035" y2="1028.6035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1207.5" y="1023.8613">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="1229.5" y="1023.8613">Persist decrement to DB</text><polygon fill="#FFFFE0" filter="url(#fozt7k3w1nreb)" points="1344,1071.6035,1448,1071.6035,1458,1082.6035,1448,1094.6035,1344,1094.6035,1334,1082.6035,1344,1071.6035" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1346" y="1088.1719">transferPosition</text><polygon fill="#A80036" points="485.5,1117.2246,475.5,1121.2246,485.5,1125.2246,481.5,1121.2246" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="479.5" x2="1194.5" y1="1121.2246" y2="1121.2246"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="491.5" y="1116.4824">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="513.5" y="1116.4824">Return success</text><path d="M379.5,1143.2246 L802.5,1143.2246 L802.5,1150.2246 L792.5,1160.2246 L379.5,1160.2246 L379.5,1143.2246 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1102.5" x="379.5" y="1143.2246"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="378" x="394.5" y="1156.793">Persist Transfer State (with transferState='COMMITTED')</text><polygon fill="#A80036" points="1071,1177.8457,1081,1181.8457,1071,1185.8457,1075,1181.8457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="474.5" x2="1077" y1="1181.8457" y2="1181.8457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="481.5" y="1177.1035">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="503.5" y="1177.1035">Request to persist transfer state</text><polygon fill="#A80036" points="1379.5,1207.1563,1389.5,1211.1563,1379.5,1215.1563,1383.5,1211.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1093" x2="1385.5" y1="1211.1563" y2="1211.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1100" y="1206.4141">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1122" y="1206.4141">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#fozt7k3w1nreb)" points="1331,1254.1563,1462,1254.1563,1472,1265.1563,1462,1277.1563,1331,1277.1563,1321,1265.1563,1331,1254.1563" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1333" y="1270.7246">transferStateChange</text><polygon fill="#A80036" points="485.5,1299.7773,475.5,1303.7773,485.5,1307.7773,481.5,1303.7773" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="479.5" x2="1087" y1="1303.7773" y2="1303.7773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="491.5" y="1299.0352">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="513.5" y="1299.0352">Return success</text><path d="M379.5,1325.7773 L595.5,1325.7773 L595.5,1332.7773 L585.5,1342.7773 L379.5,1342.7773 L379.5,1325.7773 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="398.7266" style="stroke: #000000; stroke-width: 2.0;" width="1131.5" x="379.5" y="1325.7773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="171" x="394.5" y="1339.3457">Append Settlement Batch</text><path d="M479,1348.0879 L479,1388.0879 L868,1388.0879 L868,1358.0879 L858,1348.0879 L479,1348.0879 " fill="#D3D3D3" filter="url(#fozt7k3w1nreb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M858,1348.0879 L858,1358.0879 L868,1358.0879 L858,1348.0879 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="117" x="485" y="1365.6563">To be considered</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="602" y="1365.6563">: Retrieve current settlement batch from</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="348" x="485" y="1380.9668">Position-Topic (message 1) instead of querying the DB.</text><polygon fill="#A80036" points="1071,1415.0195,1081,1419.0195,1071,1423.0195,1075,1419.0195" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="474.5" x2="1077" y1="1419.0195" y2="1419.0195"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="481.5" y="1414.2773">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="372" x="503.5" y="1414.2773">Request to retrieve current/latest transfer settlement batch</text><polygon fill="#A80036" points="1379.5,1444.3301,1389.5,1448.3301,1379.5,1452.3301,1383.5,1448.3301" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1093" x2="1385.5" y1="1448.3301" y2="1448.3301"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1100" y="1443.5879">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="200" x="1122" y="1443.5879">Fetch transferSettlementBatchId</text><polygon fill="#A80036" points="1104,1473.6406,1094,1477.6406,1104,1481.6406,1100,1477.6406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1098" x2="1395.5" y1="1477.6406" y2="1477.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1110" y="1472.8984">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1136" y="1472.8984"/><polygon fill="#FFFFE0" filter="url(#fozt7k3w1nreb)" points="1319,1490.6406,1473,1490.6406,1483,1501.6406,1473,1513.6406,1319,1513.6406,1309,1501.6406,1319,1490.6406" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="1321" y="1507.209">transferSettlementBatch</text><polygon fill="#A80036" points="485.5,1536.2617,475.5,1540.2617,485.5,1544.2617,481.5,1540.2617" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="479.5" x2="1087" y1="1540.2617" y2="1540.2617"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="491.5" y="1535.5195">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="513.5" y="1535.5195">Return transferSettlementBatchId to be appended</text><polygon fill="#A80036" points="1071,1565.5723,1081,1569.5723,1071,1573.5723,1075,1569.5723" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="474.5" x2="1077" y1="1569.5723" y2="1569.5723"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="481.5" y="1564.8301">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="465" x="503.5" y="1564.8301">Request to append the transfer to current/latest transfer settlement batch</text><polygon fill="#A80036" points="1379.5,1594.8828,1389.5,1598.8828,1379.5,1602.8828,1383.5,1598.8828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1093" x2="1385.5" y1="1598.8828" y2="1598.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1100" y="1594.1406">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="1122" y="1594.1406">Append transfer</text><polygon fill="#FFFFE0" filter="url(#fozt7k3w1nreb)" points="1302,1641.8828,1491,1641.8828,1501,1652.8828,1491,1664.8828,1302,1664.8828,1292,1652.8828,1302,1641.8828" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="1304" y="1658.4512">transferSettlementBatchIndex</text><polygon fill="#A80036" points="485.5,1687.5039,475.5,1691.5039,485.5,1695.5039,481.5,1691.5039" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="479.5" x2="1087" y1="1691.5039" y2="1691.5039"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="491.5" y="1686.7617">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="513.5" y="1686.7617">Return success</text><path d="M479,1736.5039 L479,2113.5039 L788,2113.5039 L788,1746.5039 L778,1736.5039 L479,1736.5039 " fill="#FFFF00" filter="url(#fozt7k3w1nreb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M778,1736.5039 L778,1746.5039 L788,1746.5039 L778,1736.5039 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="485" y="1754.0723">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="485" y="1769.3828">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="501" y="1784.6934">id: &lt;ID&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="501" y="1800.0039">from: &lt;transferHeaders.FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="501" y="1815.3145">to: &lt;transferHeaders.FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="501" y="1830.625">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="501" y="1845.9355">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="517" y="1861.2461">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="517" y="1876.5566">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="501" y="1891.8672">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="501" y="1907.1777">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="517" y="1922.4883">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="533" y="1937.7988">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="533" y="1953.1094">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="533" y="1968.4199">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="533" y="1983.7305">action: commit,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="533" y="1999.041">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="533" y="2014.3516">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="549" y="2029.6621">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="549" y="2044.9727">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="533" y="2060.2832">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="517" y="2075.5938">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="501" y="2090.9043">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="485" y="2106.2148">}</text><polygon fill="#A80036" points="948.5,2140.2676,958.5,2144.2676,948.5,2148.2676,952.5,2144.2676" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="474.5" x2="954.5" y1="2144.2676" y2="2144.2676"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="481.5" y="2139.5254">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="503.5" y="2139.5254">Publish Transfer event</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1521" y1="2183.2676" y2="2183.2676"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="151" x="28" y="2193.9023">[Consume Batch Messages]</text><path d="M241,2202.2227 L241,2227.2227 L455,2227.2227 L455,2212.2227 L445,2202.2227 L241,2202.2227 " fill="#ADD8E6" filter="url(#fozt7k3w1nreb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M445,2202.2227 L445,2212.2227 L455,2212.2227 L445,2202.2227 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="247" y="2219.791">To be delivered by future story</text><!--
@startuml
title 2.1.2. Position Handler Consume (Success)

autonumber


collections "Position-Topic-dfsp2" as TOPIC_POSITION_DFSP2
control "Position Event Handler" as POS_HANDLER
collections "Transfer-Topic" as TOPIC_TRANSFERS
collections "Event-Topic" as TOPIC_EVENT
entity "Transfer DAO" as TRANS_DAO
entity "Position DAO" as POS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_POSITION_DFSP2
    participant TOPIC_EVENT
    participant POS_HANDLER
    participant TOPIC_TRANSFERS
    participant TRANS_DAO
    participant POS_DAO
    participant DB
end box

activate POS_HANDLER
group Position Handler Consume (Reject)
    alt Consume Single Message
        TOPIC_POSITION_DFSP2 <- POS_HANDLER: Consume Position event message for Payer
        activate TOPIC_POSITION_DFSP2
        deactivate TOPIC_POSITION_DFSP2

        break
            group Validate Event
                POS_HANDLER <-> POS_HANDLER: Validate event - Rule: type == 'position' && action == 'commit'
            end
        end

        group Persist Event Information
            POS_HANDLER -> TOPIC_EVENT: Publish event information
	        ref over POS_HANDLER, TOPIC_EVENT :  Event Handler Consume {9.1.0.} 
        end

        group Retrieve Current Transfer Details
            POS_HANDLER -> TRANS_DAO: Request to retrieve expirationDate & transferStateId
            activate TRANS_DAO
            TRANS_DAO -> DB: Fetch from database
            activate DB
            DB - -> TRANS_DAO
            deactivate DB
            hnote over DB #lightyellow
                transfer
                transferState
            end note
            note left of DB #lightgray
                **To be considered**: Lock the DB record
                to avoid processing by Timeout Handler.
            end note
            POS_HANDLER <- - TRANS_DAO: Return transfer.expirationDate & transferState.transferStateId
            deactivate TRANS_DAO
        end

        break
            group Validate Transfer
                POS_HANDLER <-> POS_HANDLER: Validate transfer expiration - Rule: Date.now() < expirationDate
                POS_HANDLER <-> POS_HANDLER: Validate transfer state - Rule: **transferState**Id corresponds to 'RESERVED'
                note right of POS_HANDLER #lightgray
                    **Condition**: Continue only if both equal to true, break otherwise
                    **Note**: All timestamps should be transformed and stored as UTC (GMT 0)
                end note
            end
            note right of POS_HANDLER #lightgray
                **Note**: Notifications in break case scenario are being handled by
                Transfer Timeout Handler.
            end note
        end

        group Decrement Payee Position (DFSP2)
            POS_HANDLER -> POS_DAO: Request to decrement latest position for Payee
            activate POS_DAO
            POS_DAO -> DB: Persist decrement to DB
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                transferPosition
            end note
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end

        group Persist Transfer State (with transferState='COMMITTED')
            POS_HANDLER -> TRANS_DAO: Request to persist transfer state
            activate TRANS_DAO
            TRANS_DAO -> DB: Persist transfer state
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                transferStateChange
            end note
            TRANS_DAO - -> POS_HANDLER: Return success
            deactivate TRANS_DAO
        end

        group Append Settlement Batch
            note right of POS_HANDLER #lightgray
                <color #FF0000>**To be considered**: Retrieve current settlement batch from</color>
                <color #FF0000>Position-Topic (message 1) instead of querying the DB.</color>
            end note
            POS_HANDLER -> TRANS_DAO: Request to retrieve current/latest transfer settlement batch
            activate TRANS_DAO
            TRANS_DAO -> DB: Fetch transferSettlementBatchId
            activate DB
            DB - -> TRANS_DAO
            deactivate DB
            hnote over DB #lightyellow
                transferSettlementBatch
            end note
            POS_HANDLER <- - TRANS_DAO: Return transferSettlementBatchId to be appended
            deactivate TRANS_DAO

            POS_HANDLER -> TRANS_DAO: Request to append the transfer to current/latest transfer settlement batch
            activate TRANS_DAO
            TRANS_DAO -> DB: Append transfer
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                transferSettlementBatchIndex
            end note
            POS_HANDLER <- - TRANS_DAO: Return success
            deactivate TRANS_DAO
            |||
        end

        note right of POS_HANDLER #yellow
            Message:
            {
                id: <ID>,
                from: <transferHeaders.FSPIOP-Source>,
                to: <transferHeaders.FSPIOP-Destination>,
                type: application/json,
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: commit,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_TRANSFERS: Publish Transfer event
        activate TOPIC_TRANSFERS
        deactivate TOPIC_TRANSFERS

    else Consume Batch Messages
        note left of POS_HANDLER #lightblue
            To be delivered by future story
        end note
    end
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.4
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>