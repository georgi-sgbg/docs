<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2934px" preserveAspectRatio="none" style="width:1988px;height:2934px;" version="1.1" viewBox="0 0 1988 2934" width="1988px" zoomAndPan="magnify"><defs><filter height="300%" id="f66do362h4f6i" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="372" x="809" y="23.5352">1.1.2.a. Position Handler Consume (single message)</text><rect fill="#FFFFE0" height="2889.4707" style="stroke: #A80036; stroke-width: 1.0;" width="1905" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="921" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="103" y="171.9082"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="2700.1836" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="415" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1032" y="1584.6777"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293.5" y="2796.4707"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425" y="451.3926"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425" y="852.4297"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425" y="1683.2539"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1540" y="601.9453"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1540" y="1833.8066"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1656.5" y="1034.9824"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1656.5" y="2154.9121"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="480.7031"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="631.2559"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="881.7402"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="1064.293"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="1712.5645"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="1863.1172"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="2184.2227"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="2708.1836" style="stroke: #000000; stroke-width: 2.0;" width="1964" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="895" x="330" y="216.9082"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="2446.0098" style="stroke: #000000; stroke-width: 2.0;" width="1647" x="320" y="388.4609"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="569.5898" style="stroke: #000000; stroke-width: 2.0;" width="1614" x="330" y="412.7715"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1627" x="330" y="996.3613"/><rect fill="#FFFFFF" height="1211.793" style="stroke: none; stroke-width: 1.0;" width="1647" x="320" y="1622.6777"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="457.6582" style="stroke: #000000; stroke-width: 2.0;" width="1614" x="330" y="1644.6328"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1627" x="330" y="2116.291"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="108" x2="108" y1="116.2871" y2="2858.4707"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="420" x2="420" y1="116.2871" y2="2858.4707"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1037" x2="1037" y1="116.2871" y2="2858.4707"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1162" x2="1162" y1="116.2871" y2="2858.4707"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1298" x2="1298" y1="116.2871" y2="2858.4707"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1430" x2="1430" y1="116.2871" y2="2858.4707"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1545" x2="1545" y1="116.2871" y2="2858.4707"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1661" x2="1661" y1="116.2871" y2="2858.4707"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1872" x2="1872" y1="116.2871" y2="2858.4707"/><rect fill="#FEFECE" filter="url(#f66do362h4f6i)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="27" y="76.7988"/><rect fill="#FEFECE" filter="url(#f66do362h4f6i)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="23" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="30" y="101.334">Position-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#f66do362h4f6i)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="27" y="2857.4707"/><rect fill="#FEFECE" filter="url(#f66do362h4f6i)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="23" y="2861.4707"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="30" y="2882.0059">Position-Topic-dfsp1</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="340" y="113.334">Position Event Handler</text><ellipse cx="420" cy="83.7988" fill="#FEFECE" filter="url(#f66do362h4f6i)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="416,71.7988,422,66.7988,420,71.7988,422,76.7988,416,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="340" y="2871.0059">Position Event Handler</text><ellipse cx="420" cy="2889.959" fill="#FEFECE" filter="url(#f66do362h4f6i)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="416,2877.959,422,2872.959,420,2877.959,422,2882.959,416,2877.959" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f66do362h4f6i)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="978" y="76.7988"/><rect fill="#FEFECE" filter="url(#f66do362h4f6i)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="974" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="981" y="101.334">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f66do362h4f6i)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="978" y="2857.4707"/><rect fill="#FEFECE" filter="url(#f66do362h4f6i)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="974" y="2861.4707"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="981" y="2882.0059">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f66do362h4f6i)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1114" y="76.7988"/><rect fill="#FEFECE" filter="url(#f66do362h4f6i)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1110" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1117" y="101.334">Event-Topic</text><rect fill="#FEFECE" filter="url(#f66do362h4f6i)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1114" y="2857.4707"/><rect fill="#FEFECE" filter="url(#f66do362h4f6i)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1110" y="2861.4707"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1117" y="2882.0059">Event-Topic</text><rect fill="#FEFECE" filter="url(#f66do362h4f6i)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1229" y="76.7988"/><rect fill="#FEFECE" filter="url(#f66do362h4f6i)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1225" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1232" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f66do362h4f6i)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1229" y="2857.4707"/><rect fill="#FEFECE" filter="url(#f66do362h4f6i)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1225" y="2861.4707"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1232" y="2882.0059">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1382" y="113.334">Position DAO</text><ellipse cx="1430" cy="83.7988" fill="#FEFECE" filter="url(#f66do362h4f6i)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1418" x2="1442" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1382" y="2871.0059">Position DAO</text><ellipse cx="1430" cy="2889.959" fill="#FEFECE" filter="url(#f66do362h4f6i)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1418" x2="1442" y1="2903.959" y2="2903.959"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1488" y="113.334">Participant DAO</text><ellipse cx="1545" cy="83.7988" fill="#FEFECE" filter="url(#f66do362h4f6i)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1533" x2="1557" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1488" y="2871.0059">Participant DAO</text><ellipse cx="1545" cy="2889.959" fill="#FEFECE" filter="url(#f66do362h4f6i)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1533" x2="1557" y1="2903.959" y2="2903.959"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1612" y="113.334">Transfer DAO</text><ellipse cx="1661.5" cy="83.7988" fill="#FEFECE" filter="url(#f66do362h4f6i)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1649.5" x2="1673.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1612" y="2871.0059">Transfer DAO</text><ellipse cx="1661.5" cy="2889.959" fill="#FEFECE" filter="url(#f66do362h4f6i)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1649.5" x2="1673.5" y1="2903.959" y2="2903.959"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1824" y="113.334">Central Store</text><path d="M1854,63.7988 C1854,53.7988 1872,53.7988 1872,53.7988 C1872,53.7988 1890,53.7988 1890,63.7988 L1890,89.7988 C1890,99.7988 1872,99.7988 1872,99.7988 C1872,99.7988 1854,99.7988 1854,89.7988 L1854,63.7988 " fill="#FEFECE" filter="url(#f66do362h4f6i)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1854,63.7988 C1854,73.7988 1872,73.7988 1872,73.7988 C1872,73.7988 1890,73.7988 1890,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1824" y="2871.0059">Central Store</text><path d="M1854,2883.959 C1854,2873.959 1872,2873.959 1872,2873.959 C1872,2873.959 1890,2873.959 1890,2883.959 L1890,2909.959 C1890,2919.959 1872,2919.959 1872,2919.959 C1872,2919.959 1854,2919.959 1854,2909.959 L1854,2883.959 " fill="#FEFECE" filter="url(#f66do362h4f6i)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1854,2883.959 C1854,2893.959 1872,2893.959 1872,2893.959 C1872,2893.959 1890,2893.959 1890,2883.959 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="103" y="171.9082"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="2700.1836" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="415" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1032" y="1584.6777"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293.5" y="2796.4707"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425" y="451.3926"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425" y="852.4297"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425" y="1683.2539"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1540" y="601.9453"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1540" y="1833.8066"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1656.5" y="1034.9824"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1656.5" y="2154.9121"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="480.7031"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="631.2559"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="881.7402"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="1064.293"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="1712.5645"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="1863.1172"/><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="2184.2227"/><path d="M13,133.2871 L236,133.2871 L236,140.2871 L226,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2708.1836" style="stroke: #000000; stroke-width: 2.0;" width="1964" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="28" y="146.8555">Position Handler Consume</text><polygon fill="#A80036" points="124,167.9082,114,171.9082,124,175.9082,120,171.9082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="118" x2="414" y1="171.9082" y2="171.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="130" y="167.166">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="143" y="167.166">Consume Position event message for Payer</text><path d="M330,216.9082 L545,216.9082 L545,223.9082 L535,233.9082 L330,233.9082 L330,216.9082 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="895" x="330" y="216.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="345" y="230.4766">Persist Event Information</text><polygon fill="#A80036" points="1150.5,276.5293,1160.5,280.5293,1150.5,284.5293,1154.5,280.5293" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1156.5" y1="280.5293" y2="280.5293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="432" y="275.7871">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="445" y="275.7871">Publish event information</text><rect fill="#FFFFFF" filter="url(#f66do362h4f6i)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="877" x="337" y="288.5293"/><polygon fill="#EEEEEE" points="337,288.5293,401,288.5293,401,295.5293,391,305.5293,337,305.5293,337,288.5293" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="350" y="303.0977">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="676.5" y="322.0977">Event Handler Consume {9.1.0.}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="680.5" y="337.4082"/><path d="M320,388.4609 L382,388.4609 L382,395.4609 L372,405.4609 L320,405.4609 L320,388.4609 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2446.0098" style="stroke: #000000; stroke-width: 2.0;" width="1647" x="320" y="388.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="335" y="402.0293">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="255" x="397" y="401.0957">[Calulate &amp; Validate Latest Position (success)]</text><path d="M330,412.7715 L629,412.7715 L629,419.7715 L619,429.7715 L330,429.7715 L330,412.7715 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="569.5898" style="stroke: #000000; stroke-width: 2.0;" width="1614" x="330" y="412.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="254" x="345" y="426.3398">Calculate position and persist change</text><polygon fill="#A80036" points="1413,447.3926,1423,451.3926,1413,455.3926,1417,451.3926" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1419" y1="451.3926" y2="451.3926"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="432" y="446.6504">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="445" y="446.6504">Request latest position from DB for Payer</text><polygon fill="#A80036" points="1855,476.7031,1865,480.7031,1855,484.7031,1859,480.7031" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1435" x2="1861" y1="480.7031" y2="480.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1442" y="475.9609">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1455" y="475.9609">Retrieve latest position from DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f66do362h4f6i)" points="1820,493.7031,1924,493.7031,1934,504.7031,1924,516.7031,1820,516.7031,1810,504.7031,1820,493.7031" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1822" y="510.2715">transferPosition</text><polygon fill="#A80036" points="1446,539.3242,1436,543.3242,1446,547.3242,1442,543.3242" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1440" x2="1871" y1="543.3242" y2="543.3242"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1452" y="538.582">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1465" y="538.582">Retrieve latest position from DB for Payer</text><polygon fill="#A80036" points="436,568.6348,426,572.6348,436,576.6348,432,572.6348" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1429" y1="572.6348" y2="572.6348"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="442" y="567.8926">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="455" y="567.8926">Return latest position</text><polygon fill="#A80036" points="1528,597.9453,1538,601.9453,1528,605.9453,1532,601.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1534" y1="601.9453" y2="601.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="432" y="597.2031">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="445" y="597.2031">Request position limits for Payer Participant</text><polygon fill="#A80036" points="1855,627.2559,1865,631.2559,1855,635.2559,1859,631.2559" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1550" x2="1861" y1="631.2559" y2="631.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1557" y="626.5137">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="1570" y="626.5137">Request position limits for Payer Participant</text><polygon fill="#FFFFE0" filter="url(#f66do362h4f6i)" points="1820,644.2559,1924,644.2559,1934,663.2559,1924,682.2559,1820,682.2559,1810,663.2559,1820,644.2559" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1822" y="660.8242">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1822" y="676.1348">participantLimit</text><polygon fill="#A80036" points="1561,705.1875,1551,709.1875,1561,713.1875,1557,709.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1555" x2="1871" y1="709.1875" y2="709.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1567" y="704.4453">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="1580" y="704.4453">Return position limits</text><polygon fill="#A80036" points="436,734.498,426,738.498,436,742.498,432,738.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1544" y1="738.498" y2="738.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="442" y="733.7559">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="464" y="733.7559">Return position limits</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="467" y1="767.8086" y2="767.8086"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="467" x2="467" y1="767.8086" y2="780.8086"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="426" x2="467" y1="780.8086" y2="780.8086"/><polygon fill="#A80036" points="436,776.8086,426,780.8086,436,784.8086,432,780.8086" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="763.0664">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="454" y="763.0664">Calculate latest position (lpos) for prepare</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="467" y1="810.1191" y2="810.1191"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="467" x2="467" y1="810.1191" y2="823.1191"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="426" x2="467" y1="823.1191" y2="823.1191"/><polygon fill="#A80036" points="436,819.1191,426,823.1191,436,827.1191,432,823.1191" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="805.377">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="571" x="454" y="805.377">Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos &lt; netcap</text><polygon fill="#A80036" points="1413,848.4297,1423,852.4297,1413,856.4297,1417,852.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1419" y1="852.4297" y2="852.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="847.6875">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="454" y="847.6875">Request to persist latest position for Payer</text><polygon fill="#A80036" points="1855,877.7402,1865,881.7402,1855,885.7402,1859,881.7402" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1435" x2="1861" y1="881.7402" y2="881.7402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1442" y="876.998">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="1464" y="876.998">Persist latest position to DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f66do362h4f6i)" points="1820,924.7402,1924,924.7402,1934,935.7402,1924,947.7402,1820,947.7402,1810,935.7402,1820,924.7402" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1822" y="941.3086">transferPosition</text><polygon fill="#A80036" points="436,970.3613,426,974.3613,436,978.3613,432,974.3613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1429" y1="974.3613" y2="974.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="442" y="969.6191">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="464" y="969.6191">Return success</text><path d="M330,996.3613 L894,996.3613 L894,1003.3613 L884,1013.3613 L330,1013.3613 L330,996.3613 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1627" x="330" y="996.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="519" x="345" y="1009.9297">Persist Transfer State (with transferState='RESERVED' on position check pass)</text><polygon fill="#A80036" points="1644.5,1030.9824,1654.5,1034.9824,1644.5,1038.9824,1648.5,1034.9824" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1650.5" y1="1034.9824" y2="1034.9824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="1030.2402">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="454" y="1030.2402">Request to persist transfer</text><polygon fill="#A80036" points="1855,1060.293,1865,1064.293,1855,1068.293,1859,1064.293" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1666.5" x2="1861" y1="1064.293" y2="1064.293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1673.5" y="1059.5508">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1695.5" y="1059.5508">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#f66do362h4f6i)" points="1806,1107.293,1937,1107.293,1947,1118.293,1937,1130.293,1806,1130.293,1796,1118.293,1806,1107.293" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1808" y="1123.8613">transferStateChange</text><polygon fill="#A80036" points="436,1152.9141,426,1156.9141,436,1160.9141,432,1156.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1660.5" y1="1156.9141" y2="1156.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="442" y="1152.1719">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="464" y="1152.1719">Return success</text><path d="M430,1176.9141 L430,1553.9141 L692,1553.9141 L692,1186.9141 L682,1176.9141 L430,1176.9141 " fill="#FFFF00" filter="url(#f66do362h4f6i)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M682,1176.9141 L682,1186.9141 L692,1186.9141 L682,1176.9141 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="436" y="1194.4824">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="436" y="1209.793">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="452" y="1225.1035">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="452" y="1240.4141">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="452" y="1255.7246">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="452" y="1271.0352">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="452" y="1286.3457">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="468" y="1301.6563">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="468" y="1316.9668">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="452" y="1332.2773">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="452" y="1347.5879">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="468" y="1362.8984">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="484" y="1378.209">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="484" y="1393.5195">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="484" y="1408.8301">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="484" y="1424.1406">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="484" y="1439.4512">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="484" y="1454.7617">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="500" y="1470.0723">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="500" y="1485.3828">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="484" y="1500.6934">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="468" y="1516.0039">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="452" y="1531.3145">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="436" y="1546.625">}</text><polygon fill="#A80036" points="1020,1580.6777,1030,1584.6777,1020,1588.6777,1024,1584.6777" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1026" y1="1584.6777" y2="1584.6777"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="1579.9355">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="454" y="1579.9355">Publish Transfer event</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="320" x2="1967" y1="1623.6777" y2="1623.6777"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="255" x="325" y="1634.3125">[Calculate &amp; Validate Latest Position (failure)]</text><path d="M330,1644.6328 L629,1644.6328 L629,1651.6328 L619,1661.6328 L330,1661.6328 L330,1644.6328 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="457.6582" style="stroke: #000000; stroke-width: 2.0;" width="1614" x="330" y="1644.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="254" x="345" y="1658.2012">Calculate position and persist change</text><polygon fill="#A80036" points="1413,1679.2539,1423,1683.2539,1413,1687.2539,1417,1683.2539" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1419" y1="1683.2539" y2="1683.2539"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="1678.5117">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="454" y="1678.5117">Request latest position from DB for Payer</text><polygon fill="#A80036" points="1855,1708.5645,1865,1712.5645,1855,1716.5645,1859,1712.5645" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1435" x2="1861" y1="1712.5645" y2="1712.5645"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1442" y="1707.8223">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1464" y="1707.8223">Retrieve latest position from DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f66do362h4f6i)" points="1820,1725.5645,1924,1725.5645,1934,1736.5645,1924,1748.5645,1820,1748.5645,1810,1736.5645,1820,1725.5645" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1822" y="1742.1328">transferPosition</text><polygon fill="#A80036" points="1446,1771.1855,1436,1775.1855,1446,1779.1855,1442,1775.1855" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1440" x2="1871" y1="1775.1855" y2="1775.1855"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1452" y="1770.4434">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1474" y="1770.4434">Retrieve latest position from DB for Payer</text><polygon fill="#A80036" points="436,1800.4961,426,1804.4961,436,1808.4961,432,1804.4961" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1429" y1="1804.4961" y2="1804.4961"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="442" y="1799.7539">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="464" y="1799.7539">Return latest position</text><polygon fill="#A80036" points="1528,1829.8066,1538,1833.8066,1528,1837.8066,1532,1833.8066" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1534" y1="1833.8066" y2="1833.8066"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="1829.0645">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="454" y="1829.0645">Request position limits for Payer Participant</text><polygon fill="#A80036" points="1855,1859.1172,1865,1863.1172,1855,1867.1172,1859,1863.1172" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1550" x2="1861" y1="1863.1172" y2="1863.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1557" y="1858.375">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="1579" y="1858.375">Request position limits for Payer Participant</text><polygon fill="#FFFFE0" filter="url(#f66do362h4f6i)" points="1820,1876.1172,1924,1876.1172,1934,1895.1172,1924,1914.1172,1820,1914.1172,1810,1895.1172,1820,1876.1172" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1822" y="1892.6855">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1822" y="1907.9961">participantLimit</text><polygon fill="#A80036" points="1561,1937.0488,1551,1941.0488,1561,1945.0488,1557,1941.0488" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1555" x2="1871" y1="1941.0488" y2="1941.0488"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1567" y="1936.3066">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="1589" y="1936.3066">Return position limits</text><polygon fill="#A80036" points="436,1966.3594,426,1970.3594,436,1974.3594,432,1970.3594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1544" y1="1970.3594" y2="1970.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="442" y="1965.6172">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="464" y="1965.6172">Return position limits</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="467" y1="1999.6699" y2="1999.6699"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="467" x2="467" y1="1999.6699" y2="2012.6699"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="426" x2="467" y1="2012.6699" y2="2012.6699"/><polygon fill="#A80036" points="436,2008.6699,426,2012.6699,436,2016.6699,432,2012.6699" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="1994.9277">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="454" y="1994.9277">Calculate latest position (lpos) for prepare</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="467" y1="2041.9805" y2="2041.9805"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="467" x2="467" y1="2041.9805" y2="2054.9805"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="426" x2="467" y1="2054.9805" y2="2054.9805"/><polygon fill="#A80036" points="436,2050.9805,426,2054.9805,436,2058.9805,432,2054.9805" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="2037.2383">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="571" x="454" y="2037.2383">Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos &lt; netcap</text><path d="M430,2067.9805 L430,2092.9805 L562,2092.9805 L562,2077.9805 L552,2067.9805 L430,2067.9805 " fill="#FF0000" filter="url(#f66do362h4f6i)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M552,2067.9805 L552,2077.9805 L562,2077.9805 L552,2067.9805 " fill="#FF0000" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="436" y="2085.5488">Validation failure!</text><path d="M330,2116.291 L891,2116.291 L891,2123.291 L881,2133.291 L330,2133.291 L330,2116.291 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1627" x="330" y="2116.291"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="516" x="345" y="2129.8594">Persist Transfer State (with transferState='ABORTED' on position check pass)</text><polygon fill="#A80036" points="1644.5,2150.9121,1654.5,2154.9121,1644.5,2158.9121,1648.5,2154.9121" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1650.5" y1="2154.9121" y2="2154.9121"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="2150.1699">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="454" y="2150.1699">Request to persist transfer</text><polygon fill="#A80036" points="1855,2180.2227,1865,2184.2227,1855,2188.2227,1859,2184.2227" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1666.5" x2="1861" y1="2184.2227" y2="2184.2227"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1673.5" y="2179.4805">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1695.5" y="2179.4805">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#f66do362h4f6i)" points="1806,2227.2227,1937,2227.2227,1947,2238.2227,1937,2250.2227,1806,2250.2227,1796,2238.2227,1806,2227.2227" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1808" y="2243.791">transferStateChange</text><polygon fill="#A80036" points="436,2272.8438,426,2276.8438,436,2280.8438,432,2276.8438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1660.5" y1="2276.8438" y2="2276.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="442" y="2272.1016">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="464" y="2272.1016">Return success</text><path d="M430,2296.8438 L430,2765.8438 L840,2765.8438 L840,2306.8438 L830,2296.8438 L430,2296.8438 " fill="#FFFF00" filter="url(#f66do362h4f6i)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M830,2296.8438 L830,2306.8438 L840,2306.8438 L830,2296.8438 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="436" y="2314.4121">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="436" y="2329.7227">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="452" y="2345.0332">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="452" y="2360.3438">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="452" y="2375.6543">to: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="452" y="2390.9648">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="452" y="2406.2754">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="468" y="2421.5859">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="468" y="2436.8965">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="484" y="2452.207">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="500" y="2467.5176">"errorCode": 4001,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="325" x="500" y="2482.8281">"errorDescription": "Payer FSP insufficient liquidity",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="500" y="2498.1387">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="468" y="2513.4492">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="452" y="2528.7598">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="452" y="2544.0703">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="468" y="2559.3809">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="484" y="2574.6914">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="484" y="2590.002">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="484" y="2605.3125">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="484" y="2620.623">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="484" y="2635.9336">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="484" y="2651.2441">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="500" y="2666.5547">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="500" y="2681.8652">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="500" y="2697.1758">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="484" y="2712.4863">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="468" y="2727.7969">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="452" y="2743.1074">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="436" y="2758.418">}</text><polygon fill="#A80036" points="1281.5,2792.4707,1291.5,2796.4707,1281.5,2800.4707,1285.5,2796.4707" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1287.5" y1="2796.4707" y2="2796.4707"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="2791.7285">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="454" y="2791.7285">Publish Notification (failure) event for Payer</text><!--
@startuml
title 1.1.2.a. Position Handler Consume (single message)

autonumber


collections "Position-Topic-dfsp1" as TOPIC_POSITION_DFSP1
control "Position Event Handler" as POS_HANDLER
collections "Transfer-Topic" as TOPIC_TRANSFERS
entity "Position DAO" as POS_DAO
collections "Event-Topic" as TOPIC_EVENTS
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Participant DAO" as PARTICIPANT_DAO
entity "Transfer DAO" as TRANS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_POSITION_DFSP1
    participant POS_HANDLER
    participant TOPIC_TRANSFERS
    participant TOPIC_EVENTS
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant PARTICIPANT_DAO
    participant TRANS_DAO
    participant DB
end box

activate POS_HANDLER
group Position Handler Consume
    TOPIC_POSITION_DFSP1 <- POS_HANDLER: Consume Position event message for Payer
    activate TOPIC_POSITION_DFSP1
    deactivate TOPIC_POSITION_DFSP1
    group Persist Event Information
        |||
        POS_HANDLER -> TOPIC_EVENTS: Publish event information
        ref over POS_HANDLER, TOPIC_EVENTS :  Event Handler Consume {9.1.0.} \n
        |||
    end

    alt Calulate & Validate Latest Position (success)
        group Calculate position and persist change
            POS_HANDLER -> POS_DAO: Request latest position from DB for Payer
            activate POS_DAO
            POS_DAO -> DB: Retrieve latest position from DB for Payer
            activate DB
            hnote over DB #lightyellow
                transferPosition
            end note
            DB - -> POS_DAO: Retrieve latest position from DB for Payer
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return latest position
            deactivate POS_DAO

            POS_HANDLER -> PARTICIPANT_DAO: Request position limits for Payer Participant
            activate PARTICIPANT_DAO
            PARTICIPANT_DAO -> DB: Request position limits for Payer Participant
            activate DB
            hnote over DB #lightyellow
                participant
                participantLimit
            end note
            DB - -> PARTICIPANT_DAO: Return position limits
            deactivate DB
            deactivate DB
            PARTICIPANT_DAO - -> POS_HANDLER: Return position limits
            deactivate PARTICIPANT_DAO

            POS_HANDLER <-> POS_HANDLER: Calculate latest position (lpos) for prepare
            POS_HANDLER <-> POS_HANDLER: Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos < netcap
            
            POS_HANDLER -> POS_DAO: Request to persist latest position for Payer
            activate POS_DAO
            POS_DAO -> DB: Persist latest position to DB for Payer
            hnote over DB #lightyellow
                transferPosition
            end note
            activate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end

        group Persist Transfer State (with transferState='RESERVED' on position check pass)
            POS_HANDLER -> TRANS_DAO: Request to persist transfer
            activate TRANS_DAO
            TRANS_DAO -> DB: Persist transfer state
            hnote over DB #lightyellow
                transferStateChange
            end note
            activate DB
            deactivate DB
            TRANS_DAO - -> POS_HANDLER: Return success
            deactivate TRANS_DAO
        end

        note right of POS_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_TRANSFERS: Publish Transfer event
        activate TOPIC_TRANSFERS
        deactivate TOPIC_TRANSFERS
    else Calculate & Validate Latest Position (failure)
        group Calculate position and persist change
            POS_HANDLER -> POS_DAO: Request latest position from DB for Payer
            activate POS_DAO
            POS_DAO -> DB: Retrieve latest position from DB for Payer
            activate DB
            hnote over DB #lightyellow
                transferPosition
            end note
            DB - -> POS_DAO: Retrieve latest position from DB for Payer
            deactivate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return latest position
            deactivate POS_DAO

            POS_HANDLER -> PARTICIPANT_DAO: Request position limits for Payer Participant
            activate PARTICIPANT_DAO
            PARTICIPANT_DAO -> DB: Request position limits for Payer Participant
            activate DB
            hnote over DB #lightyellow
                participant
                participantLimit
            end note
            DB - -> PARTICIPANT_DAO: Return position limits
            deactivate DB
            deactivate DB
            PARTICIPANT_DAO - -> POS_HANDLER: Return position limits
            deactivate PARTICIPANT_DAO

            POS_HANDLER <-> POS_HANDLER: Calculate latest position (lpos) for prepare
            POS_HANDLER <-> POS_HANDLER: Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos < netcap
            note right of POS_HANDLER #red: Validation failure!
        end
        
        group Persist Transfer State (with transferState='ABORTED' on position check pass)
            POS_HANDLER -> TRANS_DAO: Request to persist transfer
            activate TRANS_DAO
            TRANS_DAO -> DB: Persist transfer state
            hnote over DB #lightyellow
                transferStateChange
            end note
            activate DB
            deactivate DB
            TRANS_DAO - -> POS_HANDLER: Return success
            deactivate TRANS_DAO
        end

        note right of POS_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <ledgerName>,
                to: <transferMessage.payerFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                        "errorInformation": {
                            "errorCode": 4001,
                            "errorDescription": "Payer FSP insufficient liquidity",
                            "extensionList": <transferMessage.extensionList>
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: notification,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification (failure) event for Payer
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
        deactivate POS_HANDLER
    end
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.4
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>