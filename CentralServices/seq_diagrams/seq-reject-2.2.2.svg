<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1760px" preserveAspectRatio="none" style="width:1513px;height:1760px;" version="1.1" viewBox="0 0 1513 1760" width="1513px" zoomAndPan="magnify"><defs><filter height="300%" id="f1r5pvqty19i0o" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="293" x="611" y="23.5352">2.2.2. Position Handler Consume (Reject)</text><rect fill="#FFFFE0" height="1714.9434" style="stroke: #A80036; stroke-width: 1.0;" width="1419.5" x="29" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="688.25" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="113" y="196.2188"/><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="1547.6563" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="464.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="960.5" y="1567.6777"/><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="491.0137"/><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="1017.9824"/><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1190.5" y="835.4297"/><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="520.3242"/><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="864.7402"/><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="1047.293"/><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="1533.6563" style="stroke: #000000; stroke-width: 2.0;" width="1489" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="1502.3457" style="stroke: #000000; stroke-width: 2.0;" width="1469" x="23" y="157.5977"/><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="90.9316" style="stroke: #000000; stroke-width: 2.0;" width="533" x="369.5" y="241.2188"/><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="513" x="379.5" y="265.5293"/><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="92.2422" style="stroke: #000000; stroke-width: 2.0;" width="356.5" x="203" y="346.1504"/><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="183.1738" style="stroke: #000000; stroke-width: 2.0;" width="1078.5" x="379.5" y="452.3926"/><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="133.2422" style="stroke: #000000; stroke-width: 2.0;" width="606" x="369.5" y="649.5664"/><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="101.9316" style="stroke: #000000; stroke-width: 2.0;" width="586" x="379.5" y="673.877"/><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1088.5" x="379.5" y="796.8086"/><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1102.5" x="379.5" y="979.3613"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="1469" x="23" y="1605.6777"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="118" x2="118" y1="116.2871" y2="1683.9434"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="265" x2="265" y1="116.2871" y2="1683.9434"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="469.5" x2="469.5" y1="116.2871" y2="1683.9434"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="965.5" x2="965.5" y1="116.2871" y2="1683.9434"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1087.5" x2="1087.5" y1="116.2871" y2="1683.9434"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1195.5" x2="1195.5" y1="116.2871" y2="1683.9434"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1396.5" x2="1396.5" y1="116.2871" y2="1683.9434"/><rect fill="#FEFECE" filter="url(#f1r5pvqty19i0o)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="37" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1r5pvqty19i0o)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="33" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="40" y="101.334">Position-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#f1r5pvqty19i0o)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="37" y="1682.9434"/><rect fill="#FEFECE" filter="url(#f1r5pvqty19i0o)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="33" y="1686.9434"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="40" y="1707.4785">Position-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#f1r5pvqty19i0o)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="217" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1r5pvqty19i0o)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="213" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="220" y="101.334">Event-Topic</text><rect fill="#FEFECE" filter="url(#f1r5pvqty19i0o)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="217" y="1682.9434"/><rect fill="#FEFECE" filter="url(#f1r5pvqty19i0o)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="213" y="1686.9434"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="220" y="1707.4785">Event-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="389.5" y="113.334">Position Event Handler</text><ellipse cx="469.5" cy="83.7988" fill="#FEFECE" filter="url(#f1r5pvqty19i0o)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="465.5,71.7988,471.5,66.7988,469.5,71.7988,471.5,76.7988,465.5,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="389.5" y="1696.4785">Position Event Handler</text><ellipse cx="469.5" cy="1715.4316" fill="#FEFECE" filter="url(#f1r5pvqty19i0o)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="465.5,1703.4316,471.5,1698.4316,469.5,1703.4316,471.5,1708.4316,465.5,1703.4316" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f1r5pvqty19i0o)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="906.5" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1r5pvqty19i0o)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="902.5" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="909.5" y="101.334">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f1r5pvqty19i0o)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="906.5" y="1682.9434"/><rect fill="#FEFECE" filter="url(#f1r5pvqty19i0o)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="902.5" y="1686.9434"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="909.5" y="1707.4785">Transfer-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1038.5" y="113.334">Transfer DAO</text><ellipse cx="1088" cy="83.7988" fill="#FEFECE" filter="url(#f1r5pvqty19i0o)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1076" x2="1100" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1038.5" y="1696.4785">Transfer DAO</text><ellipse cx="1088" cy="1715.4316" fill="#FEFECE" filter="url(#f1r5pvqty19i0o)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1076" x2="1100" y1="1729.4316" y2="1729.4316"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1147.5" y="113.334">Position DAO</text><ellipse cx="1195.5" cy="83.7988" fill="#FEFECE" filter="url(#f1r5pvqty19i0o)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1183.5" x2="1207.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1147.5" y="1696.4785">Position DAO</text><ellipse cx="1195.5" cy="1715.4316" fill="#FEFECE" filter="url(#f1r5pvqty19i0o)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1183.5" x2="1207.5" y1="1729.4316" y2="1729.4316"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1348.5" y="113.334">Central Store</text><path d="M1378.5,63.7988 C1378.5,53.7988 1396.5,53.7988 1396.5,53.7988 C1396.5,53.7988 1414.5,53.7988 1414.5,63.7988 L1414.5,89.7988 C1414.5,99.7988 1396.5,99.7988 1396.5,99.7988 C1396.5,99.7988 1378.5,99.7988 1378.5,89.7988 L1378.5,63.7988 " fill="#FEFECE" filter="url(#f1r5pvqty19i0o)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1378.5,63.7988 C1378.5,73.7988 1396.5,73.7988 1396.5,73.7988 C1396.5,73.7988 1414.5,73.7988 1414.5,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1348.5" y="1696.4785">Central Store</text><path d="M1378.5,1709.4316 C1378.5,1699.4316 1396.5,1699.4316 1396.5,1699.4316 C1396.5,1699.4316 1414.5,1699.4316 1414.5,1709.4316 L1414.5,1735.4316 C1414.5,1745.4316 1396.5,1745.4316 1396.5,1745.4316 C1396.5,1745.4316 1378.5,1745.4316 1378.5,1735.4316 L1378.5,1709.4316 " fill="#FEFECE" filter="url(#f1r5pvqty19i0o)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1378.5,1709.4316 C1378.5,1719.4316 1396.5,1719.4316 1396.5,1719.4316 C1396.5,1719.4316 1414.5,1719.4316 1414.5,1709.4316 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="113" y="196.2188"/><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="1547.6563" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="464.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="960.5" y="1567.6777"/><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="491.0137"/><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="1017.9824"/><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1190.5" y="835.4297"/><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="520.3242"/><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="864.7402"/><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="1047.293"/><path d="M13,133.2871 L291,133.2871 L291,140.2871 L281,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1533.6563" style="stroke: #000000; stroke-width: 2.0;" width="1489" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="233" x="28" y="146.8555">Position Handler Consume (Reject)</text><path d="M23,157.5977 L85,157.5977 L85,164.5977 L75,174.5977 L23,174.5977 L23,157.5977 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1502.3457" style="stroke: #000000; stroke-width: 2.0;" width="1469" x="23" y="157.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="171.166">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="149" x="100" y="170.2324">[Consume Single Message]</text><polygon fill="#A80036" points="134,192.2188,124,196.2188,134,200.2188,130,196.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="128" x2="463.5" y1="196.2188" y2="196.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="140" y="191.4766">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="153" y="191.4766">Consume Position event message for Payer</text><path d="M369.5,241.2188 L453.5,241.2188 L453.5,248.2188 L443.5,258.2188 L369.5,258.2188 L369.5,241.2188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="90.9316" style="stroke: #000000; stroke-width: 2.0;" width="533" x="369.5" y="241.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="384.5" y="254.7871">break</text><path d="M379.5,265.5293 L521.5,265.5293 L521.5,272.5293 L511.5,282.5293 L379.5,282.5293 L379.5,265.5293 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="513" x="379.5" y="265.5293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="394.5" y="279.0977">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="474.5" x2="516.5" y1="304.1504" y2="304.1504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="516.5" x2="516.5" y1="304.1504" y2="317.1504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="475.5" x2="516.5" y1="317.1504" y2="317.1504"/><polygon fill="#A80036" points="485.5,313.1504,475.5,317.1504,485.5,321.1504,481.5,317.1504" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="481.5" y="299.4082">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="386" x="494.5" y="299.4082">Validate event - Rule: type == 'position' &amp;&amp; action == 'reject'</text><path d="M203,346.1504 L418,346.1504 L418,353.1504 L408,363.1504 L203,363.1504 L203,346.1504 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="92.2422" style="stroke: #000000; stroke-width: 2.0;" width="356.5" x="203" y="346.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="218" y="359.7188">Persist Event Information</text><polygon fill="#A80036" points="276.5,380.7715,266.5,384.7715,276.5,388.7715,272.5,384.7715" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="270.5" x2="463.5" y1="384.7715" y2="384.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="282.5" y="380.0293">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="295.5" y="380.0293">Publish event information</text><rect fill="#FFFFFF" filter="url(#f1r5pvqty19i0o)" height="40.6211" style="stroke: #000000; stroke-width: 2.0;" width="338.5" x="210" y="392.7715"/><polygon fill="#EEEEEE" points="210,392.7715,274,392.7715,274,399.7715,264,409.7715,210,409.7715,210,392.7715" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="223" y="407.3398">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="282.25" y="426.3398">Event Handler Consume {9.1.0.}</text><path d="M379.5,452.3926 L648.5,452.3926 L648.5,459.3926 L638.5,469.3926 L379.5,469.3926 L379.5,452.3926 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="183.1738" style="stroke: #000000; stroke-width: 2.0;" width="1078.5" x="379.5" y="452.3926"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224" x="394.5" y="465.9609">Retrieve Current Transfer Details</text><polygon fill="#A80036" points="1071,487.0137,1081,491.0137,1071,495.0137,1075,491.0137" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="474.5" x2="1077" y1="491.0137" y2="491.0137"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="481.5" y="486.2715">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="324" x="494.5" y="486.2715">Request to retrieve expirationDate &amp; transferStateId</text><polygon fill="#A80036" points="1379.5,516.3242,1389.5,520.3242,1379.5,524.3242,1383.5,520.3242" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1093" x2="1385.5" y1="520.3242" y2="520.3242"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1100" y="515.582">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="1113" y="515.582">Fetch from database</text><polygon fill="#A80036" points="1104,545.6348,1094,549.6348,1104,553.6348,1100,549.6348" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1098" x2="1395.5" y1="549.6348" y2="549.6348"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1110" y="544.8926">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1127" y="544.8926"/><polygon fill="#FFFFE0" filter="url(#f1r5pvqty19i0o)" points="1354,562.6348,1438,562.6348,1448,581.6348,1438,600.6348,1354,600.6348,1344,581.6348,1354,562.6348" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1356" y="579.2031">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1356" y="594.5137">transferState</text><polygon fill="#A80036" points="485.5,623.5664,475.5,627.5664,485.5,631.5664,481.5,627.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="479.5" x2="1087" y1="627.5664" y2="627.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="491.5" y="622.8242">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="384" x="504.5" y="622.8242">Return transfer.expirationDate &amp; transferState.transferStateId</text><path d="M369.5,649.5664 L453.5,649.5664 L453.5,656.5664 L443.5,666.5664 L369.5,666.5664 L369.5,649.5664 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="133.2422" style="stroke: #000000; stroke-width: 2.0;" width="606" x="369.5" y="649.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="384.5" y="663.1348">break</text><path d="M379.5,673.877 L541.5,673.877 L541.5,680.877 L531.5,690.877 L379.5,690.877 L379.5,673.877 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="101.9316" style="stroke: #000000; stroke-width: 2.0;" width="586" x="379.5" y="673.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="117" x="394.5" y="687.4453">Validate Transfer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="474.5" x2="516.5" y1="712.498" y2="712.498"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="516.5" x2="516.5" y1="712.498" y2="725.498"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="475.5" x2="516.5" y1="725.498" y2="725.498"/><polygon fill="#A80036" points="485.5,721.498,475.5,725.498,485.5,729.498,481.5,725.498" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="481.5" y="707.7559">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="400" x="494.5" y="707.7559">Validate transfer expiration - Rule: Date.now() &lt; expirationDate</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="474.5" x2="516.5" y1="754.8086" y2="754.8086"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="516.5" x2="516.5" y1="754.8086" y2="767.8086"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="475.5" x2="516.5" y1="767.8086" y2="767.8086"/><polygon fill="#A80036" points="485.5,763.8086,475.5,767.8086,485.5,771.8086,481.5,767.8086" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="481.5" y="750.0664">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="494.5" y="750.0664">Validate transfer state - Rule:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="87" x="683.5" y="750.0664">transferState</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="770.5" y="750.0664">Id corresponds to 'RESERVED'</text><path d="M379.5,796.8086 L652.5,796.8086 L652.5,803.8086 L642.5,813.8086 L379.5,813.8086 L379.5,796.8086 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1088.5" x="379.5" y="796.8086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="228" x="394.5" y="810.377">Decrement Payer Position (DFSP1)</text><polygon fill="#A80036" points="1178.5,831.4297,1188.5,835.4297,1178.5,839.4297,1182.5,835.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="474.5" x2="1184.5" y1="835.4297" y2="835.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="481.5" y="830.6875">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="503.5" y="830.6875">Request to decrement latest position for Payer</text><polygon fill="#A80036" points="1379.5,860.7402,1389.5,864.7402,1379.5,868.7402,1383.5,864.7402" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1200.5" x2="1385.5" y1="864.7402" y2="864.7402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1207.5" y="859.998">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="1229.5" y="859.998">Persist decrement to DB</text><polygon fill="#FFFFE0" filter="url(#f1r5pvqty19i0o)" points="1344,907.7402,1448,907.7402,1458,918.7402,1448,930.7402,1344,930.7402,1334,918.7402,1344,907.7402" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1346" y="924.3086">transferPosition</text><polygon fill="#A80036" points="485.5,953.3613,475.5,957.3613,485.5,961.3613,481.5,957.3613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="479.5" x2="1194.5" y1="957.3613" y2="957.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="491.5" y="952.6191">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="513.5" y="952.6191">Return success</text><path d="M379.5,979.3613 L783.5,979.3613 L783.5,986.3613 L773.5,996.3613 L379.5,996.3613 L379.5,979.3613 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1102.5" x="379.5" y="979.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="359" x="394.5" y="992.9297">Persist Transfer State (with transferState='ABORTED')</text><polygon fill="#A80036" points="1071,1013.9824,1081,1017.9824,1071,1021.9824,1075,1017.9824" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="474.5" x2="1077" y1="1017.9824" y2="1017.9824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="481.5" y="1013.2402">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="503.5" y="1013.2402">Request to persist transfer state</text><polygon fill="#A80036" points="1379.5,1043.293,1389.5,1047.293,1379.5,1051.293,1383.5,1047.293" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1093" x2="1385.5" y1="1047.293" y2="1047.293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1100" y="1042.5508">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1122" y="1042.5508">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#f1r5pvqty19i0o)" points="1331,1090.293,1462,1090.293,1472,1101.293,1462,1113.293,1331,1113.293,1321,1101.293,1331,1090.293" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1333" y="1106.8613">transferStateChange</text><polygon fill="#A80036" points="485.5,1135.9141,475.5,1139.9141,485.5,1143.9141,481.5,1139.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="479.5" x2="1087" y1="1139.9141" y2="1139.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="491.5" y="1135.1719">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="513.5" y="1135.1719">Return success</text><path d="M479,1159.9141 L479,1536.9141 L788,1536.9141 L788,1169.9141 L778,1159.9141 L479,1159.9141 " fill="#FFFF00" filter="url(#f1r5pvqty19i0o)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M778,1159.9141 L778,1169.9141 L788,1169.9141 L778,1159.9141 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="485" y="1177.4824">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="485" y="1192.793">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="501" y="1208.1035">id: &lt;ID&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="501" y="1223.4141">from: &lt;transferHeaders.FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="501" y="1238.7246">to: &lt;transferHeaders.FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="501" y="1254.0352">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="501" y="1269.3457">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="517" y="1284.6563">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="517" y="1299.9668">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="501" y="1315.2773">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="501" y="1330.5879">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="517" y="1345.8984">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="533" y="1361.209">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="533" y="1376.5195">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="533" y="1391.8301">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="86" x="533" y="1407.1406">action: reject,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="533" y="1422.4512">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="533" y="1437.7617">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="549" y="1453.0723">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="549" y="1468.3828">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="533" y="1483.6934">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="517" y="1499.0039">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="501" y="1514.3145">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="485" y="1529.625">}</text><polygon fill="#A80036" points="948.5,1563.6777,958.5,1567.6777,948.5,1571.6777,952.5,1567.6777" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="474.5" x2="954.5" y1="1567.6777" y2="1567.6777"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="481.5" y="1562.9355">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="503.5" y="1562.9355">Publish Transfer event</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1492" y1="1606.6777" y2="1606.6777"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="151" x="28" y="1617.3125">[Consume Batch Messages]</text><path d="M241,1625.6328 L241,1650.6328 L455,1650.6328 L455,1635.6328 L445,1625.6328 L241,1625.6328 " fill="#ADD8E6" filter="url(#f1r5pvqty19i0o)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M445,1625.6328 L445,1635.6328 L455,1635.6328 L445,1625.6328 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="247" y="1643.2012">To be delivered by future story</text><!--
@startuml
title 2.2.2. Position Handler Consume (Reject)

autonumber


collections "Position-Topic-dfsp1" as TOPIC_POSITION_DFSP1
control "Position Event Handler" as POS_HANDLER
collections "Transfer-Topic" as TOPIC_TRANSFERS
collections "Event-Topic" as TOPIC_EVENT
entity "Transfer DAO" as TRANS_DAO
entity "Position DAO" as POS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_POSITION_DFSP1
    participant TOPIC_EVENT
    participant POS_HANDLER
    participant TOPIC_TRANSFERS
    participant TRANS_DAO
    participant POS_DAO
    participant DB
end box

activate POS_HANDLER
group Position Handler Consume (Reject)
    alt Consume Single Message
        TOPIC_POSITION_DFSP1 <- POS_HANDLER: Consume Position event message for Payer
        activate TOPIC_POSITION_DFSP1
        deactivate TOPIC_POSITION_DFSP1

        break
            group Validate Event
                POS_HANDLER <-> POS_HANDLER: Validate event - Rule: type == 'position' && action == 'reject'
            end
        end

        group Persist Event Information
            POS_HANDLER -> TOPIC_EVENT: Publish event information
	        ref over POS_HANDLER, TOPIC_EVENT :  Event Handler Consume {9.1.0.} 
        end

        group Retrieve Current Transfer Details
            POS_HANDLER -> TRANS_DAO: Request to retrieve expirationDate & transferStateId
            activate TRANS_DAO
            TRANS_DAO -> DB: Fetch from database
            activate DB
            DB - -> TRANS_DAO
            deactivate DB
            hnote over DB #lightyellow
                transfer
                transferState
            end note
            POS_HANDLER <- - TRANS_DAO: Return transfer.expirationDate & transferState.transferStateId
            deactivate TRANS_DAO
        end

        break
            group Validate Transfer
                POS_HANDLER <-> POS_HANDLER: Validate transfer expiration - Rule: Date.now() < expirationDate
                POS_HANDLER <-> POS_HANDLER: Validate transfer state - Rule: **transferState**Id corresponds to 'RESERVED'
            end
        end

        group Decrement Payer Position (DFSP1)
            POS_HANDLER -> POS_DAO: Request to decrement latest position for Payer
            activate POS_DAO
            POS_DAO -> DB: Persist decrement to DB
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                transferPosition
            end note
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end

        group Persist Transfer State (with transferState='ABORTED')
            POS_HANDLER -> TRANS_DAO: Request to persist transfer state
            activate TRANS_DAO
            TRANS_DAO -> DB: Persist transfer state
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                transferStateChange
            end note
            TRANS_DAO - -> POS_HANDLER: Return success
            deactivate TRANS_DAO
        end
    
        note right of POS_HANDLER #yellow
            Message:
            {
                id: <ID>,
                from: <transferHeaders.FSPIOP-Source>,
                to: <transferHeaders.FSPIOP-Destination>,
                type: application/json,
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: reject,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_TRANSFERS: Publish Transfer event
        activate TOPIC_TRANSFERS
        deactivate TOPIC_TRANSFERS

    else Consume Batch Messages
        note left of POS_HANDLER #lightblue
            To be delivered by future story
        end note
    end
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.4
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>