<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2169px" preserveAspectRatio="none" style="width:1620px;height:2169px;" version="1.1" viewBox="0 0 1620 2169" width="1620px" zoomAndPan="magnify"><defs><filter height="300%" id="f6o7zjeaqjayy" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="310" x="656" y="23.5352">2.3.2. Position Handler Consume (Timeout)</text><rect fill="#FFFFE0" height="2124.0859" style="stroke: #A80036; stroke-width: 1.0;" width="1546.5" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="741.75" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="103" y="171.9082"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="1956.7988" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="454.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1077.5" y="2038.0859"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="137.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1200" y="466.7031"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1200" y="1050.6719"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1307.5" y="861.1191"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1508.5" y="496.0137"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1508.5" y="890.4297"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1508.5" y="1079.9824"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="1942.7988" style="stroke: #000000; stroke-width: 2.0;" width="1596" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="90.9316" style="stroke: #000000; stroke-width: 2.0;" width="733" x="359.5" y="216.9082"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="713" x="369.5" y="241.2188"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="92.2422" style="stroke: #000000; stroke-width: 2.0;" width="356.5" x="193" y="321.8398"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="183.8633" style="stroke: #000000; stroke-width: 2.0;" width="1205.5" x="369.5" y="428.082"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="133.2422" style="stroke: #000000; stroke-width: 2.0;" width="693" x="359.5" y="625.9453"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="101.9316" style="stroke: #000000; stroke-width: 2.0;" width="673" x="369.5" y="650.2559"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="224.8633" style="stroke: #000000; stroke-width: 2.0;" width="1235.5" x="359.5" y="773.1875"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1215.5" x="369.5" y="822.498"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1229.5" x="369.5" y="1012.0508"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="815.1719" style="stroke: #000000; stroke-width: 2.0;" width="284" x="459" y="1194.6035"/><rect fill="#FFFFFF" height="406.4082" style="stroke: none; stroke-width: 1.0;" width="284" x="459" y="1603.3672"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="108" x2="108" y1="116.2871" y2="2093.0859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="255" x2="255" y1="116.2871" y2="2093.0859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="459.5" x2="459.5" y1="116.2871" y2="2093.0859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1082.5" x2="1082.5" y1="116.2871" y2="2093.0859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1204.5" x2="1204.5" y1="116.2871" y2="2093.0859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1312.5" x2="1312.5" y1="116.2871" y2="2093.0859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1513.5" x2="1513.5" y1="116.2871" y2="2093.0859"/><rect fill="#FEFECE" filter="url(#f6o7zjeaqjayy)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="27" y="76.7988"/><rect fill="#FEFECE" filter="url(#f6o7zjeaqjayy)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="23" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="30" y="101.334">Position-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#f6o7zjeaqjayy)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="27" y="2092.0859"/><rect fill="#FEFECE" filter="url(#f6o7zjeaqjayy)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="23" y="2096.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="30" y="2116.6211">Position-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#f6o7zjeaqjayy)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="207" y="76.7988"/><rect fill="#FEFECE" filter="url(#f6o7zjeaqjayy)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="203" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="210" y="101.334">Event-Topic</text><rect fill="#FEFECE" filter="url(#f6o7zjeaqjayy)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="207" y="2092.0859"/><rect fill="#FEFECE" filter="url(#f6o7zjeaqjayy)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="203" y="2096.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="210" y="2116.6211">Event-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="379.5" y="113.334">Position Event Handler</text><ellipse cx="459.5" cy="83.7988" fill="#FEFECE" filter="url(#f6o7zjeaqjayy)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="455.5,71.7988,461.5,66.7988,459.5,71.7988,461.5,76.7988,455.5,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="379.5" y="2105.6211">Position Event Handler</text><ellipse cx="459.5" cy="2124.5742" fill="#FEFECE" filter="url(#f6o7zjeaqjayy)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="455.5,2112.5742,461.5,2107.5742,459.5,2112.5742,461.5,2117.5742,455.5,2112.5742" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f6o7zjeaqjayy)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="1023.5" y="76.7988"/><rect fill="#FEFECE" filter="url(#f6o7zjeaqjayy)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="1019.5" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="1026.5" y="101.334">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f6o7zjeaqjayy)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="1023.5" y="2092.0859"/><rect fill="#FEFECE" filter="url(#f6o7zjeaqjayy)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="1019.5" y="2096.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="1026.5" y="2116.6211">Transfer-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1155.5" y="113.334">Transfer DAO</text><ellipse cx="1205" cy="83.7988" fill="#FEFECE" filter="url(#f6o7zjeaqjayy)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1193" x2="1217" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1155.5" y="2105.6211">Transfer DAO</text><ellipse cx="1205" cy="2124.5742" fill="#FEFECE" filter="url(#f6o7zjeaqjayy)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1193" x2="1217" y1="2138.5742" y2="2138.5742"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1264.5" y="113.334">Position DAO</text><ellipse cx="1312.5" cy="83.7988" fill="#FEFECE" filter="url(#f6o7zjeaqjayy)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1300.5" x2="1324.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1264.5" y="2105.6211">Position DAO</text><ellipse cx="1312.5" cy="2124.5742" fill="#FEFECE" filter="url(#f6o7zjeaqjayy)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1300.5" x2="1324.5" y1="2138.5742" y2="2138.5742"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1465.5" y="113.334">Central Store</text><path d="M1495.5,63.7988 C1495.5,53.7988 1513.5,53.7988 1513.5,53.7988 C1513.5,53.7988 1531.5,53.7988 1531.5,63.7988 L1531.5,89.7988 C1531.5,99.7988 1513.5,99.7988 1513.5,99.7988 C1513.5,99.7988 1495.5,99.7988 1495.5,89.7988 L1495.5,63.7988 " fill="#FEFECE" filter="url(#f6o7zjeaqjayy)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1495.5,63.7988 C1495.5,73.7988 1513.5,73.7988 1513.5,73.7988 C1513.5,73.7988 1531.5,73.7988 1531.5,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1465.5" y="2105.6211">Central Store</text><path d="M1495.5,2118.5742 C1495.5,2108.5742 1513.5,2108.5742 1513.5,2108.5742 C1513.5,2108.5742 1531.5,2108.5742 1531.5,2118.5742 L1531.5,2144.5742 C1531.5,2154.5742 1513.5,2154.5742 1513.5,2154.5742 C1513.5,2154.5742 1495.5,2154.5742 1495.5,2144.5742 L1495.5,2118.5742 " fill="#FEFECE" filter="url(#f6o7zjeaqjayy)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1495.5,2118.5742 C1495.5,2128.5742 1513.5,2128.5742 1513.5,2128.5742 C1513.5,2128.5742 1531.5,2128.5742 1531.5,2118.5742 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="103" y="171.9082"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="1956.7988" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="454.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1077.5" y="2038.0859"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="137.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1200" y="466.7031"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1200" y="1050.6719"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1307.5" y="861.1191"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1508.5" y="496.0137"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1508.5" y="890.4297"/><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1508.5" y="1079.9824"/><path d="M13,133.2871 L302,133.2871 L302,140.2871 L292,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1942.7988" style="stroke: #000000; stroke-width: 2.0;" width="1596" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="244" x="28" y="146.8555">Position Handler Consume (timeout)</text><polygon fill="#A80036" points="124,167.9082,114,171.9082,124,175.9082,120,171.9082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="118" x2="453.5" y1="171.9082" y2="171.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="130" y="167.166">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="143" y="167.166">Consume Position event message</text><path d="M359.5,216.9082 L443.5,216.9082 L443.5,223.9082 L433.5,233.9082 L359.5,233.9082 L359.5,216.9082 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="90.9316" style="stroke: #000000; stroke-width: 2.0;" width="733" x="359.5" y="216.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="374.5" y="230.4766">break</text><path d="M369.5,241.2188 L511.5,241.2188 L511.5,248.2188 L501.5,258.2188 L369.5,258.2188 L369.5,241.2188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="713" x="369.5" y="241.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="384.5" y="254.7871">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="464.5" x2="506.5" y1="279.8398" y2="279.8398"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="506.5" x2="506.5" y1="279.8398" y2="292.8398"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="465.5" x2="506.5" y1="292.8398" y2="292.8398"/><polygon fill="#A80036" points="475.5,288.8398,465.5,292.8398,475.5,296.8398,471.5,292.8398" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="471.5" y="275.0977">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="586" x="484.5" y="275.0977">Validate event - Rule: type == 'position' &amp;&amp; action IN ['timeout-received', 'timeout-reserved']</text><path d="M193,321.8398 L408,321.8398 L408,328.8398 L398,338.8398 L193,338.8398 L193,321.8398 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="92.2422" style="stroke: #000000; stroke-width: 2.0;" width="356.5" x="193" y="321.8398"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="208" y="335.4082">Persist Event Information</text><polygon fill="#A80036" points="266.5,356.4609,256.5,360.4609,266.5,364.4609,262.5,360.4609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="260.5" x2="453.5" y1="360.4609" y2="360.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="272.5" y="355.7188">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="285.5" y="355.7188">Publish event information</text><rect fill="#FFFFFF" filter="url(#f6o7zjeaqjayy)" height="40.6211" style="stroke: #000000; stroke-width: 2.0;" width="338.5" x="200" y="368.4609"/><polygon fill="#EEEEEE" points="200,368.4609,264,368.4609,264,375.4609,254,385.4609,200,385.4609,200,368.4609" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="213" y="383.0293">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="272.25" y="402.0293">Event Handler Consume {9.1.0.}</text><path d="M369.5,428.082 L638.5,428.082 L638.5,435.082 L628.5,445.082 L369.5,445.082 L369.5,428.082 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="183.8633" style="stroke: #000000; stroke-width: 2.0;" width="1205.5" x="369.5" y="428.082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224" x="384.5" y="441.6504">Retrieve Current Transfer Details</text><polygon fill="#A80036" points="1188,462.7031,1198,466.7031,1188,470.7031,1192,466.7031" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="464.5" x2="1194" y1="466.7031" y2="466.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="471.5" y="461.9609">4</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="324" x="484.5" y="461.9609">Request to retrieve expirationDate &amp; transferStateId</text><polygon fill="#A80036" points="1496.5,492.0137,1506.5,496.0137,1496.5,500.0137,1500.5,496.0137" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1210" x2="1502.5" y1="496.0137" y2="496.0137"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1217" y="491.2715">5</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="1230" y="491.2715">Fetch from database</text><polygon fill="#FFFFE0" filter="url(#f6o7zjeaqjayy)" points="1471,539.0137,1555,539.0137,1565,558.0137,1555,577.0137,1471,577.0137,1461,558.0137,1471,539.0137" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1473" y="555.582">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1473" y="570.8926">transferState</text><polygon fill="#A80036" points="475.5,599.9453,465.5,603.9453,475.5,607.9453,471.5,603.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="469.5" x2="1204" y1="603.9453" y2="603.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="481.5" y="599.2031">6</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="384" x="494.5" y="599.2031">Return transfer.expirationDate &amp; transferState.transferStateId</text><path d="M359.5,625.9453 L443.5,625.9453 L443.5,632.9453 L433.5,642.9453 L359.5,642.9453 L359.5,625.9453 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="133.2422" style="stroke: #000000; stroke-width: 2.0;" width="693" x="359.5" y="625.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="374.5" y="639.5137">break</text><path d="M369.5,650.2559 L531.5,650.2559 L531.5,657.2559 L521.5,667.2559 L369.5,667.2559 L369.5,650.2559 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="101.9316" style="stroke: #000000; stroke-width: 2.0;" width="673" x="369.5" y="650.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="117" x="384.5" y="663.8242">Validate Transfer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="464.5" x2="506.5" y1="688.877" y2="688.877"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="506.5" x2="506.5" y1="688.877" y2="701.877"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="465.5" x2="506.5" y1="701.877" y2="701.877"/><polygon fill="#A80036" points="475.5,697.877,465.5,701.877,475.5,705.877,471.5,701.877" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="471.5" y="684.1348">7</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="400" x="484.5" y="684.1348">Validate transfer expiration - Rule: Date.now() &gt; expirationDate</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="464.5" x2="506.5" y1="731.1875" y2="731.1875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="506.5" x2="506.5" y1="731.1875" y2="744.1875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="465.5" x2="506.5" y1="744.1875" y2="744.1875"/><polygon fill="#A80036" points="475.5,740.1875,465.5,744.1875,475.5,748.1875,471.5,744.1875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="471.5" y="726.4453">8</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="484.5" y="726.4453">Validate transfer state - Rule:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="87" x="673.5" y="726.4453">transferState</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="760.5" y="726.4453">Id corresponds to 'RECEIVED' or 'RESERVED'</text><path d="M359.5,773.1875 L426.5,773.1875 L426.5,780.1875 L416.5,790.1875 L359.5,790.1875 L359.5,773.1875 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="224.8633" style="stroke: #000000; stroke-width: 2.0;" width="1235.5" x="359.5" y="773.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="374.5" y="786.7559">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="172" x="441.5" y="785.8223">[action == 'timeout-reserved']</text><path d="M369.5,822.498 L642.5,822.498 L642.5,829.498 L632.5,839.498 L369.5,839.498 L369.5,822.498 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1215.5" x="369.5" y="822.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="228" x="384.5" y="836.0664">Decrement Payer Position (DFSP1)</text><polygon fill="#A80036" points="1295.5,857.1191,1305.5,861.1191,1295.5,865.1191,1299.5,861.1191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="464.5" x2="1301.5" y1="861.1191" y2="861.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="471.5" y="856.377">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="484.5" y="856.377">Request to decrement latest position for Payer</text><polygon fill="#A80036" points="1496.5,886.4297,1506.5,890.4297,1496.5,894.4297,1500.5,890.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1317.5" x2="1502.5" y1="890.4297" y2="890.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1324.5" y="885.6875">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="1346.5" y="885.6875">Persist decrement to DB</text><polygon fill="#FFFFE0" filter="url(#f6o7zjeaqjayy)" points="1461,933.4297,1565,933.4297,1575,944.4297,1565,956.4297,1461,956.4297,1451,944.4297,1461,933.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1463" y="949.998">transferPosition</text><polygon fill="#A80036" points="475.5,979.0508,465.5,983.0508,475.5,987.0508,471.5,983.0508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="469.5" x2="1311.5" y1="983.0508" y2="983.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="481.5" y="978.3086">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="503.5" y="978.3086">Return success</text><path d="M369.5,1012.0508 L773.5,1012.0508 L773.5,1019.0508 L763.5,1029.0508 L369.5,1029.0508 L369.5,1012.0508 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1229.5" x="369.5" y="1012.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="359" x="384.5" y="1025.6191">Persist Transfer State (with transferState='ABORTED')</text><polygon fill="#A80036" points="1188,1046.6719,1198,1050.6719,1188,1054.6719,1192,1050.6719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="464.5" x2="1194" y1="1050.6719" y2="1050.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="471.5" y="1045.9297">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="493.5" y="1045.9297">Request to persist transfer state</text><polygon fill="#A80036" points="1496.5,1075.9824,1506.5,1079.9824,1496.5,1083.9824,1500.5,1079.9824" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1210" x2="1502.5" y1="1079.9824" y2="1079.9824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1217" y="1075.2402">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1239" y="1075.2402">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#f6o7zjeaqjayy)" points="1448,1122.9824,1579,1122.9824,1589,1133.9824,1579,1145.9824,1448,1145.9824,1438,1133.9824,1448,1122.9824" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1450" y="1139.5508">transferStateChange</text><polygon fill="#A80036" points="475.5,1168.6035,465.5,1172.6035,475.5,1176.6035,471.5,1172.6035" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="469.5" x2="1204" y1="1172.6035" y2="1172.6035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="481.5" y="1167.8613">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="503.5" y="1167.8613">Return success</text><path d="M459,1194.6035 L521,1194.6035 L521,1201.6035 L511,1211.6035 L459,1211.6035 L459,1194.6035 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="815.1719" style="stroke: #000000; stroke-width: 2.0;" width="284" x="459" y="1194.6035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="474" y="1208.1719">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="171" x="536" y="1207.2383">[action == 'timeout-received']</text><path d="M469,1216.9141 L469,1593.9141 L729,1593.9141 L729,1226.9141 L719,1216.9141 L469,1216.9141 " fill="#FFFF00" filter="url(#f6o7zjeaqjayy)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M719,1216.9141 L719,1226.9141 L729,1226.9141 L719,1216.9141 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="475" y="1234.4824">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="475" y="1249.793">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="491" y="1265.1035">id: &lt;transferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="491" y="1280.4141">from: &lt;payerParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="491" y="1295.7246">to: &lt;payeeParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="491" y="1311.0352">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="491" y="1326.3457"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="491" y="1326.3457">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="507" y="1341.6563"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="507" y="1341.6563">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="507" y="1356.9668"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="507" y="1356.9668">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="491" y="1372.2773"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="491" y="1372.2773">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="491" y="1387.5879">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="507" y="1402.8984">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="523" y="1418.209">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="523" y="1433.5195">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="523" y="1448.8301">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="523" y="1464.1406">action: timeout-received,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="523" y="1479.4512">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="523" y="1494.7617">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="539" y="1510.0723">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="539" y="1525.3828">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="523" y="1540.6934">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="507" y="1556.0039">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="491" y="1571.3145">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="475" y="1586.625">}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="459" x2="743" y1="1604.3672" y2="1604.3672"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="172" x="464" y="1615.002">[action == 'timeout-reserved']</text><path d="M469,1623.3223 L469,2000.3223 L729,2000.3223 L729,1633.3223 L719,1623.3223 L469,1623.3223 " fill="#FFFF00" filter="url(#f6o7zjeaqjayy)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M719,1623.3223 L719,1633.3223 L729,1633.3223 L719,1623.3223 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="475" y="1640.8906">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="475" y="1656.2012">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="491" y="1671.5117">id: &lt;transferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="491" y="1686.8223">from: &lt;payerParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="491" y="1702.1328">to: &lt;payeeParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="491" y="1717.4434">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="491" y="1732.7539"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="491" y="1732.7539">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="507" y="1748.0645"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="507" y="1748.0645">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="507" y="1763.375"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="507" y="1763.375">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="491" y="1778.6855"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="491" y="1778.6855">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="491" y="1793.9961">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="507" y="1809.3066">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="523" y="1824.6172">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="523" y="1839.9277">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="523" y="1855.2383">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="523" y="1870.5488">action: timeout-reserved,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="523" y="1885.8594">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="523" y="1901.1699">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="539" y="1916.4805">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="539" y="1931.791">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="523" y="1947.1016">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="507" y="1962.4121">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="491" y="1977.7227">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="475" y="1993.0332">}</text><polygon fill="#A80036" points="1065.5,2034.0859,1075.5,2038.0859,1065.5,2042.0859,1069.5,2038.0859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="464.5" x2="1071.5" y1="2038.0859" y2="2038.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="471.5" y="2033.3438">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="493.5" y="2033.3438">Publish Transfer event</text><!--
@startuml
title 2.3.2. Position Handler Consume (Timeout)

autonumber


collections "Position-Topic-dfsp1" as TOPIC_POSITION_DFSP1
control "Position Event Handler" as POS_HANDLER
collections "Transfer-Topic" as TOPIC_TRANSFERS
collections "Event-Topic" as TOPIC_EVENT
entity "Transfer DAO" as TRANS_DAO
entity "Position DAO" as POS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_POSITION_DFSP1
    participant TOPIC_EVENT
    participant POS_HANDLER
    participant TOPIC_TRANSFERS
    participant TRANS_DAO
    participant POS_DAO
    participant DB
end box

activate POS_HANDLER
group Position Handler Consume (timeout)
    TOPIC_POSITION_DFSP1 <- POS_HANDLER: Consume Position event message
    activate TOPIC_POSITION_DFSP1
    deactivate TOPIC_POSITION_DFSP1

    break
        group Validate Event
            POS_HANDLER <-> POS_HANDLER: Validate event - Rule: type == 'position' && action IN ['timeout-received', 'timeout-reserved']
        end
    end

    group Persist Event Information
        POS_HANDLER -> TOPIC_EVENT: Publish event information
        ref over POS_HANDLER, TOPIC_EVENT :  Event Handler Consume {9.1.0.} 
    end
        
    group Retrieve Current Transfer Details
        POS_HANDLER -> TRANS_DAO: <color #FF0000>Request to retrieve expirationDate & transferStateId</color>
        activate TRANS_DAO
        TRANS_DAO -> DB: <color #FF0000>Fetch from database</color>
        activate DB
        deactivate DB
        hnote over DB #lightyellow
            transfer
            transferState
        end note
        POS_HANDLER <- - TRANS_DAO: <color #FF0000>Return transfer.expirationDate & transferState.transferStateId</color>
        deactivate TRANS_DAO
    end

    break
        group Validate Transfer
            POS_HANDLER <-> POS_HANDLER: <color #FF0000>Validate transfer expiration - Rule: Date.now() > expirationDate</color>
            POS_HANDLER <-> POS_HANDLER: <color #FF0000>Validate transfer state - Rule: **transferState**Id corresponds to 'RECEIVED' or 'RESERVED'</color>
        end
    end

    opt action == 'timeout-reserved'
        |||
        group Decrement Payer Position (DFSP1)
            POS_HANDLER -> POS_DAO: Request to decrement latest position for Payer
            activate POS_DAO
            POS_DAO -> DB: Persist decrement to DB
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                transferPosition
            end note
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
    end

    group Persist Transfer State (with transferState='ABORTED')
        POS_HANDLER -> TRANS_DAO: Request to persist transfer state
        activate TRANS_DAO
        TRANS_DAO -> DB: Persist transfer state
        activate DB
        deactivate DB
        hnote over DB #lightyellow
            transferStateChange
        end note
        TRANS_DAO - -> POS_HANDLER: Return success
        deactivate TRANS_DAO
    end

    alt action == 'timeout-received'
        note right of POS_HANDLER #yellow
            Message:
            {
                id: <transferId>,
                from: <payerParticipantId>,
                to: <payeeParticipantId>,
                type: application/json,
                <color #FF0000>content: {</color>
                    <color #FF0000>headers: <transferHeaders>,</color>
                    <color #FF0000>payload: <transferMessage></color>
                <color #FF0000>},</color>
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: timeout-received,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
    else action == 'timeout-reserved'
        note right of POS_HANDLER #yellow
            Message:
            {
                id: <transferId>,
                from: <payerParticipantId>,
                to: <payeeParticipantId>,
                type: application/json,
                <color #FF0000>content: {</color>
                    <color #FF0000>headers: <transferHeaders>,</color>
                    <color #FF0000>payload: <transferMessage></color>
                <color #FF0000>},</color>
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: timeout-reserved,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
    end
    POS_HANDLER -> TOPIC_TRANSFERS: Publish Transfer event
    activate TOPIC_TRANSFERS
    deactivate TOPIC_TRANSFERS
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.4
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>