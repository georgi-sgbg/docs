<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2641px" preserveAspectRatio="none" style="width:1518px;height:2641px;" version="1.1" viewBox="0 0 1518 2641" width="1518px" zoomAndPan="magnify"><defs><filter height="300%" id="f1b88zthp48eu0" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="289" x="615.5" y="23.5352">1.1.3. Bulk Processing Handler Consume</text><rect fill="#FFFFE0" height="2595.9395" style="stroke: #A80036; stroke-width: 1.0;" width="1419" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="678" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="69" y="174.3965"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="2423.6758" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="229" y="128.7754"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="891" y="2493.4512"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1007" y="565.123"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1007" y="862.1602"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="167.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1007" y="1185.5762"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1007" y="1849.5137"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1381" y="594.4336"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1381" y="891.4707"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1381" y="1214.8867"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1381" y="1878.8242"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="2409.6758" style="stroke: #000000; stroke-width: 2.0;" width="1494" x="13" y="135.7754"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="121.5527" style="stroke: #000000; stroke-width: 2.0;" width="493.5" x="157.5" y="219.3965"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="90.2422" style="stroke: #000000; stroke-width: 2.0;" width="473.5" x="167.5" y="243.707"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="657.5" x="167.5" y="354.9492"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="2011.9492" style="stroke: #000000; stroke-width: 2.0;" width="1339.5" x="157.5" y="526.502"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="128.2422" style="stroke: #000000; stroke-width: 2.0;" width="657.5" x="167.5" y="1029.0234"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="410" x="167.5" y="1590.7871"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="299.7266" style="stroke: #000000; stroke-width: 2.0;" width="1319.5" x="167.5" y="1679.7188"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="538.0059" style="stroke: #000000; stroke-width: 2.0;" width="809.5" x="167.5" y="1993.4453"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="74" x2="74" y1="118.7754" y2="2562.4512"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="233.5" x2="233.5" y1="118.7754" y2="2562.4512"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="641" x2="641" y1="118.7754" y2="2562.4512"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="764" x2="764" y1="118.7754" y2="2562.4512"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="896" x2="896" y1="118.7754" y2="2562.4512"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1012" x2="1012" y1="118.7754" y2="2562.4512"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1386" x2="1386" y1="118.7754" y2="2562.4512"/><rect fill="#FEFECE" filter="url(#f1b88zthp48eu0)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="27" y="62.7988"/><rect fill="#FEFECE" filter="url(#f1b88zthp48eu0)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="23" y="66.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="30" y="87.334">topic-bulk-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="75" x="32.5" y="103.8223">processing</text><rect fill="#FEFECE" filter="url(#f1b88zthp48eu0)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="27" y="2561.4512"/><rect fill="#FEFECE" filter="url(#f1b88zthp48eu0)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="23" y="2565.4512"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="30" y="2585.9863">topic-bulk-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="75" x="32.5" y="2602.4746">processing</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="107" x="177.5" y="99.334">Bulk Processing</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="204" y="115.8223">Handler</text><ellipse cx="234" cy="69.7988" fill="#FEFECE" filter="url(#f1b88zthp48eu0)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="230,57.7988,236,52.7988,234,57.7988,236,62.7988,230,57.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="107" x="177.5" y="2574.9863">Bulk Processing</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="204" y="2591.4746">Handler</text><ellipse cx="234" cy="2610.4277" fill="#FEFECE" filter="url(#f1b88zthp48eu0)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="230,2598.4277,236,2593.4277,234,2598.4277,236,2603.4277,230,2598.4277" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f1b88zthp48eu0)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="582" y="62.7988"/><rect fill="#FEFECE" filter="url(#f1b88zthp48eu0)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="578" y="66.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="585" y="87.334">topic-transfer-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="610" y="103.8223">prepare</text><rect fill="#FEFECE" filter="url(#f1b88zthp48eu0)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="582" y="2561.4512"/><rect fill="#FEFECE" filter="url(#f1b88zthp48eu0)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="578" y="2565.4512"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="585" y="2585.9863">topic-transfer-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="610" y="2602.4746">prepare</text><rect fill="#FEFECE" filter="url(#f1b88zthp48eu0)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="718" y="79.2871"/><rect fill="#FEFECE" filter="url(#f1b88zthp48eu0)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="714" y="83.2871"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="721" y="103.8223">topic-event</text><rect fill="#FEFECE" filter="url(#f1b88zthp48eu0)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="718" y="2561.4512"/><rect fill="#FEFECE" filter="url(#f1b88zthp48eu0)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="714" y="2565.4512"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="721" y="2585.9863">topic-event</text><rect fill="#FEFECE" filter="url(#f1b88zthp48eu0)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="134" x="829" y="79.2871"/><rect fill="#FEFECE" filter="url(#f1b88zthp48eu0)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="134" x="825" y="83.2871"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="120" x="832" y="103.8223">topic-notification</text><rect fill="#FEFECE" filter="url(#f1b88zthp48eu0)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="134" x="829" y="2561.4512"/><rect fill="#FEFECE" filter="url(#f1b88zthp48eu0)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="134" x="825" y="2565.4512"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="120" x="832" y="2585.9863">topic-notification</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="64" x="977" y="115.8223">Bulk DAO</text><ellipse cx="1012" cy="86.2871" fill="#FEFECE" filter="url(#f1b88zthp48eu0)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1000" x2="1024" y1="100.2871" y2="100.2871"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="64" x="977" y="2574.9863">Bulk DAO</text><ellipse cx="1012" cy="2593.9395" fill="#FEFECE" filter="url(#f1b88zthp48eu0)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1000" x2="1024" y1="2607.9395" y2="2607.9395"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1338" y="115.8223">Central Store</text><path d="M1368,66.2871 C1368,56.2871 1386,56.2871 1386,56.2871 C1386,56.2871 1404,56.2871 1404,66.2871 L1404,92.2871 C1404,102.2871 1386,102.2871 1386,102.2871 C1386,102.2871 1368,102.2871 1368,92.2871 L1368,66.2871 " fill="#FEFECE" filter="url(#f1b88zthp48eu0)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1368,66.2871 C1368,76.2871 1386,76.2871 1386,76.2871 C1386,76.2871 1404,76.2871 1404,66.2871 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1338" y="2574.9863">Central Store</text><path d="M1368,2587.9395 C1368,2577.9395 1386,2577.9395 1386,2577.9395 C1386,2577.9395 1404,2577.9395 1404,2587.9395 L1404,2613.9395 C1404,2623.9395 1386,2623.9395 1386,2623.9395 C1386,2623.9395 1368,2623.9395 1368,2613.9395 L1368,2587.9395 " fill="#FEFECE" filter="url(#f1b88zthp48eu0)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1368,2587.9395 C1368,2597.9395 1386,2597.9395 1386,2597.9395 C1386,2597.9395 1404,2597.9395 1404,2587.9395 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="69" y="174.3965"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="2423.6758" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="229" y="128.7754"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="891" y="2493.4512"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1007" y="565.123"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1007" y="862.1602"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="167.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1007" y="1185.5762"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1007" y="1849.5137"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1381" y="594.4336"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1381" y="891.4707"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1381" y="1214.8867"/><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1381" y="1878.8242"/><path d="M13,135.7754 L289,135.7754 L289,142.7754 L279,152.7754 L13,152.7754 L13,135.7754 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2409.6758" style="stroke: #000000; stroke-width: 2.0;" width="1494" x="13" y="135.7754"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="231" x="28" y="149.3438">Bulk Processing Handler Consume</text><polygon fill="#A80036" points="90,170.3965,80,174.3965,90,178.3965,86,174.3965" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="84" x2="228" y1="174.3965" y2="174.3965"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="96" y="169.6543">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="109" y="169.6543">Consume message</text><path d="M157.5,219.3965 L241.5,219.3965 L241.5,226.3965 L231.5,236.3965 L157.5,236.3965 L157.5,219.3965 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="121.5527" style="stroke: #000000; stroke-width: 2.0;" width="493.5" x="157.5" y="219.3965"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="172.5" y="232.9648">break</text><path d="M167.5,243.707 L309.5,243.707 L309.5,250.707 L299.5,260.707 L167.5,260.707 L167.5,243.707 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="90.2422" style="stroke: #000000; stroke-width: 2.0;" width="473.5" x="167.5" y="243.707"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="182.5" y="257.2754">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="239" x2="281" y1="312.9492" y2="312.9492"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="281" x2="281" y1="312.9492" y2="325.9492"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="240" x2="281" y1="325.9492" y2="325.9492"/><polygon fill="#A80036" points="250,321.9492,240,325.9492,250,329.9492,246,325.9492" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="246" y="292.8965">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="259" y="277.5859">Validate event - Rule:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="259" y="292.8965">type == 'bulk-processing' &amp;&amp; action == 'bulk-processing'</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="259" y="308.207">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="343" y="308.207">2001</text><path d="M167.5,354.9492 L382.5,354.9492 L382.5,361.9492 L372.5,371.9492 L167.5,371.9492 L167.5,354.9492 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="657.5" x="167.5" y="354.9492"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="182.5" y="368.5176">Persist Event Information</text><polygon fill="#A80036" points="752.5,414.5703,762.5,418.5703,752.5,422.5703,756.5,418.5703" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="239" x2="758.5" y1="418.5703" y2="418.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="246" y="413.8281">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="259" y="413.8281">Publish event information</text><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="639.5" x="174.5" y="426.5703"/><polygon fill="#EEEEEE" points="174.5,426.5703,238.5,426.5703,238.5,433.5703,228.5,443.5703,174.5,443.5703,174.5,426.5703" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="187.5" y="441.1387">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="397.25" y="460.1387">Event Handler Consume {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/master/CentralServices/seq_diagrams/seq-event-9.1.0.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/master/CentralServices/seq_diagrams/seq-event-9.1.0.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="32" x="555.25" y="460.1387">9.1.0</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="555.25" x2="587.25" y1="462.1387" y2="462.1387"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="587.25" y="460.1387">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="401.25" y="475.4492"/><path d="M157.5,526.502 L316.5,526.502 L316.5,533.502 L306.5,543.502 L157.5,543.502 L157.5,526.502 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2011.9492" style="stroke: #000000; stroke-width: 2.0;" width="1339.5" x="157.5" y="526.502"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="114" x="172.5" y="540.0703">Process Message</text><polygon fill="#A80036" points="995,561.123,1005,565.123,995,569.123,999,565.123" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="239" x2="1001" y1="565.123" y2="565.123"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="246" y="560.3809">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="259" y="560.3809">Retrieve current state of Bulk Transfer</text><polygon fill="#A80036" points="1369,590.4336,1379,594.4336,1369,598.4336,1373,594.4336" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1017" x2="1375" y1="594.4336" y2="594.4336"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1024" y="589.6914">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="1037" y="589.6914">Retrieve current state of Bulk Transfer</text><polygon fill="#FFFFE0" filter="url(#f1b88zthp48eu0)" points="1305,607.4336,1467,607.4336,1477,626.4336,1467,645.4336,1305,645.4336,1295,626.4336,1305,607.4336" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1307" y="624.002">bulkTransfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="1307" y="639.3125">bulkTransferStateChange</text><polygon fill="#A80036" points="1028,668.3652,1018,672.3652,1028,676.3652,1024,672.3652" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1022" x2="1385" y1="672.3652" y2="672.3652"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1034" y="667.623">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="1047" y="667.623">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="114" x="1092" y="667.623">bulkTransferInfo</text><polygon fill="#A80036" points="250,697.6758,240,701.6758,250,705.6758,246,701.6758" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="244" x2="1011" y1="701.6758" y2="701.6758"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="256" y="696.9336">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="269" y="696.9336">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="114" x="314" y="696.9336">bulkTransferInfo</text><path d="M244,714.6758 L244,785.6758 L593,785.6758 L593,724.6758 L583,714.6758 L244,714.6758 " fill="#D3D3D3" filter="url(#f1b88zthp48eu0)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M583,714.6758 L583,724.6758 L593,724.6758 L583,714.6758 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="328" x="250" y="732.2441">Depending on the current state of the Bulk Transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="316" x="250" y="747.5547">determine success criteria - no individual transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="314" x="250" y="762.8652">should remain in what state(s)? Use the output for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="250" y="778.1758">the following...</text><polygon fill="#A80036" points="995,858.1602,1005,862.1602,995,866.1602,999,862.1602" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="239" x2="1001" y1="862.1602" y2="862.1602"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="246" y="834.4521">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="259" y="811.4863">Check if all individual transfers have been processed</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="259" y="826.7969">(fastest and least expensive method possible to be</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="301" x="259" y="842.1074">selected as it may be repeated 999 times before</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="259" y="857.418">the bulk transfer is ready for processing)</text><polygon fill="#A80036" points="1369,887.4707,1379,891.4707,1369,895.4707,1373,891.4707" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1017" x2="1375" y1="891.4707" y2="891.4707"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1024" y="886.7285">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="1037" y="886.7285">Check if all individual transfers have been processed</text><polygon fill="#FFFFE0" filter="url(#f1b88zthp48eu0)" points="1307,904.4707,1465,904.4707,1475,930.4707,1465,957.4707,1307,957.4707,1297,930.4707,1307,904.4707" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="1309" y="921.0391">bulkTransferAssociation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1309" y="936.3496">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1309" y="951.6602">transferStateChange</text><polygon fill="#A80036" points="1028,980.7129,1018,984.7129,1028,988.7129,1024,984.7129" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1022" x2="1385" y1="984.7129" y2="984.7129"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1034" y="979.9707">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="1056" y="979.9707">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="146" x="1101" y="979.9707">pendingTransfersList</text><polygon fill="#A80036" points="250,1010.0234,240,1014.0234,250,1018.0234,246,1014.0234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="244" x2="1011" y1="1014.0234" y2="1014.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="256" y="1009.2813">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="278" y="1009.2813">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="146" x="323" y="1009.2813">pendingTransfersList</text><path d="M167.5,1029.0234 L251.5,1029.0234 L251.5,1036.0234 L241.5,1046.0234 L167.5,1046.0234 L167.5,1029.0234 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="128.2422" style="stroke: #000000; stroke-width: 2.0;" width="657.5" x="167.5" y="1029.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="182.5" y="1042.5918">break</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="189" x="266.5" y="1041.6582">[pendingTransfersList.length &gt; 0]</text><rect fill="#FFFFFF" filter="url(#f1b88zthp48eu0)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="639.5" x="174.5" y="1071.334"/><polygon fill="#EEEEEE" points="174.5,1071.334,238.5,1071.334,238.5,1078.334,228.5,1088.334,174.5,1088.334,174.5,1071.334" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="187.5" y="1085.9023">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="417.25" y="1104.9023">Persist Event Information</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="421.25" y="1120.2129"/><polygon fill="#A80036" points="995,1181.5762,1005,1185.5762,995,1189.5762,999,1185.5762" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="239" x2="1001" y1="1185.5762" y2="1185.5762"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="246" y="1180.834">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="383" x="268" y="1180.834">Request to retrieve all individual transfers in the bulk (heavy)</text><polygon fill="#A80036" points="1369,1210.8867,1379,1214.8867,1369,1218.8867,1373,1214.8867" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1017" x2="1375" y1="1214.8867" y2="1214.8867"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1024" y="1210.1445">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="224" x="1046" y="1210.1445">Request all individual transfers info</text><polygon fill="#FFFFE0" filter="url(#f1b88zthp48eu0)" points="1307,1227.8867,1465,1227.8867,1475,1261.8867,1465,1296.8867,1307,1296.8867,1297,1261.8867,1307,1227.8867" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="1309" y="1244.4551">bulkTransferAssociation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1309" y="1259.7656">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1309" y="1275.0762">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1309" y="1290.3867">bulkTransfer</text><polygon fill="#A80036" points="1028,1319.4395,1018,1323.4395,1028,1327.4395,1024,1323.4395" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1022" x2="1385" y1="1323.4395" y2="1323.4395"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1034" y="1318.6973">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="1056" y="1318.6973">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="159" x="1101" y="1318.6973">individualTransfersInfo</text><polygon fill="#A80036" points="250,1348.75,240,1352.75,250,1356.75,246,1352.75" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="244" x2="1011" y1="1352.75" y2="1352.75"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="256" y="1348.0078">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="278" y="1348.0078">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="159" x="323" y="1348.0078">individualTransfersInfo</text><path d="M244,1365.75 L244,1574.75 L439,1574.75 L439,1375.75 L429,1365.75 L244,1365.75 " fill="#D3D3D3" filter="url(#f1b88zthp48eu0)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M429,1365.75 L429,1375.75 L439,1375.75 L429,1365.75 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="250" y="1383.3184">let receivedPrepareList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="250" y="1398.6289">let reservedList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="250" y="1413.9395">let receivedFulfilList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="250" y="1429.25">let committedList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="250" y="1444.5605">let failedList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="250" y="1459.8711">let reservedTimeoutList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="250" y="1475.1816">let receivedRejectList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="250" y="1490.4922">let abortedRejectedList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="250" y="1505.8027">let receivedErrorList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="250" y="1521.1133">let abortedErrorList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="250" y="1536.4238">let expiredPreparedList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="250" y="1551.7344">let expiredReservedList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="250" y="1567.0449">let invalidList = []</text><path d="M167.5,1590.7871 L241.5,1590.7871 L241.5,1597.7871 L231.5,1607.7871 L167.5,1607.7871 L167.5,1590.7871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="410" x="167.5" y="1590.7871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="182.5" y="1604.3555">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="316" x="256.5" y="1603.4219">[for each individualTransfer in individualTransfersInfo]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="239" x2="281" y1="1644.7188" y2="1644.7188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="281" x2="281" y1="1644.7188" y2="1657.7188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="240" x2="281" y1="1657.7188" y2="1657.7188"/><polygon fill="#A80036" points="250,1653.7188,240,1657.7188,250,1661.7188,246,1657.7188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="246" y="1632.3213">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="268" y="1624.666">Push individualTransfer to the appropriate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="268" y="1639.9766">list according to the transferState</text><path d="M167.5,1679.7188 L374.5,1679.7188 L374.5,1686.7188 L364.5,1696.7188 L167.5,1696.7188 L167.5,1679.7188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="299.7266" style="stroke: #000000; stroke-width: 2.0;" width="1319.5" x="167.5" y="1679.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="162" x="182.5" y="1693.2871">Process Agregated Data</text><path d="M244,1702.0293 L244,1819.0293 L592,1819.0293 L592,1712.0293 L582,1702.0293 L244,1702.0293 " fill="#D3D3D3" filter="url(#f1b88zthp48eu0)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M582,1702.0293 L582,1712.0293 L592,1712.0293 L582,1702.0293 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="250" y="1719.5977">Depending on the list counts, decide the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="250" y="1734.9082">following state for the entrire Bulk Transfer:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="327" x="250" y="1750.2188">RECEIVED, PENDING, PENDING_INVALID, ACCEPTED,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="294" x="250" y="1765.5293">PROCESSING, COMPLETED, REJECTED, INVALID.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="254" y="1780.8398"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="41" x="250" y="1796.1504">TODO</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="291" y="1796.1504">: Reduce the above list to the possible</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="250" y="1811.4609">states from Bulk Processing Handler.</text><polygon fill="#A80036" points="995,1845.5137,1005,1849.5137,995,1853.5137,999,1849.5137" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="239" x2="1001" y1="1849.5137" y2="1849.5137"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="246" y="1844.7715">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="268" y="1844.7715">Persist Bulk Transfer state</text><polygon fill="#A80036" points="1369,1874.8242,1379,1878.8242,1369,1882.8242,1373,1878.8242" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1017" x2="1375" y1="1878.8242" y2="1878.8242"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1024" y="1874.082">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="1046" y="1874.082">Persist Bulk Transfer state</text><polygon fill="#FFFFE0" filter="url(#f1b88zthp48eu0)" points="1305,1921.8242,1467,1921.8242,1477,1932.8242,1467,1944.8242,1305,1944.8242,1295,1932.8242,1305,1921.8242" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="1307" y="1938.3926">bulkTransferStateChange</text><polygon fill="#A80036" points="250,1967.4453,240,1971.4453,250,1975.4453,246,1971.4453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="244" x2="1011" y1="1971.4453" y2="1971.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="256" y="1966.7031">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="278" y="1966.7031">Return success</text><path d="M167.5,1993.4453 L359.5,1993.4453 L359.5,2000.4453 L349.5,2010.4453 L167.5,2010.4453 L167.5,1993.4453 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="538.0059" style="stroke: #000000; stroke-width: 2.0;" width="809.5" x="167.5" y="1993.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="147" x="182.5" y="2007.0137">Send Bulk Notification</text><path d="M244,2015.7559 L244,2055.7559 L613,2055.7559 L613,2025.7559 L603,2015.7559 L244,2015.7559 " fill="#D3D3D3" filter="url(#f1b88zthp48eu0)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M603,2015.7559 L603,2025.7559 L613,2025.7559 L603,2015.7559 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="318" x="250" y="2033.3242">Use individualTransfersInfo to complete individual</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="348" x="250" y="2048.6348">transfer results to be included in the response payload.</text><path d="M244,2070.377 L244,2447.377 L635,2447.377 L635,2080.377 L625,2070.377 L244,2070.377 " fill="#FFFF00" filter="url(#f1b88zthp48eu0)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M625,2070.377 L625,2080.377 L635,2080.377 L625,2070.377 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="250" y="2087.9453">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="250" y="2103.2559">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="266" y="2118.5664">id: &lt;bulkTransferMessage.bulkTransferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="266" y="2133.877">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="266" y="2149.1875">to: &lt;bulkTransferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="266" y="2164.498">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="266" y="2179.8086">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="282" y="2195.1191">headers: &lt;bulkTransferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="282" y="2210.4297">payload: &lt;bulkTransferWithIndividualTransferResult&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="266" y="2225.7402">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="266" y="2241.0508">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="282" y="2256.3613">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="298" y="2271.6719">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="298" y="2286.9824">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="298" y="2302.293">type: bulk-notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="298" y="2317.6035">action: bulk-notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="298" y="2332.9141">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="298" y="2348.2246">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="314" y="2363.5352">status: 'success',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="314" y="2378.8457">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="298" y="2394.1563">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="282" y="2409.4668">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="266" y="2424.7773">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="250" y="2440.0879">}</text><polygon fill="#A80036" points="879,2489.4512,889,2493.4512,879,2497.4512,883,2493.4512" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="239" x2="885" y1="2493.4512" y2="2493.4512"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="246" y="2481.0537">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="268" y="2473.3984">Publish Notification event for Payer/Payee</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="268" y="2488.709">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="352" y="2488.709">2003</text><!--
@startuml
title 1.1.3. Bulk Processing Handler Consume

autonumber


collections "topic-bulk-\nprocessing" as TOPIC_BULK_PROCESSING
control "Bulk Processing\nHandler" as BULK_PROC_HANDLER
collections "topic-transfer-\nprepare" as TOPIC_TRANSFER_PREPARE
collections "topic-event" as TOPIC_EVENTS
collections "topic-notification" as TOPIC_NOTIFICATION
entity "Bulk DAO" as BULK_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_BULK_PROCESSING
    participant BULK_PROC_HANDLER
    participant TOPIC_TRANSFER_PREPARE
    participant TOPIC_EVENTS
    participant TOPIC_NOTIFICATION
    participant BULK_DAO
    participant DB
end box

activate BULK_PROC_HANDLER
group Bulk Processing Handler Consume
    TOPIC_BULK_PROCESSING <- BULK_PROC_HANDLER: Consume message
    activate TOPIC_BULK_PROCESSING
    deactivate TOPIC_BULK_PROCESSING

    break
        group Validate Event
            BULK_PROC_HANDLER <-> BULK_PROC_HANDLER: Validate event - Rule:\ntype == 'bulk-processing' && action == 'bulk-processing'\n<color #FF0000><b>Error codes:</b> 2001</color>
        end
    end

    group Persist Event Information
        |||
        BULK_PROC_HANDLER -> TOPIC_EVENTS: Publish event information
        ref over BULK_PROC_HANDLER, TOPIC_EVENTS:  Event Handler Consume {[[https://github.com/mojaloop/docs/blob/master/CentralServices/seq_diagrams/seq-event-9.1.0.svg 9.1.0]]} \n
        |||
    end

    group Process Message
        BULK_PROC_HANDLER -> BULK_DAO: Retrieve current state of Bulk Transfer
        activate BULK_DAO
        BULK_DAO -> DB: Retrieve current state of Bulk Transfer
        activate DB
        hnote over DB #lightyellow
            bulkTransfer
            bulkTransferStateChange
        end note
        BULK_DAO <- - DB: Return **bulkTransferInfo**
        deactivate DB
        BULK_PROC_HANDLER <- - BULK_DAO: Return **bulkTransferInfo**
        deactivate BULK_DAO

        note right of BULK_PROC_HANDLER #lightgrey
            Depending on the current state of the Bulk Transfer,
            determine success criteria - no individual transfer
            should remain in what state(s)? Use the output for
            the following...
        end note

        BULK_PROC_HANDLER -> BULK_DAO: Check if all individual transfers have been processed\n(fastest and least expensive method possible to be\nselected as it may be repeated 999 times before\nthe bulk transfer is ready for processing)
        activate BULK_DAO
        BULK_DAO -> DB: Check if all individual transfers have been processed
        activate DB
        hnote over DB #lightyellow
            bulkTransferAssociation
            transfer
            transferStateChange
        end note
        BULK_DAO <- - DB: Return **pendingTransfersList**
        deactivate DB
        BULK_PROC_HANDLER <- - BULK_DAO: Return **pendingTransfersList**
        deactivate BULK_DAO

        break pendingTransfersList.length > 0
            |||
            ref over BULK_PROC_HANDLER, TOPIC_EVENTS: Persist Event Information\n
            |||
        end

        BULK_PROC_HANDLER -> BULK_DAO: Request to retrieve all individual transfers in the bulk (heavy)
        activate BULK_DAO
        BULK_DAO -> DB: Request all individual transfers info
        activate DB
        hnote over DB #lightyellow
            bulkTransferAssociation
            transfer
            transferStateChange
            bulkTransfer
        end note
        BULK_DAO <- - DB: Return **individualTransfersInfo**
        deactivate DB
        BULK_PROC_HANDLER <- - BULK_DAO: Return **individualTransfersInfo**
        deactivate BULK_DAO

        note right of BULK_PROC_HANDLER #lightgrey
            let receivedPrepareList = []
            let reservedList = []
            let receivedFulfilList = []
            let committedList = []
            let failedList = []
            let reservedTimeoutList = []
            let receivedRejectList = []
            let abortedRejectedList = []
            let receivedErrorList = []
            let abortedErrorList = []
            let expiredPreparedList = []
            let expiredReservedList = []
            let invalidList = []
        end note
        loop for each individualTransfer in individualTransfersInfo
            BULK_PROC_HANDLER -> BULK_PROC_HANDLER: Push individualTransfer to the appropriate\nlist according to the transferState
        end

        group Process Agregated Data
            note right of BULK_PROC_HANDLER #lightgrey
                Depending on the list counts, decide the
                following state for the entrire Bulk Transfer:
                RECEIVED, PENDING, PENDING_INVALID, ACCEPTED,
                PROCESSING, COMPLETED, REJECTED, INVALID.

                **<color #red>TODO</color>**: Reduce the above list to the possible
                states from Bulk Processing Handler.
            end note

            BULK_PROC_HANDLER -> BULK_DAO: Persist Bulk Transfer state
            activate BULK_DAO
            BULK_DAO -> DB: Persist Bulk Transfer state
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                bulkTransferStateChange
            end note
            BULK_PROC_HANDLER <- - BULK_DAO: Return success
            deactivate BULK_DAO
        end

        group Send Bulk Notification
            note right of BULK_PROC_HANDLER #lightgrey
                Use individualTransfersInfo to complete individual
                transfer results to be included in the response payload.
            end note
            note right of BULK_PROC_HANDLER #yellow
                Message:
                {
                    id: <bulkTransferMessage.bulkTransferId>
                    from: <ledgerName>,
                    to: <bulkTransferMessage.payerFsp>,
                    type: application/json
                    content: {
                        headers: <bulkTransferHeaders>,
                        payload: <bulkTransferWithIndividualTransferResult>
                    },
                    metadata: {
                        event: {
                            id: <uuid>,
                            responseTo: <previous.uuid>,
                            type: bulk-notification,
                            action: bulk-notification,
                            createdAt: <timestamp>,
                            state: {
                                status: 'success',
                                code: 0
                            }
                        }
                    }
                }
            end note
            BULK_PROC_HANDLER -> TOPIC_NOTIFICATION: Publish Notification event for Payer/Payee\n<color #FF0000><b>Error codes:</b> 2003</color>
            activate TOPIC_NOTIFICATION
            deactivate TOPIC_NOTIFICATION
        end
    end
end
deactivate BULK_PROC_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.14.4
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>