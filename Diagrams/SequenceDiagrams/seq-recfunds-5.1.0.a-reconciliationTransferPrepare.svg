<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1228px" preserveAspectRatio="none" style="width:646px;height:1228px;" version="1.1" viewBox="0 0 646 1228" width="646px" zoomAndPan="magnify"><defs><filter height="300%" id="fmgil613eyh4x" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="503" x="72" y="23.5352">5.1.0.a. Reconciliation transfer prepare (reconciliationTransferPrepare)</text><rect fill="#FFFFE0" height="1183.3535" style="stroke: #A80036; stroke-width: 1.0;" width="386.5" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="161.75" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#fmgil613eyh4x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="348.5" y="171.9082"/><rect fill="#FFFFFF" filter="url(#fmgil613eyh4x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="348.5" y="341.082"/><rect fill="#FFFFFF" filter="url(#fmgil613eyh4x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="348.5" y="679.7637"/><rect fill="#FFFFFF" filter="url(#fmgil613eyh4x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="348.5" y="925.4902"/><rect fill="#FFFFFF" filter="url(#fmgil613eyh4x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="348.5" y="1064.043"/><rect fill="#FFFFFF" filter="url(#fmgil613eyh4x)" height="1002.0664" style="stroke: #000000; stroke-width: 2.0;" width="621" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#fmgil613eyh4x)" height="141.5078" style="stroke: #000000; stroke-width: 2.0;" width="332" x="67" y="509.9453"/><rect fill="#FFFFFF" height="69.5762" style="stroke: none; stroke-width: 1.0;" width="332" x="67" y="581.877"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="72" x2="72" y1="116.2871" y2="1152.3535"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="353.5" x2="353.5" y1="116.2871" y2="1152.3535"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="23" y="113.334">Transfer DAO</text><ellipse cx="72.5" cy="83.7988" fill="#FEFECE" filter="url(#fmgil613eyh4x)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="60.5" x2="84.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="23" y="1164.8887">Transfer DAO</text><ellipse cx="72.5" cy="1183.8418" fill="#FEFECE" filter="url(#fmgil613eyh4x)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="60.5" x2="84.5" y1="1197.8418" y2="1197.8418"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="305.5" y="113.334">Central Store</text><path d="M335.5,63.7988 C335.5,53.7988 353.5,53.7988 353.5,53.7988 C353.5,53.7988 371.5,53.7988 371.5,63.7988 L371.5,89.7988 C371.5,99.7988 353.5,99.7988 353.5,99.7988 C353.5,99.7988 335.5,99.7988 335.5,89.7988 L335.5,63.7988 " fill="#FEFECE" filter="url(#fmgil613eyh4x)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M335.5,63.7988 C335.5,73.7988 353.5,73.7988 353.5,73.7988 C353.5,73.7988 371.5,73.7988 371.5,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="305.5" y="1164.8887">Central Store</text><path d="M335.5,1177.8418 C335.5,1167.8418 353.5,1167.8418 353.5,1167.8418 C353.5,1167.8418 371.5,1167.8418 371.5,1177.8418 L371.5,1203.8418 C371.5,1213.8418 353.5,1213.8418 353.5,1213.8418 C353.5,1213.8418 335.5,1213.8418 335.5,1203.8418 L335.5,1177.8418 " fill="#FEFECE" filter="url(#fmgil613eyh4x)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M335.5,1177.8418 C335.5,1187.8418 353.5,1187.8418 353.5,1187.8418 C353.5,1187.8418 371.5,1187.8418 371.5,1177.8418 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fmgil613eyh4x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="348.5" y="171.9082"/><rect fill="#FFFFFF" filter="url(#fmgil613eyh4x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="348.5" y="341.082"/><rect fill="#FFFFFF" filter="url(#fmgil613eyh4x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="348.5" y="679.7637"/><rect fill="#FFFFFF" filter="url(#fmgil613eyh4x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="348.5" y="925.4902"/><rect fill="#FFFFFF" filter="url(#fmgil613eyh4x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="348.5" y="1064.043"/><path d="M13,133.2871 L354,133.2871 L354,140.2871 L344,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1002.0664" style="stroke: #000000; stroke-width: 2.0;" width="621" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="296" x="28" y="146.8555">reconciliationTransferPrepare (payload, trx)</text><polygon fill="#A80036" points="336.5,167.9082,346.5,171.9082,336.5,175.9082,340.5,171.9082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="72.5" x2="342.5" y1="171.9082" y2="171.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="79.5" y="167.166">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="92.5" y="167.166">Insert transfer</text><polygon fill="#FFFFE0" filter="url(#fmgil613eyh4x)" points="143,214.9082,563,214.9082,573,263.9082,563,313.9082,143,313.9082,133,263.9082,143,214.9082" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="145" y="231.4766">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="54" x="229" y="231.4766">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="287" y="231.4766">(transferId, amount, currencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="161" y="246.7871">ilpCondition, expirationDate, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="145" y="262.0977">VALUES ({payload.transferId}, {payload.amount.amount},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="161" y="277.4082">{payload.amount.curency}, 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="400" x="161" y="292.7188">{new Date()+Config.INTERNAL_TRANSFER_VALIDITY_SECONDS},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="161" y="308.0293">{transactionTimestamp})</text><polygon fill="#A80036" points="336.5,337.082,346.5,341.082,336.5,345.082,340.5,341.082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="72.5" x2="342.5" y1="341.082" y2="341.082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="79.5" y="336.3398">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="222" x="92.5" y="336.3398">Retrieve hub reconciliation account</text><polygon fill="#FFFFE0" filter="url(#fmgil613eyh4x)" points="172,384.082,535,384.082,545,426.082,535,468.082,172,468.082,162,426.082,172,384.082" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="174" y="400.6504">SELECT participantCurrencyId AS reconciliationAccountId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="174" y="415.9609">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="214" y="415.9609">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="174" y="431.2715">WHERE participantId = 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="174" y="446.582">AND currencyId = {payload.amount.currency}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="174" y="461.8926">LIMIT 1</text><polygon fill="#A80036" points="83.5,490.9453,73.5,494.9453,83.5,498.9453,79.5,494.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="77.5" x2="352.5" y1="494.9453" y2="494.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="89.5" y="490.2031">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="102.5" y="490.2031">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="159" x="147.5" y="490.2031">reconciliationAccountId</text><path d="M67,509.9453 L129,509.9453 L129,516.9453 L119,526.9453 L67,526.9453 L67,509.9453 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="141.5078" style="stroke: #000000; stroke-width: 2.0;" width="332" x="67" y="509.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="82" y="523.5137">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="230" x="144" y="522.5801">[payload.action == 'RECORD_FUNDS_IN']</text><path d="M77,532.2559 L77,572.2559 L372,572.2559 L372,542.2559 L362,532.2559 L77,532.2559 " fill="#D3D3D3" filter="url(#fmgil613eyh4x)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M362,532.2559 L362,542.2559 L372,542.2559 L362,532.2559 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="83" y="549.8242">ledgerEntryTypeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="214" y="549.8242">= 'RECORD_FUNDS_IN'</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="52" x="83" y="565.1348">amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="139" y="565.1348">=</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="153" y="565.1348">payload.amount.amount</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="67" x2="399" y1="582.877" y2="582.877"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="301" x="72" y="593.5117">[payload.action == 'RECORD_FUNDS_OUT_PREPARE']</text><path d="M77,601.832 L77,641.832 L385,641.832 L385,611.832 L375,601.832 L77,601.832 " fill="#D3D3D3" filter="url(#fmgil613eyh4x)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M375,601.832 L375,611.832 L385,611.832 L375,601.832 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="83" y="619.4004">ledgerEntryTypeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="214" y="619.4004">= 'RECORD_FUNDS_OUT'</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="52" x="83" y="634.7109">amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="139" y="634.7109">=</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="153" y="634.7109">-payload.amount.amount</text><polygon fill="#A80036" points="336.5,675.7637,346.5,679.7637,336.5,683.7637,340.5,679.7637" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="72.5" x2="342.5" y1="679.7637" y2="679.7637"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="79.5" y="675.0215">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="92.5" y="675.0215">Insert transferParticipant records</text><polygon fill="#FFFFE0" filter="url(#fmgil613eyh4x)" points="92,722.7637,614,722.7637,624,810.7637,614,898.7637,92,898.7637,82,810.7637,92,722.7637" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="94" y="739.332">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="178" y="739.332">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="110" y="754.6426">(transferId, participantCurrencyId, transferParticipantRoleTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="110" y="769.9531">ledgerEntryTypeId, amount, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="371" x="94" y="785.2637">VALUES (payload.transferId, reconciliationAccountId, 'HUB',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="110" y="800.5742">{ledgerEntryTypeId}, {amount}, {transactionTimestamp})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="98" y="815.8848"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="94" y="831.1953">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="178" y="831.1953">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="110" y="846.5059">(transferId, participantCurrencyId, transferParticipantRoleTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="110" y="861.8164">ledgerEntryTypeId, amount, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="518" x="94" y="877.127">VALUES ({payload.transferId}, {payload.participantCurrencyId}, 'DFSP_SETTLEMENT',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="354" x="110" y="892.4375">{ledgerEntryTypeId}, {-amount}, {transactionTimestamp})</text><polygon fill="#A80036" points="336.5,921.4902,346.5,925.4902,336.5,929.4902,340.5,925.4902" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="72.5" x2="342.5" y1="925.4902" y2="925.4902"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="79.5" y="920.748">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="92.5" y="920.748">Insert transferStateChange record</text><polygon fill="#FFFFE0" filter="url(#fmgil613eyh4x)" points="192,968.4902,514,968.4902,524,1002.4902,514,1037.4902,192,1037.4902,182,1002.4902,192,968.4902" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="194" y="985.0586">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="278" y="985.0586">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="210" y="1000.3691">(transferId, transferStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="194" y="1015.6797">VALUES ({payload.transferId}, 'RECEIVED_PREPARE',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="210" y="1030.9902">{payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="336.5,1060.043,346.5,1064.043,336.5,1068.043,340.5,1064.043" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="72.5" x2="342.5" y1="1064.043" y2="1064.043"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="79.5" y="1059.3008">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="92.5" y="1059.3008">Save externalReference and extensions</text><polygon fill="#FFFFE0" filter="url(#fmgil613eyh4x)" points="296,1107.043,411,1107.043,421,1118.043,411,1130.043,296,1130.043,286,1118.043,296,1107.043" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="298" y="1123.6113">transferExtension</text><!--
@startuml
title 5.1.0.a. Reconciliation transfer prepare (reconciliationTransferPrepare)

autonumber


entity "Transfer DAO" as TRANSFER_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TRANSFER_DAO
    participant DB
end box

group reconciliationTransferPrepare (payload, trx)
    TRANSFER_DAO -> DB: Insert transfer
    activate DB
    deactivate DB
    hnote over DB #lightyellow
        INSERT INTO **transfer** (transferId, amount, currencyId,
            ilpCondition, expirationDate, createdDate)
        VALUES ({payload.transferId}, {payload.amount.amount},
            {payload.amount.curency}, 0,
            {new Date()+Config.INTERNAL_TRANSFER_VALIDITY_SECONDS},
            {transactionTimestamp})
    end hnote

    TRANSFER_DAO -> DB: Retrieve hub reconciliation account
    activate DB
    hnote over DB #lightyellow
        SELECT participantCurrencyId AS reconciliationAccountId
        FROM **participantCurrency**
        WHERE participantId = 1
        AND currencyId = {payload.amount.currency}
        LIMIT 1
    end hnote
    deactivate DB
    TRANSFER_DAO <- - DB: Return **reconciliationAccountId**

    alt payload.action == 'RECORD_FUNDS_IN'
        note right of TRANSFER_DAO #lightgray
            **ledgerEntryTypeId** = 'RECORD_FUNDS_IN'
            **amount** = <color #blue>payload.amount.amount</color>
        end note
    else payload.action == 'RECORD_FUNDS_OUT_PREPARE'
        note right of TRANSFER_DAO #lightgray
            **ledgerEntryTypeId** = 'RECORD_FUNDS_OUT'
            **amount** = <color #red>-payload.amount.amount</color>
        end note
    end

    TRANSFER_DAO -> DB: Insert transferParticipant records
    activate DB
    deactivate DB
    hnote over DB #lightyellow
        INSERT INTO **transferParticipant**
            (transferId, participantCurrencyId, transferParticipantRoleTypeId,
            ledgerEntryTypeId, amount, createdDate)
        VALUES (payload.transferId, reconciliationAccountId, 'HUB',
            {ledgerEntryTypeId}, {amount}, {transactionTimestamp})

        INSERT INTO **transferParticipant**
            (transferId, participantCurrencyId, transferParticipantRoleTypeId,
            ledgerEntryTypeId, amount, createdDate)
        VALUES ({payload.transferId}, {payload.participantCurrencyId}, 'DFSP_SETTLEMENT',
            {ledgerEntryTypeId}, {-amount}, {transactionTimestamp})
    end hnote

    TRANSFER_DAO -> DB: Insert transferStateChange record
    activate DB
    deactivate DB
    hnote over DB #lightyellow
        INSERT INTO **transferStateChange**
            (transferId, transferStateId, reason, createdDate)
        VALUES ({payload.transferId}, 'RECEIVED_PREPARE',
            {payload.reason}, {transactionTimestamp})
    end hnote

    TRANSFER_DAO -> DB: Save externalReference and extensions
    activate DB
    deactivate DB
    hnote over DB #lightyellow
        transferExtension
    end hnote
end
@enduml

PlantUML version 1.2018.05(Sat May 05 22:00:17 CEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>