<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1783px" preserveAspectRatio="none" style="width:654px;height:1783px;" version="1.1" viewBox="0 0 654 1783" width="654px" zoomAndPan="magnify"><defs><filter height="300%" id="fj8xt5b8blzxt" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="555" x="50" y="23.5352">5.1.0.b. Transfer state and position change (transferStateAndPositionChange)</text><rect fill="#FFFFE0" height="1738.1992" style="stroke: #A80036; stroke-width: 1.0;" width="344.5" x="35" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="156.75" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#fj8xt5b8blzxt)" height="521.9375" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="322.5" y="318.3926"/><rect fill="#FFFFFF" filter="url(#fj8xt5b8blzxt)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="322.5" y="869.6406"/><rect fill="#FFFFFF" filter="url(#fj8xt5b8blzxt)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="322.5" y="1071.8145"/><rect fill="#FFFFFF" filter="url(#fj8xt5b8blzxt)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="322.5" y="1388.8516"/><rect fill="#FFFFFF" filter="url(#fj8xt5b8blzxt)" height="1556.9121" style="stroke: #000000; stroke-width: 2.0;" width="629" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#fj8xt5b8blzxt)" height="303.0371" style="stroke: #000000; stroke-width: 2.0;" width="527" x="29" y="962.5723"/><rect fill="#FFFFFF" filter="url(#fj8xt5b8blzxt)" height="56.6211" style="stroke: #000000; stroke-width: 2.0;" width="309" x="83" y="986.8828"/><rect fill="#FFFFFF" filter="url(#fj8xt5b8blzxt)" height="303.0371" style="stroke: #000000; stroke-width: 2.0;" width="525" x="29" y="1279.6094"/><rect fill="#FFFFFF" filter="url(#fj8xt5b8blzxt)" height="56.6211" style="stroke: #000000; stroke-width: 2.0;" width="309" x="83" y="1303.9199"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="88" x2="88" y1="116.2871" y2="1707.1992"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="327.5" x2="327.5" y1="116.2871" y2="1707.1992"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="39" y="113.334">Transfer DAO</text><ellipse cx="88.5" cy="83.7988" fill="#FEFECE" filter="url(#fj8xt5b8blzxt)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="76.5" x2="100.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="39" y="1719.7344">Transfer DAO</text><ellipse cx="88.5" cy="1738.6875" fill="#FEFECE" filter="url(#fj8xt5b8blzxt)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="76.5" x2="100.5" y1="1752.6875" y2="1752.6875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="279.5" y="113.334">Central Store</text><path d="M309.5,63.7988 C309.5,53.7988 327.5,53.7988 327.5,53.7988 C327.5,53.7988 345.5,53.7988 345.5,63.7988 L345.5,89.7988 C345.5,99.7988 327.5,99.7988 327.5,99.7988 C327.5,99.7988 309.5,99.7988 309.5,89.7988 L309.5,63.7988 " fill="#FEFECE" filter="url(#fj8xt5b8blzxt)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M309.5,63.7988 C309.5,73.7988 327.5,73.7988 327.5,73.7988 C327.5,73.7988 345.5,73.7988 345.5,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="279.5" y="1719.7344">Central Store</text><path d="M309.5,1732.6875 C309.5,1722.6875 327.5,1722.6875 327.5,1722.6875 C327.5,1722.6875 345.5,1722.6875 345.5,1732.6875 L345.5,1758.6875 C345.5,1768.6875 327.5,1768.6875 327.5,1768.6875 C327.5,1768.6875 309.5,1768.6875 309.5,1758.6875 L309.5,1732.6875 " fill="#FEFECE" filter="url(#fj8xt5b8blzxt)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M309.5,1732.6875 C309.5,1742.6875 327.5,1742.6875 327.5,1742.6875 C327.5,1742.6875 345.5,1742.6875 345.5,1732.6875 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fj8xt5b8blzxt)" height="521.9375" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="322.5" y="318.3926"/><rect fill="#FFFFFF" filter="url(#fj8xt5b8blzxt)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="322.5" y="869.6406"/><rect fill="#FFFFFF" filter="url(#fj8xt5b8blzxt)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="322.5" y="1071.8145"/><rect fill="#FFFFFF" filter="url(#fj8xt5b8blzxt)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="322.5" y="1388.8516"/><path d="M13,133.2871 L368,133.2871 L368,140.2871 L358,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1556.9121" style="stroke: #000000; stroke-width: 2.0;" width="629" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="310" x="28" y="146.8555">transferStateAndPositionUpdate (param1, trx)</text><path d="M93,155.5977 L93,287.5977 L366,287.5977 L366,165.5977 L356,155.5977 L93,155.5977 " fill="#D3D3D3" filter="url(#fj8xt5b8blzxt)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M356,155.5977 L356,165.5977 L366,165.5977 L356,155.5977 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="53" x="99" y="173.166">param1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="156" y="173.166">= {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="115" y="188.4766">transferId: {payload.transferId},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="115" y="203.7871">transferStateId: "enum",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157" x="115" y="219.0977">reason: {payload.reason},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="115" y="234.4082">createdDate: {transactionTimestamp},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="115" y="249.7188">drUpdated: "boolean",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="115" y="265.0293">crUpdated: "boolean"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="99" y="280.3398">}</text><polygon fill="#A80036" points="310.5,314.3926,320.5,318.3926,310.5,322.3926,314.5,318.3926" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="88.5" x2="316.5" y1="318.3926" y2="318.3926"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="95.5" y="313.6504">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="108.5" y="313.6504">Select all required info</text><polygon fill="#FFFFE0" filter="url(#fj8xt5b8blzxt)" points="102,331.3926,553,331.3926,563,572.3926,553,813.3926,102,813.3926,92,572.3926,102,331.3926" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="104" y="347.9609">SELECT dr.participantCurrencyId AS drAccountId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="420" x="120" y="363.2715">dr.amount AS drAmount, drp.participantPositionId AS drPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="431" x="120" y="378.582">drp.value AS drPositionValue, drp.reservedValue AS drReservedValue,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="120" y="393.8926">cr.participantCurrencyId AS crAccountId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="416" x="120" y="409.2031">cr.amount AS crAmount, crp.participantPositionId AS crPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="427" x="120" y="424.5137">crp.value AS crPositionValue, crp.reservedValue AS crReservedValue,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="120" y="439.8242">tsc.transferStateId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="104" y="455.1348">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="54" x="144" y="455.1348">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="202" y="455.1348">t</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="104" y="470.4453">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="136" y="470.4453">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="13" x="267" y="470.4453">dr</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="104" y="485.7559">ON dr.transferId = t.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="104" y="501.0664">AND dr.amount &lt; 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="104" y="516.377">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="136" y="516.377">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="276" y="516.377">drpc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="363" x="104" y="531.6875">ON drpc.participantCurrencyId = dr.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="104" y="546.998">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="136" y="546.998">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="267" y="546.998">drp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="356" x="104" y="562.3086">ON drp.participantCurrencyId = dr.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="104" y="577.6191">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="136" y="577.6191">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="267" y="577.6191">cr</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="104" y="592.9297">ON cr.transferId = t.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="104" y="608.2402">AND cr.amount &gt; 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="104" y="623.5508">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="136" y="623.5508">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="276" y="623.5508">crpc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="104" y="638.8613">ON crpc.participantCurrencyId = dr.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="104" y="654.1719">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="136" y="654.1719">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="20" x="267" y="654.1719">crp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="354" x="104" y="669.4824">ON crp.participantCurrencyId = cr.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="104" y="684.793">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="136" y="684.793">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="279" y="684.793">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="196" x="104" y="700.1035">ON tsc.transferId = t.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="104" y="715.4141">WHERE t.transferId = param1.tranferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="391" x="104" y="730.7246">AND drpc.ledgerAccountTypeId IN('POSITION', 'SETTLEMENT', '</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="377" x="120" y="746.0352">HUB_RECONCILIATION', 'HUB_MULTILATERAL_SETTLEMENT')</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="390" x="104" y="761.3457">AND crpc.ledgerAccountTypeId IN('POSITION', 'SETTLEMENT', '</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="377" x="120" y="776.6563">HUB_RECONCILIATION', 'HUB_MULTILATERAL_SETTLEMENT')</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="242" x="104" y="791.9668">ORDER BY transferStateChangeId DESC</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="104" y="807.2773">LIMIT 1</text><polygon fill="#A80036" points="99.5,836.3301,89.5,840.3301,99.5,844.3301,95.5,840.3301" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="93.5" x2="326.5" y1="840.3301" y2="840.3301"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="105.5" y="835.5879">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="118.5" y="835.5879">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="26" x="163.5" y="835.5879">info</text><polygon fill="#A80036" points="310.5,865.6406,320.5,869.6406,310.5,873.6406,314.5,869.6406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="88.5" x2="316.5" y1="869.6406" y2="869.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="95.5" y="864.8984">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="108.5" y="864.8984">Change transfer state</text><polygon fill="#FFFFE0" filter="url(#fj8xt5b8blzxt)" points="33,882.6406,622,882.6406,632,901.6406,622,920.6406,33,920.6406,23,901.6406,33,882.6406" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="35" y="899.209">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="119" y="899.209">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="262" y="899.209">(transferId, transferStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="585" x="35" y="914.5195">VALUES ({param1.transferId, {param1.transferStateId}, {param1.reason}, {param1.createdDate})</text><polygon fill="#A80036" points="99.5,943.5723,89.5,947.5723,99.5,951.5723,95.5,947.5723" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="93.5" x2="326.5" y1="947.5723" y2="947.5723"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="105.5" y="942.8301">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="118.5" y="942.8301">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="163.5" y="942.8301">transferStateChangeId</text><path d="M29,962.5723 L96,962.5723 L96,969.5723 L86,979.5723 L29,979.5723 L29,962.5723 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="303.0371" style="stroke: #000000; stroke-width: 2.0;" width="527" x="29" y="962.5723"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="44" y="976.1406">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="111" y="975.207">[param1.drUpdated == true]</text><path d="M83,986.8828 L150,986.8828 L150,993.8828 L140,1003.8828 L83,1003.8828 L83,986.8828 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="56.6211" style="stroke: #000000; stroke-width: 2.0;" width="309" x="83" y="986.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="98" y="1000.4512">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="222" x="165" y="999.5176">[param1.transferStateId == 'ABORTED']</text><path d="M93,1009.1934 L93,1034.1934 L324,1034.1934 L324,1019.1934 L314,1009.1934 L93,1009.1934 " fill="#D3D3D3" filter="url(#fj8xt5b8blzxt)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M314,1009.1934 L314,1019.1934 L324,1019.1934 L314,1009.1934 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="99" y="1026.7617">info.drAmount = -info.drAmount</text><polygon fill="#A80036" points="310.5,1067.8145,320.5,1071.8145,310.5,1075.8145,314.5,1071.8145" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="88.5" x2="316.5" y1="1071.8145" y2="1071.8145"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="95.5" y="1067.0723">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="108.5" y="1067.0723">Change DR position</text><polygon fill="#FFFFE0" filter="url(#fj8xt5b8blzxt)" points="119,1114.8145,536,1114.8145,546,1186.8145,536,1259.8145,119,1259.8145,109,1186.8145,119,1114.8145" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="121" y="1131.3828">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="175" y="1131.3828">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="322" x="121" y="1146.6934">SET value = {info.drPositionValue + info.drAmount}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="121" y="1162.0039">WHERE participantPositionId = {info.drPositionId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="125" y="1177.3145"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="121" y="1192.625">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="205" y="1192.625">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="388" y="1192.625">(participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="137" y="1207.9355">transferStateChangeId, value, reservedValue, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="327" x="121" y="1223.2461">VALUES ({info.drPositionId}, {transferStateChangeId},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="397" x="137" y="1238.5566">{info.drPositionValue + info.drAmount}, {info.drReservedValue},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="137" y="1253.8672">{param1.createdDate})</text><path d="M29,1279.6094 L96,1279.6094 L96,1286.6094 L86,1296.6094 L29,1296.6094 L29,1279.6094 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="303.0371" style="stroke: #000000; stroke-width: 2.0;" width="525" x="29" y="1279.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="44" y="1293.1777">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="111" y="1292.2441">[param1.crUpdated == true]</text><path d="M83,1303.9199 L150,1303.9199 L150,1310.9199 L140,1320.9199 L83,1320.9199 L83,1303.9199 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="56.6211" style="stroke: #000000; stroke-width: 2.0;" width="309" x="83" y="1303.9199"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="98" y="1317.4883">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="222" x="165" y="1316.5547">[param1.transferStateId == 'ABORTED']</text><path d="M93,1326.2305 L93,1351.2305 L322,1351.2305 L322,1336.2305 L312,1326.2305 L93,1326.2305 " fill="#D3D3D3" filter="url(#fj8xt5b8blzxt)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M312,1326.2305 L312,1336.2305 L322,1336.2305 L312,1326.2305 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="99" y="1343.7988">info.crAmount = -info.crAmount</text><polygon fill="#A80036" points="310.5,1384.8516,320.5,1388.8516,310.5,1392.8516,314.5,1388.8516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="88.5" x2="316.5" y1="1388.8516" y2="1388.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="95.5" y="1384.1094">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="108.5" y="1384.1094">Change CR position</text><polygon fill="#FFFFE0" filter="url(#fj8xt5b8blzxt)" points="120,1431.8516,534,1431.8516,544,1503.8516,534,1576.8516,120,1576.8516,110,1503.8516,120,1431.8516" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="122" y="1448.4199">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="176" y="1448.4199">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="122" y="1463.7305">SET value = {info.crPositionValue + info.crAmount}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="122" y="1479.041">WHERE participantPositionId = {info.crPositionId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="126" y="1494.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="122" y="1509.6621">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="206" y="1509.6621">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="389" y="1509.6621">(participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="138" y="1524.9727">transferStateChangeId, value, reservedValue, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="326" x="122" y="1540.2832">VALUES ({info.crPositionId}, {transferStateChangeId},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="394" x="138" y="1555.5938">{info.crPositionValue + info.crAmount}, {info.crReservedValue},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="138" y="1570.9043">{param1.createdDate})</text><path d="M93,1594.6465 L93,1680.6465 L481,1680.6465 L481,1604.6465 L471,1594.6465 L93,1594.6465 " fill="#D3D3D3" filter="url(#fj8xt5b8blzxt)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M471,1594.6465 L471,1604.6465 L481,1604.6465 L471,1594.6465 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="99" y="1612.2148">return</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="146" y="1612.2148">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="115" y="1627.5254">transferStateChangeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="351" x="115" y="1642.8359">drPositionValue: {info.drPositionValue + info.drAmount}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="348" x="115" y="1658.1465">crPositionValue: {info.crPositionValue + info.crAmount}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="99" y="1673.457">}</text><!--
@startuml
title 5.1.0.b. Transfer state and position change (transferStateAndPositionChange)

autonumber


entity "Transfer DAO" as TRANSFER_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TRANSFER_DAO
    participant DB
end box

group transferStateAndPositionUpdate (param1, trx)
    note right of TRANSFER_DAO #lightgray
        **param1** = {
            transferId: {payload.transferId},
            transferStateId: "enum",
            reason: {payload.reason},
            createdDate: {transactionTimestamp},
            drUpdated: "boolean",
            crUpdated: "boolean"
        }
    end note

    TRANSFER_DAO -> DB: Select all required info
    activate DB
    hnote over DB #lightyellow
        SELECT dr.participantCurrencyId AS drAccountId,
            dr.amount AS drAmount, drp.participantPositionId AS drPositionId,
            drp.value AS drPositionValue, drp.reservedValue AS drReservedValue,
            cr.participantCurrencyId AS crAccountId,
            cr.amount AS crAmount, crp.participantPositionId AS crPositionId,
            crp.value AS crPositionValue, crp.reservedValue AS crReservedValue,
            tsc.transferStateId
        FROM **transfer** t
        JOIN **transferParticipant** dr
        ON dr.transferId = t.transferId
        AND dr.amount < 0
        JOIN **participantCurrency** drpc
        ON drpc.participantCurrencyId = dr.participantCurrencyId
        JOIN **participantPosition** drp
        ON drp.participantCurrencyId = dr.participantCurrencyId
        JOIN **transferParticipant** cr
        ON cr.transferId = t.transferId
        AND cr.amount > 0
        JOIN **participantCurrency** crpc
        ON crpc.participantCurrencyId = dr.participantCurrencyId
        JOIN **participantPosition** crp
        ON crp.participantCurrencyId = cr.participantCurrencyId
        JOIN **transferStateChange** tsc
        ON tsc.transferId = t.transferId
        WHERE t.transferId = param1.tranferId
        AND drpc.ledgerAccountTypeId IN('POSITION', 'SETTLEMENT', '
            HUB_RECONCILIATION', 'HUB_MULTILATERAL_SETTLEMENT')
        AND crpc.ledgerAccountTypeId IN('POSITION', 'SETTLEMENT', '
            HUB_RECONCILIATION', 'HUB_MULTILATERAL_SETTLEMENT')
        ORDER BY transferStateChangeId DESC
        LIMIT 1
    end hnote
    TRANSFER_DAO <- - DB: Return **info**
    deactivate DB

    TRANSFER_DAO -> DB: Change transfer state
    activate DB
    hnote over DB #lightyellow
        INSERT INTO **transferStateChange** (transferId, transferStateId, reason, createdDate)
        VALUES ({param1.transferId, {param1.transferStateId}, {param1.reason}, {param1.createdDate})
    end hnote
    TRANSFER_DAO <- - DB: Return **transferStateChangeId**
    deactivate DB

    opt param1.drUpdated == true
        opt param1.transferStateId == 'ABORTED'
            note right of TRANSFER_DAO #lightgray
                info.drAmount = -info.drAmount
            end note
        end

        TRANSFER_DAO -> DB: Change DR position
        activate DB
        deactivate DB
        hnote over DB #lightyellow
            UPDATE **participantPosition**
            SET value = {info.drPositionValue + info.drAmount}
            WHERE participantPositionId = {info.drPositionId}

            INSERT INTO **participantPositionChange** (participantPositionId,
                transferStateChangeId, value, reservedValue, createdDate)
            VALUES ({info.drPositionId}, {transferStateChangeId},
                {info.drPositionValue + info.drAmount}, {info.drReservedValue},
                {param1.createdDate})
        end hnote
    end

    opt param1.crUpdated == true
        opt param1.transferStateId == 'ABORTED'
            note right of TRANSFER_DAO #lightgray
                info.crAmount = -info.crAmount
            end note
        end

        TRANSFER_DAO -> DB: Change CR position
        activate DB
        deactivate DB
        hnote over DB #lightyellow
            UPDATE **participantPosition**
            SET value = {info.crPositionValue + info.crAmount}
            WHERE participantPositionId = {info.crPositionId}

            INSERT INTO **participantPositionChange** (participantPositionId,
                transferStateChangeId, value, reservedValue, createdDate)
            VALUES ({info.crPositionId}, {transferStateChangeId},
                {info.crPositionValue + info.crAmount}, {info.crReservedValue},
                {param1.createdDate})
        end hnote
    end

    note right of TRANSFER_DAO #lightgray
        **return** {
            transferStateChangeId,
            drPositionValue: {info.drPositionValue + info.drAmount}
            crPositionValue: {info.crPositionValue + info.crAmount}
        }
    end note
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>