<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3735px" preserveAspectRatio="none" style="width:1617px;height:3735px;" version="1.1" viewBox="0 0 1617 3735" width="1617px" zoomAndPan="magnify"><defs><filter height="300%" id="f1k6ltftfhk18x" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="274" x="672.5" y="23.5352">5.1.1. Record Funds In (recordFundsIn)</text><rect fill="#FFB6C1" height="3690.1113" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="34.5" y="47.0566">Central HUB</text><rect fill="#FFFFE0" height="3690.1113" style="stroke: #A80036; stroke-width: 1.0;" width="1024" x="324" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="785.5" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="552.3164" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="377" y="507.8086"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="117.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="606" y="913.2617"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="3480.8242" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="804" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="2494.3652" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="950" y="1118.7461"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1291" y="1196.6777"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1291" y="1365.8516"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1291" y="1649.5781"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1291" y="1879.9941"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1291" y="2042.8574"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1291" y="2188.4102"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1291" y="2337.3418"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1291" y="2547.5156"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1291" y="2700.6895"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1291" y="2869.1738"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1291" y="3092.2793"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1291" y="3276.7637"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1291" y="3384.0059"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="3466.8242" style="stroke: #000000; stroke-width: 2.0;" width="1593" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="2451.0547" style="stroke: #000000; stroke-width: 2.0;" width="720.5" x="875.5" y="1133.7461"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="1101.6641" style="stroke: #000000; stroke-width: 2.0;" width="643.5" x="885.5" y="1158.0566"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="155.8633" style="stroke: #000000; stroke-width: 2.0;" width="581.5" x="895.5" y="2004.2363"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="171.1738" style="stroke: #000000; stroke-width: 2.0;" width="625.5" x="895.5" y="2298.7207"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="1068.9063" style="stroke: #000000; stroke-width: 2.0;" width="690.5" x="895.5" y="2508.8945"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="75" x2="75" y1="137.2871" y2="3638.1113"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="382" x2="382" y1="137.2871" y2="3638.1113"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="610.5" x2="610.5" y1="137.2871" y2="3638.1113"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="809" x2="809" y1="137.2871" y2="3638.1113"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="954.5" x2="954.5" y1="137.2871" y2="3638.1113"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1296" x2="1296" y1="137.2871" y2="3638.1113"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="23" y="134.334">Hub Employee</text><ellipse cx="75" cy="63.7988" fill="#FEFECE" filter="url(#f1k6ltftfhk18x)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M75,71.7988 L75,98.7988 M62,79.7988 L88,79.7988 M75,98.7988 L62,113.7988 M75,98.7988 L88,113.7988 " fill="none" filter="url(#f1k6ltftfhk18x)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="23" y="3650.6465">Hub Employee</text><ellipse cx="75" cy="3663.5996" fill="#FEFECE" filter="url(#f1k6ltftfhk18x)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M75,3671.5996 L75,3698.5996 M62,3679.5996 L88,3679.5996 M75,3698.5996 L62,3713.5996 M75,3698.5996 L88,3713.5996 " fill="none" filter="url(#f1k6ltftfhk18x)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102" x="328" y="117.8457">Central Service</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="345.5" y="134.334">Admin API</text><path d="M361.5,76.3105 L361.5,100.3105 M361.5,88.3105 L378.5,88.3105 " fill="none" filter="url(#f1k6ltftfhk18x)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="390.5" cy="88.3105" fill="#FEFECE" filter="url(#f1k6ltftfhk18x)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102" x="328" y="3650.6465">Central Service</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="345.5" y="3667.1348">Admin API</text><path d="M361.5,3674.0879 L361.5,3698.0879 M361.5,3686.0879 L378.5,3686.0879 " fill="none" filter="url(#f1k6ltftfhk18x)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="390.5" cy="3686.0879" fill="#FEFECE" filter="url(#f1k6ltftfhk18x)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#f1k6ltftfhk18x)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="525.5" y="97.7988"/><rect fill="#FEFECE" filter="url(#f1k6ltftfhk18x)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="521.5" y="101.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="157" x="528.5" y="122.334">Admin-Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f1k6ltftfhk18x)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="525.5" y="3637.1113"/><rect fill="#FEFECE" filter="url(#f1k6ltftfhk18x)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="521.5" y="3641.1113"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="157" x="528.5" y="3661.6465">Admin-Transfer-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="144" x="734" y="134.334">Admin Event Handler</text><ellipse cx="809" cy="104.7988" fill="#FEFECE" filter="url(#f1k6ltftfhk18x)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="805,92.7988,811,87.7988,809,92.7988,811,97.7988,805,92.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="144" x="734" y="3650.6465">Admin Event Handler</text><ellipse cx="809" cy="3669.5996" fill="#FEFECE" filter="url(#f1k6ltftfhk18x)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="805,3657.5996,811,3652.5996,809,3657.5996,811,3662.5996,805,3657.5996" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="905.5" y="134.334">Transfer DAO</text><ellipse cx="955" cy="104.7988" fill="#FEFECE" filter="url(#f1k6ltftfhk18x)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="943" x2="967" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="905.5" y="3650.6465">Transfer DAO</text><ellipse cx="955" cy="3669.5996" fill="#FEFECE" filter="url(#f1k6ltftfhk18x)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="943" x2="967" y1="3683.5996" y2="3683.5996"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1248" y="134.334">Central Store</text><path d="M1278,84.7988 C1278,74.7988 1296,74.7988 1296,74.7988 C1296,74.7988 1314,74.7988 1314,84.7988 L1314,110.7988 C1314,120.7988 1296,120.7988 1296,120.7988 C1296,120.7988 1278,120.7988 1278,110.7988 L1278,84.7988 " fill="#FEFECE" filter="url(#f1k6ltftfhk18x)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1278,84.7988 C1278,94.7988 1296,94.7988 1296,94.7988 C1296,94.7988 1314,94.7988 1314,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1248" y="3650.6465">Central Store</text><path d="M1278,3663.5996 C1278,3653.5996 1296,3653.5996 1296,3653.5996 C1296,3653.5996 1314,3653.5996 1314,3663.5996 L1314,3689.5996 C1314,3699.5996 1296,3699.5996 1296,3699.5996 C1296,3699.5996 1278,3699.5996 1278,3689.5996 L1278,3663.5996 " fill="#FEFECE" filter="url(#f1k6ltftfhk18x)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1278,3663.5996 C1278,3673.5996 1296,3673.5996 1296,3673.5996 C1296,3673.5996 1314,3673.5996 1314,3663.5996 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="552.3164" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="377" y="507.8086"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="117.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="606" y="913.2617"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="3480.8242" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="804" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="2494.3652" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="950" y="1118.7461"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1291" y="1196.6777"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1291" y="1365.8516"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1291" y="1649.5781"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1291" y="1879.9941"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1291" y="2042.8574"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1291" y="2188.4102"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1291" y="2337.3418"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1291" y="2547.5156"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1291" y="2700.6895"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1291" y="2869.1738"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1291" y="3092.2793"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1291" y="3276.7637"/><rect fill="#FFFFFF" filter="url(#f1k6ltftfhk18x)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1291" y="3384.0059"/><path d="M13,154.2871 L167,154.2871 L167,161.2871 L157,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3466.8242" style="stroke: #000000; stroke-width: 2.0;" width="1593" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="109" x="28" y="167.8555">Record Funds In</text><path d="M80,176.5977 L80,476.5977 L298,476.5977 L298,186.5977 L288,176.5977 L80,176.5977 " fill="#FFFF00" filter="url(#f1k6ltftfhk18x)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M288,176.5977 L288,186.5977 L298,186.5977 L288,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="86" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="102" y="209.4766">"transferId": &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="102" y="224.7871">"externalReference": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="102" y="240.0977">"action": "recordFundsIn",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="102" y="255.4082">"amount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="118" y="270.7188">"amount": &lt;decimal&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="118" y="286.0293">"currency": "string"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="90" y="301.3398"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="102" y="316.6504">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="102" y="331.9609">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="102" y="347.2715">"extensionList": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="118" y="362.582">"extension": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="377.8926">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="150" y="393.2031">"key": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="150" y="408.5137">"value": "string"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="423.8242">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="439.1348">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="102" y="454.4453">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="86" y="469.7559">}</text><polygon fill="#A80036" points="365,503.8086,375,507.8086,365,511.8086,369,507.8086" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="75" x2="371" y1="507.8086" y2="507.8086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="82" y="503.0664">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="95" y="503.0664">POST - /participants/{name}/accounts/{id}</text><path d="M392,520.8086 L392,866.8086 L626,866.8086 L626,530.8086 L616,520.8086 L392,520.8086 " fill="#FFFF00" filter="url(#f1k6ltftfhk18x)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M616,520.8086 L616,530.8086 L626,530.8086 L616,520.8086 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="398" y="538.377">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="398" y="553.6875">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="414" y="568.998">id: &lt;payload.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="414" y="584.3086">from: "dfspName",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="59" x="414" y="599.6191">to: "hub",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="414" y="614.9297">type: "application/json"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="414" y="630.2402">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="430" y="645.5508">headers: &lt;payloadHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="430" y="660.8613">payload: &lt;payloadMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="414" y="676.1719">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="414" y="691.4824">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="430" y="706.793">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="446" y="722.1035">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="446" y="737.4141">responseTo: "",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="446" y="752.7246">type: "transfer",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="446" y="768.0352">action: "recordFundsIn",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="446" y="783.3457">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="446" y="798.6563">state: ""</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="430" y="813.9668">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="414" y="829.2773">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="34" x="414" y="844.5879">pp: ""</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="398" y="859.8984">}</text><polygon fill="#A80036" points="594,909.2617,604,913.2617,594,917.2617,598,913.2617" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="387" x2="600" y1="913.2617" y2="913.2617"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="394" y="900.8643">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="407" y="893.209">Route &amp; Publish Prepare event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="407" y="908.5195">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="484" y="908.5195">2003</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="616" x2="658" y1="973.1934" y2="973.1934"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="658" x2="658" y1="973.1934" y2="986.1934"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="617" x2="658" y1="986.1934" y2="986.1934"/><polygon fill="#A80036" points="627,982.1934,617,986.1934,627,990.1934,623,986.1934" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="623" y="953.1406">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="636" y="937.8301">Ensure event is replicated</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="636" y="953.1406">as configured (ACKS=all)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="636" y="968.4512">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="713" y="968.4512">2003</text><polygon fill="#A80036" points="398,1026.8145,388,1030.8145,398,1034.8145,394,1030.8145" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="392" x2="610" y1="1030.8145" y2="1030.8145"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="404" y="1018.417">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="417" y="1010.7617">Respond replication acks</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="417" y="1026.0723">have been received</text><polygon fill="#A80036" points="86,1056.125,76,1060.125,86,1064.125,82,1060.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="80" x2="381" y1="1060.125" y2="1060.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="92" y="1055.3828">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="105" y="1055.3828">Respond HTTP - 202 (Accepted)</text><polygon fill="#A80036" points="622,1085.4355,612,1089.4355,622,1093.4355,618,1089.4355" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="616" x2="803" y1="1089.4355" y2="1089.4355"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="628" y="1084.6934">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="641" y="1084.6934">Consume message</text><polygon fill="#A80036" points="938,1114.7461,948,1118.7461,938,1122.7461,942,1118.7461" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="814" x2="944" y1="1118.7461" y2="1118.7461"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="821" y="1114.0039">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="834" y="1114.0039">Prepare transfer</text><path d="M875.5,1133.7461 L1040.5,1133.7461 L1040.5,1140.7461 L1030.5,1150.7461 L875.5,1150.7461 L875.5,1133.7461 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2451.0547" style="stroke: #000000; stroke-width: 2.0;" width="720.5" x="875.5" y="1133.7461"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="890.5" y="1147.3145">DB TRANSACTION</text><path d="M885.5,1158.0566 L1143.5,1158.0566 L1143.5,1165.0566 L1133.5,1175.0566 L885.5,1175.0566 L885.5,1158.0566 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1101.6641" style="stroke: #000000; stroke-width: 2.0;" width="643.5" x="885.5" y="1158.0566"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="213" x="900.5" y="1171.625">Reconciliation Transfer Prepare</text><polygon fill="#A80036" points="1279,1192.6777,1289,1196.6777,1279,1200.6777,1283,1196.6777" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="960" x2="1285" y1="1196.6777" y2="1196.6777"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="967" y="1191.9355">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="980" y="1191.9355">Insert transfer</text><polygon fill="#FFFFE0" filter="url(#f1k6ltftfhk18x)" points="1086,1239.6777,1506,1239.6777,1516,1288.6777,1506,1338.6777,1086,1338.6777,1076,1288.6777,1086,1239.6777" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1088" y="1256.2461">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="54" x="1172" y="1256.2461">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="1230" y="1256.2461">(transferId, amount, currencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="1104" y="1271.5566">ilpCondition, expirationDate, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="1088" y="1286.8672">VALUES ({payload.transferId}, {payload.amount.amount},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="1104" y="1302.1777">{payload.amount.curency}, 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="400" x="1104" y="1317.4883">{new Date()+Config.INTERNAL_TRANSFER_VALIDITY_SECONDS},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="1104" y="1332.7988">{transactionTimestamp})</text><polygon fill="#A80036" points="1279,1361.8516,1289,1365.8516,1279,1369.8516,1283,1365.8516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="960" x2="1285" y1="1365.8516" y2="1365.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="967" y="1361.1094">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="222" x="980" y="1361.1094">Retrieve hub reconciliation account</text><polygon fill="#FFFFE0" filter="url(#f1k6ltftfhk18x)" points="1114,1408.8516,1477,1408.8516,1487,1450.8516,1477,1492.8516,1114,1492.8516,1104,1450.8516,1114,1408.8516" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="1116" y="1425.4199">SELECT participantCurrencyId AS reconciliationAccountId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1116" y="1440.7305">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="1156" y="1440.7305">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="1116" y="1456.041">WHERE participantId = 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="1116" y="1471.3516">AND currencyId = {payload.amount.currency}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="1116" y="1486.6621">LIMIT 1</text><polygon fill="#A80036" points="971,1515.7148,961,1519.7148,971,1523.7148,967,1519.7148" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="965" x2="1295" y1="1519.7148" y2="1519.7148"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="977" y="1514.9727">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="999" y="1514.9727">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="159" x="1044" y="1514.9727">reconciliationAccountId</text><path d="M965,1532.7148 L965,1618.7148 L1276,1618.7148 L1276,1542.7148 L1266,1532.7148 L965,1532.7148 " fill="#D3D3D3" filter="url(#f1k6ltftfhk18x)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1266,1532.7148 L1266,1542.7148 L1276,1542.7148 L1266,1532.7148 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="971" y="1550.2832">let ledgerEntryTypeId, amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="971" y="1565.5938">if (payload.action === 'RECORD_FUNDS_IN') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="987" y="1580.9043"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="987" y="1580.9043">ledgerEntryTypeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="1118" y="1580.9043">= 'RECORD_FUNDS_IN'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="987" y="1596.2148"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="52" x="987" y="1596.2148">amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="1043" y="1596.2148">=</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="1057" y="1596.2148">payload.amount.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="971" y="1611.5254">}</text><polygon fill="#A80036" points="1279,1645.5781,1289,1649.5781,1279,1653.5781,1283,1649.5781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="960" x2="1285" y1="1649.5781" y2="1649.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="967" y="1644.8359">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="989" y="1644.8359">Insert transferParticipant records</text><polygon fill="#FFFFE0" filter="url(#f1k6ltftfhk18x)" points="1083,1692.5781,1509,1692.5781,1519,1772.5781,1509,1853.5781,1083,1853.5781,1073,1772.5781,1083,1692.5781" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1085" y="1709.1465">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1169" y="1709.1465">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="1101" y="1724.457">(transferId, participantCurrencyId, transferParticipantRoleTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="1101" y="1739.7676">ledgerEntryTypeId, amount, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="371" x="1085" y="1755.0781">VALUES (payload.transferId, reconciliationAccountId, 'HUB',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="1101" y="1770.3887">{ledgerEntryTypeId}, {amount}, {transactionTimestamp})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1089" y="1785.6992"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1085" y="1801.0098">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1169" y="1801.0098">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="1101" y="1816.3203">(transferId, participantCurrencyId, transferParticipantRoleTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="1101" y="1831.6309">ledgerEntryTypeId, amount, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="386" x="1085" y="1846.9414">VALUES ({payload.transferId}, {payload.participantCurrencyId},</text><polygon fill="#A80036" points="1279,1875.9941,1289,1879.9941,1279,1883.9941,1283,1879.9941" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="960" x2="1285" y1="1879.9941" y2="1879.9941"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="967" y="1875.252">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="989" y="1875.252">Insert transferStateChange record</text><polygon fill="#FFFFE0" filter="url(#f1k6ltftfhk18x)" points="1135,1922.9941,1457,1922.9941,1467,1956.9941,1457,1991.9941,1135,1991.9941,1125,1956.9941,1135,1922.9941" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1137" y="1939.5625">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1221" y="1939.5625">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="1153" y="1954.873">(transferId, transferStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="1137" y="1970.1836">VALUES ({payload.transferId}, 'RECEIVED_PREPARE',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="1153" y="1985.4941">{payload.reason}, {transactionTimestamp})</text><path d="M895.5,2004.2363 L962.5,2004.2363 L962.5,2011.2363 L952.5,2021.2363 L895.5,2021.2363 L895.5,2004.2363 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="155.8633" style="stroke: #000000; stroke-width: 2.0;" width="581.5" x="895.5" y="2004.2363"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="910.5" y="2017.8047">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="233" x="977.5" y="2016.8711">[payload.action === RECORD_FUNDS_IN]</text><polygon fill="#A80036" points="1279,2038.8574,1289,2042.8574,1279,2046.8574,1283,2042.8574" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="960" x2="1285" y1="2042.8574" y2="2042.8574"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="967" y="2038.1152">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="989" y="2038.1152">Insert transferStateChange record</text><polygon fill="#FFFFE0" filter="url(#f1k6ltftfhk18x)" points="1135,2085.8574,1457,2085.8574,1467,2119.8574,1457,2154.8574,1135,2154.8574,1125,2119.8574,1135,2085.8574" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1137" y="2102.4258">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1221" y="2102.4258">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="1153" y="2117.7363">(transferId, transferStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="1137" y="2133.0469">VALUES ({payload.transferId}, 'RESERVED',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="1153" y="2148.3574">{payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="1279,2184.4102,1289,2188.4102,1279,2192.4102,1283,2188.4102" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="960" x2="1285" y1="2188.4102" y2="2188.4102"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="967" y="2183.668">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="989" y="2183.668">Save externalReference and extensions</text><polygon fill="#FFFFE0" filter="url(#f1k6ltftfhk18x)" points="1238,2231.4102,1353,2231.4102,1363,2242.4102,1353,2254.4102,1238,2254.4102,1228,2242.4102,1238,2231.4102" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="1240" y="2247.9785">transferExtension</text><path d="M895.5,2298.7207 L1152.5,2298.7207 L1152.5,2305.7207 L1142.5,2315.7207 L895.5,2315.7207 L895.5,2298.7207 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="171.1738" style="stroke: #000000; stroke-width: 2.0;" width="625.5" x="895.5" y="2298.7207"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="212" x="910.5" y="2312.2891">Reconciliation Transfer Commit</text><polygon fill="#A80036" points="1279,2333.3418,1289,2337.3418,1279,2341.3418,1283,2337.3418" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="960" x2="1285" y1="2337.3418" y2="2337.3418"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="967" y="2332.5996">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="989" y="2332.5996">Insert transferFulfilment record</text><polygon fill="#FFFFE0" filter="url(#f1k6ltftfhk18x)" points="1090,2380.3418,1501,2380.3418,1511,2422.3418,1501,2464.3418,1090,2464.3418,1080,2422.3418,1090,2380.3418" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1092" y="2396.9102">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="1176" y="2396.9102">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="290" x="1108" y="2412.2207">(transferFulfilmentId, transferId, ilpFulfilment,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="368" x="1108" y="2427.5313">completedDate, isValid, settlementWindowId, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="407" x="1092" y="2442.8418">VALUES ({Uuid()}, {payload.transferId}, 0, {transactionTimestamp},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="1108" y="2458.1523">1, NULL, {transactionTimestamp})</text><path d="M895.5,2508.8945 L1147.5,2508.8945 L1147.5,2515.8945 L1137.5,2525.8945 L895.5,2525.8945 L895.5,2508.8945 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1068.9063" style="stroke: #000000; stroke-width: 2.0;" width="690.5" x="895.5" y="2508.8945"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="910.5" y="2522.4629">Reconciliation Position Change</text><polygon fill="#A80036" points="1279,2543.5156,1289,2547.5156,1279,2551.5156,1283,2547.5156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="960" x2="1285" y1="2547.5156" y2="2547.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="967" y="2542.7734">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="222" x="989" y="2542.7734">Retrieve hub reconciliation account</text><polygon fill="#FFFFE0" filter="url(#f1k6ltftfhk18x)" points="1114,2560.5156,1477,2560.5156,1487,2602.5156,1477,2644.5156,1114,2644.5156,1104,2602.5156,1114,2560.5156" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="1116" y="2577.084">SELECT participantCurrencyId AS reconciliationAccountId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1116" y="2592.3945">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="1156" y="2592.3945">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="1116" y="2607.7051">WHERE participantId = 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="1116" y="2623.0156">AND currencyId = {payload.amount.currency}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="1116" y="2638.3262">LIMIT 1</text><polygon fill="#A80036" points="971,2667.3789,961,2671.3789,971,2675.3789,967,2671.3789" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="965" x2="1295" y1="2671.3789" y2="2671.3789"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="977" y="2666.6367">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="999" y="2666.6367">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="159" x="1044" y="2666.6367">reconciliationAccountId</text><polygon fill="#A80036" points="1279,2696.6895,1289,2700.6895,1279,2704.6895,1283,2700.6895" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="960" x2="1285" y1="2700.6895" y2="2700.6895"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="967" y="2695.9473">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="989" y="2695.9473">Select hub reconciliation account position</text><polygon fill="#FFFFE0" filter="url(#f1k6ltftfhk18x)" points="1114,2713.6895,1477,2713.6895,1487,2755.6895,1477,2797.6895,1114,2797.6895,1104,2755.6895,1114,2713.6895" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="357" x="1116" y="2730.2578">SELECT participantPositionId AS reconciliationPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="1132" y="2745.5684">value AS reconciliationPositionValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1116" y="2760.8789">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1156" y="2760.8789">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="1116" y="2776.1895">WHERE participantCurrencyId = {reconciliationAccountId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="1116" y="2791.5">LIMIT 1</text><polygon fill="#A80036" points="971,2835.8633,961,2839.8633,971,2843.8633,967,2839.8633" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="965" x2="1295" y1="2839.8633" y2="2839.8633"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="977" y="2827.4658">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="999" y="2819.8105">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="1044" y="2819.8105">reconciliationPositionId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1201" y="2819.8105">,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="182" x="999" y="2835.1211">reconciliationPositionValue</text><polygon fill="#A80036" points="1279,2865.1738,1289,2869.1738,1279,2873.1738,1283,2869.1738" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="960" x2="1285" y1="2869.1738" y2="2869.1738"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="967" y="2864.4316">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="290" x="989" y="2864.4316">Select participant settlement account position</text><polygon fill="#FFFFE0" filter="url(#f1k6ltftfhk18x)" points="1095,2882.1738,1497,2882.1738,1507,2924.1738,1497,2966.1738,1095,2966.1738,1085,2924.1738,1095,2882.1738" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="1097" y="2898.7422">SELECT participantPositionId AS settlementPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="1113" y="2914.0527">value AS settlementPositionValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1097" y="2929.3633">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1137" y="2929.3633">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="398" x="1097" y="2944.6738">WHERE participantCurrencyId = {payload.participantCurrencyId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="1097" y="2959.9844">LIMIT 1</text><polygon fill="#A80036" points="971,3004.3477,961,3008.3477,971,3012.3477,967,3008.3477" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="965" x2="1295" y1="3008.3477" y2="3008.3477"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="977" y="2995.9502">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="999" y="2988.2949">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="138" x="1044" y="2988.2949">settlementPositionId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1182" y="2988.2949">,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="163" x="999" y="3003.6055">settlementPositionValue</text><path d="M965,3021.3477 L965,3061.3477 L1445,3061.3477 L1445,3031.3477 L1435,3021.3477 L965,3021.3477 " fill="#D3D3D3" filter="url(#f1k6ltftfhk18x)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1435,3021.3477 L1435,3031.3477 L1445,3031.3477 L1435,3021.3477 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="971" y="3038.916">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="184" x="991" y="3038.916">latestReconciliationPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="1179" y="3038.916">= reconciliationPositionValue + amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="971" y="3054.2266">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="162" x="991" y="3054.2266">latestSettlementPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="1157" y="3054.2266">= settlementPositionValue - amount</text><polygon fill="#A80036" points="1279,3088.2793,1289,3092.2793,1279,3096.2793,1283,3092.2793" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="960" x2="1285" y1="3092.2793" y2="3092.2793"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="967" y="3087.5371">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="989" y="3087.5371">Persist participant position</text><polygon fill="#FFFFE0" filter="url(#f1k6ltftfhk18x)" points="1117,3135.2793,1474,3135.2793,1484,3192.2793,1474,3250.2793,1117,3250.2793,1107,3192.2793,1117,3135.2793" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1119" y="3151.8477">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1173" y="3151.8477">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260" x="1119" y="3167.1582">SET value = {latestReconciliationPosition}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="353" x="1119" y="3182.4688">WHERE participantPositionId = {reconciliationPositionId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1123" y="3197.7793"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1119" y="3213.0898">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1173" y="3213.0898">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="1119" y="3228.4004">SET value = {latestSettlementPosition}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="1119" y="3243.7109">WHERE participantPositionId = {settlementPositionId}</text><polygon fill="#A80036" points="1279,3272.7637,1289,3276.7637,1279,3280.7637,1283,3276.7637" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="960" x2="1285" y1="3276.7637" y2="3276.7637"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="967" y="3272.0215">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="989" y="3272.0215">Change transfer state</text><polygon fill="#FFFFE0" filter="url(#f1k6ltftfhk18x)" points="1025,3289.7637,1566,3289.7637,1576,3308.7637,1566,3327.7637,1025,3327.7637,1015,3308.7637,1025,3289.7637" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1027" y="3306.332">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1111" y="3306.332">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="1254" y="3306.332">(transferId, transferStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="537" x="1027" y="3321.6426">VALUES ({payload.transferId, 'COMMITTED', {payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="971,3350.6953,961,3354.6953,971,3358.6953,967,3354.6953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="965" x2="1295" y1="3354.6953" y2="3354.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="977" y="3349.9531">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="999" y="3349.9531">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="1044" y="3349.9531">transferStateChangeId</text><polygon fill="#A80036" points="1279,3380.0059,1289,3384.0059,1279,3388.0059,1283,3384.0059" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="960" x2="1285" y1="3384.0059" y2="3384.0059"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="967" y="3379.2637">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="989" y="3379.2637">Persist participant position change</text><polygon fill="#FFFFE0" filter="url(#f1k6ltftfhk18x)" points="1091,3427.0059,1501,3427.0059,1511,3499.0059,1501,3572.0059,1091,3572.0059,1081,3499.0059,1091,3427.0059" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1093" y="3443.5742">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="1177" y="3443.5742">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="1360" y="3443.5742">(participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="1109" y="3458.8848">transferStateChangeId, value, reservedValue, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="1093" y="3474.1953">VALUES ({reconciliationPositionId}, 'COMMITTED',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="360" x="1109" y="3489.5059">{latestReconciliationPosition}, 0, {transactionTimestamp})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1097" y="3504.8164"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1093" y="3520.127">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="1177" y="3520.127">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="1360" y="3520.127">(participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="1109" y="3535.4375">transferStateChangeId, value, reservedValue, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="1093" y="3550.748">VALUES ({settlementPositionId}, 'COMMITTED',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="1109" y="3566.0586">{latestSettlementPosition}, 0, {transactionTimestamp})</text><polygon fill="#A80036" points="825,3609.1113,815,3613.1113,825,3617.1113,821,3613.1113" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="819" x2="954" y1="3613.1113" y2="3613.1113"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="831" y="3608.3691">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="853" y="3608.3691">Finished await</text><!--
@startuml
title 5.1.1. Record Funds In (recordFundsIn)

autonumber


actor "Hub Employee" as OPERATOR
boundary "Central Service\n Admin API" as CS_ADMIN_API
collections "Admin-Transfer-Topic" as TOPIC_ADMIN_TRANSFER
control "Admin Event Handler" as ADMIN_HANDLER
entity "Transfer DAO" as TRANSFER_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Central Service" #LightYellow
    participant CS_ADMIN_API
	participant TOPIC_ADMIN_TRANSFER
    participant ADMIN_HANDLER
    participant TRANSFER_DAO
    participant DB
end box

activate ADMIN_HANDLER
group Record Funds In
    note right of OPERATOR #yellow
        {
            "transferId": <uuid>,
            "externalReference": "string",
            "action": "recordFundsIn",
            "amount": {
                "amount": <decimal>,
                "currency": "string"

            },
            "reason": "string",
            "extensionList": {
                "extension": [
                    {
                        "key": "string",
                        "value": "string"
                    }
                ]
            }
        }
    end note
    OPERATOR -> CS_ADMIN_API: POST - /participants/{name}/accounts/{id}
    activate CS_ADMIN_API

    note right of CS_ADMIN_API #yellow
        Message:
        {
            id: <payload.transferId>
            from: "dfspName",
            to: "hub",
            type: "application/json"
            content: {
                headers: <payloadHeaders>,
                payload: <payloadMessage>
            },
            metadata: {
                event: {
                    id: <uuid>,
                    responseTo: "",
                    type: "transfer",
                    action: "recordFundsIn",
                    createdAt: <timestamp>,
                    state: ""
                }
            },
            pp: ""
        }
    end note
    CS_ADMIN_API -> TOPIC_ADMIN_TRANSFER: Route & Publish Prepare event\n<color #FF0000><b>Error code:</b> 2003</color>
    activate TOPIC_ADMIN_TRANSFER
    TOPIC_ADMIN_TRANSFER <-> TOPIC_ADMIN_TRANSFER: Ensure event is replicated\nas configured (ACKS=all)\n<color #FF0000><b>Error code:</b> 2003</color>
    TOPIC_ADMIN_TRANSFER - -> CS_ADMIN_API: Respond replication acks\nhave been received
    deactivate TOPIC_ADMIN_TRANSFER
    CS_ADMIN_API - - -> OPERATOR: Respond HTTP - 202 (Accepted)
    deactivate CS_ADMIN_API

    TOPIC_ADMIN_TRANSFER <- ADMIN_HANDLER: Consume message
    ADMIN_HANDLER -> TRANSFER_DAO: Prepare transfer
    activate TRANSFER_DAO
    group <color #blue>DB TRANSACTION</color>
        group Reconciliation Transfer Prepare
            TRANSFER_DAO -> DB: Insert transfer
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                INSERT INTO **transfer** (transferId, amount, currencyId,
                    ilpCondition, expirationDate, createdDate)
                VALUES ({payload.transferId}, {payload.amount.amount},
                    {payload.amount.curency}, 0,
                    {new Date()+Config.INTERNAL_TRANSFER_VALIDITY_SECONDS},
                    {transactionTimestamp})
            end hnote

            TRANSFER_DAO -> DB: Retrieve hub reconciliation account
            activate DB
            hnote over DB #lightyellow
                SELECT participantCurrencyId AS reconciliationAccountId
                FROM **participantCurrency**
                WHERE participantId = 1
                AND currencyId = {payload.amount.currency}
                LIMIT 1
            end hnote
            deactivate DB
            TRANSFER_DAO <- - DB: Return **reconciliationAccountId**

            note right of TRANSFER_DAO #lightgray
                let ledgerEntryTypeId, amount
                if (payload.action === 'RECORD_FUNDS_IN') {
                    **ledgerEntryTypeId** = 'RECORD_FUNDS_IN'
                    **amount** = <color #blue>payload.amount.amount</color>
                }
            end note

            TRANSFER_DAO -> DB: Insert transferParticipant records
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                INSERT INTO **transferParticipant**
                    (transferId, participantCurrencyId, transferParticipantRoleTypeId,
                    ledgerEntryTypeId, amount, createdDate)
                VALUES (payload.transferId, reconciliationAccountId, 'HUB',
                    {ledgerEntryTypeId}, {amount}, {transactionTimestamp})

                INSERT INTO **transferParticipant**
                    (transferId, participantCurrencyId, transferParticipantRoleTypeId,
                    ledgerEntryTypeId, amount, createdDate)
                VALUES ({payload.transferId}, {payload.participantCurrencyId},
            end hnote

            TRANSFER_DAO -> DB: Insert transferStateChange record
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                INSERT INTO **transferStateChange**
                    (transferId, transferStateId, reason, createdDate)
                VALUES ({payload.transferId}, 'RECEIVED_PREPARE',
                    {payload.reason}, {transactionTimestamp})
            end hnote

            opt payload.action === RECORD_FUNDS_IN
                TRANSFER_DAO -> DB: Insert transferStateChange record
                activate DB
                deactivate DB
                hnote over DB #lightyellow
                    INSERT INTO **transferStateChange**
                        (transferId, transferStateId, reason, createdDate)
                    VALUES ({payload.transferId}, 'RESERVED',
                        {payload.reason}, {transactionTimestamp})
                end hnote
            end

            TRANSFER_DAO -> DB: Save externalReference and extensions
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                transferExtension
            end hnote
        end
        |||
        group Reconciliation Transfer Commit
            TRANSFER_DAO -> DB: Insert transferFulfilment record
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                INSERT INTO **transferFulfilment**
                    (transferFulfilmentId, transferId, ilpFulfilment,
                    completedDate, isValid, settlementWindowId, createdDate)
                VALUES ({Uuid()}, {payload.transferId}, 0, {transactionTimestamp},
                    1, NULL, {transactionTimestamp})
            end hnote
        end
        |||
        group Reconciliation Position Change
            TRANSFER_DAO -> DB: Retrieve hub reconciliation account
            activate DB
            hnote over DB #lightyellow
                SELECT participantCurrencyId AS reconciliationAccountId
                FROM **participantCurrency**
                WHERE participantId = 1
                AND currencyId = {payload.amount.currency}
                LIMIT 1
            end hnote
            TRANSFER_DAO <- - DB: Return **reconciliationAccountId**
            deactivate DB

            TRANSFER_DAO -> DB: Select hub reconciliation account position
            activate DB
            hnote over DB #lightyellow
                SELECT participantPositionId AS reconciliationPositionId,
                    value AS reconciliationPositionValue
                FROM **participantPosition**
                WHERE participantCurrencyId = {reconciliationAccountId}
                LIMIT 1
            end hnote
            TRANSFER_DAO <- - DB: Return **reconciliationPositionId**,\n**reconciliationPositionValue**
            deactivate DB

            TRANSFER_DAO -> DB: Select participant settlement account position
            activate DB
            hnote over DB #lightyellow
                SELECT participantPositionId AS settlementPositionId,
                    value AS settlementPositionValue
                FROM **participantPosition**
                WHERE participantCurrencyId = {payload.participantCurrencyId}
                LIMIT 1
            end hnote
            TRANSFER_DAO <- - DB: Return **settlementPositionId**,\n**settlementPositionValue**
            deactivate DB

            note right of TRANSFER_DAO #lightgray
                let **latestReconciliationPosition** = reconciliationPositionValue + amount
                let **latestSettlementPosition** = settlementPositionValue - amount
            end note

            TRANSFER_DAO -> DB: Persist participant position
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                UPDATE **participantPosition**
                SET value = {latestReconciliationPosition}
                WHERE participantPositionId = {reconciliationPositionId}

                UPDATE **participantPosition**
                SET value = {latestSettlementPosition}
                WHERE participantPositionId = {settlementPositionId}
            end hnote

            TRANSFER_DAO -> DB: Change transfer state
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **transferStateChange** (transferId, transferStateId, reason, createdDate)
                VALUES ({payload.transferId, 'COMMITTED', {payload.reason}, {transactionTimestamp})
            end hnote
            TRANSFER_DAO <- - DB: Return **transferStateChangeId**
            deactivate DB

            TRANSFER_DAO -> DB: Persist participant position change
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                INSERT INTO **participantPositionChange** (participantPositionId,
                    transferStateChangeId, value, reservedValue, createdDate)
                VALUES ({reconciliationPositionId}, 'COMMITTED',
                    {latestReconciliationPosition}, 0, {transactionTimestamp})

                INSERT INTO **participantPositionChange** (participantPositionId,
                    transferStateChangeId, value, reservedValue, createdDate)
                VALUES ({settlementPositionId}, 'COMMITTED',
                    {latestSettlementPosition}, 0, {transactionTimestamp})
            end hnote
        end
    end
    ADMIN_HANDLER <- - TRANSFER_DAO: Finished await
    deactivate TRANSFER_DAO
end
deactivate ADMIN_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 22:00:17 CEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>