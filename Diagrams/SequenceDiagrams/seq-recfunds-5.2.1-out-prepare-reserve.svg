<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3532px" preserveAspectRatio="none" style="width:1684px;height:3532px;" version="1.1" viewBox="0 0 1684 3532" width="1684px" zoomAndPan="magnify"><defs><filter height="300%" id="f1l965irovn99c" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="559" x="563.5" y="23.5352">5.2.1. Record Funds Out - Prepare &amp; Reserve (recordFundsOutPrepareReserve)</text><rect fill="#FFB6C1" height="3486.8691" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="34.5" y="47.0566">Central HUB</text><rect fill="#FFFFE0" height="3486.8691" style="stroke: #A80036; stroke-width: 1.0;" width="1095" x="324" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="821" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="552.3164" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="377" y="507.8086"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="117.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="606" y="913.2617"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="3277.582" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="804" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="2275.8125" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="950" y="1134.0566"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="1211.9883"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="1381.1621"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="1664.8887"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="1910.6152"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="2049.168"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="2198.0996"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="2351.2734"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="2519.7578"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="2742.8633"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="2927.3477"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="185.1055" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="3034.5898"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="3263.582" style="stroke: #000000; stroke-width: 2.0;" width="1660" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="2232.502" style="stroke: #000000; stroke-width: 2.0;" width="777.5" x="885.5" y="1149.0566"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="947.1113" style="stroke: #000000; stroke-width: 2.0;" width="752.5" x="895.5" y="1173.3672"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="1068.2168" style="stroke: #000000; stroke-width: 2.0;" width="757.5" x="895.5" y="2159.4785"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="132.8633" style="stroke: #000000; stroke-width: 2.0;" width="529.5" x="895.5" y="3241.6953"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="75" x2="75" y1="137.2871" y2="3434.8691"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="382" x2="382" y1="137.2871" y2="3434.8691"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="610.5" x2="610.5" y1="137.2871" y2="3434.8691"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="809" x2="809" y1="137.2871" y2="3434.8691"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="954.5" x2="954.5" y1="137.2871" y2="3434.8691"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1367" x2="1367" y1="137.2871" y2="3434.8691"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="23" y="134.334">Hub Employee</text><ellipse cx="75" cy="63.7988" fill="#FEFECE" filter="url(#f1l965irovn99c)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M75,71.7988 L75,98.7988 M62,79.7988 L88,79.7988 M75,98.7988 L62,113.7988 M75,98.7988 L88,113.7988 " fill="none" filter="url(#f1l965irovn99c)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="23" y="3447.4043">Hub Employee</text><ellipse cx="75" cy="3460.3574" fill="#FEFECE" filter="url(#f1l965irovn99c)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M75,3468.3574 L75,3495.3574 M62,3476.3574 L88,3476.3574 M75,3495.3574 L62,3510.3574 M75,3495.3574 L88,3510.3574 " fill="none" filter="url(#f1l965irovn99c)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102" x="328" y="117.8457">Central Service</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="345.5" y="134.334">Admin API</text><path d="M361.5,76.3105 L361.5,100.3105 M361.5,88.3105 L378.5,88.3105 " fill="none" filter="url(#f1l965irovn99c)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="390.5" cy="88.3105" fill="#FEFECE" filter="url(#f1l965irovn99c)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102" x="328" y="3447.4043">Central Service</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="345.5" y="3463.8926">Admin API</text><path d="M361.5,3470.8457 L361.5,3494.8457 M361.5,3482.8457 L378.5,3482.8457 " fill="none" filter="url(#f1l965irovn99c)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="390.5" cy="3482.8457" fill="#FEFECE" filter="url(#f1l965irovn99c)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#f1l965irovn99c)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="525.5" y="97.7988"/><rect fill="#FEFECE" filter="url(#f1l965irovn99c)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="521.5" y="101.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="157" x="528.5" y="122.334">Admin-Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f1l965irovn99c)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="525.5" y="3433.8691"/><rect fill="#FEFECE" filter="url(#f1l965irovn99c)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="521.5" y="3437.8691"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="157" x="528.5" y="3458.4043">Admin-Transfer-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="144" x="734" y="134.334">Admin Event Handler</text><ellipse cx="809" cy="104.7988" fill="#FEFECE" filter="url(#f1l965irovn99c)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="805,92.7988,811,87.7988,809,92.7988,811,97.7988,805,92.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="144" x="734" y="3447.4043">Admin Event Handler</text><ellipse cx="809" cy="3466.3574" fill="#FEFECE" filter="url(#f1l965irovn99c)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="805,3454.3574,811,3449.3574,809,3454.3574,811,3459.3574,805,3454.3574" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="905.5" y="134.334">Transfer DAO</text><ellipse cx="955" cy="104.7988" fill="#FEFECE" filter="url(#f1l965irovn99c)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="943" x2="967" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="905.5" y="3447.4043">Transfer DAO</text><ellipse cx="955" cy="3466.3574" fill="#FEFECE" filter="url(#f1l965irovn99c)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="943" x2="967" y1="3480.3574" y2="3480.3574"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1319" y="134.334">Central Store</text><path d="M1349,84.7988 C1349,74.7988 1367,74.7988 1367,74.7988 C1367,74.7988 1385,74.7988 1385,84.7988 L1385,110.7988 C1385,120.7988 1367,120.7988 1367,120.7988 C1367,120.7988 1349,120.7988 1349,110.7988 L1349,84.7988 " fill="#FEFECE" filter="url(#f1l965irovn99c)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1349,84.7988 C1349,94.7988 1367,94.7988 1367,94.7988 C1367,94.7988 1385,94.7988 1385,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1319" y="3447.4043">Central Store</text><path d="M1349,3460.3574 C1349,3450.3574 1367,3450.3574 1367,3450.3574 C1367,3450.3574 1385,3450.3574 1385,3460.3574 L1385,3486.3574 C1385,3496.3574 1367,3496.3574 1367,3496.3574 C1367,3496.3574 1349,3496.3574 1349,3486.3574 L1349,3460.3574 " fill="#FEFECE" filter="url(#f1l965irovn99c)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1349,3460.3574 C1349,3470.3574 1367,3470.3574 1367,3470.3574 C1367,3470.3574 1385,3470.3574 1385,3460.3574 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="552.3164" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="377" y="507.8086"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="117.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="606" y="913.2617"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="3277.582" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="804" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="2275.8125" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="950" y="1134.0566"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="1211.9883"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="1381.1621"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="1664.8887"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="1910.6152"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="2049.168"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="2198.0996"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="2351.2734"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="2519.7578"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="2742.8633"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="2927.3477"/><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="185.1055" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="3034.5898"/><path d="M13,154.2871 L320,154.2871 L320,161.2871 L310,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3263.582" style="stroke: #000000; stroke-width: 2.0;" width="1660" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="262" x="28" y="167.8555">Record Funds Out - Prepare &amp; Reserve</text><path d="M80,176.5977 L80,476.5977 L335,476.5977 L335,186.5977 L325,176.5977 L80,176.5977 " fill="#FFFF00" filter="url(#f1l965irovn99c)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M325,176.5977 L325,186.5977 L335,186.5977 L325,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="86" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="102" y="209.4766">"transferId": &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="102" y="224.7871">"externalReference": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="102" y="240.0977">"action": "recordFundsOutPrepare",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="102" y="255.4082">"amount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="118" y="270.7188">"amount": &lt;decimal&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="118" y="286.0293">"currency": "string"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="90" y="301.3398"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="102" y="316.6504">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="102" y="331.9609">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="102" y="347.2715">"extensionList": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="118" y="362.582">"extension": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="377.8926">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="150" y="393.2031">"key": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="150" y="408.5137">"value": "string"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="423.8242">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="439.1348">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="102" y="454.4453">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="86" y="469.7559">}</text><polygon fill="#A80036" points="365,503.8086,375,507.8086,365,511.8086,369,507.8086" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="75" x2="371" y1="507.8086" y2="507.8086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="82" y="503.0664">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="95" y="503.0664">POST - /participants/{name}/accounts/{id}</text><path d="M392,520.8086 L392,866.8086 L669,866.8086 L669,530.8086 L659,520.8086 L392,520.8086 " fill="#FFFF00" filter="url(#f1l965irovn99c)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M659,520.8086 L659,530.8086 L669,530.8086 L659,520.8086 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="398" y="538.377">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="398" y="553.6875">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="414" y="568.998">id: &lt;payload.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="76" x="414" y="584.3086">from: "hub",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="414" y="599.6191">to: "dfspName",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="414" y="614.9297">type: "application/json"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="414" y="630.2402">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="430" y="645.5508">headers: &lt;payloadHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="430" y="660.8613">payload: &lt;payloadMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="414" y="676.1719">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="414" y="691.4824">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="430" y="706.793">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="446" y="722.1035">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="446" y="737.4141">responseTo: "",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="446" y="752.7246">type: "transfer",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="446" y="768.0352">action: "recordFundsOutPrepare",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="446" y="783.3457">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="446" y="798.6563">state: ""</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="430" y="813.9668">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="414" y="829.2773">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="34" x="414" y="844.5879">pp: ""</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="398" y="859.8984">}</text><polygon fill="#A80036" points="594,909.2617,604,913.2617,594,917.2617,598,913.2617" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="387" x2="600" y1="913.2617" y2="913.2617"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="394" y="900.8643">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="407" y="893.209">Route &amp; Publish Prepare event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="407" y="908.5195">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="484" y="908.5195">2003</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="616" x2="658" y1="973.1934" y2="973.1934"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="658" x2="658" y1="973.1934" y2="986.1934"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="617" x2="658" y1="986.1934" y2="986.1934"/><polygon fill="#A80036" points="627,982.1934,617,986.1934,627,990.1934,623,986.1934" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="623" y="953.1406">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="636" y="937.8301">Ensure event is replicated</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="636" y="953.1406">as configured (ACKS=all)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="636" y="968.4512">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="713" y="968.4512">2003</text><polygon fill="#A80036" points="398,1026.8145,388,1030.8145,398,1034.8145,394,1030.8145" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="392" x2="610" y1="1030.8145" y2="1030.8145"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="404" y="1018.417">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="417" y="1010.7617">Respond replication acks</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="417" y="1026.0723">have been received</text><polygon fill="#A80036" points="86,1056.125,76,1060.125,86,1064.125,82,1060.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="80" x2="381" y1="1060.125" y2="1060.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="92" y="1055.3828">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="105" y="1055.3828">Respond HTTP - 202 (Accepted)</text><polygon fill="#A80036" points="622,1085.4355,612,1089.4355,622,1093.4355,618,1089.4355" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="616" x2="803" y1="1089.4355" y2="1089.4355"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="628" y="1084.6934">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="641" y="1084.6934">Consume message</text><polygon fill="#A80036" points="938,1130.0566,948,1134.0566,938,1138.0566,942,1134.0566" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="814" x2="944" y1="1134.0566" y2="1134.0566"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="821" y="1121.6592">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="834" y="1114.0039">Prepare transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="834" y="1129.3145">and reserve</text><path d="M885.5,1149.0566 L1050.5,1149.0566 L1050.5,1156.0566 L1040.5,1166.0566 L885.5,1166.0566 L885.5,1149.0566 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2232.502" style="stroke: #000000; stroke-width: 2.0;" width="777.5" x="885.5" y="1149.0566"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="900.5" y="1162.625">DB TRANSACTION</text><path d="M895.5,1173.3672 L1153.5,1173.3672 L1153.5,1180.3672 L1143.5,1190.3672 L895.5,1190.3672 L895.5,1173.3672 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="947.1113" style="stroke: #000000; stroke-width: 2.0;" width="752.5" x="895.5" y="1173.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="213" x="910.5" y="1186.9355">Reconciliation Transfer Prepare</text><polygon fill="#A80036" points="1350,1207.9883,1360,1211.9883,1350,1215.9883,1354,1211.9883" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="960" x2="1356" y1="1211.9883" y2="1211.9883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="967" y="1207.2461">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="980" y="1207.2461">Insert transfer</text><polygon fill="#FFFFE0" filter="url(#f1l965irovn99c)" points="1157,1254.9883,1577,1254.9883,1587,1303.9883,1577,1353.9883,1157,1353.9883,1147,1303.9883,1157,1254.9883" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1159" y="1271.5566">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="54" x="1243" y="1271.5566">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="1301" y="1271.5566">(transferId, amount, currencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="1175" y="1286.8672">ilpCondition, expirationDate, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="1159" y="1302.1777">VALUES ({payload.transferId}, {payload.amount.amount},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="1175" y="1317.4883">{payload.amount.curency}, 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="400" x="1175" y="1332.7988">{new Date()+Config.INTERNAL_TRANSFER_VALIDITY_SECONDS},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="1175" y="1348.1094">{transactionTimestamp})</text><polygon fill="#A80036" points="1350,1377.1621,1360,1381.1621,1350,1385.1621,1354,1381.1621" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="960" x2="1356" y1="1381.1621" y2="1381.1621"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="967" y="1376.4199">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="222" x="980" y="1376.4199">Retrieve hub reconciliation account</text><polygon fill="#FFFFE0" filter="url(#f1l965irovn99c)" points="1185,1424.1621,1548,1424.1621,1558,1466.1621,1548,1508.1621,1185,1508.1621,1175,1466.1621,1185,1424.1621" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="1187" y="1440.7305">SELECT participantCurrencyId AS reconciliationAccountId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1187" y="1456.041">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="1227" y="1456.041">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="1187" y="1471.3516">WHERE participantId = 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="1187" y="1486.6621">AND currencyId = {payload.amount.currency}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="1187" y="1501.9727">LIMIT 1</text><polygon fill="#A80036" points="971,1531.0254,961,1535.0254,971,1539.0254,967,1535.0254" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="965" x2="1366" y1="1535.0254" y2="1535.0254"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="977" y="1530.2832">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="999" y="1530.2832">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="159" x="1044" y="1530.2832">reconciliationAccountId</text><path d="M965,1548.0254 L965,1634.0254 L1347,1634.0254 L1347,1558.0254 L1337,1548.0254 L965,1548.0254 " fill="#D3D3D3" filter="url(#f1l965irovn99c)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1337,1548.0254 L1337,1558.0254 L1347,1558.0254 L1337,1548.0254 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="971" y="1565.5938">let ledgerEntryTypeId, amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="361" x="971" y="1580.9043">if (payload.action === 'RECORD_FUNDS_OUT_PREPARE') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="987" y="1596.2148"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="987" y="1596.2148">ledgerEntryTypeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="1118" y="1596.2148">= 'RECORD_FUNDS_OUT'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="987" y="1611.5254"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="52" x="987" y="1611.5254">amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="1043" y="1611.5254">=</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="1057" y="1611.5254">-payload.amount.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="971" y="1626.8359">}</text><polygon fill="#A80036" points="1350,1660.8887,1360,1664.8887,1350,1668.8887,1354,1664.8887" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="960" x2="1356" y1="1664.8887" y2="1664.8887"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="967" y="1660.1465">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="989" y="1660.1465">Insert transferParticipant records</text><polygon fill="#FFFFE0" filter="url(#f1l965irovn99c)" points="1106,1707.8887,1628,1707.8887,1638,1795.8887,1628,1883.8887,1106,1883.8887,1096,1795.8887,1106,1707.8887" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1108" y="1724.457">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1192" y="1724.457">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="1124" y="1739.7676">(transferId, participantCurrencyId, transferParticipantRoleTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="1124" y="1755.0781">ledgerEntryTypeId, amount, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="371" x="1108" y="1770.3887">VALUES (payload.transferId, reconciliationAccountId, 'HUB',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="1124" y="1785.6992">{ledgerEntryTypeId}, {amount}, {transactionTimestamp})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1112" y="1801.0098"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1108" y="1816.3203">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1192" y="1816.3203">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="1124" y="1831.6309">(transferId, participantCurrencyId, transferParticipantRoleTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="1124" y="1846.9414">ledgerEntryTypeId, amount, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="518" x="1108" y="1862.252">VALUES ({payload.transferId}, {payload.participantCurrencyId}, 'DFSP_SETTLEMENT',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="354" x="1124" y="1877.5625">{ledgerEntryTypeId}, {-amount}, {transactionTimestamp})</text><polygon fill="#A80036" points="1350,1906.6152,1360,1910.6152,1350,1914.6152,1354,1910.6152" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="960" x2="1356" y1="1910.6152" y2="1910.6152"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="967" y="1905.873">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="989" y="1905.873">Insert transferStateChange record</text><polygon fill="#FFFFE0" filter="url(#f1l965irovn99c)" points="1206,1953.6152,1528,1953.6152,1538,1987.6152,1528,2022.6152,1206,2022.6152,1196,1987.6152,1206,1953.6152" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1208" y="1970.1836">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1292" y="1970.1836">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="1224" y="1985.4941">(transferId, transferStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="1208" y="2000.8047">VALUES ({payload.transferId}, 'RECEIVED_PREPARE',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="1224" y="2016.1152">{payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="1350,2045.168,1360,2049.168,1350,2053.168,1354,2049.168" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="960" x2="1356" y1="2049.168" y2="2049.168"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="967" y="2044.4258">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="989" y="2044.4258">Save externalReference and extensions</text><polygon fill="#FFFFE0" filter="url(#f1l965irovn99c)" points="1309,2092.168,1424,2092.168,1434,2103.168,1424,2115.168,1309,2115.168,1299,2103.168,1309,2092.168" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="1311" y="2108.7363">transferExtension</text><path d="M895.5,2159.4785 L1147.5,2159.4785 L1147.5,2166.4785 L1137.5,2176.4785 L895.5,2176.4785 L895.5,2159.4785 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1068.2168" style="stroke: #000000; stroke-width: 2.0;" width="757.5" x="895.5" y="2159.4785"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="910.5" y="2173.0469">Reconciliation Position Change</text><polygon fill="#A80036" points="1350,2194.0996,1360,2198.0996,1350,2202.0996,1354,2198.0996" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="960" x2="1356" y1="2198.0996" y2="2198.0996"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="967" y="2193.3574">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="222" x="989" y="2193.3574">Retrieve hub reconciliation account</text><polygon fill="#FFFFE0" filter="url(#f1l965irovn99c)" points="1185,2211.0996,1548,2211.0996,1558,2253.0996,1548,2295.0996,1185,2295.0996,1175,2253.0996,1185,2211.0996" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="1187" y="2227.668">SELECT participantCurrencyId AS reconciliationAccountId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1187" y="2242.9785">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="1227" y="2242.9785">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="1187" y="2258.2891">WHERE participantId = 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="1187" y="2273.5996">AND currencyId = {payload.amount.currency}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="1187" y="2288.9102">LIMIT 1</text><polygon fill="#A80036" points="971,2317.9629,961,2321.9629,971,2325.9629,967,2321.9629" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="965" x2="1366" y1="2321.9629" y2="2321.9629"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="977" y="2317.2207">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="999" y="2317.2207">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="159" x="1044" y="2317.2207">reconciliationAccountId</text><polygon fill="#A80036" points="1350,2347.2734,1360,2351.2734,1350,2355.2734,1354,2351.2734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="960" x2="1356" y1="2351.2734" y2="2351.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="967" y="2346.5313">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="989" y="2346.5313">Select hub reconciliation account position</text><polygon fill="#FFFFE0" filter="url(#f1l965irovn99c)" points="1185,2364.2734,1548,2364.2734,1558,2406.2734,1548,2448.2734,1185,2448.2734,1175,2406.2734,1185,2364.2734" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="357" x="1187" y="2380.8418">SELECT participantPositionId AS reconciliationPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="1203" y="2396.1523">value AS reconciliationPositionValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1187" y="2411.4629">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1227" y="2411.4629">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="1187" y="2426.7734">WHERE participantCurrencyId = {reconciliationAccountId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="1187" y="2442.084">LIMIT 1</text><polygon fill="#A80036" points="971,2486.4473,961,2490.4473,971,2494.4473,967,2490.4473" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="965" x2="1366" y1="2490.4473" y2="2490.4473"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="977" y="2478.0498">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="999" y="2470.3945">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="1044" y="2470.3945">reconciliationPositionId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1201" y="2470.3945">,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="182" x="999" y="2485.7051">reconciliationPositionValue</text><polygon fill="#A80036" points="1350,2515.7578,1360,2519.7578,1350,2523.7578,1354,2519.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="960" x2="1356" y1="2519.7578" y2="2519.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="967" y="2515.0156">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="290" x="989" y="2515.0156">Select participant settlement account position</text><polygon fill="#FFFFE0" filter="url(#f1l965irovn99c)" points="1166,2532.7578,1568,2532.7578,1578,2574.7578,1568,2616.7578,1166,2616.7578,1156,2574.7578,1166,2532.7578" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="1168" y="2549.3262">SELECT participantPositionId AS settlementPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="1184" y="2564.6367">value AS settlementPositionValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1168" y="2579.9473">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1208" y="2579.9473">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="398" x="1168" y="2595.2578">WHERE participantCurrencyId = {payload.participantCurrencyId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="1168" y="2610.5684">LIMIT 1</text><polygon fill="#A80036" points="971,2654.9316,961,2658.9316,971,2662.9316,967,2658.9316" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="965" x2="1366" y1="2658.9316" y2="2658.9316"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="977" y="2646.5342">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="999" y="2638.8789">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="138" x="1044" y="2638.8789">settlementPositionId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1182" y="2638.8789">,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="163" x="999" y="2654.1895">settlementPositionValue</text><path d="M965,2671.9316 L965,2711.9316 L1445,2711.9316 L1445,2681.9316 L1435,2671.9316 L965,2671.9316 " fill="#D3D3D3" filter="url(#f1l965irovn99c)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1435,2671.9316 L1435,2681.9316 L1445,2681.9316 L1435,2671.9316 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="971" y="2689.5">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="184" x="991" y="2689.5">latestReconciliationPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="1179" y="2689.5">= reconciliationPositionValue + amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="971" y="2704.8105">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="162" x="991" y="2704.8105">latestSettlementPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="1157" y="2704.8105">= settlementPositionValue - amount</text><polygon fill="#A80036" points="1350,2738.8633,1360,2742.8633,1350,2746.8633,1354,2742.8633" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="960" x2="1356" y1="2742.8633" y2="2742.8633"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="967" y="2738.1211">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="989" y="2738.1211">Persist participant position</text><polygon fill="#FFFFE0" filter="url(#f1l965irovn99c)" points="1188,2785.8633,1545,2785.8633,1555,2842.8633,1545,2900.8633,1188,2900.8633,1178,2842.8633,1188,2785.8633" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1190" y="2802.4316">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1244" y="2802.4316">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260" x="1190" y="2817.7422">SET value = {latestReconciliationPosition}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="353" x="1190" y="2833.0527">WHERE participantPositionId = {reconciliationPositionId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1194" y="2848.3633"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1190" y="2863.6738">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1244" y="2863.6738">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="1190" y="2878.9844">SET value = {latestSettlementPosition}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="1190" y="2894.2949">WHERE participantPositionId = {settlementPositionId}</text><polygon fill="#A80036" points="1350,2923.3477,1360,2927.3477,1350,2931.3477,1354,2927.3477" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="960" x2="1356" y1="2927.3477" y2="2927.3477"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="967" y="2922.6055">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="989" y="2922.6055">Change transfer state</text><polygon fill="#FFFFE0" filter="url(#f1l965irovn99c)" points="1100,2940.3477,1633,2940.3477,1643,2959.3477,1633,2978.3477,1100,2978.3477,1090,2959.3477,1100,2940.3477" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1102" y="2956.916">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1186" y="2956.916">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="1329" y="2956.916">(transferId, transferStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="521" x="1102" y="2972.2266">VALUES ({payload.transferId, 'RESERVED', {payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="971,3001.2793,961,3005.2793,971,3009.2793,967,3005.2793" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="965" x2="1366" y1="3005.2793" y2="3005.2793"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="977" y="3000.5371">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="999" y="3000.5371">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="1044" y="3000.5371">transferStateChangeId</text><polygon fill="#A80036" points="1350,3030.5898,1360,3034.5898,1350,3038.5898,1354,3034.5898" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="960" x2="1356" y1="3034.5898" y2="3034.5898"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="967" y="3029.8477">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="989" y="3029.8477">Persist participant position change</text><polygon fill="#FFFFE0" filter="url(#f1l965irovn99c)" points="1162,3047.5898,1572,3047.5898,1582,3119.5898,1572,3192.5898,1162,3192.5898,1152,3119.5898,1162,3047.5898" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1164" y="3064.1582">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="1248" y="3064.1582">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="1431" y="3064.1582">(participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="1180" y="3079.4688">transferStateChangeId, value, reservedValue, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="371" x="1164" y="3094.7793">VALUES ({reconciliationPositionId}, {transferStateChangeId},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="360" x="1180" y="3110.0898">{latestReconciliationPosition}, 0, {transactionTimestamp})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1168" y="3125.4004"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1164" y="3140.7109">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="1248" y="3140.7109">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="1431" y="3140.7109">(participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="1180" y="3156.0215">transferStateChangeId, value, reservedValue, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="352" x="1164" y="3171.332">VALUES ({settlementPositionId}, {transferStateChangeId},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="1180" y="3186.6426">{latestSettlementPosition}, 0, {transactionTimestamp})</text><polygon fill="#A80036" points="971,3215.6953,961,3219.6953,971,3223.6953,967,3219.6953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="965" x2="1366" y1="3219.6953" y2="3219.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="977" y="3214.9531">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="999" y="3214.9531">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="311" x="1044" y="3214.9531">position.participantSettlementAccountPosition</text><path d="M895.5,3241.6953 L962.5,3241.6953 L962.5,3248.6953 L952.5,3258.6953 L895.5,3258.6953 L895.5,3241.6953 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="132.8633" style="stroke: #000000; stroke-width: 2.0;" width="529.5" x="895.5" y="3241.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="910.5" y="3255.2637">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="290" x="977.5" y="3254.3301">[position.participantSettlementAccountPosition &gt; 0]</text><path d="M965,3264.0059 L965,3304.0059 L1315,3304.0059 L1315,3274.0059 L1305,3264.0059 L965,3264.0059 " fill="#D3D3D3" filter="url(#f1l965irovn99c)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1305,3264.0059 L1305,3274.0059 L1315,3274.0059 L1305,3264.0059 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="329" x="971" y="3281.5742">payload.reason = 'Aborted due to insufficient funds'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="301" x="971" y="3296.8848">payload.action = 'RECORD_FUNDS_OUT_ABORT'</text><rect fill="#FFFFFF" filter="url(#f1l965irovn99c)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="511.5" x="902.5" y="3313.627"/><polygon fill="#EEEEEE" points="902.5,3313.627,966.5,3313.627,966.5,3320.627,956.5,3330.627,902.5,3330.627,902.5,3313.627" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="915.5" y="3328.1953">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="1046.25" y="3347.1953">Reconciliation Transfer Abort {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/develop/Diagrams/SequenceDiagrams/seq-recfunds-5.2.3-out-abort.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/develop/Diagrams/SequenceDiagrams/seq-recfunds-5.2.3-out-abort.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="32" x="1238.25" y="3347.1953">5.2.3</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="1238.25" x2="1270.25" y1="3349.1953" y2="3349.1953"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1270.25" y="3347.1953">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1050.25" y="3362.5059"/><polygon fill="#A80036" points="825,3405.8691,815,3409.8691,825,3413.8691,821,3409.8691" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="819" x2="954" y1="3409.8691" y2="3409.8691"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="831" y="3405.127">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="853" y="3405.127">Finished await</text><!--
@startuml
title 5.2.1. Record Funds Out - Prepare & Reserve (recordFundsOutPrepareReserve)

autonumber


actor "Hub Employee" as OPERATOR
boundary "Central Service\n Admin API" as CS_ADMIN_API
collections "Admin-Transfer-Topic" as TOPIC_ADMIN_TRANSFER
control "Admin Event Handler" as ADMIN_HANDLER
entity "Transfer DAO" as TRANSFER_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Central Service" #LightYellow
    participant CS_ADMIN_API
	participant TOPIC_ADMIN_TRANSFER
    participant ADMIN_HANDLER
    participant TRANSFER_DAO
    participant DB
end box

activate ADMIN_HANDLER
group Record Funds Out - Prepare & Reserve
    note right of OPERATOR #yellow
        {
            "transferId": <uuid>,
            "externalReference": "string",
            "action": "recordFundsOutPrepare",
            "amount": {
                "amount": <decimal>,
                "currency": "string"

            },
            "reason": "string",
            "extensionList": {
                "extension": [
                    {
                        "key": "string",
                        "value": "string"
                    }
                ]
            }
        }
    end note
    OPERATOR -> CS_ADMIN_API: POST - /participants/{name}/accounts/{id}
    activate CS_ADMIN_API

    note right of CS_ADMIN_API #yellow
        Message:
        {
            id: <payload.transferId>
            from: "hub",
            to: "dfspName",
            type: "application/json"
            content: {
                headers: <payloadHeaders>,
                payload: <payloadMessage>
            },
            metadata: {
                event: {
                    id: <uuid>,
                    responseTo: "",
                    type: "transfer",
                    action: "recordFundsOutPrepare",
                    createdAt: <timestamp>,
                    state: ""
                }
            },
            pp: ""
        }
    end note
    CS_ADMIN_API -> TOPIC_ADMIN_TRANSFER: Route & Publish Prepare event\n<color #FF0000><b>Error code:</b> 2003</color>
    activate TOPIC_ADMIN_TRANSFER
    TOPIC_ADMIN_TRANSFER <-> TOPIC_ADMIN_TRANSFER: Ensure event is replicated\nas configured (ACKS=all)\n<color #FF0000><b>Error code:</b> 2003</color>
    TOPIC_ADMIN_TRANSFER - -> CS_ADMIN_API: Respond replication acks\nhave been received
    deactivate TOPIC_ADMIN_TRANSFER
    CS_ADMIN_API - - -> OPERATOR: Respond HTTP - 202 (Accepted)
    deactivate CS_ADMIN_API

    TOPIC_ADMIN_TRANSFER <- ADMIN_HANDLER: Consume message
    ADMIN_HANDLER -> TRANSFER_DAO: Prepare transfer\nand reserve
    activate TRANSFER_DAO
    group <color #blue>DB TRANSACTION</color>
        group Reconciliation Transfer Prepare
            TRANSFER_DAO -> DB: Insert transfer
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                INSERT INTO **transfer** (transferId, amount, currencyId,
                    ilpCondition, expirationDate, createdDate)
                VALUES ({payload.transferId}, {payload.amount.amount},
                    {payload.amount.curency}, 0,
                    {new Date()+Config.INTERNAL_TRANSFER_VALIDITY_SECONDS},
                    {transactionTimestamp})
            end hnote

            TRANSFER_DAO -> DB: Retrieve hub reconciliation account
            activate DB
            hnote over DB #lightyellow
                SELECT participantCurrencyId AS reconciliationAccountId
                FROM **participantCurrency**
                WHERE participantId = 1
                AND currencyId = {payload.amount.currency}
                LIMIT 1
            end hnote
            deactivate DB
            TRANSFER_DAO <- - DB: Return **reconciliationAccountId**

            note right of TRANSFER_DAO #lightgray
                let ledgerEntryTypeId, amount
                if (payload.action === 'RECORD_FUNDS_OUT_PREPARE') {
                    **ledgerEntryTypeId** = 'RECORD_FUNDS_OUT'
                    **amount** = <color #red>-payload.amount.amount</color>
                }
            end note

            TRANSFER_DAO -> DB: Insert transferParticipant records
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                INSERT INTO **transferParticipant**
                    (transferId, participantCurrencyId, transferParticipantRoleTypeId,
                    ledgerEntryTypeId, amount, createdDate)
                VALUES (payload.transferId, reconciliationAccountId, 'HUB',
                    {ledgerEntryTypeId}, {amount}, {transactionTimestamp})

                INSERT INTO **transferParticipant**
                    (transferId, participantCurrencyId, transferParticipantRoleTypeId,
                    ledgerEntryTypeId, amount, createdDate)
                VALUES ({payload.transferId}, {payload.participantCurrencyId}, 'DFSP_SETTLEMENT',
                    {ledgerEntryTypeId}, {-amount}, {transactionTimestamp})
            end hnote

            TRANSFER_DAO -> DB: Insert transferStateChange record
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                INSERT INTO **transferStateChange**
                    (transferId, transferStateId, reason, createdDate)
                VALUES ({payload.transferId}, 'RECEIVED_PREPARE',
                    {payload.reason}, {transactionTimestamp})
            end hnote

            TRANSFER_DAO -> DB: Save externalReference and extensions
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                transferExtension
            end hnote
        end
        |||
        group Reconciliation Position Change
            TRANSFER_DAO -> DB: Retrieve hub reconciliation account
            activate DB
            hnote over DB #lightyellow
                SELECT participantCurrencyId AS reconciliationAccountId
                FROM **participantCurrency**
                WHERE participantId = 1
                AND currencyId = {payload.amount.currency}
                LIMIT 1
            end hnote
            TRANSFER_DAO <- - DB: Return **reconciliationAccountId**
            deactivate DB

            TRANSFER_DAO -> DB: Select hub reconciliation account position
            activate DB
            hnote over DB #lightyellow
                SELECT participantPositionId AS reconciliationPositionId,
                    value AS reconciliationPositionValue
                FROM **participantPosition**
                WHERE participantCurrencyId = {reconciliationAccountId}
                LIMIT 1
            end hnote
            TRANSFER_DAO <- - DB: Return **reconciliationPositionId**,\n**reconciliationPositionValue**
            deactivate DB

            TRANSFER_DAO -> DB: Select participant settlement account position
            activate DB
            hnote over DB #lightyellow
                SELECT participantPositionId AS settlementPositionId,
                    value AS settlementPositionValue
                FROM **participantPosition**
                WHERE participantCurrencyId = {payload.participantCurrencyId}
                LIMIT 1
            end hnote
            TRANSFER_DAO <- - DB: Return **settlementPositionId**,\n**settlementPositionValue**
            deactivate DB

            note right of TRANSFER_DAO #lightgray
                let **latestReconciliationPosition** = reconciliationPositionValue + amount
                let **latestSettlementPosition** = settlementPositionValue - amount
            end note

            TRANSFER_DAO -> DB: Persist participant position
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                UPDATE **participantPosition**
                SET value = {latestReconciliationPosition}
                WHERE participantPositionId = {reconciliationPositionId}

                UPDATE **participantPosition**
                SET value = {latestSettlementPosition}
                WHERE participantPositionId = {settlementPositionId}
            end hnote

            TRANSFER_DAO -> DB: Change transfer state
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **transferStateChange** (transferId, transferStateId, reason, createdDate)
                VALUES ({payload.transferId, 'RESERVED', {payload.reason}, {transactionTimestamp})
            end hnote
            TRANSFER_DAO <- - DB: Return **transferStateChangeId**
            deactivate DB

            TRANSFER_DAO -> DB: Persist participant position change
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **participantPositionChange** (participantPositionId,
                    transferStateChangeId, value, reservedValue, createdDate)
                VALUES ({reconciliationPositionId}, {transferStateChangeId},
                    {latestReconciliationPosition}, 0, {transactionTimestamp})

                INSERT INTO **participantPositionChange** (participantPositionId,
                    transferStateChangeId, value, reservedValue, createdDate)
                VALUES ({settlementPositionId}, {transferStateChangeId},
                    {latestSettlementPosition}, 0, {transactionTimestamp})
            end hnote
            TRANSFER_DAO <- - DB: Return **position.participantSettlementAccountPosition**
            deactivate DB
        end

        opt position.participantSettlementAccountPosition > 0
            note right of TRANSFER_DAO #lightgray
                payload.reason = 'Aborted due to insufficient funds'
                payload.action = 'RECORD_FUNDS_OUT_ABORT'
            end note
            ref over TRANSFER_DAO, DB: Reconciliation Transfer Abort {[[https://github.com/mojaloop/docs/blob/develop/Diagrams/SequenceDiagrams/seq-recfunds-5.2.3-out-abort.svg 5.2.3]]}\n
        end
    end
    ADMIN_HANDLER <- - TRANSFER_DAO: Finished await
    deactivate TRANSFER_DAO
end
deactivate ADMIN_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>