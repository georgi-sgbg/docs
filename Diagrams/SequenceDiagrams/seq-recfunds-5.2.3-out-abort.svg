<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1658px" preserveAspectRatio="none" style="width:1565px;height:1658px;" version="1.1" viewBox="0 0 1565 1658" width="1565px" zoomAndPan="magnify"><defs><filter height="300%" id="f1kpgbftsdna0p" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="385" x="591" y="23.5352">5.2.3. Record Funds Out Abort (recordFundsOutAbort)</text><rect fill="#FFB6C1" height="1613.4727" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="34.5" y="47.0566">Central HUB</text><rect fill="#FFFFE0" height="1613.4727" style="stroke: #A80036; stroke-width: 1.0;" width="1021" x="296" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="756" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f1kpgbftsdna0p)" height="552.3164" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="349" y="293.4609"/><rect fill="#FFFFFF" filter="url(#f1kpgbftsdna0p)" height="117.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="578" y="698.9141"/><rect fill="#FFFFFF" filter="url(#f1kpgbftsdna0p)" height="1404.1855" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="776" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f1kpgbftsdna0p)" height="632.0742" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="922" y="904.3984"/><rect fill="#FFFFFF" filter="url(#f1kpgbftsdna0p)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1260" y="1021.6406"/><rect fill="#FFFFFF" filter="url(#f1kpgbftsdna0p)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1260" y="1160.1934"/><rect fill="#FFFFFF" filter="url(#f1kpgbftsdna0p)" height="1390.1855" style="stroke: #000000; stroke-width: 2.0;" width="1541" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#f1kpgbftsdna0p)" height="588.7637" style="stroke: #000000; stroke-width: 2.0;" width="686.5" x="857.5" y="919.3984"/><rect fill="#FFFFFF" filter="url(#f1kpgbftsdna0p)" height="557.4531" style="stroke: #000000; stroke-width: 2.0;" width="666.5" x="867.5" y="943.709"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="75" x2="75" y1="137.2871" y2="1561.4727"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="354" x2="354" y1="137.2871" y2="1561.4727"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="582.5" x2="582.5" y1="137.2871" y2="1561.4727"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="781" x2="781" y1="137.2871" y2="1561.4727"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="926.5" x2="926.5" y1="137.2871" y2="1561.4727"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1265" x2="1265" y1="137.2871" y2="1561.4727"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="23" y="134.334">Hub Employee</text><ellipse cx="75" cy="63.7988" fill="#FEFECE" filter="url(#f1kpgbftsdna0p)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M75,71.7988 L75,98.7988 M62,79.7988 L88,79.7988 M75,98.7988 L62,113.7988 M75,98.7988 L88,113.7988 " fill="none" filter="url(#f1kpgbftsdna0p)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="23" y="1574.0078">Hub Employee</text><ellipse cx="75" cy="1586.9609" fill="#FEFECE" filter="url(#f1kpgbftsdna0p)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M75,1594.9609 L75,1621.9609 M62,1602.9609 L88,1602.9609 M75,1621.9609 L62,1636.9609 M75,1621.9609 L88,1636.9609 " fill="none" filter="url(#f1kpgbftsdna0p)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102" x="300" y="117.8457">Central Service</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="317.5" y="134.334">Admin API</text><path d="M333.5,76.3105 L333.5,100.3105 M333.5,88.3105 L350.5,88.3105 " fill="none" filter="url(#f1kpgbftsdna0p)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="362.5" cy="88.3105" fill="#FEFECE" filter="url(#f1kpgbftsdna0p)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102" x="300" y="1574.0078">Central Service</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="317.5" y="1590.4961">Admin API</text><path d="M333.5,1597.4492 L333.5,1621.4492 M333.5,1609.4492 L350.5,1609.4492 " fill="none" filter="url(#f1kpgbftsdna0p)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="362.5" cy="1609.4492" fill="#FEFECE" filter="url(#f1kpgbftsdna0p)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#f1kpgbftsdna0p)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="497.5" y="97.7988"/><rect fill="#FEFECE" filter="url(#f1kpgbftsdna0p)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="493.5" y="101.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="157" x="500.5" y="122.334">Admin-Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f1kpgbftsdna0p)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="497.5" y="1560.4727"/><rect fill="#FEFECE" filter="url(#f1kpgbftsdna0p)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="493.5" y="1564.4727"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="157" x="500.5" y="1585.0078">Admin-Transfer-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="144" x="706" y="134.334">Admin Event Handler</text><ellipse cx="781" cy="104.7988" fill="#FEFECE" filter="url(#f1kpgbftsdna0p)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="777,92.7988,783,87.7988,781,92.7988,783,97.7988,777,92.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="144" x="706" y="1574.0078">Admin Event Handler</text><ellipse cx="781" cy="1592.9609" fill="#FEFECE" filter="url(#f1kpgbftsdna0p)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="777,1580.9609,783,1575.9609,781,1580.9609,783,1585.9609,777,1580.9609" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="877.5" y="134.334">Transfer DAO</text><ellipse cx="927" cy="104.7988" fill="#FEFECE" filter="url(#f1kpgbftsdna0p)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="915" x2="939" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="877.5" y="1574.0078">Transfer DAO</text><ellipse cx="927" cy="1592.9609" fill="#FEFECE" filter="url(#f1kpgbftsdna0p)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="915" x2="939" y1="1606.9609" y2="1606.9609"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1217" y="134.334">Central Store</text><path d="M1247,84.7988 C1247,74.7988 1265,74.7988 1265,74.7988 C1265,74.7988 1283,74.7988 1283,84.7988 L1283,110.7988 C1283,120.7988 1265,120.7988 1265,120.7988 C1265,120.7988 1247,120.7988 1247,110.7988 L1247,84.7988 " fill="#FEFECE" filter="url(#f1kpgbftsdna0p)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1247,84.7988 C1247,94.7988 1265,94.7988 1265,94.7988 C1265,94.7988 1283,94.7988 1283,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1217" y="1574.0078">Central Store</text><path d="M1247,1586.9609 C1247,1576.9609 1265,1576.9609 1265,1576.9609 C1265,1576.9609 1283,1576.9609 1283,1586.9609 L1283,1612.9609 C1283,1622.9609 1265,1622.9609 1265,1622.9609 C1265,1622.9609 1247,1622.9609 1247,1612.9609 L1247,1586.9609 " fill="#FEFECE" filter="url(#f1kpgbftsdna0p)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1247,1586.9609 C1247,1596.9609 1265,1596.9609 1265,1596.9609 C1265,1596.9609 1283,1596.9609 1283,1586.9609 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1kpgbftsdna0p)" height="552.3164" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="349" y="293.4609"/><rect fill="#FFFFFF" filter="url(#f1kpgbftsdna0p)" height="117.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="578" y="698.9141"/><rect fill="#FFFFFF" filter="url(#f1kpgbftsdna0p)" height="1404.1855" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="776" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f1kpgbftsdna0p)" height="632.0742" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="922" y="904.3984"/><rect fill="#FFFFFF" filter="url(#f1kpgbftsdna0p)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1260" y="1021.6406"/><rect fill="#FFFFFF" filter="url(#f1kpgbftsdna0p)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1260" y="1160.1934"/><path d="M13,154.2871 L221,154.2871 L221,161.2871 L211,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1390.1855" style="stroke: #000000; stroke-width: 2.0;" width="1541" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="163" x="28" y="167.8555">Record Funds Out Abort</text><path d="M80,176.5977 L80,247.5977 L324,247.5977 L324,186.5977 L314,176.5977 L80,176.5977 " fill="#FFFF00" filter="url(#f1kpgbftsdna0p)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M314,176.5977 L314,186.5977 L324,186.5977 L314,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="86" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="102" y="209.4766">"action": "recordFundsOutAbort",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="102" y="224.7871">"reason": "string"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="86" y="240.0977">}</text><polygon fill="#A80036" points="337,289.4609,347,293.4609,337,297.4609,341,293.4609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="75" x2="343" y1="293.4609" y2="293.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="82" y="281.0635">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="242" x="95" y="273.4082">PUT - /participants/{name}/accounts/</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="139" y="288.7188">{id}/transfers/{transferId}</text><path d="M364,306.4609 L364,652.4609 L630,652.4609 L630,316.4609 L620,306.4609 L364,306.4609 " fill="#FFFF00" filter="url(#f1kpgbftsdna0p)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M620,306.4609 L620,316.4609 L630,316.4609 L620,306.4609 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="370" y="324.0293">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="370" y="339.3398">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="386" y="354.6504">id: &lt;payload.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="386" y="369.9609">from: "Hub",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="386" y="385.2715">to: "dfspName",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="386" y="400.582">type: "application/json"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="386" y="415.8926">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="402" y="431.2031">headers: &lt;payloadHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="402" y="446.5137">payload: &lt;payloadMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="386" y="461.8242">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="386" y="477.1348">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="402" y="492.4453">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="418" y="507.7559">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="418" y="523.0664">responseTo: "",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="418" y="538.377">type: "transfer",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="418" y="553.6875">action: "recordFundsOutAbort",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="418" y="568.998">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="418" y="584.3086">state: ""</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="402" y="599.6191">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="386" y="614.9297">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="34" x="386" y="630.2402">pp: ""</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="370" y="645.5508">}</text><polygon fill="#A80036" points="566,694.9141,576,698.9141,566,702.9141,570,698.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="359" x2="572" y1="698.9141" y2="698.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="366" y="686.5166">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="379" y="678.8613">Route &amp; Publish Prepare event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="379" y="694.1719">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="456" y="694.1719">2003</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="588" x2="630" y1="758.8457" y2="758.8457"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="630" x2="630" y1="758.8457" y2="771.8457"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="589" x2="630" y1="771.8457" y2="771.8457"/><polygon fill="#A80036" points="599,767.8457,589,771.8457,599,775.8457,595,771.8457" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="595" y="738.793">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="608" y="723.4824">Ensure event is replicated</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="608" y="738.793">as configured (ACKS=all)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="608" y="754.1035">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="685" y="754.1035">2003</text><polygon fill="#A80036" points="370,812.4668,360,816.4668,370,820.4668,366,816.4668" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="364" x2="582" y1="816.4668" y2="816.4668"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="376" y="804.0693">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="389" y="796.4141">Respond replication acks</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="389" y="811.7246">have been received</text><polygon fill="#A80036" points="86,841.7773,76,845.7773,86,849.7773,82,845.7773" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="80" x2="353" y1="845.7773" y2="845.7773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="92" y="841.0352">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="105" y="841.0352">Respond HTTP - 202 (Accepted)</text><polygon fill="#A80036" points="594,871.0879,584,875.0879,594,879.0879,590,875.0879" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="588" x2="775" y1="875.0879" y2="875.0879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="600" y="870.3457">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="613" y="870.3457">Consume message</text><polygon fill="#A80036" points="910,900.3984,920,904.3984,910,908.3984,914,904.3984" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="786" x2="916" y1="904.3984" y2="904.3984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="793" y="899.6563">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="806" y="899.6563">Abort transfer</text><path d="M857.5,919.3984 L1022.5,919.3984 L1022.5,926.3984 L1012.5,936.3984 L857.5,936.3984 L857.5,919.3984 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="588.7637" style="stroke: #000000; stroke-width: 2.0;" width="686.5" x="857.5" y="919.3984"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="872.5" y="932.9668">DB TRANSACTION</text><path d="M867.5,943.709 L1110.5,943.709 L1110.5,950.709 L1100.5,960.709 L867.5,960.709 L867.5,943.709 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="557.4531" style="stroke: #000000; stroke-width: 2.0;" width="666.5" x="867.5" y="943.709"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="198" x="882.5" y="957.2773">Reconciliation Transfer Abort</text><path d="M937,966.0195 L937,991.0195 L1168,991.0195 L1168,976.0195 L1158,966.0195 L937,966.0195 " fill="#D3D3D3" filter="url(#f1kpgbftsdna0p)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1158,966.0195 L1158,976.0195 L1168,976.0195 L1158,966.0195 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="943" y="983.5879">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="963" y="983.5879">transferFulfilmentId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="1102" y="983.5879">= Uuid()</text><polygon fill="#A80036" points="1248,1017.6406,1258,1021.6406,1248,1025.6406,1252,1021.6406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="932" x2="1254" y1="1021.6406" y2="1021.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="939" y="1016.8984">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="952" y="1016.8984">Insert transferFulfilmentDuplicateCheck record</text><polygon fill="#FFFFE0" filter="url(#f1kpgbftsdna0p)" points="1078,1064.6406,1451,1064.6406,1461,1098.6406,1451,1133.6406,1078,1133.6406,1068,1098.6406,1078,1064.6406" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1080" y="1081.209">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="227" x="1164" y="1081.209">transferFulfilmentDuplicateCheck</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="323" x="1096" y="1096.5195">(transferFulfilmentId, transferId, hash, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="322" x="1080" y="1111.8301">VALUES ({transferFulfilmentId}, {payload.transferId},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="353" x="1096" y="1127.1406">hashCode({payload.transferId}), {transactionTimestamp})</text><polygon fill="#A80036" points="1248,1156.1934,1258,1160.1934,1248,1164.1934,1252,1160.1934" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="932" x2="1254" y1="1160.1934" y2="1160.1934"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="939" y="1155.4512">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="952" y="1155.4512">Insert transferFulfilment record</text><polygon fill="#FFFFE0" filter="url(#f1kpgbftsdna0p)" points="1015,1203.1934,1514,1203.1934,1524,1245.1934,1514,1287.1934,1015,1287.1934,1005,1245.1934,1015,1203.1934" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1017" y="1219.7617">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="1101" y="1219.7617">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="290" x="1033" y="1235.0723">(transferFulfilmentId, transferId, ilpFulfilment,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="368" x="1033" y="1250.3828">completedDate, isValid, settlementWindowId, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="495" x="1017" y="1265.6934">VALUES ({transferFulfilmentId}, {payload.transferId}, 0, {transactionTimestamp},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="1033" y="1281.0039">1, NULL, {transactionTimestamp})</text><rect fill="#FFFFFF" filter="url(#f1kpgbftsdna0p)" height="178.416" style="stroke: #000000; stroke-width: 2.0;" width="437.5" x="874.5" y="1317.7461"/><polygon fill="#EEEEEE" points="874.5,1317.7461,938.5,1317.7461,938.5,1324.7461,928.5,1334.7461,874.5,1334.7461,874.5,1317.7461" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="887.5" y="1332.3145">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="217" x="956.75" y="1351.3145">transferStateAndPositionUpdate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1177.75" y="1351.3145">{</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/develop/Diagrams/SequenceDiagrams/seq-recfunds-5.1.0.b-transferStateAndPositionUpdate.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/develop/Diagrams/SequenceDiagrams/seq-recfunds-5.1.0.b-transferStateAndPositionUpdate.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="44" x="1181.75" y="1351.3145">5.1.0.b</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="1181.75" x2="1225.75" y1="1353.3145" y2="1353.3145"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1225.75" y="1351.3145">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="956.75" y="1366.625">({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="972.75" y="1381.9355">transferId: {payload.transferId},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="972.75" y="1397.2461">transferStateId: "ABORTED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157" x="972.75" y="1412.5566">reason: {payload.reason},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="972.75" y="1427.8672">createdDate: {transactionTimestamp},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="972.75" y="1443.1777">drUpdated: true,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="972.75" y="1458.4883">crUpdated: false</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="34" x="956.75" y="1473.7988">}, trx)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="960.75" y="1489.1094"/><polygon fill="#A80036" points="797,1532.4727,787,1536.4727,797,1540.4727,793,1536.4727" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="791" x2="926" y1="1536.4727" y2="1536.4727"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="803" y="1531.7305">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="825" y="1531.7305">Finished await</text><!--
@startuml
title 5.2.3. Record Funds Out Abort (recordFundsOutAbort)

autonumber


actor "Hub Employee" as OPERATOR
boundary "Central Service\n Admin API" as CS_ADMIN_API
collections "Admin-Transfer-Topic" as TOPIC_ADMIN_TRANSFER
control "Admin Event Handler" as ADMIN_HANDLER
entity "Transfer DAO" as TRANSFER_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Central Service" #LightYellow
    participant CS_ADMIN_API
	participant TOPIC_ADMIN_TRANSFER
    participant ADMIN_HANDLER
    participant TRANSFER_DAO
    participant DB
end box

activate ADMIN_HANDLER
group Record Funds Out Abort
    note right of OPERATOR #yellow
        {
            "action": "recordFundsOutAbort",
            "reason": "string"
        }
    end note
    OPERATOR -> CS_ADMIN_API: PUT - /participants/{name}/accounts/\n           {id}/transfers/{transferId}
    activate CS_ADMIN_API

    note right of CS_ADMIN_API #yellow
        Message:
        {
            id: <payload.transferId>
            from: "Hub",
            to: "dfspName",
            type: "application/json"
            content: {
                headers: <payloadHeaders>,
                payload: <payloadMessage>
            },
            metadata: {
                event: {
                    id: <uuid>,
                    responseTo: "",
                    type: "transfer",
                    action: "recordFundsOutAbort",
                    createdAt: <timestamp>,
                    state: ""
                }
            },
            pp: ""
        }
    end note
    CS_ADMIN_API -> TOPIC_ADMIN_TRANSFER: Route & Publish Prepare event\n<color #FF0000><b>Error code:</b> 2003</color>
    activate TOPIC_ADMIN_TRANSFER
    TOPIC_ADMIN_TRANSFER <-> TOPIC_ADMIN_TRANSFER: Ensure event is replicated\nas configured (ACKS=all)\n<color #FF0000><b>Error code:</b> 2003</color>
    TOPIC_ADMIN_TRANSFER - -> CS_ADMIN_API: Respond replication acks\nhave been received
    deactivate TOPIC_ADMIN_TRANSFER
    CS_ADMIN_API - - -> OPERATOR: Respond HTTP - 202 (Accepted)
    deactivate CS_ADMIN_API

    TOPIC_ADMIN_TRANSFER <- ADMIN_HANDLER: Consume message
    ADMIN_HANDLER -> TRANSFER_DAO: Abort transfer
    activate TRANSFER_DAO
    group <color #blue>DB TRANSACTION</color>
        group Reconciliation Transfer Abort
            note right of TRANSFER_DAO #lightgray
                let **transferFulfilmentId** = Uuid()
            end note

            TRANSFER_DAO -> DB: Insert transferFulfilmentDuplicateCheck record
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                INSERT INTO **transferFulfilmentDuplicateCheck**
                    (transferFulfilmentId, transferId, hash, createdDate)
                VALUES ({transferFulfilmentId}, {payload.transferId},
                    hashCode({payload.transferId}), {transactionTimestamp})
            end hnote

            TRANSFER_DAO -> DB: Insert transferFulfilment record
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                INSERT INTO **transferFulfilment**
                    (transferFulfilmentId, transferId, ilpFulfilment,
                    completedDate, isValid, settlementWindowId, createdDate)
                VALUES ({transferFulfilmentId}, {payload.transferId}, 0, {transactionTimestamp},
                    1, NULL, {transactionTimestamp})
            end hnote
            |||
            ref over TRANSFER_DAO, DB:**transferStateAndPositionUpdate** {[[https://github.com/mojaloop/docs/blob/develop/Diagrams/SequenceDiagrams/seq-recfunds-5.1.0.b-transferStateAndPositionUpdate.svg 5.1.0.b]]} \n({\n    transferId: {payload.transferId},\n    transferStateId: "ABORTED",\n    reason: {payload.reason},\n    createdDate: {transactionTimestamp},\n    drUpdated: true,\n    crUpdated: false\n}, trx)\n
        end
    end
    ADMIN_HANDLER <- - TRANSFER_DAO: Finished await
    deactivate TRANSFER_DAO
end
deactivate ADMIN_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>