<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="9541px" preserveAspectRatio="none" style="width:1358px;height:9541px;" version="1.1" viewBox="0 0 1358 9541" width="1358px" zoomAndPan="magnify"><defs><filter height="300%" id="f17jvp8yspv6t" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="515" x="422.5" y="23.5352">6.2.5. Acknowledgement of Settlement Transfer (updateSettlementById)</text><rect fill="#FFB6C1" height="9496.1016" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="107" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="122.5" y="47.0566">Central HUB</text><rect fill="#90EE90" height="9496.1016" style="stroke: #A80036; stroke-width: 1.0;" width="387.5" x="263.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="395.25" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="9496.1016" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="1031" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="1034" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="9287.8145" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="158" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="8895.9824" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="341" y="523.1191"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="8023.834" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="585" y="567.7402"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="154.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="621.3613"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="231.0371" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="805.1563"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="185.1055" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="1065.5039"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="1279.9199"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="6991.6113"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="7156.4746"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="7902.877"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="8037.1191"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="8294.4688"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="8386.4004"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="9272.8145" style="stroke: #000000; stroke-width: 2.0;" width="1334" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="7980.5234" style="stroke: #000000; stroke-width: 2.0;" width="844" x="493" y="582.7402"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="767.1152" style="stroke: #000000; stroke-width: 2.0;" width="454" x="523" y="2675.7637"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="382.2148" style="stroke: #000000; stroke-width: 2.0;" width="377" x="590" y="3053.6641"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="590" y="3110.2852"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="590" y="3164.5508"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="590" y="3218.8164"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="590" y="3273.082"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="590" y="3327.3477"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="590" y="3381.6133"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="133.1738" style="stroke: #000000; stroke-width: 2.0;" width="326" x="590" y="3645.1211"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="628.2285" style="stroke: #000000; stroke-width: 2.0;" width="534" x="580" y="3914.2266"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="327.9492" style="stroke: #000000; stroke-width: 2.0;" width="395" x="590" y="4207.5059"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="395" x="590" y="4264.127"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="395" x="590" y="4318.3926"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="395" x="590" y="4372.6582"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="395" x="590" y="4426.9238"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="395" x="590" y="4481.1895"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="2043.1875" style="stroke: #000000; stroke-width: 2.0;" width="824" x="503" y="4895.8027"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="1884.3242" style="stroke: #000000; stroke-width: 2.0;" width="804" x="513" y="5047.666"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="1771.3926" style="stroke: #000000; stroke-width: 2.0;" width="784" x="523" y="5153.5977"/><rect fill="#FFFFFF" height="188.4395" style="stroke: none; stroke-width: 1.0;" width="784" x="523" y="5344.3926"/><rect fill="#FFFFFF" height="249.6816" style="stroke: none; stroke-width: 1.0;" width="784" x="523" y="5532.832"/><rect fill="#FFFFFF" height="310.9238" style="stroke: none; stroke-width: 1.0;" width="784" x="523" y="5782.5137"/><rect fill="#FFFFFF" height="14.9551" style="stroke: none; stroke-width: 1.0;" width="784" x="523" y="6093.4375"/><rect fill="#FFFFFF" height="14.9551" style="stroke: none; stroke-width: 1.0;" width="784" x="523" y="6108.3926"/><rect fill="#FFFFFF" height="14.9551" style="stroke: none; stroke-width: 1.0;" width="784" x="523" y="6123.3477"/><rect fill="#FFFFFF" height="549.9609" style="stroke: none; stroke-width: 1.0;" width="784" x="523" y="6138.3027"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="148.4844" style="stroke: #000000; stroke-width: 2.0;" width="510" x="590" y="6532.7793"/><rect fill="#FFFFFF" height="236.7266" style="stroke: none; stroke-width: 1.0;" width="784" x="523" y="6688.2637"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="397.2793" style="stroke: #000000; stroke-width: 2.0;" width="796" x="523" y="6952.9902"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="652.6074" style="stroke: #000000; stroke-width: 2.0;" width="749" x="523" y="7455.8223"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="293.8809" style="stroke: #000000; stroke-width: 2.0;" width="625" x="570" y="7580.6855"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="207.9492" style="stroke: #000000; stroke-width: 2.0;" width="605" x="580" y="7659.6172"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="126.418" style="stroke: #000000; stroke-width: 2.0;" width="540" x="590" y="7694.8379"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="433.834" style="stroke: #000000; stroke-width: 2.0;" width="739" x="513" y="8122.4297"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="402.5234" style="stroke: #000000; stroke-width: 2.0;" width="719" x="523" y="8146.7402"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="163" x2="163" y1="137.2871" y2="9444.1016"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="345.5" x2="345.5" y1="137.2871" y2="9444.1016"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="590" x2="590" y1="137.2871" y2="9444.1016"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1088" x2="1088" y1="137.2871" y2="9444.1016"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="111" y="134.334">Hub Employee</text><ellipse cx="163" cy="63.7988" fill="#FEFECE" filter="url(#f17jvp8yspv6t)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M163,71.7988 L163,98.7988 M150,79.7988 L176,79.7988 M163,98.7988 L150,113.7988 M163,98.7988 L176,113.7988 " fill="none" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="111" y="9456.6367">Hub Employee</text><ellipse cx="163" cy="9469.5898" fill="#FEFECE" filter="url(#f17jvp8yspv6t)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M163,9477.5898 L163,9504.5898 M150,9485.5898 L176,9485.5898 M163,9504.5898 L150,9519.5898 M163,9504.5898 L176,9519.5898 " fill="none" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="267.5" y="134.334">Settlement Service API</text><path d="M325.5,92.7988 L325.5,116.7988 M325.5,104.7988 L342.5,104.7988 " fill="none" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="354.5" cy="104.7988" fill="#FEFECE" filter="url(#f17jvp8yspv6t)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="267.5" y="9456.6367">Settlement Service API</text><path d="M325.5,9463.5898 L325.5,9487.5898 M325.5,9475.5898 L342.5,9475.5898 " fill="none" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="354.5" cy="9475.5898" fill="#FEFECE" filter="url(#f17jvp8yspv6t)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="533" y="134.334">Settlement DAO</text><ellipse cx="590" cy="104.7988" fill="#FEFECE" filter="url(#f17jvp8yspv6t)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="578" x2="602" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="533" y="9456.6367">Settlement DAO</text><ellipse cx="590" cy="9475.5898" fill="#FEFECE" filter="url(#f17jvp8yspv6t)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="578" x2="602" y1="9489.5898" y2="9489.5898"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1040" y="134.334">Central Store</text><path d="M1070,84.7988 C1070,74.7988 1088,74.7988 1088,74.7988 C1088,74.7988 1106,74.7988 1106,84.7988 L1106,110.7988 C1106,120.7988 1088,120.7988 1088,120.7988 C1088,120.7988 1070,120.7988 1070,110.7988 L1070,84.7988 " fill="#FEFECE" filter="url(#f17jvp8yspv6t)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1070,84.7988 C1070,94.7988 1088,94.7988 1088,94.7988 C1088,94.7988 1106,94.7988 1106,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1040" y="9456.6367">Central Store</text><path d="M1070,9469.5898 C1070,9459.5898 1088,9459.5898 1088,9459.5898 C1088,9459.5898 1106,9459.5898 1106,9469.5898 L1106,9495.5898 C1106,9505.5898 1088,9505.5898 1088,9505.5898 C1088,9505.5898 1070,9505.5898 1070,9495.5898 L1070,9469.5898 " fill="#FEFECE" filter="url(#f17jvp8yspv6t)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1070,9469.5898 C1070,9479.5898 1088,9479.5898 1088,9479.5898 C1088,9479.5898 1106,9479.5898 1106,9469.5898 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="9287.8145" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="158" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="8895.9824" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="341" y="523.1191"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="8023.834" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="585" y="567.7402"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="154.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="621.3613"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="231.0371" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="805.1563"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="185.1055" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="1065.5039"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="1279.9199"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="6991.6113"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="7156.4746"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="7902.877"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="8037.1191"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="8294.4688"/><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="8386.4004"/><path d="M13,154.2871 L339,154.2871 L339,161.2871 L329,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="9272.8145" style="stroke: #000000; stroke-width: 2.0;" width="1334" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="281" x="28" y="167.8555">Acknowledgement of Settlement Transfer</text><path d="M173,176.5977 L173,492.5977 L654,492.5977 L654,186.5977 L644,176.5977 L173,176.5977 " fill="#FFFF00" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M644,176.5977 L644,186.5977 L654,186.5977 L644,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="195" y="209.4766">"participants": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="211" y="224.7871">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="227" y="240.0977">"id": 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="227" y="255.4082">"accounts" : [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="369" x="243" y="270.7188">{ "id": 1, "state": "PENDING_SETTLEMENT", "reason": "abc" },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="391" x="243" y="286.0293">{ "id": 2, "state": "PS_TRANSFERS_RECORDED", "reason": "def" },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="384" x="243" y="301.3398">{ "id": 3, "state": "PS_TRANSFERS_RESERVED", "reason": "ghi" },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396" x="243" y="316.6504">{ "id": 4, "state": "PS_TRANSFERS_COMMITTED", "reason": "jkl" },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="281" x="243" y="331.9609">{ "id": 5, "state": "SETTLED", "reason": "mno" }</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="227" y="347.2715">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="211" y="362.582">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="211" y="377.8926">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="227" y="393.2031">"id": 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="227" y="408.5137">"accounts" : [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="243" y="423.8242">{ "id": 6, "state": "NOT_SETTLED", "reason": "pqr" }</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="227" y="439.1348">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="211" y="454.4453">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="195" y="469.7559">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="485.0664">}</text><polygon fill="#A80036" points="329,519.1191,339,523.1191,329,527.1191,333,523.1191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="168" x2="335" y1="523.1191" y2="523.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="175" y="518.377">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="188" y="518.377">PUT - /settlement/{id}</text><polygon fill="#A80036" points="573,563.7402,583,567.7402,573,571.7402,577,567.7402" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="351" x2="579" y1="567.7402" y2="567.7402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="358" y="555.3428">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="371" y="547.6875">updateSettlementById command</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="371" y="562.998">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="448" y="562.998">2001</text><path d="M493,582.7402 L658,582.7402 L658,589.7402 L648,599.7402 L493,599.7402 L493,582.7402 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="7980.5234" style="stroke: #000000; stroke-width: 2.0;" width="844" x="493" y="582.7402"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="508" y="596.3086">DB TRANSACTION</text><polygon fill="#A80036" points="1071,617.3613,1081,621.3613,1071,625.3613,1075,621.3613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="1077" y1="621.3613" y2="621.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="602" y="616.6191">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="615" y="616.6191">Retrieve settlement information</text><polygon fill="#FFFFE0" filter="url(#f17jvp8yspv6t)" points="901,634.3613,1275,634.3613,1285,691.3613,1275,749.3613,901,749.3613,891,691.3613,901,634.3613" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="286" x="903" y="650.9297">SELECT s.settlementId, ssc.settlementStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="919" y="666.2402">ssc.reason, ssc.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="903" y="681.5508">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="943" y="681.5508">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="7" x="1019" y="681.5508">s</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="903" y="696.8613">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="935" y="696.8613">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1096" y="696.8613">ssc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="903" y="712.1719">ON ssc.settlementStateChangeId = s.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="903" y="727.4824">WHERE s.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="903" y="742.793">FOR UPDATE</text><polygon fill="#A80036" points="606,771.8457,596,775.8457,606,779.8457,602,775.8457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="600" x2="1087" y1="775.8457" y2="775.8457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="612" y="771.1035">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="625" y="771.1035">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="670" y="771.1035">settlementData</text><polygon fill="#A80036" points="1071,801.1563,1081,805.1563,1071,809.1563,1075,805.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="1077" y1="805.1563" y2="805.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="602" y="800.4141">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="615" y="800.4141">Retrive settlement accounts information</text><polygon fill="#FFFFE0" filter="url(#f17jvp8yspv6t)" points="904,818.1563,1272,818.1563,1282,913.1563,1272,1009.1563,904,1009.1563,894,913.1563,904,818.1563" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="322" x="906" y="834.7246">SELECT pc.participantId, spc.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="922" y="850.0352">spcsc.settlementStateId, spcsc.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="316" x="922" y="865.3457">spcsc.createdDate, spc.netAmount, pc.currencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="248" x="922" y="880.6563">spc.settlementParticipantCurrencyId AS</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1174" y="880.6563">key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="906" y="895.9668">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="946" y="895.9668">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1157" y="895.9668">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="906" y="911.2773">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="938" y="911.2773">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1234" y="911.2773">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="906" y="926.5879">ON spcsc.settlementParticipantCurrencyStateChangeId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="906" y="941.8984">spc.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="906" y="957.209">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="938" y="957.209">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1078" y="957.209">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="906" y="972.5195">ON pc.participantCurrencyId = spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="906" y="987.8301">WHERE spc.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="906" y="1003.1406">FOR UPDATE</text><polygon fill="#A80036" points="606,1032.1934,596,1036.1934,606,1040.1934,602,1036.1934" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="600" x2="1087" y1="1036.1934" y2="1036.1934"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="612" y="1031.4512">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="625" y="1031.4512">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="670" y="1031.4512">settlementAccountsList</text><polygon fill="#A80036" points="1071,1061.5039,1081,1065.5039,1071,1069.5039,1075,1065.5039" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="1077" y1="1065.5039" y2="1065.5039"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="602" y="1060.7617">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="615" y="1060.7617">Retrive settlement windows information</text><polygon fill="#FFFFE0" filter="url(#f17jvp8yspv6t)" points="866,1078.5039,1309,1078.5039,1319,1150.5039,1309,1223.5039,866,1223.5039,856,1150.5039,866,1078.5039" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="868" y="1095.0723">SELECT ssw.settlementWindowId, swsc.settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="884" y="1110.3828">swsc.reason, swsc.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="868" y="1125.6934">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="908" y="1125.6934">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="1109" y="1125.6934">ssw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="868" y="1141.0039">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="900" y="1141.0039">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="1029" y="1141.0039">sw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="335" x="868" y="1156.3145">ON sw.settlementWindow = ssw.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="868" y="1171.625">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="900" y="1171.625">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="31" x="1114" y="1171.625">swsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="439" x="868" y="1186.9355">ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="868" y="1202.2461">WHERE ssw.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="868" y="1217.5566">FOR UPDATE</text><polygon fill="#A80036" points="606,1246.6094,596,1250.6094,606,1254.6094,602,1250.6094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="600" x2="1087" y1="1250.6094" y2="1250.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="612" y="1245.8672">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="625" y="1245.8672">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="83" x="670" y="1245.8672">windowsList</text><polygon fill="#A80036" points="1071,1275.9199,1081,1279.9199,1071,1283.9199,1075,1279.9199" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="1077" y1="1279.9199" y2="1279.9199"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="602" y="1275.1777">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="615" y="1275.1777">Retrieve settlement windows accounts information</text><polygon fill="#FFFFE0" filter="url(#f17jvp8yspv6t)" points="893,1292.9199,1282,1292.9199,1292,1326.9199,1282,1361.9199,893,1361.9199,883,1326.9199,893,1292.9199" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="385" x="895" y="1309.4883">SELECT DISTINCT settlementWindowId, participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="895" y="1324.7988">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="203" x="935" y="1324.7988">settlementTransferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="895" y="1340.1094">WHERE settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="895" y="1355.4199">FOR UPDATE</text><polygon fill="#A80036" points="606,1384.4727,596,1388.4727,606,1392.4727,602,1388.4727" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="600" x2="1087" y1="1388.4727" y2="1388.4727"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="612" y="1383.7305">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="634" y="1383.7305">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="145" x="679" y="1383.7305">windowsAccountsList</text><path d="M600,1401.4727 L600,1472.4727 L1097,1472.4727 L1097,1411.4727 L1087,1401.4727 L600,1401.4727 " fill="#ADD8E6" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1087,1401.4727 L1087,1411.4727 L1097,1411.4727 L1087,1401.4727 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="447" x="606" y="1419.041">All objects below are done for the purposes of the syncronous request.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="462" x="606" y="1434.3516">If at same point Node process memory limit is reached we may decide to:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="476" x="606" y="1449.6621">A. Limit the amount of transfers per window and windows per settlement or</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="442" x="606" y="1464.9727">B. Move to asyncronous processing where we don't need these objects</text><path d="M600,1486.7148 L600,2368.7148 L1289,2368.7148 L1289,1496.7148 L1279,1486.7148 L600,1486.7148 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1279,1486.7148 L1279,1496.7148 L1289,1496.7148 L1279,1486.7148 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="606" y="1504.2832">Available raw datasets from DB:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="606" y="1519.5938">settlementData</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="423" x="713" y="1519.5938">contains information about settlement and its current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="606" y="1534.9043">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="768" y="1534.9043">holds information about all accounts and their current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="83" x="606" y="1550.2148">windowsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="693" y="1550.2148">has information about all windows and their current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="145" x="606" y="1565.5254">windowsAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="755" y="1565.5254">has information about all accounts and windows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="610" y="1580.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="606" y="1596.1465">Local variables and objects:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="606" y="1611.457">settlementAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="740" y="1611.457">: { // (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="862" y="1611.457">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1011" y="1611.457">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="567" x="622" y="1626.7676">pendingSettlementCount: &lt;integer&gt;, // count of accounts in PENDING_SETTLEMENT state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="605" x="622" y="1642.0781">psTransfersRecordedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_RECORDED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="596" x="622" y="1657.3887">psTransfersReservedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_RESERVED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="626" x="622" y="1672.6992">psTransfersCommittedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_COMMITTED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="402" x="622" y="1688.0098">settledCount: &lt;integer&gt;, // count of accounts in SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="454" x="622" y="1703.3203">notSettledCount: &lt;integer&gt; // count of accounts in NOT_SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="606" y="1718.6309">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="606" y="1733.9414">settlementAccountsInit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="427" x="766" y="1733.9414">copy of previous object to be preserved for comparission at the end</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="606" y="1749.252">allAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="684" y="1749.252">: { // same as previous but accessed by account id (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="1094" y="1749.252">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1243" y="1749.252">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="523" x="622" y="1764.5625">participantCurrencyId_key: { // number used to access the object in map-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="638" y="1779.873">id: participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="638" y="1795.1836">state: settlementStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="638" y="1810.4941">reason: reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="638" y="1825.8047">createdDate: createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="638" y="1841.1152">netSettlementAmount: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="654" y="1856.4258">amount: netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="654" y="1871.7363">currency: currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="638" y="1887.0469">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="468" x="638" y="1902.3574">participantId: participantId, // could be used to reconstruct allParticipants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="638" y="1917.668">key:</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="668" y="1917.668">key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="430" x="694" y="1917.668">// will be used to insert new state for settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="622" y="1932.9785">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="606" y="1948.2891">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76" x="606" y="1963.5996">allWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="506" x="682" y="1963.5996">: { // same as settlementWindows response object with initial data (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="1192" y="1963.5996">windowsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1270" y="1963.5996">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="515" x="622" y="1978.9102">settlementWindowId_key: { // number used to access the object in map-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="638" y="1994.2207">id: settlementWindowId, // same as key value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="638" y="2009.5313">state: settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="638" y="2024.8418">reason: reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="638" y="2040.1523">createdDate: createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="622" y="2055.4629">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="606" y="2070.7734">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121" x="606" y="2086.084">windowsAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="727" y="2086.084">: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="515" x="622" y="2101.3945">settlementWindowId_key: { // number used to access the object in map-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="638" y="2116.7051">id: settlementWindowId // same as key value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="567" x="638" y="2132.0156">pendingSettlementCount: &lt;integer&gt;, // count of accounts in PENDING_SETTLEMENT state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="605" x="638" y="2147.3262">psTransfersRecordedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_RECORDED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="596" x="638" y="2162.6367">psTransfersReservedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_RESERVED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="626" x="638" y="2177.9473">psTransfersCommittedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_COMMITTED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="402" x="638" y="2193.2578">settledCount: &lt;integer&gt;, // count of accounts in SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="454" x="638" y="2208.5684">notSettledCount: &lt;integer&gt; // count of accounts in NOT_SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="622" y="2223.8789">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="606" y="2239.1895">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="143" x="606" y="2254.5">windowsAccountsInit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="427" x="753" y="2254.5">copy of previous object to be preserved for comparission at the end</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="606" y="2269.8105">accountsWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="726" y="2269.8105">: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="523" x="622" y="2285.1211">participantCurrencyId_key: { // number used to access the object in map-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="638" y="2300.4316">id: participantCurrencyId, // same as key value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="638" y="2315.7422">windows: [] // array of windows to which the account settlement spans</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="622" y="2331.0527">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="606" y="2346.3633">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="606" y="2361.6738">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="626" y="2361.6738">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="782" y="2361.6738">= now()</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="2424.7266" y2="2424.7266"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="2424.7266" y2="2437.7266"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="2437.7266" y2="2437.7266"/><polygon fill="#A80036" points="606,2433.7266,596,2437.7266,606,2441.7266,602,2437.7266" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="2419.9844">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="624" y="2419.9844">Declare and initialize variables</text><path d="M600,2450.7266 L600,2659.7266 L892,2659.7266 L892,2460.7266 L882,2450.7266 L600,2450.7266 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M882,2450.7266 L882,2460.7266 L892,2460.7266 L882,2450.7266 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="606" y="2468.2949">let settlementAccounts = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="622" y="2483.6055">pendingSettlementCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="622" y="2498.916">psTransfersRecordedCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="622" y="2514.2266">psTransfersReservedCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="622" y="2529.5371">psTransfersCommittedCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="622" y="2544.8477">settledCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="622" y="2560.1582">notSettledCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="622" y="2575.4688">unknownCount: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="606" y="2590.7793">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="606" y="2606.0898">let allAccounts = {} // declare map</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="606" y="2621.4004">let pid // participantId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="271" x="606" y="2636.7109">let aid // accountId (participantCurrencyId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="606" y="2652.0215">let state</text><path d="M523,2675.7637 L597,2675.7637 L597,2682.7637 L587,2692.7637 L523,2692.7637 L523,2675.7637 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="767.1152" style="stroke: #000000; stroke-width: 2.0;" width="454" x="523" y="2675.7637"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="538" y="2689.332">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="200" x="612" y="2688.3984">[settlementAccountsList as account]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="2714.3848" y2="2714.3848"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="2714.3848" y2="2727.3848"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="2727.3848" y2="2727.3848"/><polygon fill="#A80036" points="606,2723.3848,596,2727.3848,606,2731.3848,602,2727.3848" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="2709.6426">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="624" y="2709.6426">Populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="682" y="2709.6426">allAccounts</text><path d="M600,2740.3848 L600,2994.3848 L848,2994.3848 L848,2750.3848 L838,2740.3848 L600,2740.3848 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M838,2740.3848 L838,2750.3848 L848,2750.3848 L838,2740.3848 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="606" y="2757.9531">pid = account.participantId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="606" y="2773.2637">aid = account.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="606" y="2788.5742">state = account.settlementStateId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="610" y="2803.8848"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="606" y="2819.1953">allAccounts[aid] = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="622" y="2834.5059">id: aid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="622" y="2849.8164">state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="622" y="2865.127">reason: account.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="622" y="2880.4375">createDate: account.createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="622" y="2895.748">netSettlementAmount: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="638" y="2911.0586">amount: account.netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="638" y="2926.3691">currency: account.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="622" y="2941.6797">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="622" y="2956.9902">participantId: pid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="622" y="2972.3008">key: account.key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="606" y="2987.6113">}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="3025.6641" y2="3025.6641"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="3025.6641" y2="3038.6641"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="3038.6641" y2="3038.6641"/><polygon fill="#A80036" points="606,3034.6641,596,3038.6641,606,3042.6641,602,3038.6641" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="3020.9219">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="624" y="3020.9219">Populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="682" y="3020.9219">settlementAccounts</text><path d="M590,3053.6641 L652,3053.6641 L652,3060.6641 L642,3070.6641 L590,3070.6641 L590,3053.6641 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="382.2148" style="stroke: #000000; stroke-width: 2.0;" width="377" x="590" y="3053.6641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="605" y="3067.2324">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="667" y="3066.2988">[state === 'PENDING_SETTLEMENT']</text><path d="M600,3075.9746 L600,3100.9746 L927,3100.9746 L927,3085.9746 L917,3075.9746 L600,3075.9746 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M917,3075.9746 L917,3085.9746 L927,3085.9746 L917,3075.9746 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="606" y="3093.543">settlementAccounts.pendingSettlementCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="590" x2="967" y1="3111.2852" y2="3111.2852"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="230" x="595" y="3121.9199">[state === 'PS_TRANSFERS_RECORDED']</text><path d="M600,3130.2402 L600,3155.2402 L941,3155.2402 L941,3140.2402 L931,3130.2402 L600,3130.2402 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M931,3130.2402 L931,3140.2402 L941,3140.2402 L931,3130.2402 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="606" y="3147.8086">settlementAccounts.psTransfersRecordedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="590" x2="967" y1="3165.5508" y2="3165.5508"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="225" x="595" y="3176.1855">[state === 'PS_TRANSFERS_RESERVED']</text><path d="M600,3184.5059 L600,3209.5059 L939,3209.5059 L939,3194.5059 L929,3184.5059 L600,3184.5059 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M929,3184.5059 L929,3194.5059 L939,3194.5059 L929,3184.5059 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="318" x="606" y="3202.0742">settlementAccounts.psTransfersReservedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="590" x2="967" y1="3219.8164" y2="3219.8164"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="238" x="595" y="3230.4512">[state === 'PS_TRANSFERS_COMMITTED']</text><path d="M600,3238.7715 L600,3263.7715 L953,3263.7715 L953,3248.7715 L943,3238.7715 L600,3238.7715 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M943,3238.7715 L943,3248.7715 L953,3248.7715 L943,3238.7715 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="606" y="3256.3398">settlementAccounts.psTransfersCommittedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="590" x2="967" y1="3274.082" y2="3274.082"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="126" x="595" y="3284.7168">[state === 'SETTLED']</text><path d="M600,3293.0371 L600,3318.0371 L852,3318.0371 L852,3303.0371 L842,3293.0371 L600,3293.0371 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M842,3293.0371 L842,3303.0371 L852,3303.0371 L842,3293.0371 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="606" y="3310.6055">settlementAccounts.settledCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="590" x2="967" y1="3328.3477" y2="3328.3477"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="595" y="3338.9824">[state === 'NOT_SETTLED']</text><path d="M600,3347.3027 L600,3372.3027 L873,3372.3027 L873,3357.3027 L863,3347.3027 L600,3347.3027 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M863,3347.3027 L863,3357.3027 L873,3357.3027 L863,3347.3027 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="606" y="3364.8711">settlementAccounts.notSettledCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="590" x2="967" y1="3382.6133" y2="3382.6133"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="47" x="595" y="3393.248">[default]</text><path d="M600,3401.5684 L600,3426.5684 L867,3426.5684 L867,3411.5684 L857,3401.5684 L600,3401.5684 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M857,3401.5684 L857,3411.5684 L867,3411.5684 L857,3401.5684 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="606" y="3419.1367">settlementAccounts.unknownCount++</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="3471.1895" y2="3471.1895"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="3471.1895" y2="3484.1895"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="3484.1895" y2="3484.1895"/><polygon fill="#A80036" points="606,3480.1895,596,3484.1895,606,3488.1895,602,3484.1895" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="3466.4473">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="254" x="624" y="3466.4473">Make a copy of settlementAccounts into</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="882" y="3466.4473">settlementAccountsInit</text><path d="M600,3497.1895 L600,3522.1895 L1022,3522.1895 L1022,3507.1895 L1012,3497.1895 L600,3497.1895 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1012,3497.1895 L1012,3507.1895 L1022,3507.1895 L1012,3497.1895 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="401" x="606" y="3514.7578">settlementAccountsInit = Object.assign({}, settlementAccounts)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="3577.8105" y2="3577.8105"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="3577.8105" y2="3590.8105"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="3590.8105" y2="3590.8105"/><polygon fill="#A80036" points="606,3586.8105,596,3590.8105,606,3594.8105,602,3590.8105" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="3573.0684">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="624" y="3573.0684">Declare and populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76" x="761" y="3573.0684">allWindows</text><path d="M600,3603.8105 L600,3628.8105 L836,3628.8105 L836,3613.8105 L826,3603.8105 L600,3603.8105 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M826,3603.8105 L826,3613.8105 L836,3613.8105 L826,3603.8105 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="215" x="606" y="3621.3789">let allWindows = {} // declare map</text><path d="M590,3645.1211 L664,3645.1211 L664,3652.1211 L654,3662.1211 L590,3662.1211 L590,3645.1211 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="133.1738" style="stroke: #000000; stroke-width: 2.0;" width="326" x="590" y="3645.1211"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="605" y="3658.6895">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="140" x="679" y="3657.7559">[windowsList as window]</text><path d="M600,3667.4316 L600,3768.4316 L902,3768.4316 L902,3677.4316 L892,3667.4316 L600,3667.4316 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M892,3667.4316 L892,3677.4316 L902,3677.4316 L892,3667.4316 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="281" x="606" y="3685">allWindows[window.settlementWindowId] = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="622" y="3700.3105">id: window.settlementWindowId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="254" x="622" y="3715.6211">state: window.settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="622" y="3730.9316">reason: window.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="622" y="3746.2422">createDate: window.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="606" y="3761.5527">}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="3831.6055" y2="3831.6055"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="3831.6055" y2="3844.6055"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="3844.6055" y2="3844.6055"/><polygon fill="#A80036" points="606,3840.6055,596,3844.6055,606,3848.6055,602,3844.6055" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="3826.8633">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="624" y="3826.8633">Declare and populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="761" y="3826.8633">accountsWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="885" y="3826.8633">and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121" x="912" y="3826.8633">windowsAccounts</text><path d="M600,3857.6055 L600,3897.6055 L879,3897.6055 L879,3867.6055 L869,3857.6055 L600,3857.6055 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M869,3857.6055 L869,3867.6055 L879,3867.6055 L869,3857.6055 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="606" y="3875.1738">let accountsWindows = {} // declare map</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="606" y="3890.4844">let windowsAccounts = {} // declare map</text><path d="M580,3914.2266 L654,3914.2266 L654,3921.2266 L644,3931.2266 L580,3931.2266 L580,3914.2266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="628.2285" style="stroke: #000000; stroke-width: 2.0;" width="534" x="580" y="3914.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="595" y="3927.7949">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="184" x="669" y="3926.8613">[windowsAccountsList as record]</text><path d="M600,3936.5371 L600,4190.5371 L1100,4190.5371 L1100,3946.5371 L1090,3936.5371 L600,3936.5371 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1090,3936.5371 L1090,3946.5371 L1100,3946.5371 L1090,3936.5371 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="606" y="3954.1055">wid = record.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="606" y="3969.416">aid = record.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="606" y="3984.7266">state = allAccounts[aid]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="610" y="4000.0371"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="467" x="606" y="4015.3477">accountsWindows[aid] = accountsWindows[aid] ? accountsWindows[aid] : {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="622" y="4030.6582">id: aid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71" x="622" y="4045.9688">windows: []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="606" y="4061.2793">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="606" y="4076.5898">accountsWindows[aid].windows.push(wid)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="610" y="4091.9004"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="479" x="606" y="4107.2109">windowsAccounts[wid] = windowsAccounts[wid] ? windowsAccounts[wid] : {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="622" y="4122.5215">id: wid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="622" y="4137.832">pendingSettlementCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="622" y="4153.1426">settledCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="622" y="4168.4531">notSettledCount: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="606" y="4183.7637">}</text><path d="M590,4207.5059 L652,4207.5059 L652,4214.5059 L642,4224.5059 L590,4224.5059 L590,4207.5059 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="327.9492" style="stroke: #000000; stroke-width: 2.0;" width="395" x="590" y="4207.5059"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="605" y="4221.0742">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="667" y="4220.1406">[state === 'PENDING_SETTLEMENT']</text><path d="M600,4229.8164 L600,4254.8164 L945,4254.8164 L945,4239.8164 L935,4229.8164 L600,4229.8164 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M935,4229.8164 L935,4239.8164 L945,4239.8164 L935,4229.8164 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="324" x="606" y="4247.3848">windowsAccounts[wid].pendingSettlementCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="590" x2="985" y1="4265.127" y2="4265.127"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="230" x="595" y="4275.7617">[state === 'PS_TRANSFERS_RECORDED']</text><path d="M600,4284.082 L600,4309.082 L959,4309.082 L959,4294.082 L949,4284.082 L600,4284.082 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M949,4284.082 L949,4294.082 L959,4294.082 L949,4284.082 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="606" y="4301.6504">windowsAccounts[wid].psTransfersRecordedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="590" x2="985" y1="4319.3926" y2="4319.3926"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="225" x="595" y="4330.0273">[state === 'PS_TRANSFERS_RESERVED']</text><path d="M600,4338.3477 L600,4363.3477 L957,4363.3477 L957,4348.3477 L947,4338.3477 L600,4338.3477 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M947,4338.3477 L947,4348.3477 L957,4348.3477 L947,4338.3477 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="336" x="606" y="4355.916">windowsAccounts[wid].psTransfersReservedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="590" x2="985" y1="4373.6582" y2="4373.6582"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="238" x="595" y="4384.293">[state === 'PS_TRANSFERS_COMMITTED']</text><path d="M600,4392.6133 L600,4417.6133 L971,4417.6133 L971,4402.6133 L961,4392.6133 L600,4392.6133 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M961,4392.6133 L961,4402.6133 L971,4402.6133 L961,4392.6133 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="606" y="4410.1816">windowsAccounts[wid].psTransfersCommittedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="590" x2="985" y1="4427.9238" y2="4427.9238"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="126" x="595" y="4438.5586">[state === 'SETTLED']</text><path d="M600,4446.8789 L600,4471.8789 L870,4471.8789 L870,4456.8789 L860,4446.8789 L600,4446.8789 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M860,4446.8789 L860,4456.8789 L870,4456.8789 L860,4446.8789 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="249" x="606" y="4464.4473">windowsAccounts[wid].settledCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="590" x2="985" y1="4482.1895" y2="4482.1895"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="595" y="4492.8242">[state === 'NOT_SETTLED']</text><path d="M600,4501.1445 L600,4526.1445 L891,4526.1445 L891,4511.1445 L881,4501.1445 L600,4501.1445 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M881,4501.1445 L881,4511.1445 L891,4511.1445 L881,4501.1445 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="606" y="4518.7129">windowsAccounts[wid].notSettledCount++</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="4570.7656" y2="4570.7656"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="4570.7656" y2="4583.7656"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="4583.7656" y2="4583.7656"/><polygon fill="#A80036" points="606,4579.7656,596,4583.7656,606,4587.7656,602,4583.7656" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="4566.0234">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="242" x="624" y="4566.0234">Make a copy of windowsAccounts into</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="143" x="870" y="4566.0234">windowsAccountsInit</text><path d="M600,4596.7656 L600,4621.7656 L998,4621.7656 L998,4606.7656 L988,4596.7656 L600,4596.7656 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M988,4596.7656 L988,4606.7656 L998,4606.7656 L988,4596.7656 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="377" x="606" y="4614.334">windowsAccountsInit = Object.assign({}, windowsAccounts)</text><path d="M600,4661.0762 L600,4854.0762 L1294,4854.0762 L1294,4671.0762 L1284,4661.0762 L600,4661.0762 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1284,4661.0762 L1284,4671.0762 L1294,4671.0762 L1284,4661.0762 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="606" y="4678.6445">Available objects after the setup:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="606" y="4693.9551">settlementAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="414" x="744" y="4693.9551">is used for tracing settlement state and state transition allowance</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="606" y="4709.2656">allAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="474" x="688" y="4709.2656">is helper object, same as previous, providing direct access to account by id</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76" x="606" y="4724.5762">allWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="363" x="686" y="4724.5762">has window information for all windows in the settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121" x="606" y="4739.8867">windowsAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="466" x="731" y="4739.8867">is used for tracing settlement window state and state transition allowance</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="606" y="4755.1973">accountsWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="499" x="730" y="4755.1973">is helper object to show the list of windows to which settlement account spans</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="610" y="4770.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="606" y="4785.8184">Now we are ready to process the</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="54" x="814" y="4785.8184">payload</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="868" y="4785.8184">:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="606" y="4801.1289">participants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="588" x="691" y="4801.1289">= [] // part of the response object that lists the affected participants and respective accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="115" x="606" y="4816.4395">affectedWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="725" y="4816.4395">= [] // array of the affected windows</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="606" y="4831.75">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="261" x="902" y="4831.75">= [] // array to collect inserts to the table</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="131" x="606" y="4847.0605">processedAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="471" x="741" y="4847.0605">= [] // array to log processed accounts and restrict subsequent processing</text><path d="M503,4895.8027 L577,4895.8027 L577,4902.8027 L567,4912.8027 L503,4912.8027 L503,4895.8027 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2043.1875" style="stroke: #000000; stroke-width: 2.0;" width="824" x="503" y="4895.8027"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="518" y="4909.3711">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="218" x="592" y="4908.4375">[let participant IN payload.participants]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="4934.4238" y2="4934.4238"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="4934.4238" y2="4947.4238"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="4947.4238" y2="4947.4238"/><polygon fill="#A80036" points="606,4943.4238,596,4947.4238,606,4951.4238,602,4947.4238" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="4929.6816">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="624" y="4929.6816">Loop payload for each</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="767" y="4929.6816">participantPayload</text><path d="M600,4960.4238 L600,5031.4238 L980,5031.4238 L980,4970.4238 L970,4960.4238 L600,4960.4238 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M970,4960.4238 L970,4970.4238 L980,4970.4238 L970,4960.4238 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="606" y="4977.9922">let participantPayload = payload.participants[participant]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="606" y="4993.3027">participants.push({id: participantPayload.id, accounts: []})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="606" y="5008.6133">let pi = participants.length - 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="606" y="5023.9238">participant = participants[pi]</text><path d="M513,5047.666 L587,5047.666 L587,5054.666 L577,5064.666 L513,5064.666 L513,5047.666 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1884.3242" style="stroke: #000000; stroke-width: 2.0;" width="804" x="513" y="5047.666"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="528" y="5061.2344">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="244" x="602" y="5060.3008">[let account IN participantPayload.accounts]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="5086.2871" y2="5086.2871"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="5086.2871" y2="5099.2871"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="5099.2871" y2="5099.2871"/><polygon fill="#A80036" points="606,5095.2871,596,5099.2871,606,5103.2871,602,5099.2871" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="5081.5449">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="624" y="5081.5449">Loop payload for each</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="106" x="767" y="5081.5449">accountPayload</text><path d="M600,5112.2871 L600,5137.2871 L992,5137.2871 L992,5122.2871 L982,5112.2871 L600,5112.2871 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M982,5112.2871 L982,5122.2871 L992,5122.2871 L982,5112.2871 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="371" x="606" y="5129.8555">let accountPayload = participantPayload.accounts[account]</text><path d="M523,5153.5977 L585,5153.5977 L585,5160.5977 L575,5170.5977 L523,5170.5977 L523,5153.5977 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1771.3926" style="stroke: #000000; stroke-width: 2.0;" width="784" x="523" y="5153.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="538" y="5167.166">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="272" x="600" y="5166.2324">[allAccounts[accountPayload.id] === undefined]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="5192.2188" y2="5192.2188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="5192.2188" y2="5205.2188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="5205.2188" y2="5205.2188"/><polygon fill="#A80036" points="606,5201.2188,596,5205.2188,606,5209.2188,602,5205.2188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="5187.4766">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="624" y="5187.4766">If the account doesn't match the settlement</text><path d="M600,5218.2188 L600,5335.2188 L888,5335.2188 L888,5228.2188 L878,5218.2188 L600,5218.2188 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M878,5218.2188 L878,5228.2188 L888,5228.2188 L878,5218.2188 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="606" y="5235.7871">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="622" y="5251.0977">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="622" y="5266.4082">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="638" y="5281.7188">errorCode: 3000,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="638" y="5297.0293">errorDescription: 'Account not found'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="622" y="5312.3398">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="606" y="5327.6504">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="523" x2="1307" y1="5345.3926" y2="5345.3926"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="401" x="528" y="5356.0273">[participantPayload.id !== allAccounts[accountPayload.id].participantId]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="5380.6582" y2="5380.6582"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="5380.6582" y2="5393.6582"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="5393.6582" y2="5393.6582"/><polygon fill="#A80036" points="606,5389.6582,596,5393.6582,606,5397.6582,602,5393.6582" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="5375.916">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="624" y="5375.916">If the account doesn't match the participant</text><path d="M600,5406.6582 L600,5523.6582 L984,5523.6582 L984,5416.6582 L974,5406.6582 L600,5406.6582 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M974,5406.6582 L974,5416.6582 L984,5416.6582 L974,5406.6582 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="606" y="5424.2266">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="622" y="5439.5371">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="622" y="5454.8477">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="638" y="5470.1582">errorCode: 3000,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="331" x="638" y="5485.4688">errorDescription: 'Participant and account mismatch'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="622" y="5500.7793">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="606" y="5516.0898">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="523" x2="1307" y1="5533.832" y2="5533.832"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="301" x="528" y="5544.4668">[processedAccounts.indexOf(accountPayload.id) &gt; -1]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="5569.0977" y2="5569.0977"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="5569.0977" y2="5582.0977"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="5582.0977" y2="5582.0977"/><polygon fill="#A80036" points="606,5578.0977,596,5582.0977,606,5586.0977,602,5582.0977" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="5564.3555">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="447" x="624" y="5564.3555">If the account has been previosly processed (duplicated in the payload)</text><path d="M600,5595.0977 L600,5773.0977 L1119,5773.0977 L1119,5605.0977 L1109,5595.0977 L600,5595.0977 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1109,5595.0977 L1109,5605.0977 L1119,5605.0977 L1109,5595.0977 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="606" y="5612.666">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="622" y="5627.9766">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="622" y="5643.2871">state: allAccounts[accountPayload.id].state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="622" y="5658.5977">reason: allAccounts[accountPayload.id].reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="622" y="5673.9082">createdDate: allAccounts[accountPayload.id].createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="622" y="5689.2188">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="622" y="5704.5293">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="638" y="5719.8398">errorCode: 3000,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="638" y="5735.1504">errorDescription: 'Account already processed once'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="622" y="5750.4609">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="606" y="5765.7715">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="523" x2="1307" y1="5783.5137" y2="5783.5137"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="380" x="528" y="5794.1484">[allAccounts[account.id].state === accountPayload.state // allowed]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="5818.7793" y2="5818.7793"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="5818.7793" y2="5831.7793"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="5831.7793" y2="5831.7793"/><polygon fill="#A80036" points="606,5827.7793,596,5831.7793,606,5835.7793,602,5831.7793" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="5814.0371">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="624" y="5814.0371">Same-state reason amendment is always allowed</text><path d="M600,5844.7793 L600,6083.7793 L1119,6083.7793 L1119,5854.7793 L1109,5844.7793 L600,5844.7793 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1109,5844.7793 L1109,5854.7793 L1119,5854.7793 L1109,5844.7793 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="606" y="5862.3477">processedAccounts.push(accountPayload.id)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="606" y="5877.6582">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="622" y="5892.9688">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="622" y="5908.2793">state: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="622" y="5923.5898">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="622" y="5938.9004">createdDate: transactionTimestamp,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="622" y="5954.2109">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="606" y="5969.5215">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="606" y="5984.832">settlementParticipantCurrencyStateChange.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="622" y="6000.1426">settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="622" y="6015.4531">settlementStateId: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="622" y="6030.7637">reason: accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="606" y="6046.0742">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="606" y="6061.3848">allAccounts[accountPayload.id].reason = accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="606" y="6076.6953">allAccounts[accountPayload.id].createdDate = currentTimestamp</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="523" x2="1307" y1="6094.4375" y2="6094.4375"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="628" x="528" y="6105.0723">[settlementData.state === 'PENDING_SETTLEMENT' &amp;&amp; accountPayload.state === 'PS_TRANSFERS_RECORDED']</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="523" x2="1307" y1="6109.3926" y2="6109.3926"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="646" x="528" y="6120.0273">[settlementData.state === 'PS_TRANSFERS_RECORDED' &amp;&amp; accountPayload.state === 'PS_TRANSFERS_RESERVED']</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="523" x2="1307" y1="6124.3477" y2="6124.3477"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="654" x="528" y="6134.9824">[settlementData.state === 'PS_TRANSFERS_RESERVED' &amp;&amp; accountPayload.state === 'PS_TRANSFERS_COMMITTED']</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="523" x2="1307" y1="6139.3027" y2="6139.3027"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="779" x="528" y="6149.9375">[settlementData.state === 'PS_TRANSFERS_COMMITTED' || settlementData.state === 'SETTLING' &amp;&amp; accountPayload.state === 'SETTLED']</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="6174.5684" y2="6174.5684"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="6174.5684" y2="6187.5684"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="6187.5684" y2="6187.5684"/><polygon fill="#A80036" points="606,6183.5684,596,6187.5684,606,6191.5684,602,6187.5684" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="6169.8262">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="624" y="6169.8262">True settlement acknowledgement</text><path d="M600,6200.5684 L600,6516.5684 L1119,6516.5684 L1119,6210.5684 L1109,6200.5684 L600,6200.5684 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1109,6200.5684 L1109,6210.5684 L1119,6210.5684 L1109,6200.5684 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="606" y="6218.1367">processedAccounts.push(accountPayload.id)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="606" y="6233.4473">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="622" y="6248.7578">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="622" y="6264.0684">state: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="622" y="6279.3789">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="622" y="6294.6895">createdDate: transactionTimestamp,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="622" y="6310">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="606" y="6325.3105">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="606" y="6340.6211">settlementParticipantCurrencyStateChange.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="622" y="6355.9316">settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="622" y="6371.2422">settlementStateId: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="622" y="6386.5527">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="622" y="6401.8633">settlementTransferId: Uuid()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="606" y="6417.1738">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="606" y="6432.4844">settlementAccounts.pendingSettlementCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="606" y="6447.7949">settlementAccounts.settledCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="382" x="606" y="6463.1055">allAccounts[accountPayload.id].state = accountPayload.state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="606" y="6478.416">allAccounts[accountPayload.id].reason = accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="606" y="6493.7266">allAccounts[accountPayload.id].createdDate = currentTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="606" y="6509.0371">let settlementWindowId</text><path d="M590,6532.7793 L664,6532.7793 L664,6539.7793 L654,6549.7793 L590,6549.7793 L590,6532.7793 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="148.4844" style="stroke: #000000; stroke-width: 2.0;" width="510" x="590" y="6532.7793"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="605" y="6546.3477">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="320" x="679" y="6545.4141">[let aw IN accountsWindows[accountPayload.id].windows]</text><path d="M600,6555.0898 L600,6672.0898 L1086,6672.0898 L1086,6565.0898 L1076,6555.0898 L600,6555.0898 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1076,6555.0898 L1076,6565.0898 L1086,6565.0898 L1076,6555.0898 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="465" x="606" y="6572.6582">settlementWindowId = accountsWindows[accountPayload.id].windows[aw]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="606" y="6587.9688">windowsAccounts[settlementWindowId].pendingSettlementCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="355" x="606" y="6603.2793">windowsAccounts[settlementWindowId].settledCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="610" y="6618.5898"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="352" x="606" y="6633.9004">if (affectedWindows.indexOf(settlementWindowId) &lt; 0) {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="622" y="6649.2109">affectedWindows.push(settlementWindowId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="606" y="6664.5215">}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="523" x2="1307" y1="6689.2637" y2="6689.2637"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="6711.5742" y2="6711.5742"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="6711.5742" y2="6724.5742"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="6724.5742" y2="6724.5742"/><polygon fill="#A80036" points="606,6720.5742,596,6724.5742,606,6728.5742,602,6724.5742" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="6706.832">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="624" y="6706.832">All other state transitions are not permitted</text><path d="M600,6737.5742 L600,6915.5742 L1119,6915.5742 L1119,6747.5742 L1109,6737.5742 L600,6737.5742 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1109,6737.5742 L1109,6747.5742 L1119,6747.5742 L1109,6737.5742 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="606" y="6755.1426">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="622" y="6770.4531">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="622" y="6785.7637">state: allAccounts[accountPayload.id].state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="622" y="6801.0742">reason: allAccounts[accountPayload.id].reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="622" y="6816.3848">createdDate: allAccounts[accountPayload.id].createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="622" y="6831.6953">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="622" y="6847.0059">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="638" y="6862.3164">errorCode: &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="638" y="6877.627">errorDescription: 'State change not allowed'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="622" y="6892.9375">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="606" y="6908.248">})</text><path d="M523,6952.9902 L936,6952.9902 L936,6959.9902 L926,6969.9902 L523,6969.9902 L523,6952.9902 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="397.2793" style="stroke: #000000; stroke-width: 2.0;" width="796" x="523" y="6952.9902"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="368" x="538" y="6966.5586">Bulk insert settlementParticipantCurrencyStateChange</text><polygon fill="#A80036" points="1071,6987.6113,1081,6991.6113,1071,6995.6113,1075,6991.6113" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="1077" y1="6991.6113" y2="6991.6113"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="6986.8691">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="624" y="6986.8691">Insert settlementParticipantCurrencyStateChange</text><polygon fill="#FFFFE0" filter="url(#f17jvp8yspv6t)" points="952,7004.6113,1224,7004.6113,1234,7015.6113,1224,7027.6113,952,7027.6113,942,7015.6113,952,7004.6113" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="954" y="7021.1797">settlementParticipantCurrencyStateChange</text><polygon fill="#A80036" points="606,7050.2324,596,7054.2324,606,7058.2324,602,7054.2324" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="600" x2="1087" y1="7054.2324" y2="7054.2324"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="612" y="7049.4902">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="634" y="7049.4902">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="329" x="679" y="7049.4902">settlementParticipantCurrencyStateChangeIdList</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="7114.1641" y2="7114.1641"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="7114.1641" y2="7127.1641"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="7127.1641" y2="7127.1641"/><polygon fill="#A80036" points="606,7123.1641,596,7127.1641,606,7131.1641,602,7127.1641" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="7094.1113">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="345" x="624" y="7078.8008">Merge settlementParticipantCurrencyStateChangeIdList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="624" y="7094.1113">to settlementParticipantCurrencyIdList in order to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="624" y="7109.4219">issue the following update in one knex command</text><polygon fill="#A80036" points="1071,7152.4746,1081,7156.4746,1071,7160.4746,1075,7156.4746" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="1077" y1="7156.4746" y2="7156.4746"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="7151.7324">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="624" y="7151.7324">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#f17jvp8yspv6t)" points="876,7199.4746,1299,7199.4746,1309,7271.4746,1299,7344.4746,876,7344.4746,866,7271.4746,876,7199.4746" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="878" y="7216.043">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="932" y="7216.043">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="878" y="7231.3535">SET currentStateChangeId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="894" y="7246.6641">{settlementParticipantCurrencyStateChangeIdList},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="894" y="7261.9746"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="894" y="7261.9746">settlementTransferId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="894" y="7277.2852"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="403" x="894" y="7277.2852">settlementParticipantCurrencyStateChange.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="894" y="7292.5957"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="894" y="7292.5957">-- only for PENDING_SETTLEMENT to SETTLED</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="878" y="7307.9063">WHERE settlementParticipantCurrencyId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="910" y="7323.2168">{settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="910" y="7338.5273">.settlementParticipantCurrencyIdList}</text><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="86.5527" style="stroke: #000000; stroke-width: 2.0;" width="605" x="530" y="7357.2695"/><polygon fill="#EEEEEE" points="530,7357.2695,594,7357.2695,594,7364.2695,584,7374.2695,530,7374.2695,530,7357.2695" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="543" y="7371.8379">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="657" y="7390.8379">Settlement Transfer Prepare {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-settransfer-prepare-6.3.1.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-settransfer-prepare-6.3.1.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="32" x="838" y="7390.8379">6.3.1</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="838" x2="870" y1="7392.8379" y2="7392.8379"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="870" y="7390.8379">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="661" y="7406.1484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="657" y="7421.459">Inputs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="700" y="7421.459">: settlementId, transactionTimestamp, enums, trx</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="661" y="7436.7695"/><path d="M523,7455.8223 L908,7455.8223 L908,7462.8223 L898,7472.8223 L523,7472.8223 L523,7455.8223 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="652.6074" style="stroke: #000000; stroke-width: 2.0;" width="749" x="523" y="7455.8223"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="340" x="538" y="7469.3906">Prepare and insert settlementWindowStateChange</text><path d="M600,7478.1328 L600,7564.1328 L912,7564.1328 L912,7488.1328 L902,7478.1328 L600,7478.1328 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M902,7478.1328 L902,7488.1328 L912,7488.1328 L902,7478.1328 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="606" y="7495.7012">let settlementWindowStateChange = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="606" y="7511.0117">let settlementWindows = [] // response object</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="606" y="7526.3223">let windowAccountsInit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="606" y="7541.6328">let windowAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="606" y="7556.9434">let windowState</text><path d="M570,7580.6855 L644,7580.6855 L644,7587.6855 L634,7597.6855 L570,7597.6855 L570,7580.6855 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="293.8809" style="stroke: #000000; stroke-width: 2.0;" width="625" x="570" y="7580.6855"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="585" y="7594.2539">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="659" y="7593.3203">[let aw IN affectedWindows]</text><path d="M600,7602.9961 L600,7642.9961 L1035,7642.9961 L1035,7612.9961 L1025,7602.9961 L600,7602.9961 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1025,7602.9961 L1025,7612.9961 L1035,7612.9961 L1025,7602.9961 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="414" x="606" y="7620.5645">windowAccountsInit = windowAccountsInit[affectedWindows[aw]]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="379" x="606" y="7635.875">windowAccounts = windowsAccounts[affectedWindows[aw]]</text><path d="M580,7659.6172 L647,7659.6172 L647,7666.6172 L637,7676.6172 L580,7676.6172 L580,7659.6172 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="207.9492" style="stroke: #000000; stroke-width: 2.0;" width="605" x="580" y="7659.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="595" y="7673.1855">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="518" x="662" y="7672.252">[windowAccounts.pendingSettlementCount !== windowAccountsInit.pendingSettlementCount</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="398" x="662" y="7685.207">|| windowAccounts.settledCount !== windowAccountsInit.settledCount]</text><path d="M590,7694.8379 L657,7694.8379 L657,7701.8379 L647,7711.8379 L590,7711.8379 L590,7694.8379 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="126.418" style="stroke: #000000; stroke-width: 2.0;" width="540" x="590" y="7694.8379"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="605" y="7708.4063">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="279" x="672" y="7707.4727">[windowAccounts.pendingSettlementCount === 0</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="247" x="672" y="7720.4277">&amp;&amp; windowAccounts.notSettledCount === 0</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="218" x="672" y="7733.3828">&amp;&amp; windowAccounts.settledCound &gt; 0]</text><path d="M600,7741.0137 L600,7812.0137 L1116,7812.0137 L1116,7751.0137 L1106,7741.0137 L600,7741.0137 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1106,7741.0137 L1106,7751.0137 L1116,7751.0137 L1106,7741.0137 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="324" x="606" y="7758.582">allWindows[affectedWindows[aw]].state = 'SETTLED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="495" x="606" y="7773.8926">allWindows[affectedWindows[aw]].reason = 'All setlement accounts are settled'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="423" x="606" y="7789.2031">allWindows[affectedWindows[aw]].createdDate = currentTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="606" y="7804.5137">settlementWindowStateChange.push(allWindows[affectedWindows[aw]])</text><path d="M600,7833.2559 L600,7858.2559 L998,7858.2559 L998,7843.2559 L988,7833.2559 L600,7833.2559 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M988,7833.2559 L988,7843.2559 L998,7843.2559 L988,7833.2559 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="377" x="606" y="7850.8242">settlementWindows.push(allWindows[affectedWindows[aw]])</text><polygon fill="#A80036" points="1071,7898.877,1081,7902.877,1071,7906.877,1075,7902.877" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="1077" y1="7902.877" y2="7902.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="7898.1348">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="624" y="7898.1348">Insert settlementWindowStateChange</text><polygon fill="#FFFFE0" filter="url(#f17jvp8yspv6t)" points="989,7915.877,1187,7915.877,1197,7926.877,1187,7938.877,989,7938.877,979,7926.877,989,7915.877" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="991" y="7932.4453">settlementWindowStateChange</text><polygon fill="#A80036" points="606,7961.498,596,7965.498,606,7969.498,602,7965.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="600" x2="1087" y1="7965.498" y2="7965.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="612" y="7960.7559">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="634" y="7960.7559">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="247" x="679" y="7960.7559">settlementWindowStateChangeIdList</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="7994.8086" y2="7994.8086"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="7994.8086" y2="8007.8086"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="8007.8086" y2="8007.8086"/><polygon fill="#A80036" points="606,8003.8086,596,8007.8086,606,8011.8086,602,8007.8086" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="7990.0664">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="624" y="7990.0664">Merge ids to prepare for single update command</text><polygon fill="#A80036" points="1071,8033.1191,1081,8037.1191,1071,8041.1191,1075,8037.1191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="1077" y1="8037.1191" y2="8037.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="8032.377">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="624" y="8032.377">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#f17jvp8yspv6t)" points="923,8080.1191,1252,8080.1191,1262,8091.1191,1252,8103.1191,923,8103.1191,913,8091.1191,923,8080.1191" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="925" y="8096.6875">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="979" y="8096.6875">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="1104" y="8096.6875">.currentStateChangeIds</text><path d="M513,8122.4297 L845,8122.4297 L845,8129.4297 L835,8139.4297 L513,8139.4297 L513,8122.4297 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="433.834" style="stroke: #000000; stroke-width: 2.0;" width="739" x="513" y="8122.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="287" x="528" y="8135.998">Prepare and insert settlementStateChange</text><path d="M523,8146.7402 L590,8146.7402 L590,8153.7402 L580,8163.7402 L523,8163.7402 L523,8146.7402 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="402.5234" style="stroke: #000000; stroke-width: 2.0;" width="719" x="523" y="8146.7402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="538" y="8160.3086">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="416" x="605" y="8159.375">[settlementAccounts.settledCount !== settlementAccountsInit.settledCount</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="310" x="605" y="8172.3301">&amp;&amp; settlementAccounts.pendingSettlementCount === 0</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="266" x="605" y="8185.2852">&amp;&amp; settlementAccounts.notSettledCount === 0]</text><path d="M600,8192.916 L600,8263.916 L1001,8263.916 L1001,8202.916 L991,8192.916 L600,8192.916 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M991,8192.916 L991,8202.916 L1001,8202.916 L991,8192.916 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="606" y="8210.4844">settlementData.state = 'SETTLED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380" x="606" y="8225.7949">settlementData.reason = 'All setlement accounts are settled'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="606" y="8241.1055">settlementData.createdDate = currentTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="606" y="8256.416">settlementStateChange.push(settlementData)</text><polygon fill="#A80036" points="1071,8290.4688,1081,8294.4688,1071,8298.4688,1075,8294.4688" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="1077" y1="8294.4688" y2="8294.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="8289.7266">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="624" y="8289.7266">Insert settlementStateChange</text><polygon fill="#FFFFE0" filter="url(#f17jvp8yspv6t)" points="1013,8307.4688,1162,8307.4688,1172,8318.4688,1162,8330.4688,1013,8330.4688,1003,8318.4688,1013,8307.4688" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="1015" y="8324.0371">settlementStateChange</text><polygon fill="#A80036" points="606,8353.0898,596,8357.0898,606,8361.0898,602,8357.0898" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="600" x2="1087" y1="8357.0898" y2="8357.0898"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="612" y="8352.3477">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="634" y="8352.3477">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="679" y="8352.3477">settlementStateChangeId</text><polygon fill="#A80036" points="1071,8382.4004,1081,8386.4004,1071,8390.4004,1075,8386.4004" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="1077" y1="8386.4004" y2="8386.4004"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="8381.6582">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="624" y="8381.6582">Update pointer to current state change id</text><polygon fill="#FFFFE0" filter="url(#f17jvp8yspv6t)" points="953,8429.4004,1222,8429.4004,1232,8440.4004,1222,8452.4004,953,8452.4004,943,8440.4004,953,8429.4004" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="955" y="8445.9688">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="1009" y="8445.9688">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="1081" y="8445.9688">.currentStateChangeId</text><rect fill="#FFFFFF" filter="url(#f17jvp8yspv6t)" height="86.5527" style="stroke: #000000; stroke-width: 2.0;" width="605" x="530" y="8457.7109"/><polygon fill="#EEEEEE" points="530,8457.7109,594,8457.7109,594,8464.7109,584,8474.7109,530,8474.7109,530,8457.7109" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="543" y="8472.2793">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="657" y="8491.2793">Settlement Transfer Commit {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-settransfer-commit-6.3.2.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-settransfer-commit-6.3.2.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="32" x="842" y="8491.2793">6.3.2</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="842" x2="874" y1="8493.2793" y2="8493.2793"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="874" y="8491.2793">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="661" y="8506.5898"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="657" y="8521.9004">Inputs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="700" y="8521.9004">: settlementId, transactionTimestamp, enums, trx</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="661" y="8537.2109"/><polygon fill="#A80036" points="362,8587.5742,352,8591.5742,362,8595.5742,358,8591.5742" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="356" x2="589" y1="8591.5742" y2="8591.5742"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="368" y="8586.832">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="390" y="8586.832">Return transaction result</text><path d="M40,8604.5742 L40,9226.5742 L332,9226.5742 L332,8614.5742 L322,8604.5742 L40,8604.5742 " fill="#D3D3D3" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M322,8604.5742 L322,8614.5742 L332,8614.5742 L322,8604.5742 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="46" y="8622.1426">Samples:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="46" y="8637.4531">"</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="132" x="51" y="8637.4531">settlementWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="183" y="8637.4531">": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="62" y="8652.7637">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="78" y="8668.0742">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="78" y="8683.3848">"state": &lt;enum&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="78" y="8698.6953">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="78" y="8714.0059">"createdDate": &lt;date&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="62" y="8729.3164">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="46" y="8744.627">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="46" y="8759.9375">"</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="51" y="8759.9375">participants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="132" y="8759.9375">": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="62" y="8775.248">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="78" y="8790.5586">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="78" y="8805.8691">"accounts": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="94" y="8821.1797">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="110" y="8836.4902">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="110" y="8851.8008">"state": "SETTLED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="110" y="8867.1113">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="110" y="8882.4219">"createdDate": &lt;date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="110" y="8897.7324">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="126" y="8913.043">"amount": &lt;decimal&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="126" y="8928.3535">"currency": &lt;enum&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="110" y="8943.6641">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="94" y="8958.9746">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="94" y="8974.2852">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="110" y="8989.5957">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="110" y="9004.9063">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="110" y="9020.2168">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="110" y="9035.5273">"createdDate": &lt;date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="110" y="9050.8379">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="126" y="9066.1484">"amount": &lt;decimal&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="126" y="9081.459">"currency": &lt;enum&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="110" y="9096.7695">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="110" y="9112.0801">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="126" y="9127.3906">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="126" y="9142.7012">"errorDescription": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="110" y="9158.0117">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="94" y="9173.3223">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="78" y="9188.6328">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="62" y="9203.9434">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="46" y="9219.2539">]</text><path d="M23,9240.9961 L23,9387.9961 L332,9387.9961 L332,9250.9961 L322,9240.9961 L23,9240.9961 " fill="#FFFFE0" filter="url(#f17jvp8yspv6t)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M322,9240.9961 L322,9250.9961 L332,9250.9961 L322,9240.9961 " fill="#FFFFE0" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="29" y="9258.5645">[</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="37" y="9273.875">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="45" y="9289.1855">"id": {id},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="45" y="9304.4961">"state": settlementData.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="45" y="9319.8066">"createdDate": settlementData.createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="45" y="9335.1172">"settlementWindows": settlementWindows,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="45" y="9350.4277">"participants": participants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="37" y="9365.7383">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="29" y="9381.0488">]</text><polygon fill="#A80036" points="179,9415.1016,169,9419.1016,179,9423.1016,175,9419.1016" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="173" x2="345" y1="9419.1016" y2="9419.1016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="185" y="9414.3594">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="207" y="9414.3594">Return response</text><!--
@startuml
title 6.2.5. Acknowledgement of Settlement Transfer (updateSettlementById)
autonumber

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Settlement Service" #lightgreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

group Acknowledgement of Settlement Transfer
    activate OPERATOR
    note right of OPERATOR #yellow
        {
            "participants": [
                {
                    "id": 1
                    "accounts" : [
                        { "id": 1, "state": "PENDING_SETTLEMENT", "reason": "abc" },
                        { "id": 2, "state": "PS_TRANSFERS_RECORDED", "reason": "def" },
                        { "id": 3, "state": "PS_TRANSFERS_RESERVED", "reason": "ghi" },
                        { "id": 4, "state": "PS_TRANSFERS_COMMITTED", "reason": "jkl" },
                        { "id": 5, "state": "SETTLED", "reason": "mno" }
                    ]
                },
                {
                    "id": 2
                    "accounts" : [
                        { "id": 6, "state": "NOT_SETTLED", "reason": "pqr" }
                    ]
                }
            ]
        }
    end note

    OPERATOR -> SSAPI: PUT - /settlement/{id}
    activate SSAPI
    SSAPI -> SETTLE_DAO: updateSettlementById command\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    group <color #blue>DB TRANSACTION</color>
        SETTLE_DAO -> DB: Retrieve settlement information
        activate DB
        hnote over DB #lightyellow
            SELECT s.settlementId, ssc.settlementStateId, 
                ssc.reason, ssc.createdDate
            FROM **settlement** s
            JOIN **settlementStateChange** ssc
            ON ssc.settlementStateChangeId = s.currentStateChangeId
            WHERE s.settlementId = {id}
            FOR UPDATE
        end hnote
        SETTLE_DAO <- - DB: Return **settlementData**
        deactivate DB

        SETTLE_DAO -> DB: Retrive settlement accounts information
        activate DB
        hnote over DB #lightyellow
            SELECT pc.participantId, spc.participantCurrencyId, 
                spcsc.settlementStateId, spcsc.reason,
                spcsc.createdDate, spc.netAmount, pc.currencyId, 
                spc.settlementParticipantCurrencyId AS <color #0000FF>key</color>
            FROM **settlementParticipantCurrency** spc
            JOIN **settlementParticipantCurrencyStateChange** spcsc
            ON spcsc.settlementParticipantCurrencyStateChangeId = 
            spc.currentStateChangeId
            JOIN **participantCurrency** pc
            ON pc.participantCurrencyId = spc.participantCurrencyId
            WHERE spc.settlementId = {id}
            FOR UPDATE
        end hnote
        SETTLE_DAO <- - DB: Return **settlementAccountsList**
        deactivate DB

        SETTLE_DAO -> DB: Retrive settlement windows information
        activate DB
        hnote over DB #lightyellow
            SELECT ssw.settlementWindowId, swsc.settlementWindowStateId,
                swsc.reason, swsc.createdDate
            FROM **settlementSettlementWindow** ssw
            JOIN **settlementWindow** sw
            ON sw.settlementWindow = ssw.settlementWindowId
            JOIN **settlementWindowStateChange** swsc
            ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId
            WHERE ssw.settlementId = {id}
            FOR UPDATE
        end hnote
        SETTLE_DAO <- - DB: Return **windowsList**
        deactivate DB

        SETTLE_DAO -> DB: Retrieve settlement windows accounts information
        activate DB
        hnote over DB #lightyellow
            SELECT DISTINCT settlementWindowId, participantCurrencyId
            FROM **settlementTransferParticipant**
            WHERE settlementId = {id}
            FOR UPDATE
        end hnote
        SETTLE_DAO <- - DB: Return **windowsAccountsList**
        deactivate DB

        note right of SETTLE_DAO #lightblue
            All objects below are done for the purposes of the syncronous request.
            If at same point Node process memory limit is reached we may decide to:
            A. Limit the amount of transfers per window and windows per settlement or
            B. Move to asyncronous processing where we don't need these objects
        end note
        note right of SETTLE_DAO #lightgray
            Available raw datasets from DB:
            **settlementData** contains information about settlement and its current state/reason
            **settlementAccountsList** holds information about all accounts and their current state/reason
            **windowsList** has information about all windows and their current state/reason
            **windowsAccountsList** has information about all accounts and windows

            Local variables and objects:
            **settlementAccounts**: { // (derived from <color 0000FF>settlementAccountsList</color>)
                pendingSettlementCount: <integer>, // count of accounts in PENDING_SETTLEMENT state
                psTransfersRecordedCount: <integer>, // count of accounts in PS_TRANSFERS_RECORDED state
                psTransfersReservedCount: <integer>, // count of accounts in PS_TRANSFERS_RESERVED state
                psTransfersCommittedCount: <integer>, // count of accounts in PS_TRANSFERS_COMMITTED state
                settledCount: <integer>, // count of accounts in SETTLED state
                notSettledCount: <integer> // count of accounts in NOT_SETTLED state
            }
            **settlementAccountsInit** copy of previous object to be preserved for comparission at the end
            **allAccounts**: { // same as previous but accessed by account id (derived from <color 0000FF>settlementAccountsList</color>)
                participantCurrencyId_key: { // number used to access the object in map-like style
                    id: participantCurrencyId,
                    state: settlementStateId,
                    reason: reason,
                    createdDate: createdDate,
                    netSettlementAmount: {
                        amount: netAmount,
                        currency: currencyId
                    },
                    participantId: participantId, // could be used to reconstruct allParticipants
                    key: <color 0000FF>key</color> // will be used to insert new state for settlementParticipantCurrency
                }
            }
            **allWindows**: { // same as settlementWindows response object with initial data (derived from <color 0000FF>windowsList</color>)
                settlementWindowId_key: { // number used to access the object in map-like style
                    id: settlementWindowId, // same as key value
                    state: settlementWindowStateId, 
                    reason: reason, 
                    createdDate: createdDate
                }
            }
            **windowsAccounts**: {
                settlementWindowId_key: { // number used to access the object in map-like style
                    id: settlementWindowId // same as key value
                    pendingSettlementCount: <integer>, // count of accounts in PENDING_SETTLEMENT state
                    psTransfersRecordedCount: <integer>, // count of accounts in PS_TRANSFERS_RECORDED state
                    psTransfersReservedCount: <integer>, // count of accounts in PS_TRANSFERS_RESERVED state
                    psTransfersCommittedCount: <integer>, // count of accounts in PS_TRANSFERS_COMMITTED state
                    settledCount: <integer>, // count of accounts in SETTLED state
                    notSettledCount: <integer> // count of accounts in NOT_SETTLED state
                }
            }
            **windowsAccountsInit** copy of previous object to be preserved for comparission at the end
            **accountsWindows**: {
                participantCurrencyId_key: { // number used to access the object in map-like style
                    id: participantCurrencyId, // same as key value
                    windows: [] // array of windows to which the account settlement spans
                }
            }
            let **transactionTimestamp** = now()
        end note
        |||
        SETTLE_DAO -> SETTLE_DAO: Declare and initialize variables
        note right of SETTLE_DAO #lightgray
            let settlementAccounts = {
                pendingSettlementCount: 0,
                psTransfersRecordedCount: 0,
                psTransfersReservedCount: 0,
                psTransfersCommittedCount: 0,
                settledCount: 0,
                notSettledCount: 0,
                unknownCount: 0
            }
            let allAccounts = {} // declare map
            let pid // participantId
            let aid // accountId (participantCurrencyId)
            let state
        end note

        loop settlementAccountsList as account
            SETTLE_DAO -> SETTLE_DAO: Populate **allAccounts** 
            note right of SETTLE_DAO #lightgray
                pid = account.participantId
                aid = account.participantCurrencyId
                state = account.settlementStateId

                allAccounts[aid] = {
                    id: aid,
                    state,
                    reason: account.reason,
                    createDate: account.createdDate,
                    netSettlementAmount: {
                        amount: account.netAmount,
                        currency: account.currencyId
                    },
                    participantId: pid,
                    key: account.key
                }
            end note

            SETTLE_DAO -> SETTLE_DAO: Populate **settlementAccounts**
            alt state === 'PENDING_SETTLEMENT'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.pendingSettlementCount++
                end note
            else state === 'PS_TRANSFERS_RECORDED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.psTransfersRecordedCount++
                end note
            else state === 'PS_TRANSFERS_RESERVED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.psTransfersReservedCount++
                end note
            else state === 'PS_TRANSFERS_COMMITTED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.psTransfersCommittedCount++
                end note
            else state === 'SETTLED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.settledCount++
                end note
            else state === 'NOT_SETTLED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.notSettledCount++
                end note
            else default
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.unknownCount++
                end note
            end
        end
        SETTLE_DAO -> SETTLE_DAO: Make a copy of settlementAccounts into **settlementAccountsInit**
        note right of SETTLE_DAO #lightgray
            settlementAccountsInit = Object.assign({}, settlementAccounts)
        end note
        |||
        SETTLE_DAO -> SETTLE_DAO: Declare and populate **allWindows**
        note right of SETTLE_DAO #lightgray
            let allWindows = {} // declare map
        end note
        loop windowsList as window
            note right of SETTLE_DAO #lightgray
                allWindows[window.settlementWindowId] = {
                    id: window.settlementWindowId,
                    state: window.settlementWindowStateId,
                    reason: window.reason,
                    createDate: window.createdDate
                }
            end note
        end 
        |||
        SETTLE_DAO -> SETTLE_DAO: Declare and populate **accountsWindows** and **windowsAccounts**
        note right of SETTLE_DAO #lightgray
            let accountsWindows = {} // declare map
            let windowsAccounts = {} // declare map
        end note
        loop windowsAccountsList as record
            note right of SETTLE_DAO #lightgray
                wid = record.settlementWindowId
                aid = record.participantCurrencyId
                state = allAccounts[aid]

                accountsWindows[aid] = accountsWindows[aid] ? accountsWindows[aid] : {
                    id: aid,
                    windows: []
                }
                accountsWindows[aid].windows.push(wid)

                windowsAccounts[wid] = windowsAccounts[wid] ? windowsAccounts[wid] : {
                    id: wid, 
                    pendingSettlementCount: 0,
                    settledCount: 0,
                    notSettledCount: 0
                }
            end note
            alt state === 'PENDING_SETTLEMENT'
                note right of SETTLE_DAO #lightgray
                    windowsAccounts[wid].pendingSettlementCount++
                end note
            else state === 'PS_TRANSFERS_RECORDED'
                note right of SETTLE_DAO #lightgray
                    windowsAccounts[wid].psTransfersRecordedCount++
                end note
            else state === 'PS_TRANSFERS_RESERVED'
                note right of SETTLE_DAO #lightgray
                    windowsAccounts[wid].psTransfersReservedCount++
                end note
            else state === 'PS_TRANSFERS_COMMITTED'
                note right of SETTLE_DAO #lightgray
                    windowsAccounts[wid].psTransfersCommittedCount++
                end note
            else state === 'SETTLED'
                note right of SETTLE_DAO #lightgray
                    windowsAccounts[wid].settledCount++
                end note
            else state === 'NOT_SETTLED'
                note right of SETTLE_DAO #lightgray
                    windowsAccounts[wid].notSettledCount++
                end note
            end
        end
        SETTLE_DAO -> SETTLE_DAO: Make a copy of windowsAccounts into **windowsAccountsInit**
        note right of SETTLE_DAO #lightgray
            windowsAccountsInit = Object.assign({}, windowsAccounts)
        end note 
        |||
        note right of SETTLE_DAO #lightgray
            Available objects after the setup:
            **settlementAccounts** is used for tracing settlement state and state transition allowance
            **allAccounts** is helper object, same as previous, providing direct access to account by id
            **allWindows** has window information for all windows in the settlement
            **windowsAccounts** is used for tracing settlement window state and state transition allowance
            **accountsWindows** is helper object to show the list of windows to which settlement account spans

            Now we are ready to process the **payload**:
            **participants** = [] // part of the response object that lists the affected participants and respective accounts
            **affectedWindows** = [] // array of the affected windows
            **settlementParticipantCurrencyStateChange** = [] // array to collect inserts to the table
            **processedAccounts** = [] // array to log processed accounts and restrict subsequent processing
        end note
        |||
        loop let participant IN payload.participants
            SETTLE_DAO -> SETTLE_DAO: Loop payload for each **participantPayload**
            note right of SETTLE_DAO #lightgray
                let participantPayload = payload.participants[participant]
                participants.push({id: participantPayload.id, accounts: []})
                let pi = participants.length - 1
                participant = participants[pi]
            end note

            loop let account IN participantPayload.accounts
                SETTLE_DAO -> SETTLE_DAO: Loop payload for each **accountPayload**
                note right of SETTLE_DAO #lightgray
                    let accountPayload = participantPayload.accounts[account]
                end note
                alt allAccounts[accountPayload.id] === undefined
                    SETTLE_DAO -> SETTLE_DAO: If the account doesn't match the settlement
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            errorInformation: {
                                errorCode: 3000,
                                errorDescription: 'Account not found'
                            }
                        })
                    end note
                else participantPayload.id !== allAccounts[accountPayload.id].participantId
                    SETTLE_DAO -> SETTLE_DAO: If the account doesn't match the participant
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            errorInformation: {
                                errorCode: 3000,
                                errorDescription: 'Participant and account mismatch'
                            }
                        })
                    end note
                else processedAccounts.indexOf(accountPayload.id) > -1
                    SETTLE_DAO -> SETTLE_DAO: If the account has been previosly processed (duplicated in the payload)
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: allAccounts[accountPayload.id].state,
                            reason: allAccounts[accountPayload.id].reason,
                            createdDate: allAccounts[accountPayload.id].createdDate,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                            errorInformation: {
                                errorCode: 3000,
                                errorDescription: 'Account already processed once'
                            }
                        })
                    end note
                else allAccounts[account.id].state === accountPayload.state // allowed
                    SETTLE_DAO -> SETTLE_DAO: Same-state reason amendment is always allowed
                    note right of SETTLE_DAO #lightgray
                        processedAccounts.push(accountPayload.id)
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: accountPayload.state,
                            reason: accountPayload.reason,
                            createdDate: transactionTimestamp,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                        })
                        settlementParticipantCurrencyStateChange.push({
                            settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,
                            settlementStateId: accountPayload.state,
                            reason: accountPayload.reason
                        })
                        allAccounts[accountPayload.id].reason = accountPayload.reason
                        allAccounts[accountPayload.id].createdDate = currentTimestamp
                    end note
                else settlementData.state === 'PENDING_SETTLEMENT' && accountPayload.state === 'PS_TRANSFERS_RECORDED'
                else settlementData.state === 'PS_TRANSFERS_RECORDED' && accountPayload.state === 'PS_TRANSFERS_RESERVED'
                else settlementData.state === 'PS_TRANSFERS_RESERVED' && accountPayload.state === 'PS_TRANSFERS_COMMITTED'
                else settlementData.state === 'PS_TRANSFERS_COMMITTED' || settlementData.state === 'SETTLING' && accountPayload.state === 'SETTLED'
                    SETTLE_DAO -> SETTLE_DAO: True settlement acknowledgement
                    note right of SETTLE_DAO #lightgray
                        processedAccounts.push(accountPayload.id)
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: accountPayload.state,
                            reason: accountPayload.reason,
                            createdDate: transactionTimestamp,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                        })
                        settlementParticipantCurrencyStateChange.push({
                            settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,
                            settlementStateId: accountPayload.state,
                            reason: accountPayload.reason,
                            settlementTransferId: Uuid()
                        })
                        settlementAccounts.pendingSettlementCount- -
                        settlementAccounts.settledCount++
                        allAccounts[accountPayload.id].state = accountPayload.state
                        allAccounts[accountPayload.id].reason = accountPayload.reason
                        allAccounts[accountPayload.id].createdDate = currentTimestamp
                        let settlementWindowId
                    end note
                    loop let aw IN accountsWindows[accountPayload.id].windows
                        note right of SETTLE_DAO #lightgray
                            settlementWindowId = accountsWindows[accountPayload.id].windows[aw]
                            windowsAccounts[settlementWindowId].pendingSettlementCount- -
                            windowsAccounts[settlementWindowId].settledCount++

                            if (affectedWindows.indexOf(settlementWindowId) < 0) {
                                affectedWindows.push(settlementWindowId)
                            }
                        end note
                    end
                else
                    SETTLE_DAO -> SETTLE_DAO: All other state transitions are not permitted
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: allAccounts[accountPayload.id].state,
                            reason: allAccounts[accountPayload.id].reason,
                            createdDate: allAccounts[accountPayload.id].createdDate,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                            errorInformation: {
                                errorCode: <integer>,
                                errorDescription: 'State change not allowed'
                            }
                        })
                    end note
                end
            end
        end
        group Bulk insert settlementParticipantCurrencyStateChange
            SETTLE_DAO -> DB: Insert settlementParticipantCurrencyStateChange
            activate DB
            hnote over DB #lightyellow
                settlementParticipantCurrencyStateChange
            end hnote
            SETTLE_DAO <- - DB: Return **settlementParticipantCurrencyStateChangeIdList**
            deactivate DB

            SETTLE_DAO -> SETTLE_DAO: Merge settlementParticipantCurrencyStateChangeIdList\nto settlementParticipantCurrencyIdList in order to\nissue the following update in one knex command

            SETTLE_DAO -> DB: Update pointers to current state change ids
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementParticipantCurrency**
                SET currentStateChangeId = 
                    {settlementParticipantCurrencyStateChangeIdList},
                    <color 00F>settlementTransferId =</color>
                    <color 00F>settlementParticipantCurrencyStateChange.settlementTransferId</color>
                    <color 00F>- - only for PENDING_SETTLEMENT to SETTLED</color>
                WHERE settlementParticipantCurrencyId =
                        {settlementParticipantCurrencyStateChange
                        .settlementParticipantCurrencyIdList}
            end hnote
            deactivate DB
        end
        ref over SETTLE_DAO, DB: Settlement Transfer Prepare {[[https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-settransfer-prepare-6.3.1.svg 6.3.1]]}\n\n**Inputs**: settlementId, transactionTimestamp, enums, trx\n
        group Prepare and insert settlementWindowStateChange
            note right of SETTLE_DAO #lightgray
                let settlementWindowStateChange = []
                let settlementWindows = [] // response object
                let windowAccountsInit
                let windowAccounts
                let windowState
            end note

            loop let aw IN affectedWindows
                note right of SETTLE_DAO #lightgray
                    windowAccountsInit = windowAccountsInit[affectedWindows[aw]]
                    windowAccounts = windowsAccounts[affectedWindows[aw]]
                end note
                opt windowAccounts.pendingSettlementCount !== windowAccountsInit.pendingSettlementCount\n|| windowAccounts.settledCount !== windowAccountsInit.settledCount
                    opt windowAccounts.pendingSettlementCount === 0\n&& windowAccounts.notSettledCount === 0\n&& windowAccounts.settledCound > 0
                        note right of SETTLE_DAO #lightgray
                            allWindows[affectedWindows[aw]].state = 'SETTLED'
                            allWindows[affectedWindows[aw]].reason = 'All setlement accounts are settled'
                            allWindows[affectedWindows[aw]].createdDate = currentTimestamp
                            settlementWindowStateChange.push(allWindows[affectedWindows[aw]])
                        end note
                    end
                    note right of SETTLE_DAO #lightgray
                        settlementWindows.push(allWindows[affectedWindows[aw]])
                    end note
                end
            end

            SETTLE_DAO -> DB: Insert settlementWindowStateChange
            activate DB
            hnote over DB #lightyellow
                settlementWindowStateChange
            end hnote
            SETTLE_DAO <- - DB: Return **settlementWindowStateChangeIdList**
            deactivate DB

            SETTLE_DAO -> SETTLE_DAO: Merge ids to prepare for single update command

            SETTLE_DAO -> DB: Update pointers to current state change ids
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementWindow**.currentStateChangeIds
            end hnote
            deactivate DB
        end

        group Prepare and insert settlementStateChange
            opt settlementAccounts.settledCount !== settlementAccountsInit.settledCount\n&& settlementAccounts.pendingSettlementCount === 0\n&& settlementAccounts.notSettledCount === 0
                note right of SETTLE_DAO #lightgray
                    settlementData.state = 'SETTLED'
                    settlementData.reason = 'All setlement accounts are settled'
                    settlementData.createdDate = currentTimestamp
                    settlementStateChange.push(settlementData)
                end note

                SETTLE_DAO -> DB: Insert settlementStateChange
                activate DB
                hnote over DB #lightyellow
                    settlementStateChange
                end hnote
                SETTLE_DAO <- - DB: Return **settlementStateChangeId**
                deactivate DB

                SETTLE_DAO -> DB: Update pointer to current state change id
                activate DB
                hnote over DB #lightyellow
                    UPDATE **settlement**.currentStateChangeId
                end hnote
                deactivate DB

                ref over SETTLE_DAO, DB: Settlement Transfer Commit {[[https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-settransfer-commit-6.3.2.svg 6.3.2]]}\n\n**Inputs**: settlementId, transactionTimestamp, enums, trx\n
            end
        end
    end
    SSAPI <- - SETTLE_DAO: Return transaction result
    deactivate SETTLE_DAO

    note left of SSAPI #lightgray
        Samples:
        "**settlementWindows**": [
            {
                "id": <integer>,
                "state": <enum>,
                "reason": <string>,
                "createdDate": <date>
            }
        ]
        "**participants**": [
            {
                "id": <integer>,
                "accounts": [
                    {
                        "id": <integer>,
                        "state": "SETTLED",
                        "reason": <string>,
                        "createdDate": <date>,
                        "netSettlementAmount": {
                            "amount": <decimal>,
                            "currency": <enum>
                        }
                    },
                    {
                        "id": <integer>,
                        "state": "PENDING_SETTLEMENT",
                        "reason": <string>,
                        "createdDate": <date>,
                        "netSettlementAmount": {
                            "amount": <decimal>,
                            "currency": <enum>
                        },
                        "errorInformation": {
                            "errorCode": <integer>,
                            "errorDescription": <string>
                        }
                    }
                ]
            }
        ]
    end note

    note left of SSAPI #lightyellow
        [
          {
            "id": {id},
            "state": settlementData.state,
            "createdDate": settlementData.createdDate,
            "settlementWindows": settlementWindows,
            "participants": participants
          }
        ]
    end note

    SSAPI -> OPERATOR: Return response
    deactivate SSAPI
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>