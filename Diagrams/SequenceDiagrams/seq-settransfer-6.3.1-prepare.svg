<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1627px" preserveAspectRatio="none" style="width:983px;height:1627px;" version="1.1" viewBox="0 0 983 1627" width="983px" zoomAndPan="magnify"><defs><filter height="300%" id="f5bkzo7kchv59" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="244" x="370.5" y="23.5352">6.3.1. Settlement Transfer Prepare</text><rect fill="#90EE90" height="1581.5879" style="stroke: #A80036; stroke-width: 1.0;" width="130" x="35" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="38" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="1581.5879" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="535" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="538" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#f5bkzo7kchv59)" height="1414.3008" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="95" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f5bkzo7kchv59)" height="246.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="587" y="211.2188"/><rect fill="#FFFFFF" filter="url(#f5bkzo7kchv59)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="587" y="535.498"/><rect fill="#FFFFFF" filter="url(#f5bkzo7kchv59)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="587" y="643.4297"/><rect fill="#FFFFFF" filter="url(#f5bkzo7kchv59)" height="169.7949" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="587" y="781.9824"/><rect fill="#FFFFFF" filter="url(#f5bkzo7kchv59)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="587" y="1160.2402"/><rect fill="#FFFFFF" filter="url(#f5bkzo7kchv59)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="587" y="1375.3457"/><rect fill="#FFFFFF" filter="url(#f5bkzo7kchv59)" height="1400.3008" style="stroke: #000000; stroke-width: 2.0;" width="959" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f5bkzo7kchv59)" height="1054.0215" style="stroke: #000000; stroke-width: 2.0;" width="939" x="23" y="472.5664"/><rect fill="#FFFFFF" filter="url(#f5bkzo7kchv59)" height="1022.7109" style="stroke: #000000; stroke-width: 2.0;" width="919" x="33" y="496.877"/><rect fill="#FFFFFF" filter="url(#f5bkzo7kchv59)" height="165.1523" style="stroke: #000000; stroke-width: 2.0;" width="381" x="100" y="966.7773"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="381" x="100" y="1023.3984"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="381" x="100" y="1077.6641"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="100" x2="100" y1="116.2871" y2="1550.5879"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="592" x2="592" y1="116.2871" y2="1550.5879"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="43" y="113.334">Settlement DAO</text><ellipse cx="100" cy="83.7988" fill="#FEFECE" filter="url(#f5bkzo7kchv59)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="88" x2="112" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="43" y="1563.123">Settlement DAO</text><ellipse cx="100" cy="1582.0762" fill="#FEFECE" filter="url(#f5bkzo7kchv59)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="88" x2="112" y1="1596.0762" y2="1596.0762"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="544" y="113.334">Central Store</text><path d="M574,63.7988 C574,53.7988 592,53.7988 592,53.7988 C592,53.7988 610,53.7988 610,63.7988 L610,89.7988 C610,99.7988 592,99.7988 592,99.7988 C592,99.7988 574,99.7988 574,89.7988 L574,63.7988 " fill="#FEFECE" filter="url(#f5bkzo7kchv59)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M574,63.7988 C574,73.7988 592,73.7988 592,73.7988 C592,73.7988 610,73.7988 610,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="544" y="1563.123">Central Store</text><path d="M574,1576.0762 C574,1566.0762 592,1566.0762 592,1566.0762 C592,1566.0762 610,1566.0762 610,1576.0762 L610,1602.0762 C610,1612.0762 592,1612.0762 592,1612.0762 C592,1612.0762 574,1612.0762 574,1602.0762 L574,1576.0762 " fill="#FEFECE" filter="url(#f5bkzo7kchv59)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M574,1576.0762 C574,1586.0762 592,1586.0762 592,1586.0762 C592,1586.0762 610,1586.0762 610,1576.0762 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f5bkzo7kchv59)" height="1414.3008" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="95" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f5bkzo7kchv59)" height="246.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="587" y="211.2188"/><rect fill="#FFFFFF" filter="url(#f5bkzo7kchv59)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="587" y="535.498"/><rect fill="#FFFFFF" filter="url(#f5bkzo7kchv59)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="587" y="643.4297"/><rect fill="#FFFFFF" filter="url(#f5bkzo7kchv59)" height="169.7949" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="587" y="781.9824"/><rect fill="#FFFFFF" filter="url(#f5bkzo7kchv59)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="587" y="1160.2402"/><rect fill="#FFFFFF" filter="url(#f5bkzo7kchv59)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="587" y="1375.3457"/><path d="M13,133.2871 L249,133.2871 L249,140.2871 L239,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1400.3008" style="stroke: #000000; stroke-width: 2.0;" width="959" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="191" x="28" y="146.8555">Settlement Transfer Prepare</text><path d="M110,155.5977 L110,180.5977 L694,180.5977 L694,165.5977 L684,155.5977 L110,155.5977 " fill="#D3D3D3" filter="url(#f5bkzo7kchv59)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M684,155.5977 L684,165.5977 L694,165.5977 L684,155.5977 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="116" y="173.166">Inputs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="520" x="159" y="173.166">: settlementId, transactionTimestamp, enums, trx; transferValiditySeconds (config)</text><polygon fill="#A80036" points="575,207.2188,585,211.2188,575,215.2188,579,211.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="105" x2="581" y1="211.2188" y2="211.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="112" y="206.4766">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="441" x="125" y="206.4766">Retrieve list of PS_TRANSFERS_RECORDED, but not RECEIVED_PREPARE</text><polygon fill="#FFFFE0" filter="url(#f5bkzo7kchv59)" points="334,224.2188,850,224.2188,860,327.2188,850,431.2188,334,431.2188,324,327.2188,334,224.2188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="336" y="240.7871">SELECT spc.*, pc.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="336" y="256.0977">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="376" y="256.0977">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="587" y="256.0977">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="336" y="271.4082">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="368" y="271.4082">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="664" y="271.4082">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="512" x="336" y="286.7188">ON spcsc.settlementParticipantCurrencyId = spc.settlementParticipantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="377" x="336" y="302.0293">AND spcsc.settlementStateId = {PS_TRANSFERS_RECORDED}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="336" y="317.3398">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="368" y="317.3398">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="508" y="317.3398">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="336" y="332.6504">ON pc.participantCurrencyId = spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="336" y="347.9609">LEFT JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="159" x="401" y="347.9609">transferDuplicateCheck</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="20" x="564" y="347.9609">tdc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="336" y="363.2715">ON tdc.transferId = spc.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="336" y="378.582">WHERE spc.settlementId = {settlementId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="336" y="393.8926">AND spc.settlementTransferId IS NOT NULL</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="336" y="409.2031">AND tdc.transferId IS NULL</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="340" y="424.5137"/><polygon fill="#A80036" points="116,453.5664,106,457.5664,116,461.5664,112,457.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="110" x2="591" y1="457.5664" y2="457.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="452.8242">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="135" y="452.8242">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="180" y="452.8242">settlementTransferList</text><path d="M23,472.5664 L97,472.5664 L97,479.5664 L87,489.5664 L23,489.5664 L23,472.5664 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1054.0215" style="stroke: #000000; stroke-width: 2.0;" width="939" x="23" y="472.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="38" y="486.1348">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="112" y="485.2012">[t IN settlementTransferList]</text><path d="M33,496.877 L198,496.877 L198,503.877 L188,513.877 L33,513.877 L33,496.877 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1022.7109" style="stroke: #000000; stroke-width: 2.0;" width="919" x="33" y="496.877"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="48" y="510.4453">DB TRANSACTION</text><polygon fill="#A80036" points="575,531.498,585,535.498,575,539.498,579,535.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="105" x2="581" y1="535.498" y2="535.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="112" y="530.7559">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="125" y="530.7559">Insert transferDuplicateCheck</text><polygon fill="#FFFFE0" filter="url(#f5bkzo7kchv59)" points="303,578.498,881,578.498,891,597.498,881,616.498,303,616.498,293,597.498,303,578.498" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="305" y="595.0664">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="159" x="389" y="595.0664">transferDuplicateCheck</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="552" y="595.0664">(transferId, hash, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="574" x="305" y="610.377">VALUES (t.settlementTransferId, hashCode(t.settlementTransferId), {transactionTimestamp})</text><polygon fill="#A80036" points="575,639.4297,585,643.4297,575,647.4297,579,643.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="105" x2="581" y1="643.4297" y2="643.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="112" y="638.6875">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="125" y="638.6875">Insert transfer</text><polygon fill="#FFFFE0" filter="url(#f5bkzo7kchv59)" points="318,686.4297,865,686.4297,875,720.4297,865,755.4297,318,755.4297,308,720.4297,318,686.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="320" y="702.998">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="54" x="404" y="702.998">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="462" y="702.998">(transferId, amount, currencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="348" y="718.3086">ilpCondition, expirationDate, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="400" x="320" y="733.6191">VALUES (t.settlementTransferId, ABS(t.netAmount), t.currencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="515" x="348" y="748.9297">0, new Date(+new Date()+1000*transferValiditySeconds), {transactionTimestamp})</text><polygon fill="#A80036" points="575,777.9824,585,781.9824,575,785.9824,579,781.9824" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="105" x2="581" y1="781.9824" y2="781.9824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="112" y="777.2402">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="125" y="777.2402">Retrieve Hub MLNS account</text><polygon fill="#FFFFE0" filter="url(#f5bkzo7kchv59)" points="373,794.9824,810,794.9824,820,859.9824,810,924.9824,373,924.9824,363,859.9824,373,794.9824" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="331" x="375" y="811.5508">SELECT pc2.participantCurrencyId AS mlnsAccountId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="375" y="826.8613">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="415" y="826.8613">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="555" y="826.8613">pc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="375" y="842.1719">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="407" y="842.1719">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="547" y="842.1719">pc2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157" x="375" y="857.4824">ON pc2.participantId = 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="237" x="375" y="872.793">AND pc2.currencyId = pc1.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="433" x="375" y="888.1035">AND pc2.ledgerAccountTypeId = {HUB_MULTILATERAL_SETTLEMENT}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="375" y="903.4141">AND pc2.isActive = 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="373" x="375" y="918.7246">WHERE pc1.participantCurrencyId = t.participantCurrencyId</text><polygon fill="#A80036" points="116,947.7773,106,951.7773,116,955.7773,112,951.7773" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="110" x2="591" y1="951.7773" y2="951.7773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="947.0352">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="135" y="947.0352">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="180" y="947.0352">mlnsAccountId</text><path d="M100,966.7773 L162,966.7773 L162,973.7773 L152,983.7773 L100,983.7773 L100,966.7773 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="165.1523" style="stroke: #000000; stroke-width: 2.0;" width="381" x="100" y="966.7773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="115" y="980.3457">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="100" x="177" y="979.4121">[t.netAmount &lt; 0]</text><path d="M110,989.0879 L110,1014.0879 L467,1014.0879 L467,999.0879 L457,989.0879 L110,989.0879 " fill="#D3D3D3" filter="url(#f5bkzo7kchv59)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M457,989.0879 L457,999.0879 L467,999.0879 L457,989.0879 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="116" y="1006.6563">ledgerEntryTypeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="247" y="1006.6563">= {SETTLEMENT_NET_RECIPIENT}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="100" x2="481" y1="1024.3984" y2="1024.3984"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="100" x="105" y="1035.0332">[t.netAmount &gt; 0]</text><path d="M110,1043.3535 L110,1068.3535 L452,1068.3535 L452,1053.3535 L442,1043.3535 L110,1043.3535 " fill="#D3D3D3" filter="url(#f5bkzo7kchv59)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M442,1043.3535 L442,1053.3535 L452,1053.3535 L442,1043.3535 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="116" y="1060.9219">ledgerEntryTypeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="247" y="1060.9219">= {SETTLEMENT_NET_SENDER}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="100" x2="481" y1="1078.6641" y2="1078.6641"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="109" x="105" y="1089.2988">[t.netAmount == 0]</text><path d="M110,1097.6191 L110,1122.6191 L436,1122.6191 L436,1107.6191 L426,1097.6191 L110,1097.6191 " fill="#D3D3D3" filter="url(#f5bkzo7kchv59)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M426,1097.6191 L426,1107.6191 L436,1107.6191 L426,1097.6191 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="116" y="1115.1875">ledgerEntryTypeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="247" y="1115.1875">= {SETTLEMENT_NET_ZERO}</text><polygon fill="#A80036" points="575,1156.2402,585,1160.2402,575,1164.2402,579,1160.2402" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="105" x2="581" y1="1160.2402" y2="1160.2402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="112" y="1155.498">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="125" y="1155.498">Insert transferParticipant records</text><polygon fill="#FFFFE0" filter="url(#f5bkzo7kchv59)" points="330,1203.2402,853,1203.2402,863,1275.2402,853,1348.2402,330,1348.2402,320,1275.2402,330,1203.2402" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="332" y="1219.8086">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="416" y="1219.8086">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="547" y="1219.8086">(transferId, participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="449" x="360" y="1235.1191">transferParticipantRoleTypeId, ledgerEntryTypeId, amount, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="332" y="1250.4297">VALUES (t.settlementTransferId, {mlnsAccountId},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="360" y="1265.7402">{HUB}, {ledgerEntryTypeId}, t.netAmount, {transactionTimestamp})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="336" y="1281.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="332" y="1296.3613">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="416" y="1296.3613">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="547" y="1296.3613">(transferId, participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="449" x="360" y="1311.6719">transferParticipantRoleTypeId, ledgerEntryTypeId, amount, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="352" x="332" y="1326.9824">VALUES (t.settlementTransferId, t.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="491" x="360" y="1342.293">{DFSP_POSITION}, {ledgerEntryTypeId}, -t.netAmount, {transactionTimestamp})</text><polygon fill="#A80036" points="575,1371.3457,585,1375.3457,575,1379.3457,579,1375.3457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="105" x2="581" y1="1375.3457" y2="1375.3457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="112" y="1370.6035">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="125" y="1370.6035">Insert transferStateChange</text><polygon fill="#FFFFE0" filter="url(#f5bkzo7kchv59)" points="251,1418.3457,932,1418.3457,942,1437.3457,932,1456.3457,251,1456.3457,241,1437.3457,251,1418.3457" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="253" y="1434.9141">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="337" y="1434.9141">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="480" y="1434.9141">(transferId, transferStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="677" x="253" y="1450.2246">VALUES (t.settlementTransferId, {RECEIVED_PREPARE}, 'Settlement transfer prepare', {transactionTimestamp})</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="105" x2="147" y1="1498.5879" y2="1498.5879"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="147" x2="147" y1="1498.5879" y2="1511.5879"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="106" x2="147" y1="1511.5879" y2="1511.5879"/><polygon fill="#A80036" points="116,1507.5879,106,1511.5879,116,1515.5879,112,1511.5879" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="112" y="1486.1904">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="125" y="1478.5352">Omit ilpPacket, participantPosition &amp;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="125" y="1493.8457">participantPositionChange</text><!--
@startuml
title 6.3.1. Settlement Transfer Prepare
autonumber

entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Settlement Service" #lightgreen
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

activate SETTLE_DAO
group Settlement Transfer Prepare
    note right of SETTLE_DAO #lightgray
        **Inputs**: settlementId, transactionTimestamp, enums, trx; transferValiditySeconds (config)
    end note
    SETTLE_DAO -> DB: Retrieve list of PS_TRANSFERS_RECORDED, but not RECEIVED_PREPARE
    activate DB
    hnote over DB #lightyellow
        SELECT spc.*, pc.currencyId
        FROM **settlementParticipantCurrency** spc
        JOIN **settlementParticipantCurrencyStateChange** spcsc
        ON spcsc.settlementParticipantCurrencyId = spc.settlementParticipantCurrencyId
        AND spcsc.settlementStateId = {PS_TRANSFERS_RECORDED}
        JOIN **participantCurrency** pc
        ON pc.participantCurrencyId = spc.participantCurrencyId
        LEFT JOIN **transferDuplicateCheck** tdc
        ON tdc.transferId = spc.settlementTransferId
        WHERE spc.settlementId = {settlementId}
        AND spc.settlementTransferId IS NOT NULL
        AND tdc.transferId IS NULL

    end hnote
    DB - -> SETTLE_DAO: Return **settlementTransferList**
    deactivate DB
    loop t IN settlementTransferList
        group <color #blue>DB TRANSACTION</color>
            SETTLE_DAO -> DB: Insert transferDuplicateCheck
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **transferDuplicateCheck** (transferId, hash, createdDate)
                VALUES (t.settlementTransferId, hashCode(t.settlementTransferId), {transactionTimestamp})
            end hnote
            deactivate DB
            SETTLE_DAO -> DB: Insert transfer
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **transfer** (transferId, amount, currencyId, 
                       ilpCondition, expirationDate, createdDate)
                VALUES (t.settlementTransferId, ABS(t.netAmount), t.currencyId,
                       0, new Date(+new Date()+1000*transferValiditySeconds), {transactionTimestamp})
            end hnote
            deactivate DB
            SETTLE_DAO -> DB: Retrieve Hub MLNS account
            activate DB
            hnote over DB #lightyellow
                SELECT pc2.participantCurrencyId AS mlnsAccountId
                FROM **participantCurrency** pc1
                JOIN **participantCurrency** pc2
                ON pc2.participantId = 1
                AND pc2.currencyId = pc1.currencyId
                AND pc2.ledgerAccountTypeId = {HUB_MULTILATERAL_SETTLEMENT}
                AND pc2.isActive = 1
                WHERE pc1.participantCurrencyId = t.participantCurrencyId
            end hnote
            DB - -> SETTLE_DAO: Return **mlnsAccountId**
            deactivate DB
            alt t.netAmount < 0
                note right of SETTLE_DAO #lightgray
                    **ledgerEntryTypeId** = {SETTLEMENT_NET_RECIPIENT}
                end note
            else t.netAmount > 0
                note right of SETTLE_DAO #lightgray
                    **ledgerEntryTypeId** = {SETTLEMENT_NET_SENDER}
                end note
            else t.netAmount == 0
                note right of SETTLE_DAO #lightgray
                    **ledgerEntryTypeId** = {SETTLEMENT_NET_ZERO}
                end note
            end
            SETTLE_DAO -> DB: Insert transferParticipant records
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **transferParticipant** (transferId, participantCurrencyId, 
                       transferParticipantRoleTypeId, ledgerEntryTypeId, amount, createdDate)
                VALUES (t.settlementTransferId, {mlnsAccountId},
                       {HUB}, {ledgerEntryTypeId}, t.netAmount, {transactionTimestamp})
                
                INSERT INTO **transferParticipant** (transferId, participantCurrencyId, 
                       transferParticipantRoleTypeId, ledgerEntryTypeId, amount, createdDate)
                VALUES (t.settlementTransferId, t.participantCurrencyId,
                       {DFSP_POSITION}, {ledgerEntryTypeId}, -t.netAmount, {transactionTimestamp})
            end hnote
            deactivate DB
            SETTLE_DAO -> DB: Insert transferStateChange
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **transferStateChange** (transferId, transferStateId, reason, createdDate)
                VALUES (t.settlementTransferId, {RECEIVED_PREPARE}, 'Settlement transfer prepare', {transactionTimestamp})
            end hnote
            deactivate DB
            SETTLE_DAO - -> SETTLE_DAO: Omit ilpPacket, participantPosition &\nparticipantPositionChange
        end
    end
end
deactivate SETTLE_DAO

@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>