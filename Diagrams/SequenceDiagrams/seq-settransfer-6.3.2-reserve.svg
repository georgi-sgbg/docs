<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2038px" preserveAspectRatio="none" style="width:898px;height:2038px;" version="1.1" viewBox="0 0 898 2038" width="898px" zoomAndPan="magnify"><defs><filter height="300%" id="ffny08dsjp3q7" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="246" x="326.5" y="23.5352">6.3.2. Settlement Transfer Reserve</text><rect fill="#90EE90" height="1993.0625" style="stroke: #A80036; stroke-width: 1.0;" width="130" x="55" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="58" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="1993.0625" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="551" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="554" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#ffny08dsjp3q7)" height="1825.7754" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="115" y="126.2871"/><rect fill="#FFFFFF" filter="url(#ffny08dsjp3q7)" height="368.832" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="603" y="211.2188"/><rect fill="#FFFFFF" filter="url(#ffny08dsjp3q7)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="603" y="657.9824"/><rect fill="#FFFFFF" filter="url(#ffny08dsjp3q7)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="603" y="789.5352"/><rect fill="#FFFFFF" filter="url(#ffny08dsjp3q7)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="603" y="958.0195"/><rect fill="#FFFFFF" filter="url(#ffny08dsjp3q7)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="603" y="1159.5039"/><rect fill="#FFFFFF" filter="url(#ffny08dsjp3q7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="603" y="1377.2988"/><rect fill="#FFFFFF" filter="url(#ffny08dsjp3q7)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="603" y="1577.0938"/><rect fill="#FFFFFF" filter="url(#ffny08dsjp3q7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="603" y="1730.2676"/><rect fill="#FFFFFF" filter="url(#ffny08dsjp3q7)" height="1811.7754" style="stroke: #000000; stroke-width: 2.0;" width="873" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#ffny08dsjp3q7)" height="1343.0117" style="stroke: #000000; stroke-width: 2.0;" width="852" x="23" y="595.0508"/><rect fill="#FFFFFF" filter="url(#ffny08dsjp3q7)" height="1311.7012" style="stroke: #000000; stroke-width: 2.0;" width="832" x="33" y="619.3613"/><rect fill="#FFFFFF" filter="url(#ffny08dsjp3q7)" height="1173.1484" style="stroke: #000000; stroke-width: 2.0;" width="812" x="43" y="750.9141"/><rect fill="#FFFFFF" filter="url(#ffny08dsjp3q7)" height="228.1055" style="stroke: #000000; stroke-width: 2.0;" width="724" x="53" y="1120.8828"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="120" x2="120" y1="116.2871" y2="1962.0625"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="608" x2="608" y1="116.2871" y2="1962.0625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="63" y="113.334">Settlement DAO</text><ellipse cx="120" cy="83.7988" fill="#FEFECE" filter="url(#ffny08dsjp3q7)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="108" x2="132" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="63" y="1974.5977">Settlement DAO</text><ellipse cx="120" cy="1993.5508" fill="#FEFECE" filter="url(#ffny08dsjp3q7)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="108" x2="132" y1="2007.5508" y2="2007.5508"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="560" y="113.334">Central Store</text><path d="M590,63.7988 C590,53.7988 608,53.7988 608,53.7988 C608,53.7988 626,53.7988 626,63.7988 L626,89.7988 C626,99.7988 608,99.7988 608,99.7988 C608,99.7988 590,99.7988 590,89.7988 L590,63.7988 " fill="#FEFECE" filter="url(#ffny08dsjp3q7)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M590,63.7988 C590,73.7988 608,73.7988 608,73.7988 C608,73.7988 626,73.7988 626,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="560" y="1974.5977">Central Store</text><path d="M590,1987.5508 C590,1977.5508 608,1977.5508 608,1977.5508 C608,1977.5508 626,1977.5508 626,1987.5508 L626,2013.5508 C626,2023.5508 608,2023.5508 608,2023.5508 C608,2023.5508 590,2023.5508 590,2013.5508 L590,1987.5508 " fill="#FEFECE" filter="url(#ffny08dsjp3q7)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M590,1987.5508 C590,1997.5508 608,1997.5508 608,1997.5508 C608,1997.5508 626,1997.5508 626,1987.5508 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#ffny08dsjp3q7)" height="1825.7754" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="115" y="126.2871"/><rect fill="#FFFFFF" filter="url(#ffny08dsjp3q7)" height="368.832" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="603" y="211.2188"/><rect fill="#FFFFFF" filter="url(#ffny08dsjp3q7)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="603" y="657.9824"/><rect fill="#FFFFFF" filter="url(#ffny08dsjp3q7)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="603" y="789.5352"/><rect fill="#FFFFFF" filter="url(#ffny08dsjp3q7)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="603" y="958.0195"/><rect fill="#FFFFFF" filter="url(#ffny08dsjp3q7)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="603" y="1159.5039"/><rect fill="#FFFFFF" filter="url(#ffny08dsjp3q7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="603" y="1377.2988"/><rect fill="#FFFFFF" filter="url(#ffny08dsjp3q7)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="603" y="1577.0938"/><rect fill="#FFFFFF" filter="url(#ffny08dsjp3q7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="603" y="1730.2676"/><path d="M13,133.2871 L250,133.2871 L250,140.2871 L240,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1811.7754" style="stroke: #000000; stroke-width: 2.0;" width="873" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="192" x="28" y="146.8555">Settlement Transfer Reserve</text><path d="M130,155.5977 L130,180.5977 L817,180.5977 L817,165.5977 L807,155.5977 L130,155.5977 " fill="#D3D3D3" filter="url(#ffny08dsjp3q7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M807,155.5977 L807,165.5977 L817,165.5977 L807,155.5977 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="136" y="173.166">Inputs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="623" x="179" y="173.166">: settlementId that holds entries with PS_TRANSFERS_RESERVED, transactionTimestamp, enums, trx</text><polygon fill="#A80036" points="591,207.2188,601,211.2188,591,215.2188,595,211.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="125" x2="597" y1="211.2188" y2="211.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="132" y="206.4766">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="376" x="145" y="206.4766">Retrieve list of PS_TRANSFERS_RESERVED, but not RESERVED</text><polygon fill="#FFFFE0" filter="url(#ffny08dsjp3q7)" points="350,224.2188,866,224.2188,876,388.2188,866,553.2188,350,553.2188,340,388.2188,350,224.2188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="352" y="240.7871">SELECT tp1.transferId, tp1.ledgerEntryTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="464" x="368" y="256.0977">tp1.participantCurrencyId AS dfspAccountId, tp1.amount AS dfspAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="452" x="368" y="271.4082">tp2.participantCurrencyId AS hubAccountId, tp2.amount AS hubAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="352" y="286.7188">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="392" y="286.7188">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="603" y="286.7188">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="352" y="302.0293">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="384" y="302.0293">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="680" y="302.0293">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="512" x="352" y="317.3398">ON spcsc.settlementParticipantCurrencyId = spc.settlementParticipantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="352" y="332.6504">AND spcsc.settlementStateId = {PS_TRANSFERS_RESERVED}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="352" y="347.9609">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="384" y="347.9609">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="527" y="347.9609">tsc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="352" y="363.2715">ON tsc1.transferId = spc.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="352" y="378.582">AND tsc1.transferStateId = {RECEIVED_PREPARE}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="352" y="393.8926">LEFT JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="417" y="393.8926">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="560" y="393.8926">tsc2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="352" y="409.2031">ON tsc2.transferId = spc.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="352" y="424.5137">AND tsc2.transferStateId = {RESERVED}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="352" y="439.8242">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="384" y="439.8242">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="515" y="439.8242">tp1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="352" y="455.1348">ON tp1.transferId = spc.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="367" x="352" y="470.4453">AND tp1.transferParticipantRoleTypeId = {DFSP_POSITION}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="352" y="485.7559">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="384" y="485.7559">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="515" y="485.7559">tp2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="352" y="501.0664">ON tp2.transferId = spc.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="352" y="516.377">AND tp2.transferParticipantRoleTypeId = {HUB}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="352" y="531.6875">WHERE spc.settlementId = {settlementId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="352" y="546.998">AND tsc2.transferId IS NULL</text><polygon fill="#A80036" points="136,576.0508,126,580.0508,136,584.0508,132,580.0508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="130" x2="607" y1="580.0508" y2="580.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="142" y="575.3086">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="155" y="575.3086">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="200" y="575.3086">settlementTransferList</text><path d="M23,595.0508 L188,595.0508 L188,602.0508 L178,612.0508 L23,612.0508 L23,595.0508 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1343.0117" style="stroke: #000000; stroke-width: 2.0;" width="852" x="23" y="595.0508"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="38" y="608.6191">DB TRANSACTION</text><path d="M33,619.3613 L107,619.3613 L107,626.3613 L97,636.3613 L33,636.3613 L33,619.3613 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1311.7012" style="stroke: #000000; stroke-width: 2.0;" width="832" x="33" y="619.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="48" y="632.9297">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="122" y="631.9961">[t IN settlementTransferList]</text><polygon fill="#A80036" points="591,653.9824,601,657.9824,591,661.9824,595,657.9824" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="125" x2="597" y1="657.9824" y2="657.9824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="132" y="653.2402">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="145" y="653.2402">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#ffny08dsjp3q7)" points="383,670.9824,833,670.9824,843,689.9824,833,708.9824,383,708.9824,373,689.9824,383,670.9824" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="385" y="687.5508">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="469" y="687.5508">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="612" y="687.5508">(transferId, transferStateId, reason)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="390" x="385" y="702.8613">VALUES (t.transferId, {RESERVED}, 'Settlement transfer reserve')</text><polygon fill="#A80036" points="136,731.9141,126,735.9141,136,739.9141,132,735.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="130" x2="607" y1="735.9141" y2="735.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="142" y="731.1719">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="155" y="731.1719">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="200" y="731.1719">transferStateChangeId</text><path d="M43,750.9141 L110,750.9141 L110,757.9141 L100,767.9141 L43,767.9141 L43,750.9141 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1173.1484" style="stroke: #000000; stroke-width: 2.0;" width="812" x="43" y="750.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="58" y="764.4824">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="322" x="125" y="763.5488">[t.ledgerEntryTypeId == {SETTLEMENT_NET_RECIPIENT}]</text><polygon fill="#A80036" points="591,785.5352,601,789.5352,591,793.5352,595,789.5352" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="125" x2="597" y1="789.5352" y2="789.5352"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="132" y="784.793">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="145" y="784.793">Select dfsp position FOR UPDATE</text><polygon fill="#FFFFE0" filter="url(#ffny08dsjp3q7)" points="455,802.5352,761,802.5352,771,851.5352,761,901.5352,455,901.5352,445,851.5352,455,802.5352" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="299" x="457" y="819.1035">SELECT participantPositionId AS dfspPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="473" y="834.4141">value AS dfspPositionValue,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="473" y="849.7246">reservedValue AS dfspReservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="457" y="865.0352">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="497" y="865.0352">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="457" y="880.3457">WHERE participantCurrencyId = t.dfspAccountId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="457" y="895.6563">FOR UPDATE</text><polygon fill="#A80036" points="136,924.709,126,928.709,136,932.709,132,928.709" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="130" x2="607" y1="928.709" y2="928.709"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="142" y="923.9668">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="155" y="923.9668">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="96" x="200" y="923.9668">dfspPositionId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="296" y="923.9668">,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121" x="304" y="923.9668">dfspPositionValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="429" y="923.9668">and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="131" x="456" y="923.9668">dfspReservedValue</text><polygon fill="#A80036" points="591,954.0195,601,958.0195,591,962.0195,595,958.0195" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="125" x2="597" y1="958.0195" y2="958.0195"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="132" y="953.2773">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="145" y="953.2773">Select participant NET_DEBIT_CAP limit</text><polygon fill="#FFFFE0" filter="url(#ffny08dsjp3q7)" points="455,971.0195,761,971.0195,771,1005.0195,761,1040.0195,455,1040.0195,445,1005.0195,455,971.0195" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="457" y="987.5879">SELECT value AS netDebitCap</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="457" y="1002.8984">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="497" y="1002.8984">participantLimit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="457" y="1018.209">WHERE participantCurrencyId = t.dfspAccountId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="301" x="457" y="1033.5195">AND participantLimitTypeId = {NET_DEBIT_CAP}</text><polygon fill="#A80036" points="136,1062.5723,126,1066.5723,136,1070.5723,132,1066.5723" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="130" x2="607" y1="1066.5723" y2="1066.5723"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="142" y="1061.8301">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="155" y="1061.8301">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="84" x="200" y="1061.8301">netDebitCap</text><path d="M130,1079.5723 L130,1104.5723 L749,1104.5723 L749,1089.5723 L739,1079.5723 L130,1079.5723 " fill="#D3D3D3" filter="url(#ffny08dsjp3q7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M739,1079.5723 L739,1089.5723 L749,1089.5723 L739,1079.5723 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="136" y="1097.1406">isLimitExceeded</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="484" x="250" y="1097.1406">= netDebitCap - dfspPositionValue - dfspReservedValue - t.dfspAmount &lt; 0</text><path d="M53,1120.8828 L120,1120.8828 L120,1127.8828 L110,1137.8828 L53,1137.8828 L53,1120.8828 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="228.1055" style="stroke: #000000; stroke-width: 2.0;" width="724" x="53" y="1120.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="68" y="1134.4512">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="146" x="135" y="1133.5176">[isLimitExceeded == true]</text><polygon fill="#A80036" points="591,1155.5039,601,1159.5039,591,1163.5039,595,1159.5039" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="125" x2="597" y1="1159.5039" y2="1159.5039"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="132" y="1154.7617">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="145" y="1154.7617">Select max participantPositionChangeId</text><polygon fill="#FFFFE0" filter="url(#ffny08dsjp3q7)" points="458,1172.5039,757,1172.5039,767,1214.5039,757,1256.5039,458,1256.5039,448,1214.5039,458,1172.5039" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="460" y="1189.0723">SELECT participantPositionChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="460" y="1204.3828">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="500" y="1204.3828">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="460" y="1219.6934">WHERE participantPositionId = {dfspPositionId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="460" y="1235.0039">ORDER BY 1 DESC</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="460" y="1250.3145">LIMIT 1</text><polygon fill="#A80036" points="136,1279.3672,126,1283.3672,136,1287.3672,132,1283.3672" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="130" x2="607" y1="1283.3672" y2="1283.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="142" y="1278.625">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="164" y="1278.625">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="183" x="209" y="1278.625">startAfterPositionChangeId</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="125" x2="167" y1="1327.9883" y2="1327.9883"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="167" x2="167" y1="1327.9883" y2="1340.9883"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="126" x2="167" y1="1340.9883" y2="1340.9883"/><polygon fill="#A80036" points="136,1336.9883,126,1340.9883,136,1344.9883,132,1340.9883" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="132" y="1315.5908">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="326" x="154" y="1307.9355">Increase NET_DEBIT_CAP with the value of t.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="283" x="154" y="1323.2461">using ParticipantFacade.adjustLimits method</text><polygon fill="#A80036" points="591,1373.2988,601,1377.2988,591,1381.2988,595,1377.2988" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="125" x2="597" y1="1377.2988" y2="1377.2988"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="132" y="1372.5566">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="154" y="1372.5566">Persist latest dfsp position &amp; dfsp position change</text><polygon fill="#FFFFE0" filter="url(#ffny08dsjp3q7)" points="381,1420.2988,835,1420.2988,845,1485.2988,835,1550.2988,381,1550.2988,371,1485.2988,381,1420.2988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="383" y="1436.8672">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="437" y="1436.8672">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="303" x="383" y="1452.1777">SET value = {dfspPositionValue + t.dfspAmount}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="383" y="1467.4883">WHERE participantPositionId = {dfspPositionId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="387" y="1482.7988"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="383" y="1498.1094">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="467" y="1498.1094">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="422" x="411" y="1513.4199">(participantPositionId, transferStateChangeId, value, reservedValue)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="313" x="383" y="1528.7305">VALUES ({dfspPositionId}, {transferStateChangeId},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="364" x="399" y="1544.041">{dfspPositionValue + t.dfspAmount}, {dfspReservedValue})</text><polygon fill="#A80036" points="591,1573.0938,601,1577.0938,591,1581.0938,595,1577.0938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="125" x2="597" y1="1577.0938" y2="1577.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="132" y="1572.3516">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="154" y="1572.3516">Select hub position FOR UPDATE</text><polygon fill="#FFFFE0" filter="url(#ffny08dsjp3q7)" points="457,1590.0938,759,1590.0938,769,1632.0938,759,1674.0938,457,1674.0938,447,1632.0938,457,1590.0938" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="459" y="1606.6621">SELECT participantPositionId AS hubPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="475" y="1621.9727">value AS hubPositionValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="459" y="1637.2832">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="499" y="1637.2832">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="298" x="459" y="1652.5938">WHERE participantCurrencyId = t.hubAccountId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="459" y="1667.9043">FOR UPDATE</text><polygon fill="#A80036" points="136,1696.957,126,1700.957,136,1704.957,132,1700.957" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="130" x2="607" y1="1700.957" y2="1700.957"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="142" y="1696.2148">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="164" y="1696.2148">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="93" x="209" y="1696.2148">hubPositionId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="306" y="1696.2148">and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="333" y="1696.2148">hubPositionValue</text><polygon fill="#A80036" points="591,1726.2676,601,1730.2676,591,1734.2676,595,1730.2676" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="125" x2="597" y1="1730.2676" y2="1730.2676"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="132" y="1725.5254">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="154" y="1725.5254">Persist latest hub position &amp; hub position change</text><polygon fill="#FFFFE0" filter="url(#ffny08dsjp3q7)" points="451,1773.2676,764,1773.2676,774,1845.2676,764,1918.2676,451,1918.2676,441,1845.2676,451,1773.2676" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="453" y="1789.8359">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="507" y="1789.8359">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="453" y="1805.1465">SET value = {hubPositionValue + t.hubAmount}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="453" y="1820.457">WHERE participantPositionId = {hubPositionId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="457" y="1835.7676"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="453" y="1851.0781">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="537" y="1851.0781">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="286" x="469" y="1866.3887">(participantPositionId, transferStateChangeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="469" y="1881.6992">value, reservedValue)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="453" y="1897.0098">VALUES ({hubPositionId}, {transferStateChangeId},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="469" y="1912.3203">{hubPositionValue + t.hubAmount}, 0)</text><!--
@startuml
title 6.3.2. Settlement Transfer Reserve
autonumber

entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Settlement Service" #lightgreen
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

activate SETTLE_DAO
group Settlement Transfer Reserve
    note right of SETTLE_DAO #lightgray
        **Inputs**: settlementId that holds entries with PS_TRANSFERS_RESERVED, transactionTimestamp, enums, trx
    end note
    SETTLE_DAO -> DB: Retrieve list of PS_TRANSFERS_RESERVED, but not RESERVED
    activate DB
    hnote over DB #lightyellow
        SELECT tp1.transferId, tp1.ledgerEntryTypeId,
            tp1.participantCurrencyId AS dfspAccountId, tp1.amount AS dfspAmount,
            tp2.participantCurrencyId AS hubAccountId, tp2.amount AS hubAmount
        FROM **settlementParticipantCurrency** spc
        JOIN **settlementParticipantCurrencyStateChange** spcsc
        ON spcsc.settlementParticipantCurrencyId = spc.settlementParticipantCurrencyId
        AND spcsc.settlementStateId = {PS_TRANSFERS_RESERVED}
        JOIN **transferStateChange** tsc1
        ON tsc1.transferId = spc.settlementTransferId
        AND tsc1.transferStateId = {RECEIVED_PREPARE}
        LEFT JOIN **transferStateChange** tsc2
        ON tsc2.transferId = spc.settlementTransferId
        AND tsc2.transferStateId = {RESERVED}
        JOIN **transferParticipant** tp1
        ON tp1.transferId = spc.settlementTransferId
        AND tp1.transferParticipantRoleTypeId = {DFSP_POSITION}
        JOIN **transferParticipant** tp2
        ON tp2.transferId = spc.settlementTransferId
        AND tp2.transferParticipantRoleTypeId = {HUB}
        WHERE spc.settlementId = {settlementId}
        AND tsc2.transferId IS NULL
    end hnote
    DB - -> SETTLE_DAO: Return **settlementTransferList**
    deactivate DB
    group <color #blue>DB TRANSACTION</color>
        loop t IN settlementTransferList
            SETTLE_DAO -> DB: Persist transfer state
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **transferStateChange** (transferId, transferStateId, reason)
                VALUES (t.transferId, {RESERVED}, 'Settlement transfer reserve')
            end note
            DB - -> SETTLE_DAO: Return **transferStateChangeId**
            deactivate DB

            opt t.ledgerEntryTypeId == {SETTLEMENT_NET_RECIPIENT}
                SETTLE_DAO -> DB: Select dfsp position FOR UPDATE
                activate DB
                hnote over DB #lightyellow
                    SELECT participantPositionId AS dfspPositionId,
                        value AS dfspPositionValue,
                        reservedValue AS dfspReservedValue
                    FROM **participantPosition**
                    WHERE participantCurrencyId = t.dfspAccountId
                    FOR UPDATE
                end note
                DB - -> SETTLE_DAO: Return **dfspPositionId**, **dfspPositionValue** and **dfspReservedValue**
                deactivate DB

                SETTLE_DAO -> DB: Select participant NET_DEBIT_CAP limit
                activate DB
                hnote over DB #lightyellow
                    SELECT value AS netDebitCap
                    FROM **participantLimit**
                    WHERE participantCurrencyId = t.dfspAccountId
                    AND participantLimitTypeId = {NET_DEBIT_CAP}
                end note
                DB - -> SETTLE_DAO: Return **netDebitCap**
                deactivate DB
                note right of SETTLE_DAO #lightgray
                    **isLimitExceeded** = netDebitCap - dfspPositionValue - dfspReservedValue - t.dfspAmount < 0
                end note

                opt isLimitExceeded == true
                    SETTLE_DAO -> DB: Select max participantPositionChangeId
                    activate DB
                    hnote over DB #lightyellow
                        SELECT participantPositionChangeId
                        FROM **participantPositionChange**
                        WHERE participantPositionId = {dfspPositionId}
                        ORDER BY 1 DESC
                        LIMIT 1
                    end note
                    DB - -> SETTLE_DAO: Return **startAfterPositionChangeId**
                    deactivate DB

                    SETTLE_DAO->SETTLE_DAO: Increase NET_DEBIT_CAP with the value of t.amount\n//using ParticipantFacade.adjustLimits method//
                end

                SETTLE_DAO->DB: Persist latest dfsp position & dfsp position change
                hnote over DB #lightyellow
                    UPDATE **participantPosition**
                    SET value = {dfspPositionValue + t.dfspAmount}
                    WHERE participantPositionId = {dfspPositionId}

                    INSERT INTO **participantPositionChange**
                           (participantPositionId, transferStateChangeId, value, reservedValue)
                    VALUES ({dfspPositionId}, {transferStateChangeId},
                        {dfspPositionValue + t.dfspAmount}, {dfspReservedValue})
                end note
                activate DB
                deactivate DB

                SETTLE_DAO -> DB: Select hub position FOR UPDATE
                activate DB
                hnote over DB #lightyellow
                    SELECT participantPositionId AS hubPositionId,
                        value AS hubPositionValue
                    FROM **participantPosition**
                    WHERE participantCurrencyId = t.hubAccountId
                    FOR UPDATE
                end note
                DB - -> SETTLE_DAO: Return **hubPositionId** and **hubPositionValue**
                deactivate DB

                SETTLE_DAO->DB: Persist latest hub position & hub position change
                hnote over DB #lightyellow
                    UPDATE **participantPosition**
                    SET value = {hubPositionValue + t.hubAmount}
                    WHERE participantPositionId = {hubPositionId}

                    INSERT INTO **participantPositionChange**
                        (participantPositionId, transferStateChangeId,
                        value, reservedValue)
                    VALUES ({hubPositionId}, {transferStateChangeId},
                        {hubPositionValue + t.hubAmount}, 0)
                end note
                activate DB
                deactivate DB
            end
        end
    end
end
deactivate SETTLE_DAO

@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>