<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1617px" preserveAspectRatio="none" style="width:909px;height:1617px;" version="1.1" viewBox="0 0 909 1617" width="909px" zoomAndPan="magnify"><defs><filter height="300%" id="fu5ojy5qj5lou" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="246" x="332" y="23.5352">6.3.2. Settlement Transfer Reserve</text><rect fill="#90EE90" height="1572.2305" style="stroke: #A80036; stroke-width: 1.0;" width="130" x="55" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="58" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="1572.2305" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="533" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="536" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#fu5ojy5qj5lou)" height="1404.9434" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="115" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fu5ojy5qj5lou)" height="292.2793" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="585" y="211.2188"/><rect fill="#FFFFFF" filter="url(#fu5ojy5qj5lou)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="585" y="581.4297"/><rect fill="#FFFFFF" filter="url(#fu5ojy5qj5lou)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="585" y="743.6035"/><rect fill="#FFFFFF" filter="url(#fu5ojy5qj5lou)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="585" y="945.0879"/><rect fill="#FFFFFF" filter="url(#fu5ojy5qj5lou)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="585" y="1209.1934"/><rect fill="#FFFFFF" filter="url(#fu5ojy5qj5lou)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="585" y="1362.3672"/><rect fill="#FFFFFF" filter="url(#fu5ojy5qj5lou)" height="1390.9434" style="stroke: #000000; stroke-width: 2.0;" width="884" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#fu5ojy5qj5lou)" height="998.7324" style="stroke: #000000; stroke-width: 2.0;" width="826" x="23" y="518.498"/><rect fill="#FFFFFF" filter="url(#fu5ojy5qj5lou)" height="967.4219" style="stroke: #000000; stroke-width: 2.0;" width="806" x="33" y="542.8086"/><rect fill="#FFFFFF" filter="url(#fu5ojy5qj5lou)" height="436.5898" style="stroke: #000000; stroke-width: 2.0;" width="742" x="43" y="704.9824"/><rect fill="#FFFFFF" filter="url(#fu5ojy5qj5lou)" height="228.1055" style="stroke: #000000; stroke-width: 2.0;" width="726" x="53" y="906.4668"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="120" x2="120" y1="116.2871" y2="1541.2305"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="590" x2="590" y1="116.2871" y2="1541.2305"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="63" y="113.334">Settlement DAO</text><ellipse cx="120" cy="83.7988" fill="#FEFECE" filter="url(#fu5ojy5qj5lou)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="108" x2="132" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="63" y="1553.7656">Settlement DAO</text><ellipse cx="120" cy="1572.7188" fill="#FEFECE" filter="url(#fu5ojy5qj5lou)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="108" x2="132" y1="1586.7188" y2="1586.7188"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="542" y="113.334">Central Store</text><path d="M572,63.7988 C572,53.7988 590,53.7988 590,53.7988 C590,53.7988 608,53.7988 608,63.7988 L608,89.7988 C608,99.7988 590,99.7988 590,99.7988 C590,99.7988 572,99.7988 572,89.7988 L572,63.7988 " fill="#FEFECE" filter="url(#fu5ojy5qj5lou)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M572,63.7988 C572,73.7988 590,73.7988 590,73.7988 C590,73.7988 608,73.7988 608,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="542" y="1553.7656">Central Store</text><path d="M572,1566.7188 C572,1556.7188 590,1556.7188 590,1556.7188 C590,1556.7188 608,1556.7188 608,1566.7188 L608,1592.7188 C608,1602.7188 590,1602.7188 590,1602.7188 C590,1602.7188 572,1602.7188 572,1592.7188 L572,1566.7188 " fill="#FEFECE" filter="url(#fu5ojy5qj5lou)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M572,1566.7188 C572,1576.7188 590,1576.7188 590,1576.7188 C590,1576.7188 608,1576.7188 608,1566.7188 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fu5ojy5qj5lou)" height="1404.9434" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="115" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fu5ojy5qj5lou)" height="292.2793" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="585" y="211.2188"/><rect fill="#FFFFFF" filter="url(#fu5ojy5qj5lou)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="585" y="581.4297"/><rect fill="#FFFFFF" filter="url(#fu5ojy5qj5lou)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="585" y="743.6035"/><rect fill="#FFFFFF" filter="url(#fu5ojy5qj5lou)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="585" y="945.0879"/><rect fill="#FFFFFF" filter="url(#fu5ojy5qj5lou)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="585" y="1209.1934"/><rect fill="#FFFFFF" filter="url(#fu5ojy5qj5lou)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="585" y="1362.3672"/><path d="M13,133.2871 L250,133.2871 L250,140.2871 L240,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1390.9434" style="stroke: #000000; stroke-width: 2.0;" width="884" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="192" x="28" y="146.8555">Settlement Transfer Reserve</text><path d="M130,155.5977 L130,180.5977 L817,180.5977 L817,165.5977 L807,155.5977 L130,155.5977 " fill="#D3D3D3" filter="url(#fu5ojy5qj5lou)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M807,155.5977 L807,165.5977 L817,165.5977 L807,155.5977 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="136" y="173.166">Inputs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="623" x="179" y="173.166">: settlementId that holds entries with PS_TRANSFERS_RESERVED, transactionTimestamp, enums, trx</text><polygon fill="#A80036" points="573,207.2188,583,211.2188,573,215.2188,577,211.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="125" x2="579" y1="211.2188" y2="211.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="132" y="206.4766">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="376" x="145" y="206.4766">Retrieve list of PS_TRANSFERS_RESERVED, but not RESERVED</text><polygon fill="#FFFFE0" filter="url(#fu5ojy5qj5lou)" points="302,224.2188,877,224.2188,887,350.2188,877,476.2188,302,476.2188,292,350.2188,302,224.2188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="571" x="304" y="240.7871">SELECT tp.transferId, tp.participantCurrencyId, tp.transferParticipantRoleTypeId, tp.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="304" y="256.0977">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="344" y="256.0977">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="555" y="256.0977">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="304" y="271.4082">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="336" y="271.4082">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="632" y="271.4082">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="512" x="304" y="286.7188">ON spcsc.settlementParticipantCurrencyId = spc.settlementParticipantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="304" y="302.0293">AND spcsc.settlementStateId = {PS_TRANSFERS_RESERVED}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="304" y="317.3398">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="336" y="317.3398">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="479" y="317.3398">tsc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="304" y="332.6504">ON tsc1.transferId = spc.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="304" y="347.9609">AND tsc1.transferStateId = {RECEIVED_PREPARE}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="304" y="363.2715">LEFT JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="369" y="363.2715">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="512" y="363.2715">tsc2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="304" y="378.582">ON tsc2.transferId = spc.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="304" y="393.8926">AND tsc2.transferStateId = {RESERVED}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="304" y="409.2031">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="336" y="409.2031">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="13" x="467" y="409.2031">tp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="304" y="424.5137">ON tp.transferId = spc.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="304" y="439.8242">AND tp.amount &gt; 0</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="432" y="439.8242">-- get CR entries</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="304" y="455.1348">WHERE spc.settlementId = {settlementId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="304" y="470.4453">AND tsc2.transferId IS NULL</text><polygon fill="#A80036" points="136,499.498,126,503.498,136,507.498,132,503.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="130" x2="589" y1="503.498" y2="503.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="142" y="498.7559">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="155" y="498.7559">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="200" y="498.7559">settlementTransferList</text><path d="M23,518.498 L188,518.498 L188,525.498 L178,535.498 L23,535.498 L23,518.498 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="998.7324" style="stroke: #000000; stroke-width: 2.0;" width="826" x="23" y="518.498"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="38" y="532.0664">DB TRANSACTION</text><path d="M33,542.8086 L107,542.8086 L107,549.8086 L97,559.8086 L33,559.8086 L33,542.8086 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="967.4219" style="stroke: #000000; stroke-width: 2.0;" width="806" x="33" y="542.8086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="48" y="556.377">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="122" y="555.4434">[t IN settlementTransferList]</text><polygon fill="#A80036" points="573,577.4297,583,581.4297,573,585.4297,577,581.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="125" x2="579" y1="581.4297" y2="581.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="132" y="576.6875">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="243" x="145" y="576.6875">Select participantPosition FOR UPDATE</text><polygon fill="#FFFFE0" filter="url(#fu5ojy5qj5lou)" points="385,594.4297,795,594.4297,805,628.4297,795,663.4297,385,663.4297,375,628.4297,385,594.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="387" y="610.998">SELECT participantPositionId, value positionValue, reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="387" y="626.3086">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="427" y="626.3086">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="387" y="641.6191">WHERE participantCurrencyId = t.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="387" y="656.9297">FOR UPDATE</text><polygon fill="#A80036" points="136,685.9824,126,689.9824,136,693.9824,132,689.9824" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="130" x2="589" y1="689.9824" y2="689.9824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="142" y="685.2402">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="155" y="685.2402">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="140" x="200" y="685.2402">participantPositionId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="340" y="685.2402">,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="92" x="348" y="685.2402">positionValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="444" y="685.2402">and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="471" y="685.2402">reservedValue</text><path d="M43,704.9824 L110,704.9824 L110,711.9824 L100,721.9824 L43,721.9824 L43,704.9824 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="436.5898" style="stroke: #000000; stroke-width: 2.0;" width="742" x="43" y="704.9824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="58" y="718.5508">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="305" x="125" y="717.6172">[t.transferParticipantRoleTypeId == {DFSP_POSITION}]</text><polygon fill="#A80036" points="573,739.6035,583,743.6035,573,747.6035,577,743.6035" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="125" x2="579" y1="743.6035" y2="743.6035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="132" y="738.8613">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="145" y="738.8613">Select participant NET_DEBIT_CAP limit</text><polygon fill="#FFFFE0" filter="url(#fu5ojy5qj5lou)" points="415,756.6035,765,756.6035,775,790.6035,765,825.6035,415,825.6035,405,790.6035,415,756.6035" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="417" y="773.1719">SELECT value AS netDebitCap</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="417" y="788.4824">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="457" y="788.4824">participantLimit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="417" y="803.793">WHERE participantCurrencyId = t.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="301" x="417" y="819.1035">AND participantLimitTypeId = {NET_DEBIT_CAP}</text><polygon fill="#A80036" points="136,848.1563,126,852.1563,136,856.1563,132,852.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="130" x2="589" y1="852.1563" y2="852.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="142" y="847.4141">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="155" y="847.4141">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="84" x="200" y="847.4141">netDebitCap</text><path d="M130,865.1563 L130,890.1563 L661,890.1563 L661,875.1563 L651,865.1563 L130,865.1563 " fill="#D3D3D3" filter="url(#fu5ojy5qj5lou)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M651,865.1563 L651,875.1563 L661,875.1563 L651,865.1563 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="136" y="882.7246">isLimitExceeded</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396" x="250" y="882.7246">= netDebitCap - positionValue - reservedValue - t.amount &lt; 0</text><path d="M53,906.4668 L120,906.4668 L120,913.4668 L110,923.4668 L53,923.4668 L53,906.4668 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="228.1055" style="stroke: #000000; stroke-width: 2.0;" width="726" x="53" y="906.4668"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="68" y="920.0352">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="146" x="135" y="919.1016">[isLimitExceeded == true]</text><polygon fill="#A80036" points="573,941.0879,583,945.0879,573,949.0879,577,945.0879" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="125" x2="579" y1="945.0879" y2="945.0879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="132" y="940.3457">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="145" y="940.3457">Select max participantPositionChangeId</text><polygon fill="#FFFFE0" filter="url(#fu5ojy5qj5lou)" points="420,958.0879,759,958.0879,769,1000.0879,759,1042.0879,420,1042.0879,410,1000.0879,420,958.0879" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="422" y="974.6563">SELECT participantPositionChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="422" y="989.9668">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="462" y="989.9668">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="335" x="422" y="1005.2773">WHERE participantPositionId = {participantPositionId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="422" y="1020.5879">ORDER BY 1 DESC</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="422" y="1035.8984">LIMIT 1</text><polygon fill="#A80036" points="136,1064.9512,126,1068.9512,136,1072.9512,132,1068.9512" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="130" x2="589" y1="1068.9512" y2="1068.9512"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="142" y="1064.209">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="155" y="1064.209">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="183" x="200" y="1064.209">startAfterPositionChangeId</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="125" x2="167" y1="1113.5723" y2="1113.5723"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="167" x2="167" y1="1113.5723" y2="1126.5723"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="126" x2="167" y1="1126.5723" y2="1126.5723"/><polygon fill="#A80036" points="136,1122.5723,126,1126.5723,136,1130.5723,132,1126.5723" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="132" y="1101.1748">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="326" x="145" y="1093.5195">Increase NET_DEBIT_CAP with the value of t.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="283" x="145" y="1108.8301">using ParticipantFacade.adjustLimits method</text><path d="M130,1153.5723 L130,1178.5723 L492,1178.5723 L492,1163.5723 L482,1153.5723 L130,1153.5723 " fill="#D3D3D3" filter="url(#fu5ojy5qj5lou)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M482,1153.5723 L482,1163.5723 L492,1163.5723 L482,1153.5723 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="136" y="1171.1406">latestPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="247" x="230" y="1171.1406">= positionValue + t.amount (increased)</text><polygon fill="#A80036" points="573,1205.1934,583,1209.1934,573,1213.1934,577,1209.1934" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="125" x2="579" y1="1209.1934" y2="1209.1934"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="132" y="1204.4512">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="154" y="1204.4512">Persist latestPosition</text><polygon fill="#FFFFE0" filter="url(#fu5ojy5qj5lou)" points="424,1222.1934,755,1222.1934,765,1264.1934,755,1306.1934,424,1306.1934,414,1264.1934,424,1222.1934" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="426" y="1238.7617">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="480" y="1238.7617">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="426" y="1254.0723">SET value = {latestPosition}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="327" x="426" y="1269.3828">WHERE participantPositionId = participantPositionId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="430" y="1284.6934"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="426" y="1300.0039">SELECT LAST_INSERT_ID() AS participantPositionId</text><polygon fill="#A80036" points="136,1329.0566,126,1333.0566,136,1337.0566,132,1333.0566" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="130" x2="589" y1="1333.0566" y2="1333.0566"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="142" y="1328.3145">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="164" y="1328.3145">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="140" x="209" y="1328.3145">participantPositionId</text><polygon fill="#A80036" points="573,1358.3672,583,1362.3672,573,1366.3672,577,1362.3672" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="125" x2="579" y1="1362.3672" y2="1362.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="132" y="1357.625">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="154" y="1357.625">Persist transfer state and participant position change</text><polygon fill="#FFFFE0" filter="url(#fu5ojy5qj5lou)" points="360,1405.3672,819,1405.3672,829,1454.3672,819,1504.3672,360,1504.3672,350,1454.3672,360,1405.3672" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="362" y="1421.9355">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="446" y="1421.9355">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="589" y="1421.9355">(transferId, transferStateId, reason)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="393" x="362" y="1437.2461">VALUES (t.transferId, {RESERVED}, 'Settlement transfer commit')</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="366" y="1452.5566"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="362" y="1467.8672">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="446" y="1467.8672">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="327" x="390" y="1483.1777">(participantPositionId, transferStateChangeId, value)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="455" x="362" y="1498.4883">VALUES ({participantPositionId}, {transferStateChangeId}, {latestPosition})</text><!--
@startuml
title 6.3.2. Settlement Transfer Reserve
autonumber

entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Settlement Service" #lightgreen
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

activate SETTLE_DAO
group Settlement Transfer Reserve
    note right of SETTLE_DAO #lightgray
        **Inputs**: settlementId that holds entries with PS_TRANSFERS_RESERVED, transactionTimestamp, enums, trx
    end note
    SETTLE_DAO -> DB: Retrieve list of PS_TRANSFERS_RESERVED, but not RESERVED
    activate DB
    hnote over DB #lightyellow
        SELECT tp.transferId, tp.participantCurrencyId, tp.transferParticipantRoleTypeId, tp.amount
        FROM **settlementParticipantCurrency** spc
        JOIN **settlementParticipantCurrencyStateChange** spcsc
        ON spcsc.settlementParticipantCurrencyId = spc.settlementParticipantCurrencyId
        AND spcsc.settlementStateId = {PS_TRANSFERS_RESERVED}
        JOIN **transferStateChange** tsc1
        ON tsc1.transferId = spc.settlementTransferId
        AND tsc1.transferStateId = {RECEIVED_PREPARE}
        LEFT JOIN **transferStateChange** tsc2
        ON tsc2.transferId = spc.settlementTransferId
        AND tsc2.transferStateId = {RESERVED}
        JOIN **transferParticipant** tp
        ON tp.transferId = spc.settlementTransferId
        AND tp.amount > 0 <color #blue>- - get CR entries</color>
        WHERE spc.settlementId = {settlementId}
        AND tsc2.transferId IS NULL
    end hnote
    DB - -> SETTLE_DAO: Return **settlementTransferList**
    deactivate DB
    group <color #blue>DB TRANSACTION</color>
        loop t IN settlementTransferList
            SETTLE_DAO -> DB: Select participantPosition FOR UPDATE
            activate DB
            hnote over DB #lightyellow
                SELECT participantPositionId, value positionValue, reservedValue
                FROM **participantPosition**
                WHERE participantCurrencyId = t.participantCurrencyId
                FOR UPDATE
            end note
            DB - -> SETTLE_DAO: Return **participantPositionId**, **positionValue** and **reservedValue**
            deactivate DB

            opt t.transferParticipantRoleTypeId == {DFSP_POSITION}
                SETTLE_DAO -> DB: Select participant NET_DEBIT_CAP limit
                activate DB
                hnote over DB #lightyellow
                    SELECT value AS netDebitCap
                    FROM **participantLimit**
                    WHERE participantCurrencyId = t.participantCurrencyId
                    AND participantLimitTypeId = {NET_DEBIT_CAP}
                end note
                DB - -> SETTLE_DAO: Return **netDebitCap**
                deactivate DB
                note right of SETTLE_DAO #lightgray
                    **isLimitExceeded** = netDebitCap - positionValue - reservedValue - t.amount < 0
                end note

                opt isLimitExceeded == true
                    SETTLE_DAO -> DB: Select max participantPositionChangeId
                    activate DB
                    hnote over DB #lightyellow
                        SELECT participantPositionChangeId
                        FROM **participantPositionChange**
                        WHERE participantPositionId = {participantPositionId}
                        ORDER BY 1 DESC
                        LIMIT 1
                    end note
                    DB - -> SETTLE_DAO: Return **startAfterPositionChangeId**
                    deactivate DB

                    SETTLE_DAO->SETTLE_DAO: Increase NET_DEBIT_CAP with the value of t.amount\n//using ParticipantFacade.adjustLimits method//
                end
            end

            note right of SETTLE_DAO #lightgray
                **latestPosition** = positionValue + t.amount (increased)
            end note

            SETTLE_DAO->DB: Persist latestPosition
            activate DB
            hnote over DB #lightyellow
                UPDATE **participantPosition**
                SET value = {latestPosition}
                WHERE participantPositionId = participantPositionId

                SELECT LAST_INSERT_ID() AS participantPositionId
            end note
            DB- ->SETTLE_DAO: Return **participantPositionId**
            deactivate DB

            deactivate DB
            SETTLE_DAO -> DB: Persist transfer state and participant position change
            hnote over DB #lightyellow
                INSERT INTO **transferStateChange** (transferId, transferStateId, reason)
                VALUES (t.transferId, {RESERVED}, 'Settlement transfer commit')

                INSERT INTO **participantPositionChange**
                       (participantPositionId, transferStateChangeId, value)
                VALUES ({participantPositionId}, {transferStateChangeId}, {latestPosition})
            end note
            activate DB
            deactivate DB
        end
    end
end
deactivate SETTLE_DAO

@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>