<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1228px" preserveAspectRatio="none" style="width:889px;height:1228px;" version="1.1" viewBox="0 0 889 1228" width="889px" zoomAndPan="magnify"><defs><filter height="300%" id="f16jeyqwnnz6c5" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="248" x="321" y="23.5352">6.3.2. Settlement Transfer Commit</text><rect fill="#90EE90" height="1182.8828" style="stroke: #A80036; stroke-width: 1.0;" width="130" x="35" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="38" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="1182.8828" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="513" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="516" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#f16jeyqwnnz6c5)" height="1015.5957" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="95" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f16jeyqwnnz6c5)" height="292.2793" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="565" y="211.2188"/><rect fill="#FFFFFF" filter="url(#f16jeyqwnnz6c5)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="565" y="581.4297"/><rect fill="#FFFFFF" filter="url(#f16jeyqwnnz6c5)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="565" y="758.6035"/><rect fill="#FFFFFF" filter="url(#f16jeyqwnnz6c5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="565" y="911.7773"/><rect fill="#FFFFFF" filter="url(#f16jeyqwnnz6c5)" height="1001.5957" style="stroke: #000000; stroke-width: 2.0;" width="864" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f16jeyqwnnz6c5)" height="609.3848" style="stroke: #000000; stroke-width: 2.0;" width="814" x="23" y="518.498"/><rect fill="#FFFFFF" filter="url(#f16jeyqwnnz6c5)" height="578.0742" style="stroke: #000000; stroke-width: 2.0;" width="794" x="33" y="542.8086"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="100" x2="100" y1="116.2871" y2="1151.8828"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="570" x2="570" y1="116.2871" y2="1151.8828"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="43" y="113.334">Settlement DAO</text><ellipse cx="100" cy="83.7988" fill="#FEFECE" filter="url(#f16jeyqwnnz6c5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="88" x2="112" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="43" y="1164.418">Settlement DAO</text><ellipse cx="100" cy="1183.3711" fill="#FEFECE" filter="url(#f16jeyqwnnz6c5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="88" x2="112" y1="1197.3711" y2="1197.3711"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="522" y="113.334">Central Store</text><path d="M552,63.7988 C552,53.7988 570,53.7988 570,53.7988 C570,53.7988 588,53.7988 588,63.7988 L588,89.7988 C588,99.7988 570,99.7988 570,99.7988 C570,99.7988 552,99.7988 552,89.7988 L552,63.7988 " fill="#FEFECE" filter="url(#f16jeyqwnnz6c5)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M552,63.7988 C552,73.7988 570,73.7988 570,73.7988 C570,73.7988 588,73.7988 588,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="522" y="1164.418">Central Store</text><path d="M552,1177.3711 C552,1167.3711 570,1167.3711 570,1167.3711 C570,1167.3711 588,1167.3711 588,1177.3711 L588,1203.3711 C588,1213.3711 570,1213.3711 570,1213.3711 C570,1213.3711 552,1213.3711 552,1203.3711 L552,1177.3711 " fill="#FEFECE" filter="url(#f16jeyqwnnz6c5)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M552,1177.3711 C552,1187.3711 570,1187.3711 570,1187.3711 C570,1187.3711 588,1187.3711 588,1177.3711 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f16jeyqwnnz6c5)" height="1015.5957" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="95" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f16jeyqwnnz6c5)" height="292.2793" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="565" y="211.2188"/><rect fill="#FFFFFF" filter="url(#f16jeyqwnnz6c5)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="565" y="581.4297"/><rect fill="#FFFFFF" filter="url(#f16jeyqwnnz6c5)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="565" y="758.6035"/><rect fill="#FFFFFF" filter="url(#f16jeyqwnnz6c5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="565" y="911.7773"/><path d="M13,133.2871 L248,133.2871 L248,140.2871 L238,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1001.5957" style="stroke: #000000; stroke-width: 2.0;" width="864" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="190" x="28" y="146.8555">Settlement Transfer Commit</text><path d="M110,155.5977 L110,180.5977 L813,180.5977 L813,165.5977 L803,155.5977 L110,155.5977 " fill="#D3D3D3" filter="url(#f16jeyqwnnz6c5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M803,155.5977 L803,165.5977 L813,165.5977 L803,155.5977 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="116" y="173.166">Inputs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="639" x="159" y="173.166">: settlementId that holds entries with PS_TRANSFERS_COMMITTED, transactionTimestamp, enums, trx</text><polygon fill="#A80036" points="553,207.2188,563,211.2188,553,215.2188,557,211.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="105" x2="559" y1="211.2188" y2="211.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="112" y="206.4766">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="125" y="206.4766">Retrieve list of PS_TRANSFERS_COMMITTED, but not COMMITTED</text><polygon fill="#FFFFE0" filter="url(#f16jeyqwnnz6c5)" points="282,224.2188,857,224.2188,867,350.2188,857,476.2188,282,476.2188,272,350.2188,282,224.2188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="571" x="284" y="240.7871">SELECT tp.transferId, tp.participantCurrencyId, tp.transferParticipantRoleTypeId, tp.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="284" y="256.0977">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="324" y="256.0977">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="535" y="256.0977">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="284" y="271.4082">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="316" y="271.4082">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="612" y="271.4082">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="512" x="284" y="286.7188">ON spcsc.settlementParticipantCurrencyId = spc.settlementParticipantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="386" x="284" y="302.0293">AND spcsc.settlementStateId = {PS_TRANSFERS_COMMITTED}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="284" y="317.3398">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="316" y="317.3398">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="459" y="317.3398">tsc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="284" y="332.6504">ON tsc1.transferId = spc.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="284" y="347.9609">AND tsc1.transferStateId = {RESERVED}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="284" y="363.2715">LEFT JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="349" y="363.2715">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="492" y="363.2715">tsc2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="284" y="378.582">ON tsc2.transferId = spc.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260" x="284" y="393.8926">AND tsc2.transferStateId = {COMMITTED}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="284" y="409.2031">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="316" y="409.2031">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="13" x="447" y="409.2031">tp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="284" y="424.5137">ON tp.transferId = spc.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="284" y="439.8242">AND tp.amount &lt; 0</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="412" y="439.8242">-- get DR entries</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="284" y="455.1348">WHERE spc.settlementId = {settlementId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="284" y="470.4453">AND tsc2.transferId IS NULL</text><polygon fill="#A80036" points="116,499.498,106,503.498,116,507.498,112,503.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="110" x2="569" y1="503.498" y2="503.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="498.7559">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="135" y="498.7559">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="180" y="498.7559">settlementTransferList</text><path d="M23,518.498 L188,518.498 L188,525.498 L178,535.498 L23,535.498 L23,518.498 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="609.3848" style="stroke: #000000; stroke-width: 2.0;" width="814" x="23" y="518.498"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="38" y="532.0664">DB TRANSACTION</text><path d="M33,542.8086 L107,542.8086 L107,549.8086 L97,559.8086 L33,559.8086 L33,542.8086 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="578.0742" style="stroke: #000000; stroke-width: 2.0;" width="794" x="33" y="542.8086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="48" y="556.377">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="122" y="555.4434">[t IN settlementTransferList]</text><polygon fill="#A80036" points="553,577.4297,563,581.4297,553,585.4297,557,581.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="105" x2="559" y1="581.4297" y2="581.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="112" y="576.6875">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="243" x="125" y="576.6875">Select participantPosition FOR UPDATE</text><polygon fill="#FFFFE0" filter="url(#f16jeyqwnnz6c5)" points="365,594.4297,775,594.4297,785,628.4297,775,663.4297,365,663.4297,355,628.4297,365,594.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="367" y="610.998">SELECT participantPositionId, value positionValue, reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="367" y="626.3086">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="407" y="626.3086">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="367" y="641.6191">WHERE participantCurrencyId = t.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="367" y="656.9297">FOR UPDATE</text><polygon fill="#A80036" points="116,685.9824,106,689.9824,116,693.9824,112,689.9824" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="110" x2="569" y1="689.9824" y2="689.9824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="685.2402">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="135" y="685.2402">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="140" x="180" y="685.2402">participantPositionId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="320" y="685.2402">,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="92" x="328" y="685.2402">positionValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="424" y="685.2402">and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="451" y="685.2402">reservedValue</text><path d="M110,702.9824 L110,727.9824 L462,727.9824 L462,712.9824 L452,702.9824 L110,702.9824 " fill="#D3D3D3" filter="url(#f16jeyqwnnz6c5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M452,702.9824 L452,712.9824 L462,712.9824 L452,702.9824 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="116" y="720.5508">latestPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="237" x="210" y="720.5508">= positionValue + t.amount (reduced)</text><polygon fill="#A80036" points="553,754.6035,563,758.6035,553,762.6035,557,758.6035" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="105" x2="559" y1="758.6035" y2="758.6035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="112" y="753.8613">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="125" y="753.8613">Persist latestPosition</text><polygon fill="#FFFFE0" filter="url(#f16jeyqwnnz6c5)" points="404,771.6035,735,771.6035,745,813.6035,735,855.6035,404,855.6035,394,813.6035,404,771.6035" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="406" y="788.1719">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="460" y="788.1719">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="406" y="803.4824">SET value = {latestPosition}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="327" x="406" y="818.793">WHERE participantPositionId = participantPositionId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="410" y="834.1035"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="406" y="849.4141">SELECT LAST_INSERT_ID() AS participantPositionId</text><polygon fill="#A80036" points="116,878.4668,106,882.4668,116,886.4668,112,882.4668" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="110" x2="569" y1="882.4668" y2="882.4668"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="877.7246">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="135" y="877.7246">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="140" x="180" y="877.7246">participantPositionId</text><polygon fill="#A80036" points="553,907.7773,563,911.7773,553,915.7773,557,911.7773" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="105" x2="559" y1="911.7773" y2="911.7773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="112" y="907.0352">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="125" y="907.0352">Persist transfer state and participant position change</text><polygon fill="#FFFFE0" filter="url(#f16jeyqwnnz6c5)" points="333,954.7773,807,954.7773,817,1034.7773,807,1115.7773,333,1115.7773,323,1034.7773,333,954.7773" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="335" y="971.3457">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="419" y="971.3457">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260" x="545" y="971.3457">(transferId, ilpFulfilment, completedDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="363" y="986.6563">isValid, settlementWindowId, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="368" x="335" y="1001.9668">VALUES (t.transferId, 0, tTimestamp, 1, NULL, tTimestamp)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="339" y="1017.2773"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="335" y="1032.5879">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="419" y="1032.5879">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="562" y="1032.5879">(transferId, transferStateId, reason)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="409" x="335" y="1047.8984">VALUES (t.transferId, {COMMITTED}, 'Settlement transfer commit')</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="339" y="1063.209"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="335" y="1078.5195">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="419" y="1078.5195">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="327" x="363" y="1093.8301">(participantPositionId, transferStateChangeId, value)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="455" x="335" y="1109.1406">VALUES ({participantPositionId}, {transferStateChangeId}, {latestPosition})</text><!--
@startuml
title 6.3.2. Settlement Transfer Commit
autonumber

entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Settlement Service" #lightgreen
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

activate SETTLE_DAO
group Settlement Transfer Commit
    note right of SETTLE_DAO #lightgray
        **Inputs**: settlementId that holds entries with PS_TRANSFERS_COMMITTED, transactionTimestamp, enums, trx
    end note
    SETTLE_DAO -> DB: Retrieve list of PS_TRANSFERS_COMMITTED, but not COMMITTED
    activate DB
    hnote over DB #lightyellow
        SELECT tp.transferId, tp.participantCurrencyId, tp.transferParticipantRoleTypeId, tp.amount
        FROM **settlementParticipantCurrency** spc
        JOIN **settlementParticipantCurrencyStateChange** spcsc
        ON spcsc.settlementParticipantCurrencyId = spc.settlementParticipantCurrencyId
        AND spcsc.settlementStateId = {PS_TRANSFERS_COMMITTED}
        JOIN **transferStateChange** tsc1
        ON tsc1.transferId = spc.settlementTransferId
        AND tsc1.transferStateId = {RESERVED}
        LEFT JOIN **transferStateChange** tsc2
        ON tsc2.transferId = spc.settlementTransferId
        AND tsc2.transferStateId = {COMMITTED}
        JOIN **transferParticipant** tp
        ON tp.transferId = spc.settlementTransferId
        AND tp.amount < 0 <color #blue>- - get DR entries</color>
        WHERE spc.settlementId = {settlementId}
        AND tsc2.transferId IS NULL
    end hnote
    DB - -> SETTLE_DAO: Return **settlementTransferList**
    deactivate DB
    group <color #blue>DB TRANSACTION</color>
        loop t IN settlementTransferList
            SETTLE_DAO -> DB: Select participantPosition FOR UPDATE
            activate DB
            hnote over DB #lightyellow
                SELECT participantPositionId, value positionValue, reservedValue
                FROM **participantPosition**
                WHERE participantCurrencyId = t.participantCurrencyId
                FOR UPDATE
            end note
            DB - -> SETTLE_DAO: Return **participantPositionId**, **positionValue** and **reservedValue**
            deactivate DB

            note right of SETTLE_DAO #lightgray
                **latestPosition** = positionValue + t.amount (reduced)
            end note

            SETTLE_DAO->DB: Persist latestPosition
            activate DB
            hnote over DB #lightyellow
                UPDATE **participantPosition**
                SET value = {latestPosition}
                WHERE participantPositionId = participantPositionId

                SELECT LAST_INSERT_ID() AS participantPositionId
            end note
            DB- ->SETTLE_DAO: Return **participantPositionId**
            deactivate DB

            deactivate DB
            SETTLE_DAO -> DB: Persist transfer state and participant position change
            hnote over DB #lightyellow
                INSERT INTO **transferFulfilment** (transferId, ilpFulfilment, completedDate,
                       isValid, settlementWindowId, createdDate)
                VALUES (t.transferId, 0, tTimestamp, 1, NULL, tTimestamp)

                INSERT INTO **transferStateChange** (transferId, transferStateId, reason)
                VALUES (t.transferId, {COMMITTED}, 'Settlement transfer commit')

                INSERT INTO **participantPositionChange**
                       (participantPositionId, transferStateChangeId, value)
                VALUES ({participantPositionId}, {transferStateChangeId}, {latestPosition})
            end note
            activate DB
            deactivate DB
        end
    end
end
deactivate SETTLE_DAO

@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>