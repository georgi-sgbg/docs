<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1850px" preserveAspectRatio="none" style="width:898px;height:1850px;" version="1.1" viewBox="0 0 898 1850" width="898px" zoomAndPan="magnify"><defs><filter height="300%" id="f1plc3s39x1xyq" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="248" x="326" y="23.5352">6.3.2. Settlement Transfer Commit</text><rect fill="#90EE90" height="1804.957" style="stroke: #A80036; stroke-width: 1.0;" width="130" x="45" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="48" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="1804.957" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="541" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="544" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#f1plc3s39x1xyq)" height="1637.6699" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="105" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1plc3s39x1xyq)" height="368.832" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="211.2188"/><rect fill="#FFFFFF" filter="url(#f1plc3s39x1xyq)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="657.9824"/><rect fill="#FFFFFF" filter="url(#f1plc3s39x1xyq)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="781.2246"/><rect fill="#FFFFFF" filter="url(#f1plc3s39x1xyq)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="889.1563"/><rect fill="#FFFFFF" filter="url(#f1plc3s39x1xyq)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="1020.709"/><rect fill="#FFFFFF" filter="url(#f1plc3s39x1xyq)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="1189.1934"/><rect fill="#FFFFFF" filter="url(#f1plc3s39x1xyq)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="1388.9883"/><rect fill="#FFFFFF" filter="url(#f1plc3s39x1xyq)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="1542.1621"/><rect fill="#FFFFFF" filter="url(#f1plc3s39x1xyq)" height="1623.6699" style="stroke: #000000; stroke-width: 2.0;" width="874" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f1plc3s39x1xyq)" height="1154.9063" style="stroke: #000000; stroke-width: 2.0;" width="854" x="23" y="595.0508"/><rect fill="#FFFFFF" filter="url(#f1plc3s39x1xyq)" height="1123.5957" style="stroke: #000000; stroke-width: 2.0;" width="834" x="33" y="619.3613"/><rect fill="#FFFFFF" filter="url(#f1plc3s39x1xyq)" height="753.8691" style="stroke: #000000; stroke-width: 2.0;" width="796" x="43" y="982.0879"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="110" x2="110" y1="116.2871" y2="1773.957"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="598" x2="598" y1="116.2871" y2="1773.957"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="53" y="113.334">Settlement DAO</text><ellipse cx="110" cy="83.7988" fill="#FEFECE" filter="url(#f1plc3s39x1xyq)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="98" x2="122" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="53" y="1786.4922">Settlement DAO</text><ellipse cx="110" cy="1805.4453" fill="#FEFECE" filter="url(#f1plc3s39x1xyq)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="98" x2="122" y1="1819.4453" y2="1819.4453"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="550" y="113.334">Central Store</text><path d="M580,63.7988 C580,53.7988 598,53.7988 598,53.7988 C598,53.7988 616,53.7988 616,63.7988 L616,89.7988 C616,99.7988 598,99.7988 598,99.7988 C598,99.7988 580,99.7988 580,89.7988 L580,63.7988 " fill="#FEFECE" filter="url(#f1plc3s39x1xyq)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M580,63.7988 C580,73.7988 598,73.7988 598,73.7988 C598,73.7988 616,73.7988 616,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="550" y="1786.4922">Central Store</text><path d="M580,1799.4453 C580,1789.4453 598,1789.4453 598,1789.4453 C598,1789.4453 616,1789.4453 616,1799.4453 L616,1825.4453 C616,1835.4453 598,1835.4453 598,1835.4453 C598,1835.4453 580,1835.4453 580,1825.4453 L580,1799.4453 " fill="#FEFECE" filter="url(#f1plc3s39x1xyq)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M580,1799.4453 C580,1809.4453 598,1809.4453 598,1809.4453 C598,1809.4453 616,1809.4453 616,1799.4453 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1plc3s39x1xyq)" height="1637.6699" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="105" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1plc3s39x1xyq)" height="368.832" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="211.2188"/><rect fill="#FFFFFF" filter="url(#f1plc3s39x1xyq)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="657.9824"/><rect fill="#FFFFFF" filter="url(#f1plc3s39x1xyq)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="781.2246"/><rect fill="#FFFFFF" filter="url(#f1plc3s39x1xyq)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="889.1563"/><rect fill="#FFFFFF" filter="url(#f1plc3s39x1xyq)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="1020.709"/><rect fill="#FFFFFF" filter="url(#f1plc3s39x1xyq)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="1189.1934"/><rect fill="#FFFFFF" filter="url(#f1plc3s39x1xyq)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="1388.9883"/><rect fill="#FFFFFF" filter="url(#f1plc3s39x1xyq)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="1542.1621"/><path d="M13,133.2871 L248,133.2871 L248,140.2871 L238,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1623.6699" style="stroke: #000000; stroke-width: 2.0;" width="874" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="190" x="28" y="146.8555">Settlement Transfer Commit</text><path d="M120,155.5977 L120,180.5977 L823,180.5977 L823,165.5977 L813,155.5977 L120,155.5977 " fill="#D3D3D3" filter="url(#f1plc3s39x1xyq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M813,155.5977 L813,165.5977 L823,165.5977 L813,155.5977 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="126" y="173.166">Inputs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="639" x="169" y="173.166">: settlementId that holds entries with PS_TRANSFERS_COMMITTED, transactionTimestamp, enums, trx</text><polygon fill="#A80036" points="581,207.2188,591,211.2188,581,215.2188,585,211.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="587" y1="211.2188" y2="211.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="206.4766">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="135" y="206.4766">Retrieve list of PS_TRANSFERS_COMMITTED, but not COMMITTED</text><polygon fill="#FFFFE0" filter="url(#f1plc3s39x1xyq)" points="340,224.2188,856,224.2188,866,388.2188,856,553.2188,340,553.2188,330,388.2188,340,224.2188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="342" y="240.7871">SELECT tp1.transferId, tp1.ledgerEntryTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="464" x="358" y="256.0977">tp1.participantCurrencyId AS dfspAccountId, tp1.amount AS dfspAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="452" x="358" y="271.4082">tp2.participantCurrencyId AS hubAccountId, tp2.amount AS hubAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="342" y="286.7188">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="382" y="286.7188">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="593" y="286.7188">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="342" y="302.0293">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="374" y="302.0293">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="670" y="302.0293">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="512" x="342" y="317.3398">ON spcsc.settlementParticipantCurrencyId = spc.settlementParticipantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="386" x="342" y="332.6504">AND spcsc.settlementStateId = {PS_TRANSFERS_COMMITTED}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="342" y="347.9609">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="374" y="347.9609">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="517" y="347.9609">tsc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="342" y="363.2715">ON tsc1.transferId = spc.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="342" y="378.582">AND tsc1.transferStateId = {RESERVED}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="342" y="393.8926">LEFT JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="407" y="393.8926">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="550" y="393.8926">tsc2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="342" y="409.2031">ON tsc2.transferId = spc.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260" x="342" y="424.5137">AND tsc2.transferStateId = {COMMITTED}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="342" y="439.8242">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="374" y="439.8242">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="505" y="439.8242">tp1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="342" y="455.1348">ON tp1.transferId = spc.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="367" x="342" y="470.4453">AND tp1.transferParticipantRoleTypeId = {DFSP_POSITION}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="342" y="485.7559">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="374" y="485.7559">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="505" y="485.7559">tp2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="342" y="501.0664">ON tp2.transferId = spc.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="342" y="516.377">AND tp2.transferParticipantRoleTypeId = {HUB}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="342" y="531.6875">WHERE spc.settlementId = {settlementId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="342" y="546.998">AND tsc2.transferId IS NULL</text><polygon fill="#A80036" points="126,576.0508,116,580.0508,126,584.0508,122,580.0508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="120" x2="597" y1="580.0508" y2="580.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="132" y="575.3086">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="145" y="575.3086">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="190" y="575.3086">settlementTransferList</text><path d="M23,595.0508 L188,595.0508 L188,602.0508 L178,612.0508 L23,612.0508 L23,595.0508 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1154.9063" style="stroke: #000000; stroke-width: 2.0;" width="854" x="23" y="595.0508"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="38" y="608.6191">DB TRANSACTION</text><path d="M33,619.3613 L107,619.3613 L107,626.3613 L97,636.3613 L33,636.3613 L33,619.3613 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1123.5957" style="stroke: #000000; stroke-width: 2.0;" width="834" x="33" y="619.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="48" y="632.9297">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="122" y="631.9961">[t IN settlementTransferList]</text><polygon fill="#A80036" points="581,653.9824,591,657.9824,581,661.9824,585,657.9824" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="587" y1="657.9824" y2="657.9824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="653.2402">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="135" y="653.2402">Persist transfer fulfilment</text><polygon fill="#FFFFE0" filter="url(#f1plc3s39x1xyq)" points="360,700.9824,836,700.9824,846,726.9824,836,753.9824,360,753.9824,350,726.9824,360,700.9824" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="362" y="717.5508">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="446" y="717.5508">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="572" y="717.5508">(transferFulfilmentId, transferId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="456" x="378" y="732.8613">ilpFulfilment, completedDate, isValid, settlementWindowId, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="413" x="362" y="748.1719">VALUES (Uuid(), t.transferId, 0, tTimestamp, 1, NULL, tTimestamp)</text><polygon fill="#A80036" points="581,777.2246,591,781.2246,581,785.2246,585,781.2246" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="587" y1="781.2246" y2="781.2246"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="776.4824">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="135" y="776.4824">Persist RECEIVED_FULFIL state</text><polygon fill="#FFFFE0" filter="url(#f1plc3s39x1xyq)" points="348,824.2246,847,824.2246,857,843.2246,847,862.2246,348,862.2246,338,843.2246,348,824.2246" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="350" y="840.793">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="434" y="840.793">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="577" y="840.793">(transferId, transferStateId, reason)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="495" x="350" y="856.1035">VALUES (t.transferId, {RECEIVED_FULFIL}, 'Settlement transfer commit initiated')</text><polygon fill="#A80036" points="581,885.1563,591,889.1563,581,893.1563,585,889.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="587" y1="889.1563" y2="889.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="884.4141">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="135" y="884.4141">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#f1plc3s39x1xyq)" points="373,902.1563,823,902.1563,833,921.1563,823,940.1563,373,940.1563,363,921.1563,373,902.1563" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="375" y="918.7246">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="459" y="918.7246">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="602" y="918.7246">(transferId, transferStateId, reason)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="409" x="375" y="934.0352">VALUES (t.transferId, {COMMITTED}, 'Settlement transfer commit')</text><polygon fill="#A80036" points="126,963.0879,116,967.0879,126,971.0879,122,967.0879" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="120" x2="597" y1="967.0879" y2="967.0879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="132" y="962.3457">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="145" y="962.3457">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="190" y="962.3457">transferStateChangeId</text><path d="M43,982.0879 L110,982.0879 L110,989.0879 L100,999.0879 L43,999.0879 L43,982.0879 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="753.8691" style="stroke: #000000; stroke-width: 2.0;" width="796" x="43" y="982.0879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="58" y="995.6563">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="306" x="125" y="994.7227">[t.ledgerEntryTypeId == {SETTLEMENT_NET_SENDER}]</text><polygon fill="#A80036" points="581,1016.709,591,1020.709,581,1024.709,585,1020.709" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="587" y1="1020.709" y2="1020.709"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="1015.9668">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="135" y="1015.9668">Select dfsp position FOR UPDATE</text><polygon fill="#FFFFE0" filter="url(#f1plc3s39x1xyq)" points="445,1033.709,751,1033.709,761,1082.709,751,1132.709,445,1132.709,435,1082.709,445,1033.709" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="299" x="447" y="1050.2773">SELECT participantPositionId AS dfspPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="463" y="1065.5879">value AS dfspPositionValue,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="463" y="1080.8984">reservedValue AS dfspReservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="447" y="1096.209">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="487" y="1096.209">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="447" y="1111.5195">WHERE participantCurrencyId = t.dfspAccountId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="447" y="1126.8301">FOR UPDATE</text><polygon fill="#A80036" points="126,1155.8828,116,1159.8828,126,1163.8828,122,1159.8828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="120" x2="597" y1="1159.8828" y2="1159.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="132" y="1155.1406">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="145" y="1155.1406">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="96" x="190" y="1155.1406">dfspPositionId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="286" y="1155.1406">,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121" x="294" y="1155.1406">dfspPositionValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="419" y="1155.1406">and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="131" x="446" y="1155.1406">dfspReservedValue</text><polygon fill="#A80036" points="581,1185.1934,591,1189.1934,581,1193.1934,585,1189.1934" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="587" y1="1189.1934" y2="1189.1934"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="1184.4512">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="135" y="1184.4512">Persist latest dfsp position &amp; dfsp position change</text><polygon fill="#FFFFE0" filter="url(#f1plc3s39x1xyq)" points="377,1232.1934,819,1232.1934,829,1297.1934,819,1362.1934,377,1362.1934,367,1297.1934,377,1232.1934" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="379" y="1248.7617">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="433" y="1248.7617">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="303" x="379" y="1264.0723">SET value = {dfspPositionValue + t.dfspAmount}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="379" y="1279.3828">WHERE participantPositionId = {dfspPositionId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="383" y="1294.6934"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="379" y="1310.0039">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="463" y="1310.0039">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="422" x="395" y="1325.3145">(participantPositionId, transferStateChangeId, value, reservedValue)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="313" x="379" y="1340.625">VALUES ({dfspPositionId}, {transferStateChangeId},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="364" x="395" y="1355.9355">{dfspPositionValue + t.dfspAmount}, {dfspReservedValue})</text><polygon fill="#A80036" points="581,1384.9883,591,1388.9883,581,1392.9883,585,1388.9883" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="587" y1="1388.9883" y2="1388.9883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="122" y="1384.2461">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="144" y="1384.2461">Select hub position FOR UPDATE</text><polygon fill="#FFFFE0" filter="url(#f1plc3s39x1xyq)" points="447,1401.9883,749,1401.9883,759,1443.9883,749,1485.9883,447,1485.9883,437,1443.9883,447,1401.9883" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="449" y="1418.5566">SELECT participantPositionId AS hubPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="465" y="1433.8672">value AS hubPositionValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="449" y="1449.1777">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="489" y="1449.1777">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="298" x="449" y="1464.4883">WHERE participantCurrencyId = t.hubAccountId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="449" y="1479.7988">FOR UPDATE</text><polygon fill="#A80036" points="126,1508.8516,116,1512.8516,126,1516.8516,122,1512.8516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="120" x2="597" y1="1512.8516" y2="1512.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="132" y="1508.1094">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="154" y="1508.1094">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="93" x="199" y="1508.1094">hubPositionId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="296" y="1508.1094">and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="323" y="1508.1094">hubPositionValue</text><polygon fill="#A80036" points="581,1538.1621,591,1542.1621,581,1546.1621,585,1542.1621" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="587" y1="1542.1621" y2="1542.1621"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="122" y="1537.4199">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="144" y="1537.4199">Persist latest hub position &amp; hub position change</text><polygon fill="#FFFFE0" filter="url(#f1plc3s39x1xyq)" points="441,1585.1621,754,1585.1621,764,1657.1621,754,1730.1621,441,1730.1621,431,1657.1621,441,1585.1621" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="443" y="1601.7305">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="497" y="1601.7305">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="443" y="1617.041">SET value = {hubPositionValue + t.hubAmount}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="443" y="1632.3516">WHERE participantPositionId = {hubPositionId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="447" y="1647.6621"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="443" y="1662.9727">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="527" y="1662.9727">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="286" x="459" y="1678.2832">(participantPositionId, transferStateChangeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="459" y="1693.5938">value, reservedValue)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="443" y="1708.9043">VALUES ({hubPositionId}, {transferStateChangeId},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="459" y="1724.2148">{hubPositionValue + t.hubAmount}, 0)</text><!--
@startuml
title 6.3.2. Settlement Transfer Commit
autonumber

entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Settlement Service" #lightgreen
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

activate SETTLE_DAO
group Settlement Transfer Commit
    note right of SETTLE_DAO #lightgray
        **Inputs**: settlementId that holds entries with PS_TRANSFERS_COMMITTED, transactionTimestamp, enums, trx
    end note
    SETTLE_DAO -> DB: Retrieve list of PS_TRANSFERS_COMMITTED, but not COMMITTED
    activate DB
    hnote over DB #lightyellow
        SELECT tp1.transferId, tp1.ledgerEntryTypeId,
            tp1.participantCurrencyId AS dfspAccountId, tp1.amount AS dfspAmount,
            tp2.participantCurrencyId AS hubAccountId, tp2.amount AS hubAmount
        FROM **settlementParticipantCurrency** spc
        JOIN **settlementParticipantCurrencyStateChange** spcsc
        ON spcsc.settlementParticipantCurrencyId = spc.settlementParticipantCurrencyId
        AND spcsc.settlementStateId = {PS_TRANSFERS_COMMITTED}
        JOIN **transferStateChange** tsc1
        ON tsc1.transferId = spc.settlementTransferId
        AND tsc1.transferStateId = {RESERVED}
        LEFT JOIN **transferStateChange** tsc2
        ON tsc2.transferId = spc.settlementTransferId
        AND tsc2.transferStateId = {COMMITTED}
        JOIN **transferParticipant** tp1
        ON tp1.transferId = spc.settlementTransferId
        AND tp1.transferParticipantRoleTypeId = {DFSP_POSITION}
        JOIN **transferParticipant** tp2
        ON tp2.transferId = spc.settlementTransferId
        AND tp2.transferParticipantRoleTypeId = {HUB}
        WHERE spc.settlementId = {settlementId}
        AND tsc2.transferId IS NULL
    end hnote
    DB - -> SETTLE_DAO: Return **settlementTransferList**
    deactivate DB
    group <color #blue>DB TRANSACTION</color>
        loop t IN settlementTransferList
            SETTLE_DAO -> DB: Persist transfer fulfilment
            hnote over DB #lightyellow
                INSERT INTO **transferFulfilment** (transferFulfilmentId, transferId,
                    ilpFulfilment, completedDate, isValid, settlementWindowId, createdDate)
                VALUES (Uuid(), t.transferId, 0, tTimestamp, 1, NULL, tTimestamp)
            end note
            activate DB
            deactivate DB

            SETTLE_DAO -> DB: Persist RECEIVED_FULFIL state
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                INSERT INTO **transferStateChange** (transferId, transferStateId, reason)
                VALUES (t.transferId, {RECEIVED_FULFIL}, 'Settlement transfer commit initiated')
            end note

            SETTLE_DAO -> DB: Persist transfer state
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **transferStateChange** (transferId, transferStateId, reason)
                VALUES (t.transferId, {COMMITTED}, 'Settlement transfer commit')
            end note
            DB - -> SETTLE_DAO: Return **transferStateChangeId**
            deactivate DB

            opt t.ledgerEntryTypeId == {SETTLEMENT_NET_SENDER}
                SETTLE_DAO -> DB: Select dfsp position FOR UPDATE
                activate DB
                hnote over DB #lightyellow
                    SELECT participantPositionId AS dfspPositionId,
                        value AS dfspPositionValue,
                        reservedValue AS dfspReservedValue
                    FROM **participantPosition**
                    WHERE participantCurrencyId = t.dfspAccountId
                    FOR UPDATE
                end note
                DB - -> SETTLE_DAO: Return **dfspPositionId**, **dfspPositionValue** and **dfspReservedValue**
                deactivate DB

                SETTLE_DAO->DB: Persist latest dfsp position & dfsp position change
                hnote over DB #lightyellow
                    UPDATE **participantPosition**
                    SET value = {dfspPositionValue + t.dfspAmount}
                    WHERE participantPositionId = {dfspPositionId}

                    INSERT INTO **participantPositionChange**
                        (participantPositionId, transferStateChangeId, value, reservedValue)
                    VALUES ({dfspPositionId}, {transferStateChangeId},
                        {dfspPositionValue + t.dfspAmount}, {dfspReservedValue})
                end note
                activate DB
                deactivate DB

                SETTLE_DAO -> DB: Select hub position FOR UPDATE
                activate DB
                hnote over DB #lightyellow
                    SELECT participantPositionId AS hubPositionId,
                        value AS hubPositionValue
                    FROM **participantPosition**
                    WHERE participantCurrencyId = t.hubAccountId
                    FOR UPDATE
                end note
                DB - -> SETTLE_DAO: Return **hubPositionId** and **hubPositionValue**
                deactivate DB

                SETTLE_DAO->DB: Persist latest hub position & hub position change
                hnote over DB #lightyellow
                    UPDATE **participantPosition**
                    SET value = {hubPositionValue + t.hubAmount}
                    WHERE participantPositionId = {hubPositionId}

                    INSERT INTO **participantPositionChange**
                        (participantPositionId, transferStateChangeId,
                        value, reservedValue)
                    VALUES ({hubPositionId}, {transferStateChangeId},
                        {hubPositionValue + t.hubAmount}, 0)
                end note
                activate DB
                deactivate DB
            end
        end
    end
end
deactivate SETTLE_DAO

@enduml

PlantUML version 1.2018.05(Sat May 05 21:00:17 BST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>