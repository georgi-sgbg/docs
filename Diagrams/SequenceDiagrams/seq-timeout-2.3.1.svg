<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="5620px" preserveAspectRatio="none" style="width:1710px;height:5620px;" version="1.1" viewBox="0 0 1710 5620" width="1710px" zoomAndPan="magnify"><defs><filter height="300%" id="f1v5w3cdt8c7h5" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="382" x="665" y="23.5352">2.3.1. Timeout Handler Consume (incl. Bulk Transfer)</text><rect fill="#FFFFE0" height="5574.8398" style="stroke: #A80036; stroke-width: 1.0;" width="1343" x="49" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="670" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="5395.5762" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="110.5" y="128.7754"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="353.5" y="4288.2559"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="353.5" y="5465.3516"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="493.5" y="3562.2578"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="705.5" y="4892.459"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="290.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="834" y="621.6758"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="834" y="972.6445"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="1606.4648" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="834" y="1169.8184"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="182.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1084" y="304.9492"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1335" y="334.2598"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1335" y="650.9863"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1335" y="1001.9551"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1335" y="1265.75"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1335" y="1542.0977"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1335" y="1849.0664"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1335" y="2125.4141"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="384.1426" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1335" y="2362.8301"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="5388.5762" style="stroke: #000000; stroke-width: 2.0;" width="1686" x="13" y="135.7754"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="92.2422" style="stroke: #000000; stroke-width: 2.0;" width="597" x="43" y="160.0859"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="302.7266" style="stroke: #000000; stroke-width: 2.0;" width="1454" x="33" y="266.3281"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="400" x="43" y="502.4336"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="336.9688" style="stroke: #000000; stroke-width: 2.0;" width="1593" x="43" y="583.0547"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="183.1738" style="stroke: #000000; stroke-width: 2.0;" width="1493" x="43" y="934.0234"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="1653.0859" style="stroke: #000000; stroke-width: 2.0;" width="1646" x="43" y="1131.1973"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="1149.7012" style="stroke: #000000; stroke-width: 2.0;" width="898" x="781" y="1184.8184"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="2719.0684" style="stroke: #000000; stroke-width: 2.0;" width="788" x="23" y="2798.2832"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="2662.7578" style="stroke: #000000; stroke-width: 2.0;" width="768" x="33" y="2847.5938"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="1454.3516" style="stroke: #000000; stroke-width: 2.0;" width="520" x="43" y="2871.9043"/><rect fill="#FFFFFF" height="725.998" style="stroke: none; stroke-width: 1.0;" width="520" x="43" y="3600.2578"/><rect fill="#FFFFFF" height="1177.0957" style="stroke: none; stroke-width: 1.0;" width="768" x="33" y="4333.2559"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="1148.1406" style="stroke: #000000; stroke-width: 2.0;" width="748" x="43" y="4355.2109"/><rect fill="#FFFFFF" height="572.8926" style="stroke: none; stroke-width: 1.0;" width="748" x="43" y="4930.459"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="115" x2="115" y1="118.7754" y2="5541.3516"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="358" x2="358" y1="118.7754" y2="5541.3516"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="498" x2="498" y1="118.7754" y2="5541.3516"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="596" x2="596" y1="118.7754" y2="5541.3516"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="710" x2="710" y1="118.7754" y2="5541.3516"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="839" x2="839" y1="118.7754" y2="5541.3516"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1088.5" x2="1088.5" y1="118.7754" y2="5541.3516"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1340" x2="1340" y1="118.7754" y2="5541.3516"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="53" y="99.334">Transfer Timeout</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="85.5" y="115.8223">Handler</text><ellipse cx="115.5" cy="69.7988" fill="#FEFECE" filter="url(#f1v5w3cdt8c7h5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="111.5,57.7988,117.5,52.7988,115.5,57.7988,117.5,62.7988,111.5,57.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="53" y="5553.8867">Transfer Timeout</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="85.5" y="5570.375">Handler</text><ellipse cx="115.5" cy="5589.3281" fill="#FEFECE" filter="url(#f1v5w3cdt8c7h5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="111.5,5577.3281,117.5,5572.3281,115.5,5577.3281,117.5,5582.3281,111.5,5577.3281" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f1v5w3cdt8c7h5)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="143" x="287" y="62.7988"/><rect fill="#FEFECE" filter="url(#f1v5w3cdt8c7h5)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="143" x="283" y="66.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="129" x="290" y="87.334">Transfer-Position-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="38" x="335.5" y="103.8223">Topic</text><rect fill="#FEFECE" filter="url(#f1v5w3cdt8c7h5)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="143" x="287" y="5540.3516"/><rect fill="#FEFECE" filter="url(#f1v5w3cdt8c7h5)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="143" x="283" y="5544.3516"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="129" x="290" y="5564.8867">Transfer-Position-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="38" x="335.5" y="5581.375">Topic</text><rect fill="#FEFECE" filter="url(#f1v5w3cdt8c7h5)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="101" x="448" y="62.7988"/><rect fill="#FEFECE" filter="url(#f1v5w3cdt8c7h5)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="101" x="444" y="66.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="87" x="451" y="87.334">Notification-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="38" x="475.5" y="103.8223">Topic</text><rect fill="#FEFECE" filter="url(#f1v5w3cdt8c7h5)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="101" x="448" y="5540.3516"/><rect fill="#FEFECE" filter="url(#f1v5w3cdt8c7h5)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="101" x="444" y="5544.3516"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="87" x="451" y="5564.8867">Notification-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="38" x="475.5" y="5581.375">Topic</text><rect fill="#FEFECE" filter="url(#f1v5w3cdt8c7h5)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="59" x="567" y="62.7988"/><rect fill="#FEFECE" filter="url(#f1v5w3cdt8c7h5)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="59" x="563" y="66.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="45" x="570" y="87.334">Event-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="38" x="573.5" y="103.8223">Topic</text><rect fill="#FEFECE" filter="url(#f1v5w3cdt8c7h5)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="59" x="567" y="5540.3516"/><rect fill="#FEFECE" filter="url(#f1v5w3cdt8c7h5)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="59" x="563" y="5544.3516"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="45" x="570" y="5564.8867">Event-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="38" x="573.5" y="5581.375">Topic</text><rect fill="#FEFECE" filter="url(#f1v5w3cdt8c7h5)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="133" x="644" y="62.7988"/><rect fill="#FEFECE" filter="url(#f1v5w3cdt8c7h5)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="133" x="640" y="66.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="647" y="87.334">Bulk-Processing-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="38" x="687.5" y="103.8223">Topic</text><rect fill="#FEFECE" filter="url(#f1v5w3cdt8c7h5)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="133" x="644" y="5540.3516"/><rect fill="#FEFECE" filter="url(#f1v5w3cdt8c7h5)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="133" x="640" y="5544.3516"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="647" y="5564.8867">Bulk-Processing-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="38" x="687.5" y="5581.375">Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="791" y="115.8223">Position DAO</text><ellipse cx="839" cy="86.2871" fill="#FEFECE" filter="url(#f1v5w3cdt8c7h5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="827" x2="851" y1="100.2871" y2="100.2871"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="791" y="5553.8867">Position DAO</text><ellipse cx="839" cy="5572.8398" fill="#FEFECE" filter="url(#f1v5w3cdt8c7h5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="827" x2="851" y1="5586.8398" y2="5586.8398"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="95" x="1038.5" y="115.8223">Segment DAO</text><ellipse cx="1089" cy="86.2871" fill="#FEFECE" filter="url(#f1v5w3cdt8c7h5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1077" x2="1101" y1="100.2871" y2="100.2871"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="95" x="1038.5" y="5553.8867">Segment DAO</text><ellipse cx="1089" cy="5572.8398" fill="#FEFECE" filter="url(#f1v5w3cdt8c7h5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1077" x2="1101" y1="5586.8398" y2="5586.8398"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1292" y="115.8223">Central Store</text><path d="M1322,66.2871 C1322,56.2871 1340,56.2871 1340,56.2871 C1340,56.2871 1358,56.2871 1358,66.2871 L1358,92.2871 C1358,102.2871 1340,102.2871 1340,102.2871 C1340,102.2871 1322,102.2871 1322,92.2871 L1322,66.2871 " fill="#FEFECE" filter="url(#f1v5w3cdt8c7h5)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1322,66.2871 C1322,76.2871 1340,76.2871 1340,76.2871 C1340,76.2871 1358,76.2871 1358,66.2871 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1292" y="5553.8867">Central Store</text><path d="M1322,5566.8398 C1322,5556.8398 1340,5556.8398 1340,5556.8398 C1340,5556.8398 1358,5556.8398 1358,5566.8398 L1358,5592.8398 C1358,5602.8398 1340,5602.8398 1340,5602.8398 C1340,5602.8398 1322,5602.8398 1322,5592.8398 L1322,5566.8398 " fill="#FEFECE" filter="url(#f1v5w3cdt8c7h5)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1322,5566.8398 C1322,5576.8398 1340,5576.8398 1340,5576.8398 C1340,5576.8398 1358,5576.8398 1358,5566.8398 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="5395.5762" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="110.5" y="128.7754"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="353.5" y="4288.2559"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="353.5" y="5465.3516"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="493.5" y="3562.2578"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="705.5" y="4892.459"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="290.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="834" y="621.6758"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="834" y="972.6445"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="1606.4648" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="834" y="1169.8184"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="182.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1084" y="304.9492"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1335" y="334.2598"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1335" y="650.9863"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1335" y="1001.9551"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1335" y="1265.75"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1335" y="1542.0977"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1335" y="1849.0664"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1335" y="2125.4141"/><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="384.1426" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1335" y="2362.8301"/><path d="M13,135.7754 L239,135.7754 L239,142.7754 L229,152.7754 L13,152.7754 L13,135.7754 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="5388.5762" style="stroke: #000000; stroke-width: 2.0;" width="1686" x="13" y="135.7754"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="181" x="28" y="149.3438">Timeout Handler Consume</text><path d="M43,160.0859 L258,160.0859 L258,167.0859 L248,177.0859 L43,177.0859 L43,160.0859 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="92.2422" style="stroke: #000000; stroke-width: 2.0;" width="597" x="43" y="160.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="58" y="173.6543">Persist Event Information</text><polygon fill="#A80036" points="584.5,194.707,594.5,198.707,584.5,202.707,588.5,198.707" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="120.5" x2="590.5" y1="198.707" y2="198.707"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="127.5" y="193.9648">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="140.5" y="193.9648">Publish event information</text><rect fill="#FFFFFF" filter="url(#f1v5w3cdt8c7h5)" height="40.6211" style="stroke: #000000; stroke-width: 2.0;" width="579" x="50" y="206.707"/><polygon fill="#EEEEEE" points="50,206.707,114,206.707,114,213.707,104,223.707,50,223.707,50,206.707" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="63" y="221.2754">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="244.5" y="240.2754">Event Handler Consume {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/Operations/seq-event-9.1.0.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/Operations/seq-event-9.1.0.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="32" x="402.5" y="240.2754">9.1.0</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="402.5" x2="434.5" y1="242.2754" y2="242.2754"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="434.5" y="240.2754">}</text><path d="M33,266.3281 L585,266.3281 L585,273.3281 L575,283.3281 L33,283.3281 L33,266.3281 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="302.7266" style="stroke: #000000; stroke-width: 2.0;" width="1454" x="33" y="266.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="507" x="48" y="279.8965">Get previous checkpoint of last record processed (Lower limit for inclusion)</text><polygon fill="#A80036" points="1072,300.9492,1082,304.9492,1072,308.9492,1076,304.9492" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="120.5" x2="1078" y1="304.9492" y2="304.9492"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="127.5" y="300.207">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="140.5" y="300.207">Get last segment as @intervalMin</text><polygon fill="#A80036" points="1323,330.2598,1333,334.2598,1323,338.2598,1327,334.2598" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1094" x2="1329" y1="334.2598" y2="334.2598"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1101" y="329.5176">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="1114" y="329.5176">Get last segment as @intervalMin</text><polygon fill="#FFFFE0" filter="url(#f1v5w3cdt8c7h5)" points="1212,347.2598,1467,347.2598,1477,389.2598,1467,431.2598,1212,431.2598,1202,389.2598,1212,347.2598" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="203" x="1214" y="363.8281">SELECT value INTO @intervalMin</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1214" y="379.1387">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="59" x="1254" y="379.1387">segment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="1214" y="394.4492">WHERE segmentType = 'timeout'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="1214" y="409.7598">AND enumeration = 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="1214" y="425.0703">AND tableName = 'transferStateChange'</text><polygon fill="#A80036" points="1105,454.123,1095,458.123,1105,462.123,1101,458.123" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1099" x2="1339" y1="458.123" y2="458.123"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1111" y="453.3809">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="1124" y="453.3809">Return @intervalMin</text><polygon fill="#A80036" points="131.5,483.4336,121.5,487.4336,131.5,491.4336,127.5,487.4336" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="125.5" x2="1088" y1="487.4336" y2="487.4336"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="137.5" y="482.6914">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="150.5" y="482.6914">Return @intervalMin</text><path d="M43,502.4336 L110,502.4336 L110,509.4336 L100,519.4336 L43,519.4336 L43,502.4336 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="400" x="43" y="502.4336"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="58" y="516.002">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="313" x="125" y="515.0684">[@intervalMin IS NULL =&gt; segment record NOT FOUND]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="120.5" x2="162.5" y1="541.0547" y2="541.0547"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="162.5" x2="162.5" y1="541.0547" y2="554.0547"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="121.5" x2="162.5" y1="554.0547" y2="554.0547"/><polygon fill="#A80036" points="131.5,550.0547,121.5,554.0547,131.5,558.0547,127.5,554.0547" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="127.5" y="536.3125">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="140.5" y="536.3125">Set @intervalMin = 0</text><path d="M43,583.0547 L166,583.0547 L166,590.0547 L156,600.0547 L43,600.0547 L43,583.0547 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="336.9688" style="stroke: #000000; stroke-width: 2.0;" width="1593" x="43" y="583.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="58" y="596.623">Do Cleanup</text><polygon fill="#A80036" points="822,617.6758,832,621.6758,822,625.6758,826,621.6758" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="120.5" x2="828" y1="621.6758" y2="621.6758"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="127.5" y="616.9336">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="140.5" y="616.9336">Clean up transferTimeout from finalised transfers</text><polygon fill="#A80036" points="1323,646.9863,1333,650.9863,1323,654.9863,1327,650.9863" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="844" x2="1329" y1="650.9863" y2="650.9863"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="851" y="646.2441">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="864" y="646.2441">Clean up transferTimeout from finalised transfers</text><polygon fill="#FFFFE0" filter="url(#f1v5w3cdt8c7h5)" points="1064,693.9863,1616,693.9863,1626,788.9863,1616,884.9863,1064,884.9863,1054,788.9863,1064,693.9863" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="1066" y="710.5547">DELETE tt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1066" y="725.8652">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1106" y="725.8652">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="30" x="1220" y="725.8652">AS tt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="548" x="1066" y="741.1758">JOIN (SELECT tsc.transferId, MAX(tsc.transferStateChangeId) maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1090" y="756.4863">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1130" y="756.4863">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="1244" y="756.4863">tt1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1090" y="771.7969">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1122" y="771.7969">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1265" y="771.7969">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="1090" y="787.1074">ON tsc.transferId = tt1.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="1090" y="802.418">GROUP BY transferId) ts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1066" y="817.7285">ON ts.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1066" y="833.0391">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1098" y="833.0391">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1241" y="833.0391">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="389" x="1066" y="848.3496">ON tsc.transferStateChangeId = ts.maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="452" x="1066" y="863.6602">WHERE tsc.transferStateId IN ('RECEIVED_FULFIL', 'COMMITTED', 'FAILED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="485" x="1082" y="878.9707">, 'EXPIRED', 'REJECTED', 'EXPIRED_PREPARED', 'EXPIRED_RESERVED', 'ABORTED')</text><polygon fill="#A80036" points="131.5,908.0234,121.5,912.0234,131.5,916.0234,127.5,912.0234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="125.5" x2="838" y1="912.0234" y2="912.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="137.5" y="907.2813">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="150.5" y="907.2813">Return success</text><path d="M43,934.0234 L421,934.0234 L421,941.0234 L411,951.0234 L43,951.0234 L43,934.0234 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="183.1738" style="stroke: #000000; stroke-width: 2.0;" width="1493" x="43" y="934.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="333" x="58" y="947.5918">Determine IntervalMax (Upper limit for inclusion)</text><polygon fill="#A80036" points="822,968.6445,832,972.6445,822,976.6445,826,972.6445" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="120.5" x2="828" y1="972.6445" y2="972.6445"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="127.5" y="967.9023">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="297" x="149.5" y="967.9023">Get last transferStateChangeId as @intervalMax</text><polygon fill="#A80036" points="1323,997.9551,1333,1001.9551,1323,1005.9551,1327,1001.9551" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="844" x2="1329" y1="1001.9551" y2="1001.9551"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="851" y="997.2129">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="297" x="873" y="997.2129">Get last transferStateChangeId as @intervalMax</text><polygon fill="#FFFFE0" filter="url(#f1v5w3cdt8c7h5)" points="1164,1014.9551,1516,1014.9551,1526,1033.9551,1516,1052.9551,1164,1052.9551,1154,1033.9551,1164,1014.9551" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="348" x="1166" y="1031.5234">SELECT MAX(transferStateChangeId) INTO @intervalMax</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1166" y="1046.834">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1206" y="1046.834">transferStateChange</text><polygon fill="#A80036" points="855,1075.8867,845,1079.8867,855,1083.8867,851,1079.8867" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="849" x2="1339" y1="1079.8867" y2="1079.8867"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="861" y="1075.1445">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="883" y="1075.1445">Return @intervalMax</text><polygon fill="#A80036" points="131.5,1105.1973,121.5,1109.1973,131.5,1113.1973,127.5,1109.1973" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="125.5" x2="838" y1="1109.1973" y2="1109.1973"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="137.5" y="1104.4551">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="159.5" y="1104.4551">Return @intervalMax</text><path d="M43,1131.1973 L398,1131.1973 L398,1138.1973 L388,1148.1973 L43,1148.1973 L43,1131.1973 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1653.0859" style="stroke: #000000; stroke-width: 2.0;" width="1646" x="43" y="1131.1973"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="310" x="58" y="1144.7656">Prepare data and return the list for expiration</text><polygon fill="#A80036" points="822,1165.8184,832,1169.8184,822,1173.8184,826,1169.8184" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="120.5" x2="828" y1="1169.8184" y2="1169.8184"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="127.5" y="1165.0762">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="149.5" y="1165.0762">Prepare data and get transfers to be expired</text><path d="M781,1184.8184 L946,1184.8184 L946,1191.8184 L936,1201.8184 L781,1201.8184 L781,1184.8184 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1149.7012" style="stroke: #000000; stroke-width: 2.0;" width="898" x="781" y="1184.8184"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="796" y="1198.3867">DB TRANSACTION</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="844" x2="886" y1="1223.4395" y2="1223.4395"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="886" x2="886" y1="1223.4395" y2="1236.4395"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="845" x2="886" y1="1236.4395" y2="1236.4395"/><polygon fill="#A80036" points="855,1232.4395,845,1236.4395,855,1240.4395,851,1236.4395" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="851" y="1218.6973">15</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="873" y="1218.6973">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="1029" y="1218.6973">= now()</text><polygon fill="#A80036" points="1323,1261.75,1333,1265.75,1323,1269.75,1327,1265.75" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="844" x2="1329" y1="1265.75" y2="1265.75"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="851" y="1261.0078">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="873" y="1261.0078">Insert all new transfers still in processing state</text><polygon fill="#FFFFE0" filter="url(#f1v5w3cdt8c7h5)" points="1087,1308.75,1593,1308.75,1603,1403.75,1593,1499.75,1087,1499.75,1077,1403.75,1087,1308.75" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1089" y="1325.3184">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1173" y="1325.3184">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="1283" y="1325.3184">(transferId, expirationDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="1089" y="1340.6289">SELECT t.transferId, t.expirationDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1089" y="1355.9395">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="54" x="1129" y="1355.9395">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="1187" y="1355.9395">t</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="502" x="1089" y="1371.25">JOIN (SELECT transferId, MAX(transferStateChangeId) maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1113" y="1386.5605">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1153" y="1386.5605">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="1113" y="1401.8711">WHERE transferStateChangeId &gt; @intervalMin</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="1113" y="1417.1816">AND transferStateChangeId &lt;= @intervalMax</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="1113" y="1432.4922">GROUP BY transferId) ts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="1089" y="1447.8027">ON ts.transferId = t.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1089" y="1463.1133">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1121" y="1463.1133">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1264" y="1463.1133">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="389" x="1089" y="1478.4238">ON tsc.transferStateChangeId = ts.maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="394" x="1089" y="1493.7344">WHERE tsc.transferStateId IN ('RECEIVED_PREPARE', 'RESERVED')</text><polygon fill="#A80036" points="1323,1538.0977,1333,1542.0977,1323,1546.0977,1327,1542.0977" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="844" x2="1329" y1="1542.0977" y2="1542.0977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="851" y="1529.7002">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="873" y="1522.0449">Insert transfer state ABORTED for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="873" y="1537.3555">expired RECEIVED_PREPARE transfers</text><polygon fill="#FFFFE0" filter="url(#f1v5w3cdt8c7h5)" points="1021,1585.0977,1658,1585.0977,1668,1696.0977,1658,1807.0977,1021,1807.0977,1011,1696.0977,1021,1585.0977" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1023" y="1601.666">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1107" y="1601.666">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="633" x="1023" y="1616.9766">SELECT tt.transferId, 'EXPIRED_PREPARED' AS transferStateId, 'Aborted by Timeout Handler' AS reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1023" y="1632.2871">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1063" y="1632.2871">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="1177" y="1632.2871">tt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1023" y="1647.5977">JOIN (</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="460" x="1063" y="1647.5977">-- Following subquery is reused 3 times and may be optimized if needed</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="528" x="1047" y="1662.9082">SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1047" y="1678.2188">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1087" y="1678.2188">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="1230" y="1678.2188">tsc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1047" y="1693.5293">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1079" y="1693.5293">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="1193" y="1693.5293">tt1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="1047" y="1708.8398">ON tt1.transferId = tsc1.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="1047" y="1724.1504">GROUP BY tsc1.transferId) ts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1023" y="1739.4609">ON ts.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1023" y="1754.7715">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1055" y="1754.7715">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1198" y="1754.7715">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="389" x="1023" y="1770.082">ON tsc.transferStateChangeId = ts.maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="321" x="1023" y="1785.3926">WHERE tt.expirationDate &lt; {transactionTimestamp}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="1023" y="1800.7031">AND tsc.transferStateId = 'RECEIVED_PREPARE'</text><polygon fill="#A80036" points="1323,1845.0664,1333,1849.0664,1323,1853.0664,1327,1849.0664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="844" x2="1329" y1="1849.0664" y2="1849.0664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="851" y="1836.6689">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="873" y="1829.0137">Insert transfer state EXPIRED for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="873" y="1844.3242">expired RESERVED transfers</text><polygon fill="#FFFFE0" filter="url(#f1v5w3cdt8c7h5)" points="1020,1892.0664,1659,1892.0664,1669,1995.0664,1659,2099.0664,1020,2099.0664,1010,1995.0664,1020,1892.0664" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1022" y="1908.6348">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1106" y="1908.6348">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="635" x="1022" y="1923.9453">SELECT tt.transferId, 'RESERVED_TIMEOUT' AS transferStateId, 'Expired by Timeout Handler' AS reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1022" y="1939.2559">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1062" y="1939.2559">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="1176" y="1939.2559">tt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="564" x="1022" y="1954.5664">JOIN (SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1046" y="1969.877">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1086" y="1969.877">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="1229" y="1969.877">tsc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1046" y="1985.1875">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1078" y="1985.1875">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="1192" y="1985.1875">tt1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="1046" y="2000.498">ON tt1.transferId = tsc1.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="1046" y="2015.8086">GROUP BY tsc1.transferId) ts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1022" y="2031.1191">ON ts.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1022" y="2046.4297">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1054" y="2046.4297">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1197" y="2046.4297">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="389" x="1022" y="2061.7402">ON tsc.transferStateChangeId = ts.maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="321" x="1022" y="2077.0508">WHERE tt.expirationDate &lt; {transactionTimestamp}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="1022" y="2092.3613">AND tsc.transferStateId = 'RESERVED'</text><polygon fill="#A80036" points="1323,2121.4141,1333,2125.4141,1323,2129.4141,1327,2125.4141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="844" x2="1329" y1="2125.4141" y2="2125.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="851" y="2120.6719">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="873" y="2120.6719">Update segment table to be used for the next run</text><polygon fill="#FFFFE0" filter="url(#f1v5w3cdt8c7h5)" points="1135,2168.4141,1545,2168.4141,1555,2248.4141,1545,2329.4141,1135,2329.4141,1125,2248.4141,1135,2168.4141" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="1137" y="2184.9824">IF @intervalMin = 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="1153" y="2200.293">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="1153" y="2215.6035">INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="59" x="1189" y="2215.6035">segment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="1248" y="2215.6035">(segmentType, enumeration, tableName, value)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="363" x="1153" y="2230.9141">VALUES ('timeout', 0, 'transferStateChange', @intervalMax)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1137" y="2246.2246">ELSE</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1153" y="2261.5352">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="59" x="1207" y="2261.5352">segment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="1153" y="2276.8457">SET value = @intervalMax</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="1153" y="2292.1563">WHERE segmentType = 'timeout'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="1153" y="2307.4668">AND enumeration = 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="1153" y="2322.7773">AND tableName = 'transferStateChange'</text><polygon fill="#A80036" points="1323,2358.8301,1333,2362.8301,1323,2366.8301,1327,2362.8301" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="844" x2="1329" y1="2362.8301" y2="2362.8301"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="851" y="2358.0879">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="324" x="873" y="2358.0879">Get list of transfers to be expired with current state</text><polygon fill="#FFFFE0" filter="url(#f1v5w3cdt8c7h5)" points="1056,2375.8301,1624,2375.8301,1634,2547.8301,1624,2719.8301,1056,2719.8301,1046,2547.8301,1056,2375.8301" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="1058" y="2392.3984">SELECT tt.*, tsc.transferStateId, tp1.participantCurrencyId payerParticipantId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="1090" y="2407.709">tp2.participantCurrencyId payeeParticipantId, bta.bulkTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1058" y="2423.0195">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1098" y="2423.0195">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="1212" y="2423.0195">tt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="564" x="1058" y="2438.3301">JOIN (SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1090" y="2453.6406">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1130" y="2453.6406">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="1273" y="2453.6406">tsc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1090" y="2468.9512">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1122" y="2468.9512">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="1236" y="2468.9512">tt1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="1090" y="2484.2617">ON tt1.transferId = tsc1.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="1090" y="2499.5723">GROUP BY tsc1.transferId) ts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1058" y="2514.8828">ON ts.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1058" y="2530.1934">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1090" y="2530.1934">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1233" y="2530.1934">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="389" x="1058" y="2545.5039">ON tsc.transferStateChangeId = ts.maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1058" y="2560.8145">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1090" y="2560.8145">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1221" y="2560.8145">tp1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="203" x="1058" y="2576.125">ON tp1.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="1058" y="2591.4355">AND tp1.transferParticipantRoleTypeId = {PAYER_DFSP}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="1058" y="2606.7461">AND tp1.ledgerEntryTypeId = {PRINCIPLE_VALUE}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1058" y="2622.0566">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1090" y="2622.0566">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1221" y="2622.0566">tp2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="203" x="1058" y="2637.3672">ON tp2.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="345" x="1058" y="2652.6777">AND tp2.transferParticipantRoleTypeId = {PAYEE_DFSP}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="1058" y="2667.9883">AND tp2.ledgerEntryTypeId = {PRINCIPLE_VALUE}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="1058" y="2683.2988">LEFT JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="165" x="1123" y="2683.2988">bulkTransferAssociation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="20" x="1292" y="2683.2988">bta</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="1058" y="2698.6094">ON bta.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="321" x="1058" y="2713.9199">WHERE tt.expirationDate &lt; {transactionTimestamp}</text><polygon fill="#A80036" points="855,2742.9727,845,2746.9727,855,2750.9727,851,2746.9727" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="849" x2="1339" y1="2746.9727" y2="2746.9727"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="861" y="2742.2305">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="883" y="2742.2305">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="928" y="2742.2305">transferTimeoutList</text><polygon fill="#A80036" points="131.5,2772.2832,121.5,2776.2832,131.5,2780.2832,127.5,2776.2832" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="125.5" x2="838" y1="2776.2832" y2="2776.2832"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="137.5" y="2771.541">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="159.5" y="2771.541">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="204.5" y="2771.541">transferTimeoutList</text><path d="M23,2798.2832 L97,2798.2832 L97,2805.2832 L87,2815.2832 L23,2815.2832 L23,2798.2832 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2719.0684" style="stroke: #000000; stroke-width: 2.0;" width="788" x="23" y="2798.2832"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="38" y="2811.8516">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="160" x="112" y="2810.918">[for each transfer in the list]</text><path d="M33,2847.5938 L95,2847.5938 L95,2854.5938 L85,2864.5938 L33,2864.5938 L33,2847.5938 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2662.7578" style="stroke: #000000; stroke-width: 2.0;" width="768" x="33" y="2847.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="48" y="2861.1621">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="367" x="110" y="2860.2285">[transferTimeoutList.bulkTransferId == NULL (Regular Transfer)]</text><path d="M43,2871.9043 L105,2871.9043 L105,2878.9043 L95,2888.9043 L43,2888.9043 L43,2871.9043 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1454.3516" style="stroke: #000000; stroke-width: 2.0;" width="520" x="43" y="2871.9043"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="58" y="2885.4727">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="237" x="120" y="2884.5391">[transferStateId == 'RECEIVED_PREPARE']</text><path d="M125,2894.2148 L125,3531.2148 L525,3531.2148 L525,2904.2148 L515,2894.2148 L125,2894.2148 " fill="#FFFF00" filter="url(#f1v5w3cdt8c7h5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M515,2894.2148 L515,2904.2148 L525,2904.2148 L515,2894.2148 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="131" y="2911.7832">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="131" y="2927.0938">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="147" y="2942.4043">id: &lt;transferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="147" y="2957.7148">from: &lt;payerParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="147" y="2973.0254">to: &lt;payeeParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="147" y="2988.3359">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="147" y="3003.6465">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="163" y="3018.957">headers: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="179" y="3034.2676">Content-Length: &lt;Content-Length&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="179" y="3049.5781">Content-Type: &lt;Content-Type&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="179" y="3064.8887">Date: &lt;Date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="179" y="3080.1992">X-Forwarded-For: &lt;X-Forwarded-For&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="179" y="3095.5098">FSPIOP-Source: &lt;FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="179" y="3110.8203">FSPIOP-Destination: &lt;FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="179" y="3126.1309">FSPIOP-Encryption: &lt;FSPIOP-Encryption&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="179" y="3141.4414">FSPIOP-Signature: &lt;FSPIOP-Signature&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="179" y="3156.752">FSPIOP-URI: &lt;FSPIOP-URI&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="304" x="179" y="3172.0625">FSPIOP-HTTP-Method: &lt;FSPIOP-HTTP-Method&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="163" y="3187.373">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="163" y="3202.6836">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="179" y="3217.9941">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="195" y="3233.3047">"errorCode": 3303,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="195" y="3248.6152">"errorDescription": "Transfer expired",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="195" y="3263.9258">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="3279.2363">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="163" y="3294.5469">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="147" y="3309.8574">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="147" y="3325.168">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="163" y="3340.4785">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="179" y="3355.7891">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="179" y="3371.0996">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="179" y="3386.4102">action: timeout-received,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="179" y="3401.7207">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="179" y="3417.0313">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="195" y="3432.3418">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="195" y="3447.6523">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="195" y="3462.9629">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="3478.2734">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="163" y="3493.584">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="147" y="3508.8945">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="131" y="3524.2051">}</text><polygon fill="#A80036" points="481.5,3558.2578,491.5,3562.2578,481.5,3566.2578,485.5,3562.2578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="120.5" x2="487.5" y1="3562.2578" y2="3562.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="127.5" y="3557.5156">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="149.5" y="3557.5156">Publish Notification event</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="43" x2="563" y1="3601.2578" y2="3601.2578"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="181" x="48" y="3611.8926">[transferStateId == 'RESERVED']</text><path d="M125,3620.2129 L125,4257.2129 L525,4257.2129 L525,3630.2129 L515,3620.2129 L125,3620.2129 " fill="#FFFF00" filter="url(#f1v5w3cdt8c7h5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M515,3620.2129 L515,3630.2129 L525,3630.2129 L515,3620.2129 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="131" y="3637.7813">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="131" y="3653.0918">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="147" y="3668.4023">id: &lt;transferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="147" y="3683.7129">from: &lt;payerParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="147" y="3699.0234">to: &lt;payeeParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="147" y="3714.334">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="147" y="3729.6445">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="163" y="3744.9551">headers: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="179" y="3760.2656">Content-Length: &lt;Content-Length&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="179" y="3775.5762">Content-Type: &lt;Content-Type&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="179" y="3790.8867">Date: &lt;Date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="179" y="3806.1973">X-Forwarded-For: &lt;X-Forwarded-For&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="179" y="3821.5078">FSPIOP-Source: &lt;FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="179" y="3836.8184">FSPIOP-Destination: &lt;FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="179" y="3852.1289">FSPIOP-Encryption: &lt;FSPIOP-Encryption&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="179" y="3867.4395">FSPIOP-Signature: &lt;FSPIOP-Signature&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="179" y="3882.75">FSPIOP-URI: &lt;FSPIOP-URI&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="304" x="179" y="3898.0605">FSPIOP-HTTP-Method: &lt;FSPIOP-HTTP-Method&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="163" y="3913.3711">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="163" y="3928.6816">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="179" y="3943.9922">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="195" y="3959.3027">"errorCode": 3303,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="195" y="3974.6133">"errorDescription": "Transfer expired",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="195" y="3989.9238">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="4005.2344">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="163" y="4020.5449">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="147" y="4035.8555">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="147" y="4051.166">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="163" y="4066.4766">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="179" y="4081.7871">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="179" y="4097.0977">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="179" y="4112.4082">action: timeout-reserved,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="179" y="4127.7188">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="179" y="4143.0293">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="195" y="4158.3398">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="195" y="4173.6504">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="195" y="4188.9609">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="4204.2715">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="163" y="4219.582">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="147" y="4234.8926">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="131" y="4250.2031">}</text><polygon fill="#A80036" points="341.5,4284.2559,351.5,4288.2559,341.5,4292.2559,345.5,4288.2559" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="120.5" x2="347.5" y1="4288.2559" y2="4288.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="127.5" y="4283.5137">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="149.5" y="4283.5137">Route &amp; Publish Position event</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="33" x2="801" y1="4334.2559" y2="4334.2559"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="188" x="38" y="4344.8906">[Individual Transfer from a Bulk]</text><path d="M43,4355.2109 L105,4355.2109 L105,4362.2109 L95,4372.2109 L43,4372.2109 L43,4355.2109 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1148.1406" style="stroke: #000000; stroke-width: 2.0;" width="748" x="43" y="4355.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="58" y="4368.7793">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="237" x="120" y="4367.8457">[transferStateId == 'RECEIVED_PREPARE']</text><path d="M125,4377.5215 L125,4861.5215 L525,4861.5215 L525,4387.5215 L515,4377.5215 L125,4377.5215 " fill="#FFFF00" filter="url(#f1v5w3cdt8c7h5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M515,4377.5215 L515,4387.5215 L525,4387.5215 L515,4377.5215 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="131" y="4395.0898">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="131" y="4410.4004">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="147" y="4425.7109"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="147" y="4425.7109">id</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="159" y="4425.7109">: &lt;transferTimeoutList.bulkTransferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="147" y="4441.0215"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="147" y="4441.0215">transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="208" y="4441.0215">: &lt;transferTimeoutList.transferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="147" y="4456.332">from: &lt;payerParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="147" y="4471.6426">to: &lt;payeeParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="147" y="4486.9531">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="147" y="4502.2637">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="163" y="4517.5742">headers: &lt;bulkTransferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="163" y="4532.8848">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="179" y="4548.1953">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="195" y="4563.5059">"errorCode": 3303,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="195" y="4578.8164">"errorDescription": "Transfer expired",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="195" y="4594.127">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="4609.4375">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="163" y="4624.748">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="147" y="4640.0586">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="147" y="4655.3691">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="163" y="4670.6797">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="179" y="4685.9902">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="179" y="4701.3008">type: bulk-notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="196" x="179" y="4716.6113">action: bulk-timeout-received,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="179" y="4731.9219">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="179" y="4747.2324">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="195" y="4762.543">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="195" y="4777.8535">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="195" y="4793.1641">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="4808.4746">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="163" y="4823.7852">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="147" y="4839.0957">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="131" y="4854.4063">}</text><polygon fill="#A80036" points="693.5,4888.459,703.5,4892.459,693.5,4896.459,697.5,4892.459" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="120.5" x2="699.5" y1="4892.459" y2="4892.459"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="127.5" y="4887.7168">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="149.5" y="4887.7168">Publish Bulk Notification event for processing</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="43" x2="791" y1="4931.459" y2="4931.459"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="181" x="48" y="4942.0938">[transferStateId == 'RESERVED']</text><path d="M125,4950.4141 L125,5434.4141 L525,5434.4141 L525,4960.4141 L515,4950.4141 L125,4950.4141 " fill="#FFFF00" filter="url(#f1v5w3cdt8c7h5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M515,4950.4141 L515,4960.4141 L525,4960.4141 L515,4950.4141 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="131" y="4967.9824">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="131" y="4983.293">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="147" y="4998.6035"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="147" y="4998.6035">id</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="159" y="4998.6035">: &lt;transferTimeoutList.bulkTransferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="147" y="5013.9141"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="147" y="5013.9141">transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="208" y="5013.9141">: &lt;transferTimeoutList.transferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="147" y="5029.2246">from: &lt;payerParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="147" y="5044.5352">to: &lt;payeeParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="147" y="5059.8457">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="147" y="5075.1563">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="163" y="5090.4668">headers: &lt;bulkTransferHeaders&gt;,,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="163" y="5105.7773">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="179" y="5121.0879">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="195" y="5136.3984">"errorCode": 3303,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="195" y="5151.709">"errorDescription": "Transfer expired",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="195" y="5167.0195">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="5182.3301">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="163" y="5197.6406">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="147" y="5212.9512">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="147" y="5228.2617">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="163" y="5243.5723">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="179" y="5258.8828">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="179" y="5274.1934">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="179" y="5289.5039">action: bulk-timeout-reserved,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="179" y="5304.8145">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="179" y="5320.125">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="195" y="5335.4355">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="195" y="5350.7461">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="195" y="5366.0566">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="5381.3672">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="163" y="5396.6777">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="147" y="5411.9883">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="131" y="5427.2988">}</text><polygon fill="#A80036" points="341.5,5461.3516,351.5,5465.3516,341.5,5469.3516,345.5,5465.3516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="120.5" x2="347.5" y1="5465.3516" y2="5465.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="127.5" y="5460.6094">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="149.5" y="5460.6094">Route &amp; Publish Position event</text><!--
@startuml
title 2.3.1. Timeout Handler Consume (incl. Bulk Transfer)

autonumber


control "Transfer Timeout\nHandler" as TIMEOUT_HANDLER
collections "Transfer-Position-\nTopic" as TOPIC_TRANSFER_POSITION
collections "Notification-\nTopic" as NOTIFICATIONS_TOPIC
collections "Event-\nTopic" as EVENT_TOPIC
collections "Bulk-Processing-\nTopic" as BULK_PROCESSING_TOPIC
entity "Segment DAO" as SEGMENT_DAO
entity "Position DAO" as POS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TIMEOUT_HANDLER
    participant TOPIC_TRANSFER_POSITION
    participant NOTIFICATIONS_TOPIC
    participant EVENT_TOPIC
    participant BULK_PROCESSING_TOPIC
    participant POS_DAO
    participant SEGMENT_DAO
    participant DB
end box


group Timeout Handler Consume
    activate TIMEOUT_HANDLER
    group Persist Event Information
        TIMEOUT_HANDLER -> EVENT_TOPIC: Publish event information
        ref over TIMEOUT_HANDLER, EVENT_TOPIC :  Event Handler Consume {[[https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/Operations/seq-event-9.1.0.svg 9.1.0]]}
    end

    group Get previous checkpoint of last record processed (Lower limit for inclusion)
        TIMEOUT_HANDLER -> SEGMENT_DAO: Get last segment as @intervalMin
        activate SEGMENT_DAO
        SEGMENT_DAO -> DB: Get last segment as @intervalMin
        hnote over DB #lightyellow
            SELECT value INTO @intervalMin
            FROM **segment**
            WHERE segmentType = 'timeout'
            AND enumeration = 0
            AND tableName = 'transferStateChange'
        end note
        activate DB
        DB - -> SEGMENT_DAO: Return @intervalMin
        deactivate DB
        SEGMENT_DAO - -> TIMEOUT_HANDLER: Return @intervalMin
        deactivate SEGMENT_DAO
        opt @intervalMin IS NULL => segment record NOT FOUND
            TIMEOUT_HANDLER->TIMEOUT_HANDLER: Set @intervalMin = 0
        end
    end

    group Do Cleanup
        TIMEOUT_HANDLER -> POS_DAO: Clean up transferTimeout from finalised transfers
        activate POS_DAO
        POS_DAO -> DB: Clean up transferTimeout from finalised transfers
        hnote over DB #lightyellow
            DELETE tt
            FROM **transferTimeout** AS tt
            JOIN (SELECT tsc.transferId, MAX(tsc.transferStateChangeId) maxTransferStateChangeId
                  FROM **transferTimeout** tt1
                  JOIN **transferStateChange** tsc
                  ON tsc.transferId = tt1.transferId
                  GROUP BY transferId) ts
            ON ts.transferId = tt.transferId
            JOIN **transferStateChange** tsc
            ON tsc.transferStateChangeId = ts.maxTransferStateChangeId
            WHERE tsc.transferStateId IN ('RECEIVED_FULFIL', 'COMMITTED', 'FAILED'
                , 'EXPIRED', 'REJECTED', 'EXPIRED_PREPARED', 'EXPIRED_RESERVED', 'ABORTED')
        end note
        activate DB
        deactivate DB
        POS_DAO - -> TIMEOUT_HANDLER: Return success
        deactivate POS_DAO
    end

    group Determine IntervalMax (Upper limit for inclusion)
        TIMEOUT_HANDLER -> POS_DAO: Get last transferStateChangeId as @intervalMax
        activate POS_DAO
        POS_DAO -> DB: Get last transferStateChangeId as @intervalMax
        hnote over DB #lightyellow
            SELECT MAX(transferStateChangeId) INTO @intervalMax
            FROM **transferStateChange**
        end note
        activate DB
        DB - -> POS_DAO: Return @intervalMax
        deactivate DB
        POS_DAO - -> TIMEOUT_HANDLER: Return @intervalMax
        deactivate POS_DAO
    end

    
    group Prepare data and return the list for expiration
        TIMEOUT_HANDLER -> POS_DAO: Prepare data and get transfers to be expired
        activate POS_DAO
        group <color #blue>DB TRANSACTION</color>
            POS_DAO <-> POS_DAO: **transactionTimestamp** = now()
            POS_DAO -> DB: Insert all new transfers still in processing state
            hnote over DB #lightyellow
                INSERT INTO **transferTimeout**(transferId, expirationDate)
                SELECT t.transferId, t.expirationDate
                FROM **transfer** t
                JOIN (SELECT transferId, MAX(transferStateChangeId) maxTransferStateChangeId
                      FROM **transferStateChange**
                      WHERE transferStateChangeId > @intervalMin
                      AND transferStateChangeId <= @intervalMax
                      GROUP BY transferId) ts
                ON ts.transferId = t.transferId
                JOIN **transferStateChange** tsc
                ON tsc.transferStateChangeId = ts.maxTransferStateChangeId
                WHERE tsc.transferStateId IN ('RECEIVED_PREPARE', 'RESERVED')
            end note
            activate DB
            deactivate DB

            POS_DAO -> DB: Insert transfer state ABORTED for\nexpired RECEIVED_PREPARE transfers
            hnote over DB #lightyellow
                INSERT INTO **transferStateChange**
                SELECT tt.transferId, 'EXPIRED_PREPARED' AS transferStateId, 'Aborted by Timeout Handler' AS reason
                FROM **transferTimeout** tt
                JOIN ( <color #FF0000>- - Following subquery is reused 3 times and may be optimized if needed</color>
                      SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId
                      FROM **transferStateChange** tsc1
                      JOIN **transferTimeout** tt1
                      ON tt1.transferId = tsc1.transferId
                      GROUP BY tsc1.transferId) ts
                ON ts.transferId = tt.transferId
                JOIN **transferStateChange** tsc
                ON tsc.transferStateChangeId = ts.maxTransferStateChangeId
                WHERE tt.expirationDate < {transactionTimestamp}
                AND tsc.transferStateId = 'RECEIVED_PREPARE'
            end note
            activate DB
            deactivate DB

            POS_DAO -> DB: Insert transfer state EXPIRED for\nexpired RESERVED transfers
            hnote over DB #lightyellow
                INSERT INTO **transferStateChange**
                SELECT tt.transferId, 'RESERVED_TIMEOUT' AS transferStateId, 'Expired by Timeout Handler' AS reason
                FROM **transferTimeout** tt
                JOIN (SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId
                      FROM **transferStateChange** tsc1
                      JOIN **transferTimeout** tt1
                      ON tt1.transferId = tsc1.transferId
                      GROUP BY tsc1.transferId) ts
                ON ts.transferId = tt.transferId
                JOIN **transferStateChange** tsc
                ON tsc.transferStateChangeId = ts.maxTransferStateChangeId
                WHERE tt.expirationDate < {transactionTimestamp}
                AND tsc.transferStateId = 'RESERVED'
            end note
            activate DB
            deactivate DB

            POS_DAO -> DB: Update segment table to be used for the next run
            hnote over DB #lightyellow
                IF @intervalMin = 0
                    INSERT
                    INTO **segment**(segmentType, enumeration, tableName, value)
                    VALUES ('timeout', 0, 'transferStateChange', @intervalMax)
                ELSE
                    UPDATE **segment**
                    SET value = @intervalMax
                    WHERE segmentType = 'timeout'
                    AND enumeration = 0
                    AND tableName = 'transferStateChange'
            end note
            activate DB
            deactivate DB
        end

        POS_DAO -> DB: Get list of transfers to be expired with current state
        hnote over DB #lightyellow
            SELECT tt.*, tsc.transferStateId, tp1.participantCurrencyId payerParticipantId, 
                    tp2.participantCurrencyId payeeParticipantId, bta.bulkTransferId
            FROM **transferTimeout** tt
            JOIN (SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId
                    FROM **transferStateChange** tsc1
                    JOIN **transferTimeout** tt1
                    ON tt1.transferId = tsc1.transferId
                    GROUP BY tsc1.transferId) ts
            ON ts.transferId = tt.transferId
            JOIN **transferStateChange** tsc
            ON tsc.transferStateChangeId = ts.maxTransferStateChangeId
            JOIN **transferParticipant** tp1
            ON tp1.transferId = tt.transferId
            AND tp1.transferParticipantRoleTypeId = {PAYER_DFSP}
            AND tp1.ledgerEntryTypeId = {PRINCIPLE_VALUE}
            JOIN **transferParticipant** tp2
            ON tp2.transferId = tt.transferId
            AND tp2.transferParticipantRoleTypeId = {PAYEE_DFSP}
            AND tp2.ledgerEntryTypeId = {PRINCIPLE_VALUE}
            LEFT JOIN **bulkTransferAssociation** bta
            ON bta.transferId = tt.transferId
            WHERE tt.expirationDate < {transactionTimestamp}
        end note
        activate DB
        POS_DAO <- - DB: Return **transferTimeoutList**
        deactivate DB
        POS_DAO - -> TIMEOUT_HANDLER: Return **transferTimeoutList**
        deactivate POS_DAO
    end

    loop for each transfer in the list
        |||
        alt transferTimeoutList.bulkTransferId == NULL (Regular Transfer)
            alt transferStateId == 'RECEIVED_PREPARE'
                note right of TIMEOUT_HANDLER #yellow
                    Message:
                    {
                        id: <transferId>,
                        from: <payerParticipantId>,
                        to: <payeeParticipantId>,
                        type: application/json,
                        content: {
                            headers: {
                                Content-Length: <Content-Length>,
                                Content-Type: <Content-Type>,
                                Date: <Date>,
                                X-Forwarded-For: <X-Forwarded-For>,
                                FSPIOP-Source: <FSPIOP-Source>,
                                FSPIOP-Destination: <FSPIOP-Destination>,
                                FSPIOP-Encryption: <FSPIOP-Encryption>,
                                FSPIOP-Signature: <FSPIOP-Signature>,
                                FSPIOP-URI: <FSPIOP-URI>,
                                FSPIOP-HTTP-Method: <FSPIOP-HTTP-Method>
                            },
                            payload: {
                                "errorInformation": {
                                    "errorCode": 3303,
                                    "errorDescription": "Transfer expired",
                                    "extensionList": <transferMessage.extensionList>
                                }
                            }
                        },
                        metadata: {
                            event: {
                                id: <uuid>,
                                type: notification,
                                action: timeout-received,
                                createdAt: <timestamp>,
                                state: {
                                    status: 'error',
                                    code: <errorInformation.errorCode>
                                    description: <errorInformation.errorDescription>
                                }
                            }
                        }
                    }
                end note
                TIMEOUT_HANDLER -> NOTIFICATIONS_TOPIC: Publish Notification event
                activate NOTIFICATIONS_TOPIC
                deactivate NOTIFICATIONS_TOPIC
            else transferStateId == 'RESERVED'
                note right of TIMEOUT_HANDLER #yellow
                    Message:
                    {
                        id: <transferId>,
                        from: <payerParticipantId>,
                        to: <payeeParticipantId>,
                        type: application/json,
                        content: {
                            headers: {
                                Content-Length: <Content-Length>,
                                Content-Type: <Content-Type>,
                                Date: <Date>,
                                X-Forwarded-For: <X-Forwarded-For>,
                                FSPIOP-Source: <FSPIOP-Source>,
                                FSPIOP-Destination: <FSPIOP-Destination>,
                                FSPIOP-Encryption: <FSPIOP-Encryption>,
                                FSPIOP-Signature: <FSPIOP-Signature>,
                                FSPIOP-URI: <FSPIOP-URI>,
                                FSPIOP-HTTP-Method: <FSPIOP-HTTP-Method>
                            },
                            payload: {
                                "errorInformation": {
                                    "errorCode": 3303,
                                    "errorDescription": "Transfer expired",
                                    "extensionList": <transferMessage.extensionList>
                                }
                            }
                        },
                        metadata: {
                            event: {
                                id: <uuid>,
                                type: position,
                                action: timeout-reserved,
                                createdAt: <timestamp>,
                                state: {
                                    status: 'error',
                                    code: <errorInformation.errorCode>
                                    description: <errorInformation.errorDescription>
                                }
                            }
                        }
                    }
                end note
                TIMEOUT_HANDLER -> TOPIC_TRANSFER_POSITION: Route & Publish Position event
                activate TOPIC_TRANSFER_POSITION
                deactivate TOPIC_TRANSFER_POSITION
            end
        else Individual Transfer from a Bulk
            alt transferStateId == 'RECEIVED_PREPARE'
                note right of TIMEOUT_HANDLER #yellow
                    Message:
                    {
                        <color #red>id</color>: <transferTimeoutList.bulkTransferId>,
                        <color #red>transferId</color>: <transferTimeoutList.transferId>,
                        from: <payerParticipantId>,
                        to: <payeeParticipantId>,
                        type: application/json,
                        content: {
                            headers: <bulkTransferHeaders>,
                            payload: {
                                "errorInformation": {
                                    "errorCode": 3303,
                                    "errorDescription": "Transfer expired",
                                    "extensionList": <transferMessage.extensionList>
                                }
                            }
                        },
                        metadata: {
                            event: {
                                id: <uuid>,
                                type: bulk-notification,
                                action: bulk-timeout-received,
                                createdAt: <timestamp>,
                                state: {
                                    status: 'error',
                                    code: <errorInformation.errorCode>
                                    description: <errorInformation.errorDescription>
                                }
                            }
                        }
                    }
                end note
                TIMEOUT_HANDLER -> BULK_PROCESSING_TOPIC: Publish Bulk Notification event for processing
                activate BULK_PROCESSING_TOPIC
                deactivate BULK_PROCESSING_TOPIC
            else transferStateId == 'RESERVED'
                note right of TIMEOUT_HANDLER #yellow
                    Message:
                    {
                        <color #red>id</color>: <transferTimeoutList.bulkTransferId>,
                        <color #red>transferId</color>: <transferTimeoutList.transferId>,
                        from: <payerParticipantId>,
                        to: <payeeParticipantId>,
                        type: application/json,
                        content: {
                            headers: <bulkTransferHeaders>,,
                            payload: {
                                "errorInformation": {
                                    "errorCode": 3303,
                                    "errorDescription": "Transfer expired",
                                    "extensionList": <transferMessage.extensionList>
                                }
                            }
                        },
                        metadata: {
                            event: {
                                id: <uuid>,
                                type: position,
                                action: bulk-timeout-reserved,
                                createdAt: <timestamp>,
                                state: {
                                    status: 'error',
                                    code: <errorInformation.errorCode>
                                    description: <errorInformation.errorDescription>
                                }
                            }
                        }
                    }
                end note
                TIMEOUT_HANDLER -> TOPIC_TRANSFER_POSITION: Route & Publish Position event
                activate TOPIC_TRANSFER_POSITION
                deactivate TOPIC_TRANSFER_POSITION
            end
        end
    end

    deactivate TIMEOUT_HANDLER
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.14.4
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>